<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æµ·é“å†¬æ—… 2025</title>
    
    <!-- PWA æ¼¸é€²å¼ç¶²è·¯æ‡‰ç”¨ç¨‹å¼è¨­å®š -->
    <meta name="theme-color" content="#7d6c5e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <!-- Google Fontsä¸­æ–‡å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // å°‡ç³»çµ±é è¨­çš„ gray è¦†è“‹ç‚ºæš–ç°è‰² (Stone) 
                        gray: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917', 950: '#0c0a09'
                        },
                        muji: {
                            bg: '#f9f9f9', card: '#ffffff', text: '#4a4a4a', subtext: '#8a8a8a',
                            accent: '#7d6c5e', highlight: '#a84a32', border: '#e5e5e5',
                            transport: '#eff6ff', transportText: '#3b82f6',// è‡ªè¨‚äº¤é€šé¡è‰²
                            spot: '#f0fdf4', spotText: '#15803d',// è‡ªè¨‚æ™¯é»é¡è‰²
                            food: '#fff7ed', foodText: '#c2410c',// è‡ªè¨‚ç¾é£Ÿé¡è‰²
                            shop: '#fdf2f8', shopText: '#be185d',// è‡ªè¨‚è³¼ç‰©é¡è‰²
                            active: '#2d3748',// è‡ªè¨‚è¡Œç¨‹é¸å–é¡è‰²
                            move: '#f3f4f6'// è‡ªè¨‚ç§»å‹•ä¸­é¡è‰²
                        }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },// è‡ªè¨‚å­—é«”
                    boxShadow: { 'soft': '0 4px 20px rgba(0, 0, 0, 0.05)', 'card': '0 1px 3px rgba(0,0,0,0.1)' }// è‡ªè¨‚é™°å½±
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        /* éš±è—æ»¾å‹•æ¢ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Tab å…§å®¹åˆ‡æ› */
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; animation: fadeIn 0.25s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ */
        .timeline-line::before { content: ''; position: absolute; top: 16px; bottom: -16px; left: 18px; width: 2px; background: #e5e5e5; z-index: 0; }
        .timeline-line:last-child::before { display: none; }
        .timeline-line.type-move::before { border-left: 2px dashed #cbd5e1; background: transparent; width: 0; }
        /* æ¨™ç±¤æ¨£å¼ */
        .tag-must-eat { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .tag-must-buy { background-color: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; }
        .tag-reserve { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-transport { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        /* Event Active äº‹ä»¶ç‹€æ…‹å®šç¾© */
        .event-active { background-color: #2d3748 !important; color: white !important; border-left-color: #a84a32 !important; box-shadow: 0 0 15px rgba(45, 55, 72, 0.3); }
        .event-active h4, .event-active .transport-detail { color: white !important; }
        .event-active span, .event-active p, .event-active i { color: #cbd5e0 !important; }
        /* Pulse Animation è„ˆè¡å‹•ç•«*/
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        /* Floating Action Button æµ®å‹•æŒ‰éˆ•*/
        .fab-btn { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .fab-btn:active { transform: scale(0.9); }
        /* Checklist Item æ¸…å–®é …ç›®*/
        .checklist-item { cursor: pointer; user-select: none; }
        .checklist-item:active { background-color: #f3f4f6; }
        /* Toast Notification å½ˆå‡ºé€šçŸ¥*/
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(45, 55, 72, 0.95); color: white; padding: 12px 20px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; text-align: center; backdrop-filter: blur(4px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: rgba(220, 38, 38, 0.95); }
        .toast.success { background: rgba(22, 163, 74, 0.95); }
        /* Error Input AnimationéŒ¯èª¤è¼¸å…¥å‹•ç•«*/
        .input-error { border-color: #ef4444 !important; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        /* Progress Bar é€²åº¦æ¢*/
        #progress-bar { transition: width 0.3s ease; }
        /* --- æ·±è‰²æ¨¡å¼æ¨™ç±¤å„ªåŒ– --- */
        .dark .tag-must-eat { background-color: rgba(194, 65, 12, 0.2); color: #fdba74; border-color: #9a3412; }
        .dark .tag-must-buy { background-color: rgba(190, 24, 93, 0.2); color: #f9a8d4; border-color: #831843; }
        .dark .tag-reserve { background-color: rgba(133, 77, 14, 0.2); color: #fde047; border-color: #713f12; }
        .dark .tag-transport { background-color: rgba(29, 78, 216, 0.2); color: #93c5fd; border-color: #1e3a8a; }
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ Event Active ç‹€æ…‹å¾®èª¿ */
        .dark .event-active { background-color: #a84a32 !important; border-left-color: #fb923c !important; }
        .dark .event-active h4, .dark .event-active span { color: #fff !important; }
        /* --- æ‹–æ›³æ’åºæ¨£å¼ --- */
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        /* é˜²æ­¢æ‹–æ›³æ™‚é¸å–åˆ°æ–‡å­— */
        .sortable-item { user-select: none; }
        /* æ‹–æ›³ä¸­çš„åŠé€æ˜æ•ˆæœ */
        .sortable-ghost { opacity: 0.4; background: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen flex justify-center overflow-hidden font-sans">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- App Container -->
    <div class="w-full max-w-md h-full bg-muji-bg dark:bg-gray-900 flex flex-col relative shadow-2xl overflow-hidden mx-auto">
        
        <!-- Header -->
        <header class="bg-muji-card px-5 py-4 shadow-sm z-20 flex justify-between items-center shrink-0 border-b border-gray-100 select-none dark:bg-gray-800 dark:border-gray-700">            
            <div>
                <h1 class="text-xl font-serif font-bold text-muji-accent dark:text-stone-200 tracking-widest">HOKKAIDO</h1>
                <p class="text-[10px] text-muji-subtext dark:text-stone-400 tracking-wider uppercase">Winter Trip 2025</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettingsModal()" class="w-8 h-8 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-700 dark:text-gray-100 transition shadow-sm">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="w-8 h-8 bg-muji-accent rounded-full flex items-center justify-center text-white shadow-sm cursor-pointer" onclick="showToast('æ­¡è¿ä¾†åˆ°åŒ—æµ·é“ï¼', 'info')">
                    <i class="fas fa-snowflake animate-pulse"></i>
                </div>
            </div>
        </header>
        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative" id="main-container">
            
            <!-- SECTION: PLAN (è¡Œç¨‹) -->
            <section id="plan" class="tab-content active h-full">
                <div class="flex flex-col h-full p-4 pb-0">
                    <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-3 pb-1" id="date-scroll-container"></div>
                    <div id="plan-weather-card" class="mb-3"></div>
                    <div id="itinerary-list" class="space-y-4 pb-24 flex-1 overflow-y-auto hide-scrollbar pr-1"></div>
                    
                    <button onclick="openEditModal(currentSelectedDayIndex, -1)" class="fab-btn absolute bottom-6 right-4 w-14 h-14 bg-muji-accent text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white">
                        <i class="fas fa-plus text-2xl"></i>
                    </button>
                    <div class="absolute bottom-6 left-4 z-30">
                        <button onclick="resetItinerary()" class="text-[10px] text-gray-300 underline hover:text-red-400 bg-white dark:bg-gray-800/80 px-2 py-1 rounded backdrop-blur-sm">æ¢å¾©é è¨­</button>
                    </div>
                </div>
            </section>

            <!-- SECTION: GUIDE (å°è¦½) -->
            <section id="guide" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-20 overflow-y-auto hide-scrollbar">
                    
                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">æœ­å¹Œæ·±åº¦å°è¦½</h2>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-2 flex items-center"><i class="fas fa-shopping-basket text-blue-500 mr-2"></i>åœ¨åœ°è¶…å¸‚æ–‡åŒ–é«”é©—</h3>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-blue-100 dark:border-blue-900/50 mb-6">
                        <p class="text-xs text-gray-500 mb-4 leading-relaxed">é«”é©—æ—¥æœ¬åœ¨åœ°ç”Ÿæ´»æœ€å¥½çš„æ–¹å¼å°±æ˜¯é€›è¶…å¸‚ï¼ä»¥ä¸‹æ¨è–¦è·é›¢æ‚¨ä½å®¿ï¼ˆä¸­å³¶å…¬åœ’ï¼‰èˆ‡ç‹¸å°è·¯è¡Œç¨‹é †è·¯çš„è¶…å¸‚ã€‚</p>
                        <div class="space-y-5">
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-100 dark:text-gray-200">ğŸ“ é£¯åº—å‘¨é‚Š (ä¸­å³¶å…¬åœ’)</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-blue-600 dark:text-blue-400 dark:text-blue-300">MaxValu å—7æ¡åº—</span><p class="text-[10px] text-gray-500">24å°æ™‚ç‡Ÿæ¥­ï¼Œè¦æ¨¡ä¸­ç­‰ä½†æ‡‰æœ‰ç›¡æœ‰ã€‚</p></div>
                                    <div><span class="text-xs font-bold text-orange-500">Seicomart</span><p class="text-[10px] text-gray-500">åŒ—æµ·é“æœ€å¼·è¶…å•†ï¼Œå¿…åƒ Hot Chef ç†Ÿé£Ÿã€‚</p></div>
                                </div>
                            </div>
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-100">ğŸ“ ç‹¸å°è·¯å‘¨é‚Š</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-yellow-600">MEGA å”å‰è»»å¾·</span><p class="text-[10px] text-gray-500">B1/B2 ç”Ÿé®®è¶…å¸‚å€éå¸¸å¼·å¤§ï¼</p></div>
                                    <div><span class="text-xs font-bold text-green-600">æ¥­å‹™è¶…å¸‚</span><p class="text-[10px] text-gray-500">ä»¥å¤§ä»½é‡ã€è¶…ä½åƒ¹èåã€‚</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>æœ­å¹Œç§æˆ¿å‚™æ¡ˆ</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">è—»å²©å±±å¤œæ™¯</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">æ–°ä¸‰å¤§å¤œæ™¯</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">å¦‚æœå¤©æ°£å¥½ï¼Œé€™è£¡çš„å¤œæ™¯æ¯”é›»è¦–å¡”æ›´å£¯è§€ï¼æ­ä¹˜çºœè»Šä¸Šå±±ï¼Œä¿¯ç°æ•´å€‹æœ­å¹Œå¸‚çš„å¯¶çŸ³èˆ¬ç‡ˆç«ã€‚</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Mt.+Moiwa+Ropeway" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">ç™½è‰²æˆ€äººå…¬åœ’</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">ç«¥è©±å·¥å» </span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">åƒæ˜¯èµ°é€²æŸ¥ç†çš„å·§å…‹åŠ›å·¥å» ï¼å¯ä»¥åƒè§€é¤…ä¹¾ç”Ÿç”¢ç·šï¼Œå†¬å¤©é‚„æœ‰æˆ¶å¤–ç‡ˆé£¾ã€‚</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">æ‹‰éºµä¿¡ç„ (å—6æ¡åº—)</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">æ’éšŠååº—</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">åœ¨åœ°äººæ¨è–¦çš„å‘³å™Œæ‹‰éºµï¼Œå°±åœ¨é£¯åº—é™„è¿‘ï¼Œé©åˆç•¶å®µå¤œï¼</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Ramen+Shingen+Minami+6-jo" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    </div>

                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">å°æ¨½ï¼å ºç”ºé€šæ·±åº¦å°è¦½</h2>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>æ®¿å ‚ç´šç”œé» (ä¸€ç´šæˆ°å€)</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">LeTAO æœ¬åº—</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">ç”œé»ç‹è€…</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">å°æ¨½çš„ç”œé»ç‹è€…ã€‚å¿…åƒé›™å±¤ä¹³é…ªè›‹ç³• (Double Fromage) èˆ‡æœ¬åº—é™å®šç”Ÿä¹³æ²ã€‚äºŒæ¨“ Cafe æ°£æ°›æ¥µä½³ã€‚</p>
                            <a href="https://maps.app.goo.gl/54aXLQnse6L5XZg87" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">åŒ—è“æ¨“ å°æ¨½æœ¬é¤¨ </h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">çŸ³é€ å€‰åº«</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">å…§éƒ¨å……æ»¿æ­·å²æ„Ÿã€‚å¿…åƒã€Œå¤¢ä¸æ€è­°ã€å¤§æ³¡èŠ™ï¼Œå¤–çš®é…¥è„†å…§é¤¡çˆ†æ¼¿ï¼ŒCPå€¼è¶…é«˜ï¼å¦–ç²¾ä¹‹æ£®å¹´è¼ªè›‹ç³•ä¹Ÿæ˜¯æ‹›ç‰Œã€‚</p>
                            <a href="https://maps.app.goo.gl/Xp6VTXTAbiNfM2H26" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">å…­èŠ±äº­ å°æ¨½é‹æ²³åº—</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">è²·ç”œé»é€å’–å•¡</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">å°±åœ¨åŒ—è“æ¨“éš”å£ã€‚å¿…è²·è˜­å§†è‘¡è„å¥¶æ²¹å¤¾å¿ƒé¤…ä¹¾ï¼Œæœ‰å–®åŒ…è£å¯æŒ‘é¸ã€‚äºŒæ¨“è³¼ç‰©æ»¿é¡å¸¸æœ‰è¶…ä¾¿å®œæˆ–å…è²»å’–å•¡</p>
                            <a href="https://maps.app.goo.gl/fwqHMy3mo1ULhRRY8" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>ç‰¹è‰²IP èˆ‡æ•£æ­¥ç¾é£Ÿ</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">ã‹ã¾æ „ å·¥å ´ç›´ç‡Ÿåº— (Kamaei)</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">éºµåŒ…æ²</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">é€™æ˜¯å°æ¨½ç•¶åœ°äººä¹Ÿæ„›çš„é­šæ¿è€åº—ï¼é›–ç„¶ç¨å¾®åé›¢å ºç”ºé€šå°¾ç«¯ã‡é»é»ï¼ˆé è¿‘é‹æ²³æœ«ç«¯ï¼‰ï¼Œä½†éå¸¸å€¼å¾—èµ°éå»ã€‚</p>
                            <a href="https://maps.app.goo.gl/3J1EwY88hqdqmryR9" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">æ˜†å¸ƒå°ˆé–€åº— åˆ©å°»å±‹ Minoya</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">æ¹¯éœœæ˜†å¸ƒ</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">é–€å£æ‹›ç‰Œå¯«è‘—ã€Œçˆ¸çˆ¸å¦‚æœä¸è²·ï¼Œå°±æ˜¯åª½åª½çš„ä¸å°ï¼ˆãŠçˆ¶ã•ã‚“é ã‹ã‚Šã¾ã™ï¼‰ã€ï¼Œéå¸¸å¹½é»˜çš„åº—å®¶ã€‚</p>
                            <a href="https://maps.app.goo.gl/jBdJE7QKRcwz926G6" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-green-500 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 dark:text-gray-100 text-sm"><i class="fas fa-map mr-2 text-green-500"></i>å°æ¨½å ºç”ºé€šã‚Šå•†åº—è¡—</h3>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1 font-bold">å‰ä¼Šå¡å“‡é¢¨æ ¼åº—å®¶åˆ†å¸ƒåœ–</p>
                            <img src="Otaru.jpg" 
                                 onerror="this.src='https://placehold.co/600x400?text=Otaru+Map'" 
                                 class="w-full rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" 
                                 onclick="openImageModal(this.src)">

                        </div>
                    </div>
                           

                </div>
            </section>
            <!-- SECTION: WALLET (éŒ¢åŒ…) -->
            <section id="wallet" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-20 overflow-y-auto hide-scrollbar">
                    
                    <!-- ç²¾ç·»ç‰ˆåŒ¯ç‡å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-stone-600 to-stone-700 text-white p-3 rounded-xl shadow-lg mb-4 shrink-0 relative overflow-hidden">
                        <div class="flex justify-between items-center mb-1 opacity-90">
                            <div class="flex flex-col">
                                <h3 class="text-[10px] uppercase tracking-widest font-bold text-stone-200">åŒ¯ç‡æ›ç®—</h3>
                                <span id="rate-update-time" class="text-[8px] text-stone-300">æ›´æ–°ä¸­...</span>
                            </div>
                            <div class="text-[10px] bg-white dark:bg-black/30 px-2 py-0.5 rounded flex items-center gap-1 shadow-sm">
                                <span class="mr-1 text-stone-400 dark:text-stone-500">x</span>
                                <input type="number" id="exchange-rate" value="0.22" class="w-12 bg-transparent text-center focus:outline-none font-mono font-bold text-stone-700 dark:text-yellow-300" step="0.0001" inputmode="decimal" onfocus="this.select()">
                                
                                <button onclick="fetchExchangeRate(true)" class="ml-1 w-4 h-4 flex items-center justify-center bg-gray-100 dark:bg-white/10 rounded-full hover:bg-gray-200 dark:hover:bg-white/20 transition">
                                    <i class="fas fa-sync-alt text-[8px] text-stone-500 dark:text-stone-300"></i>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-end gap-2 justify-between">
                            <div class="flex-1">
                                <div class="flex items-baseline border-b border-white/20 pb-1">
                                    <span class="text-xs opacity-60 mr-2 text-stone-300">JPY</span>
                                    <input type="number" id="jpy-input" placeholder="0" class="w-full bg-transparent text-xl font-mono font-bold focus:outline-none placeholder-white/20 text-white" inputmode="decimal" onfocus="this.select()">
                                </div>
                            </div>
                            <div class="text-white/30 pb-1"><i class="fas fa-arrow-right text-xs"></i></div>
                            <div class="flex-1 text-right">
                                <div class="border-b border-white/20 pb-1">
                                    <div id="twd-output" class="text-2xl font-mono font-bold text-yellow-300 leading-none">0</div>
                                </div>
                            </div>
                            <span class="text-xs opacity-60 pb-1 text-stone-300">TWD</span>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-card mb-6 shrink-0">
                        <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 text-sm flex justify-between">
                            <span>æ–°å¢è¨˜å¸³ <span class="text-[10px] text-gray-400 font-normal">(é–å®šåŒ¯ç‡)</span></span>
                            <!-- æ–°å¢æ—¥æœŸæ¬„ä½ -->
                            <input type="date" id="expense-date" class="text-[10px] border border-gray-200 rounded px-1 text-gray-500 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                        </h3>
                        <div class="flex gap-2 mb-3">
                            <select id="expense-payer" class="w-20 px-1 py-2 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent"><option value="å°æˆ´">å°æˆ´</option><option value="ä½³æ¬£">ä½³æ¬£</option><option value="ä½³è±">ä½³è±</option><option value="çŸå»·">çŸå»·</option></select>
                            <select id="expense-type" class="w-20 px-1 py-2 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent ml-1 text-gray-600 dark:text-gray-300 font-bold">
                                <option value="split">å…¬è²»</option>
                                <option value="private">ç§è²»</option>
                            </select>
                            <input type="text" id="expense-item" placeholder="å“é …åç¨±" class="flex-1 px-3 py-2 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent">
                        </div>
                        <div class="flex gap-2 mb-3"><input type="number" id="expense-price" placeholder="é‡‘é¡ (æ—¥å¹£)" class="flex-1 px-3 py-2 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent" onfocus="this.select()"></div>
                        <div class="flex gap-2">
                             <label class="flex-1 flex items-center justify-center px-4 py-2 bg-gray-100 dark:bg-gray-900 text-gray-500 rounded-lg cursor-pointer hover:bg-gray-200 transition text-sm"><i class="fas fa-camera mr-2"></i> <span id="photo-label">æ‹ç…§</span><input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="document.getElementById('photo-label').innerText = 'å·²é¸æ“‡'"></label>
                            <button onclick="addExpense()" class="flex-1 bg-muji-accent text-white py-2 rounded-lg shadow-sm hover:opacity-90 transition text-sm font-medium"><i class="fas fa-plus mr-1"></i> å„²å­˜</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-2 px-1 shrink-0"><h3 class="font-bold text-gray-600 dark:text-gray-300 text-sm">æ”¯å‡ºç´€éŒ„</h3><div class="flex items-center gap-2"><button onclick="openSplitBillModal()" class="text-xs bg-white dark:bg-gray-800 text-muji-accent border border-muji-accent px-2 py-1 rounded hover:bg-muji-accent hover:text-white transition"><i class="fas fa-calculator mr-1"></i>æŸ¥çœ‹åˆ†å¸³</button><span id="total-expense" class="text-xs font-mono font-bold text-muji-accent">Total: Â¥0</span></div></div>
                    <div class="space-y-3 pb-8 flex-1" id="expense-list"></div>
                    <div class="flex flex-col gap-3 mt-2">
                        <div class="flex justify-center gap-4 text-[10px] text-gray-300">
                            <button onclick="exportData()" class="hover:text-gray-500 transition">åŒ¯å‡ºç´”æ–‡å­— (TXT)</button>
                            <span class="text-gray-200">|</span>
                            <button onclick="clearExpenses()" class="hover:text-red-300 transition">æ¸…é™¤è¨˜å¸³</button>
                        </div>
                </div>
            </section>

            <!-- SECTION: LISTS (æ¸…å–®) -->
            <section id="lists" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-0">
                <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4 shrink-0 border border-gray-200 dark:border-gray-700 transition-colors">
                    <button id="btn-checklist" onclick="toggleListTab('checklist')" class="flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-emerald-600 dark:text-emerald-400">
                        <i class="fas fa-clipboard-check mr-1"></i> è¡Œå‰æº–å‚™
                    </button>
                    
                    <button id="btn-shopping" onclick="toggleListTab('shopping')" class="flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-medium text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-shopping-cart mr-1"></i> å¿…è²·æ¸…å–®
                    </button>
                </div>
                    <div id="view-checklist" class="flex-1 overflow-y-auto hide-scrollbar pb-24">
                         <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card overflow-hidden mb-4">
                            <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-500">æº–å‚™é€²åº¦</span>
                                <div class="flex items-center gap-2"><div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div></div><span id="progress-text" class="text-xs font-mono text-gray-600 dark:text-gray-300">0%</span></div>
                            </div>
                            <div id="checklist-groups" class="p-3 space-y-4"></div>
                            <div class="p-3 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                                <button onclick="openAddCategoryModal()" class="w-full py-2 border border-dashed border-gray-300 rounded text-gray-400 text-xs hover:border-muji-accent hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> æ–°å¢åˆ†é¡</button>
                            </div>
                        </div>
                    </div>
                    <div id="view-shopping" class="hidden flex-1 flex flex-col h-full overflow-hidden relative">
                        <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar shrink-0 items-center" id="shopping-filter-container"></div>
                        <div id="shopping-container" class="flex-1 overflow-y-auto hide-scrollbar space-y-3 pb-24"></div>
                        <button onclick="openShoppingModal(null)" class="fab-btn absolute bottom-24 right-4 w-14 h-14 bg-muji-shopText text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white">
                            <i class="fas fa-plus text-2xl"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SECTION: INFO æ—…éŠè³‡è¨Š-->
            <section id="info" class="tab-content h-full">
                <div class="flex flex-col h-full p-3 pb-16 overflow-y-auto hide-scrollbar">
                    
                    <div class="flex items-center gap-2 mb-2 px-1 shrink-0">
                        <i class="fas fa-ticket-alt text-muji-accent text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">æ©Ÿç¥¨</h2>
                    </div>
                        
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card overflow-hidden mb-1 relative shrink-0">
                        <div class="absolute top-[70%] -left-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        <div class="absolute top-[70%] -right-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        
                        <div class="p-4 pb-2">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="bg-muji-accent text-white text-[10px] px-2 py-0.5 rounded font-bold tracking-wider">å»ç¨‹</span>
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400">12/18 (å››)</span>
                                </div>
                                <i class="fas fa-plane-departure text-gray-300"></i>
                            </div>
                            
                            <div class="flex justify-between items-center mb-1">
                                <div>
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">06:15</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">TPE å°åŒ—</div>
                                </div>
                                <div class="flex-1 px-2 flex flex-col items-center">
                                    <span class="text-[9px] text-gray-400 mb-0.5">3h 45m</span>
                                    <div class="w-full h-[1px] bg-gray-300 relative">
                                        <div class="absolute right-0 -top-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                                    </div>
                                    <span class="text-[10px] text-muji-accent font-bold mt-0.5">BR166</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">11:00</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">CTS æœ­å¹Œ</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center bg-gray-50 dark:bg-stone-900 p-1.5 rounded-lg border border-gray-100 dark:border-stone-700">
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">æ©Ÿå‹</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">A321</div>
                                </div>
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">åº§ä½</div>
                                    <div class="text-[10px] font-bold text-muji-accent">29 A-D</div>
                                </div>
                                <div class="text-center w-1/3">
                                    <div class="text-[9px] text-gray-400">èˆªå»ˆ</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">T2</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card overflow-hidden mb-1 relative shrink-0 opacity-95 hover:opacity-100 transition">
                        <div class="absolute top-[64%] -left-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        <div class="absolute top-[64%] -right-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        
                        <div class="p-4 pb-2">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="bg-gray-500 text-white text-[10px] px-2 py-0.5 rounded font-bold tracking-wider">å›ç¨‹</span>
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400">12/23 (äºŒ)</span>
                                </div>
                                <i class="fas fa-plane-arrival text-gray-300"></i>
                            </div>
                            
                            <div class="flex justify-between items-center mb-1">
                                <div>
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">15:20</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">CTS æœ­å¹Œ</div>
                                </div>
                                <div class="flex-1 px-2 flex flex-col items-center">
                                    <span class="text-[9px] text-gray-400 mb-0.5">4h 45m</span>
                                    <div class="w-full h-[1px] bg-gray-300 relative">
                                        <div class="absolute left-0 -top-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-bold mt-0.5">BR115</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">19:05</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">TPE å°åŒ—</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center bg-gray-50 dark:bg-stone-900 p-1.5 rounded-lg border border-gray-100 dark:border-stone-700">
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">æ©Ÿå‹</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">787-10</div>
                                </div>
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">åº§ä½</div>
                                    <div class="text-[10px] font-bold text-muji-accent">29 F-K</div>
                                </div>
                                <div class="text-center w-1/3">
                                    <div class="text-[9px] text-gray-400">èˆªå»ˆ</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">åœ‹éš›ç·š</div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-2 bg-gray-50 dark:bg-black/40">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-1.5" title="è¨—é‹: 2ä»¶/äºº (å„23kg)">
                                    <i class="fas fa-suitcase-rolling text-gray-400 text-xs"></i>
                                    <div class="flex flex-col">
                                        <span class="text-[9px] font-bold text-gray-500 dark:text-gray-400 leading-none">è¨—é‹ 2ä»¶(23kg)</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1.5" title="éš¨èº«: 7kg">
                                    <i class="fas fa-briefcase text-gray-400 text-xs"></i>
                                    <div class="flex flex-col">
                                        <span class="text-[9px] font-bold text-gray-500 dark:text-gray-400 leading-none">éš¨èº« 7kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                <span class="text-xs font-bold text-muji-highlight font-mono">NT$ 28,780/äºº</span>
                                    </div>
                            </div>
                        </div>

                    </div>                    
                    <div class="flex items-center gap-2 mb-2 px-1 mt-2 shrink-0">
                        <i class="fas fa-hotel text-indigo-400 text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">ä½å®¿è³‡è¨Š</h2>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-card mb-4 border-l-4 border-indigo-400 shrink-0">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-base text-gray-800 dark:text-gray-100 leading-tight">æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—</h4>
                                <p class="text-[10px] text-gray-400 mt-1">Hotel JAL City Sapporo Nakajima Park</p>
                            </div>
                            <a href="https://maps.app.goo.gl/somelink" target="_blank" class="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/40 text-indigo-500 flex items-center justify-center hover:bg-indigo-100 transition shadow-sm">
                                <i class="fas fa-location-arrow text-xs"></i>
                            </a>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-2 rounded-lg text-center border border-indigo-100 dark:border-indigo-900/50">
                                <div class="text-[10px] text-indigo-400 mb-1 font-bold">CHECK-IN</div>
                                <div class="text-xl font-bold text-indigo-600 dark:text-indigo-300 font-mono">12/18 15:00</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-stone-900 p-2 rounded-lg text-center border border-gray-100 dark:border-stone-700">
                                <div class="text-[10px] text-gray-400 mb-1 font-bold">CHECK-OUT</div>
                                <div class="text-xl font-bold text-gray-600 dark:text-gray-300 font-mono">12/23 11:00</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded border border-gray-200">
                                <p class="text-xs text-gray-400 mb-1 flex justify-between">
                                    <span>æ—¥æ–‡åœ°å€</span>
                                    <span class="text-[9px] bg-gray-200 dark:bg-gray-700 px-1 rounded text-gray-500">é•·æŒ‰è¤‡è£½</span>
                                </p>
                                <p class="text-base font-bold text-gray-800 dark:text-gray-100 leading-relaxed select-all">ã€’064-0808 <br>åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºå—ï¼˜æ¡è¥¿ï¼“ä¸ç›®ï¼‘âˆ’ï¼’ï¼•</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-4 px-1 mt-2 shrink-0">
                         <i class="fas fa-shield-alt text-red-400 text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">ç·Šæ€¥å”åŠ©</h2>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-card mb-4 border-l-4 border-red-500 shrink-0">
                        <div class="space-y-3">
                             <div><p class="text-xs text-gray-500 mb-1 font-bold">å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•æœ­å¹Œåˆ†è™•</p>
                                <div class="flex items-center justify-between bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-100 dark:border-red-900/30">
                                    <a href="tel:+81112222930" class="text-lg font-bold text-red-600 dark:text-red-400 font-mono">
                                    <i class="fas fa-phone mr-2"></i>+81-11-222-2930</a>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-2">åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€åŒ—4æ¢è¥¿4ä¸ç›®1ç•ªåœ° ä¼Šè—¤å¤§æ¨“5æ¨“</p>
                            </div>
                        </div>
                    </div>
                    <!-- Transportation Maps äº¤é€šè·¯ç·š -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-card mb-4 border-l-4 border-green-500 shrink-0">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 dark:text-gray-100 text-sm">
                                <i class="fas fa-map mr-2 text-green-500"></i>äº¤é€šè·¯ç·šåœ–</h3>
                        </div>
                        <div class="space-y-3">
                            <div><p class="text-xs text-gray-500 mb-1 font-bold">æœ­å¹Œåœ°éµè·¯ç·šåœ–</p>
                                <img src="route_map_h_t.jpg" onerror="this.src='https://placehold.co/600x400?text=Subway+Map'" class="w-full rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" onclick="openImageModal(this.src)"></div>
                            <div><p class="text-xs text-gray-500 mb-1 font-bold">JR åŒ—æµ·é“è¿‘éƒŠè·¯ç·šåœ–</p>
                                <img src="route_map_sapporo.jpg" onerror="this.src='https://placehold.co/600x400?text=JR+Map'" class="w-full rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" onclick="openImageModal(this.src)"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6 shrink-0">
                        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition border border-blue-100 dark:border-blue-900/30">
                            <i class="fas fa-cloud-sun text-2xl text-blue-400 dark:text-blue-300"></i>
                            <span class="text-xs font-bold text-gray-600 dark:text-gray-300">å¤©æ°£é å ±</span>
                        </a>
                        <a href="tel:119" class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition border border-red-100 dark:border-red-900/30">
                            <i class="fas fa-ambulance text-2xl text-red-400 dark:text-red-300"></i>
                            <span class="text-xs font-bold text-gray-600 dark:text-gray-300">ç·Šæ€¥ 119</span>
                        </a>
                    </div>
                </div>
            </section>

        </main>

        <!-- Navbar å°è¦½åˆ— -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center py-1 px-1 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] z-30 shrink-0 min-h-[60px] select-none pb-safe dark:bg-gray-800 dark:border-gray-700 transition-colors duration-300">
            
            <button class="nav-btn group w-1/5" data-target="info">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-info-circle text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">è³‡è¨Š</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="lists">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-check-square text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">æ¸…å–®</span>
                </div>
            </button>

            <button class="nav-btn active group w-1/5" data-target="plan">
                <div class="flex flex-col items-center gap-0.5 transition-all">
                    <div class="w-11 h-9 rounded-2xl flex items-center justify-center shadow-sm group-[.active]:shadow-md group-[.active]:scale-105 transition-all duration-300 bg-gray-200 group-[.active]:bg-muji-accent dark:bg-gray-700 dark:group-[.active]:bg-gray-600">
                        <i class="fas fa-map-marked-alt text-lg text-gray-400 group-[.active]:text-white dark:text-gray-400 dark:group-[.active]:text-gray-50 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent group-[.active]:font-bold dark:group-[.active]:text-gray-200 transition-colors">è¡Œç¨‹</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="wallet">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-wallet text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">éŒ¢åŒ…</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="guide">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-book-reader text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">å°è¦½</span>
                </div>
            </button>
        </nav>
        <!-- MODALS è¡Œç¨‹è³‡æ–™å¡ -->
        <div id="view-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden opacity-0 transition-opacity flex items-end sm:items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-sm max-h-[85vh] overflow-hidden transform translate-y-full sm:translate-y-0 sm:scale-95 transition-transform duration-300 flex flex-col">
                <div class="h-32 bg-gray-200 relative shrink-0">
                    <img id="view-img" src="" class="w-full h-full object-cover">
                    <button onclick="closeViewModal()" class="absolute top-3 right-3 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur-sm hover:bg-black/50 transition">
                    <i class="fas fa-times"></i>
                    </button>
                    <button onclick="switchToEdit()" class="absolute top-3 right-12 w-8 h-8 bg-white dark:bg-gray-800/90 rounded-full text-gray-600 dark:text-gray-300 flex items-center justify-center shadow-sm hover:text-muji-accent transition">
                    <i class="fas fa-pen text-xs"></i></button>
                </div>
                <div class="p-5 overflow-y-auto">
                <div class="flex justify-between items-start mb-3"><h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 leading-tight" id="view-title">æ¨™é¡Œ</h3>
                    <span class="text-xs bg-gray-100 dark:bg-gray-900 text-gray-500 px-2 py-1 rounded" id="view-type">é¡å‹</span></div>
                <div class="flex items-center text-sm text-gray-500 mb-4 font-mono">
                    <i class="far fa-clock mr-2 text-muji-accent"></i>
                    <span id="view-time">00:00</span>
                </div>
                <div class="mb-4">
                    <h4 class="text-xs font-bold text-muji-accent uppercase tracking-wider mb-2 border-b pb-1">ä»‹ç´¹ & æ•…äº‹</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed text-justify" id="view-story">æš«ç„¡ä»‹ç´¹...</p>
                </div>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <h4 class="text-xs font-bold text-yellow-700 mb-2 flex items-center">
                    <i class="fas fa-lightbulb mr-2"></i>æ”»ç•¥ & æ¨è–¦</h4>
                    <p class="text-sm text-yellow-800 leading-relaxed" id="view-tips">æš«ç„¡æ”»ç•¥...</p>
                </div>
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">å‚™è¨»</h4>
                    <p class="text-sm text-gray-500" id="view-note">-</p>
                </div>
                <a href="#" id="view-map-btn" target="_blank" class="block w-full bg-muji-accent text-white text-center py-3 rounded-lg font-bold shadow-md hover:opacity-90 transition">
                <i class="fas fa-location-arrow mr-2"></i> é–‹å•Ÿ Google Maps</a>
                </div>
            </div>
        </div>
        
        <!-- EDIT MODAL æ–°å¢è¡Œç¨‹å¡ç‰‡-->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100" id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="bg-gray-50 dark:bg-stone-900/50 p-3 rounded-lg border border-gray-100 dark:border-stone-700 mb-2">
                        <div class="flex items-end gap-3 mb-3">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                                <input type="time" id="edit-start" oninput="syncTime('start')" class="w-full p-2 border border-gray-200 rounded text-base bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:border-muji-accent focus:outline-none shadow-sm">
                            </div>
                            <div class="pb-3 text-gray-300 dark:text-gray-600">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                                <input type="time" id="edit-end" oninput="syncTime('end')" class="w-full p-2 border border-gray-200 rounded text-base bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:border-muji-accent focus:outline-none shadow-sm">
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-200 dark:border-stone-700">
                            <label class="text-xs font-bold text-gray-400 shrink-0 mr-1">é è¨ˆåœç•™</label>
                            <div class="flex-1 flex items-center gap-2">
                                <div class="relative flex-1">
                                    <input type="number" id="edit-duration-h" oninput="syncTime('duration')" placeholder="0" min="0" class="w-full p-1.5 pl-2 pr-6 border border-gray-200 rounded text-sm text-center font-mono font-bold text-muji-accent dark:text-muji-accent bg-white dark:bg-stone-800 dark:border-stone-600 focus:border-muji-accent focus:outline-none">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 leading-5 pointer-events-none">H</span>
                                </div>
                                <span class="text-gray-300 font-bold">:</span>
                                <div class="relative flex-1">
                                    <input type="number" id="edit-duration-m" oninput="syncTime('duration')" placeholder="0" min="0" max="59" class="w-full p-1.5 pl-2 pr-6 border border-gray-200 rounded text-sm text-center font-mono font-bold text-muji-accent dark:text-muji-accent bg-white dark:bg-stone-800 dark:border-stone-600 focus:border-muji-accent focus:outline-none">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 leading-5 pointer-events-none">M</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label><select id="edit-type" class="w-full p-2 border border-gray-200 rounded text-sm"><option value="move">äº¤é€šç§»å‹• (è»Šç¨‹)</option><option value="spot">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shop">è³¼ç‰©</option><option value="transport">äº¤é€š (è»Šç«™/æ©Ÿå ´)</option><option value="stay">ä½å®¿</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">æ¨™é¡Œ <span class="text-red-500">*</span></label><input type="text" id="edit-title" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="å¿…å¡«"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨»</label><textarea id="edit-note" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">äº¤é€š</label><input type="text" id="edit-station" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">æ¨™ç±¤</label><input type="text" id="edit-tags" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
                    <div class="text-[10px] text-gray-400 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded">ğŸ’¡ æç¤ºï¼šä¿®æ”¹çµæŸæ™‚é–“å¾Œï¼Œå¾ŒçºŒçš„äº¤é€šèˆ‡è¡Œç¨‹æ™‚é–“æœƒè‡ªå‹•é †å»¶ã€‚</div>
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="deleteEvent()" id="btn-delete" class="px-4 py-2 bg-red-50 text-red-500 rounded text-sm hidden">åˆªé™¤</button>
                    <button type="button" onclick="saveEvent()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- EXPENSE EDIT MODAL æ–°å¢è¨˜å¸³å¡ç‰‡-->
        <div id="expense-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">ç·¨è¼¯æ”¯å‡º</h3>
                    <button type="button" onclick="closeExpenseEditModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="flex gap-2">
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="edit-expense-payer" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                                <option value="å°æˆ´">å°æˆ´</option>
                                <option value="ä½³æ¬£">ä½³æ¬£</option>
                                <option value="ä½³è±">ä½³è±</option>
                                <option value="çŸå»·">çŸå»·</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label>
                            <select id="edit-expense-type" class="w-full p-2 border border-gray-200 rounded text-sm font-bold text-gray-600 dark:text-gray-300 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                                <option value="split">å…¬è²» (åˆ†å¸³)</option>
                                <option value="private">ç§è²» (å€‹äºº)</option>
                            </select>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å“é …</label><input type="text" id="edit-expense-item" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="edit-expense-date" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥å¹£é‡‘é¡ <span class="text-red-500">*</span></label><input type="number" id="edit-expense-price" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" oninput="calcTwdInEdit()" placeholder="0" onfocus="this.select()"></div>
                        <div><label class="block text-xs font-bold text-gray-500 mb-1">ç•¶æ™‚åŒ¯ç‡</label><input type="number" id="edit-expense-rate" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" step="0.0001" oninput="calcTwdInEdit()" onfocus="this.select()"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å°å¹£é‡‘é¡ (å¯å¾®èª¿)</label><input type="number" id="edit-expense-twd" class="w-full p-2 border border-gray-200 rounded text-sm font-bold text-muji-accent" oninput="calcRateInEdit()" onfocus="this.select()"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">ç…§ç‰‡</label><input type="file" id="edit-expense-photo" accept="image/*" class="w-full text-xs"></div>
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveExpenseEdit()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
        <!-- SETTINGS MODAL è¨­å®šå¡ç‰‡-->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">ç³»çµ±è¨­å®š</h3>
                    <button type="button" onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-5 space-y-6">
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">å¤–è§€è¨­å®š</h4>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 dark:bg-stone-900 dark:border-stone-700 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dark:border-gray-600">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 dark:bg-gray-600 flex items-center justify-center shadow-sm text-yellow-500 dark:text-gray-300">
                                    <i class="fas fa-moon dark:hidden"></i>
                                    <i class="fas fa-sun hidden dark:inline"></i>
                                </div>
                                <div>
                                    <h5 class="text-sm font-bold text-gray-700 dark:text-gray-100 dark:text-gray-200">æ·±è‰²æ¨¡å¼</h5>
                                    <p class="text-[10px] text-gray-400 dark:text-gray-400">æ¸›è¼•å¤œé–“çœ¼ç›ç–²å‹</p>
                                </div>
                            </div>
                            <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-gray-200 dark:bg-muji-accent">
                                <span class="sr-only">Toggle Dark Mode</span>
                                <span id="dark-mode-toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white dark:bg-gray-800 transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>
                    </div>

                    <div class="border-t border-gray-100 dark:border-gray-700 dark:border-gray-700"></div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">è³‡æ–™å‚™ä»½èˆ‡è½‰ç§»</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportFullBackup()" class="flex flex-col items-center justify-center gap-2 py-3 bg-gray-600 text-white rounded-lg text-xs font-bold shadow-sm hover:bg-gray-700 transition">
                                <i class="fas fa-download text-lg"></i> 
                                <span>ä¸‹è¼‰å‚™ä»½ (JSON)</span>
                            </button>
                            <button onclick="document.getElementById('backup-upload-setting').click()" class="flex flex-col items-center justify-center gap-2 py-3 bg-white dark:bg-gray-800 border border-gray-300 text-gray-700 dark:text-gray-100 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition">
                                <i class="fas fa-upload text-muji-accent text-lg"></i>
                                <span>é‚„åŸå‚™ä»½</span>
                            </button>
                            <input type="file" id="backup-upload-setting" accept=".json" class="hidden" onchange="importFullBackup(this)">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-center">ä¸‹è¼‰çš„ JSON æª”æ¡ˆå¯ç”¨æ–¼æ–°æ‰‹æ©Ÿæˆ–é›»è…¦é‚„åŸå®Œæ•´è¡Œç¨‹ã€‚</p>
                    </div>

                    <div class="border-t border-gray-100 dark:border-gray-700"></div>

                    <div>
                        <h4 class="text-xs font-bold text-red-300 uppercase tracking-wider mb-3">é‡ç½®èˆ‡æ¸…é™¤</h4>
                        <div class="space-y-2">
                            <button onclick="resetItinerary()" class="w-full text-left px-4 py-3 bg-red-50 text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition flex justify-between items-center">
                                <span><i class="fas fa-calendar-times mr-2"></i>æ¢å¾©é è¨­è¡Œç¨‹</span>
                                <i class="fas fa-chevron-right opacity-30"></i>
                            </button>
                            <button onclick="clearExpenses()" class="w-full text-left px-4 py-3 bg-red-50 text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition flex justify-between items-center">
                                <span><i class="fas fa-coins mr-2"></i>æ¸…é™¤æ‰€æœ‰è¨˜å¸³</span>
                                <i class="fas fa-chevron-right opacity-30"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 text-center border-t border-gray-100 dark:border-gray-700">
                    <p class="text-[10px] text-gray-300">App Version 2.0.1</p>
                </div>
            </div>
        </div>
        <!-- SPLIT BILL MODAL åˆ†å¸³çµæœå¡ç‰‡-->
        <div id="split-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">åˆ†å¸³çµæœ</h3>
                    <button type="button" onclick="closeSplitBillModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å„äººä»£å¢Šç¸½é¡ (å°å¹£)</h4>
                        <div id="split-summary" class="space-y-2 text-sm"></div>
                        <div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700 text-right">
                            <span class="text-xs text-gray-400 mr-2">å¹³å‡ï¼š</span>
                            <span id="split-average" class="font-bold text-muji-text"></span>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å»ºè­°çµç®— (å°å¹£)</h4>
                        <div id="split-plan" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SHOPPING MODAL æ–°å¢å¿…è²·å¡ç‰‡-->
        <div id="shopping-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100" id="shopping-modal-title">æ–°å¢å¿…è²·</h3>
                    <button type="button" onclick="closeShoppingModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å•†å“åç¨±<span class="text-red-500">*</span></label>
                        <input type="text" id="shop-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="å¿…å¡«">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label>
                        <select id="shop-type" class="w-full p-2 border border-gray-200 rounded text-sm">
                            <option value="drug">è—¥å¦ä¿å¥</option>
                            <option value="souvenir">ä¼´æ‰‹ç¦®</option>
                            <option value="other">å…¶ä»–/é›»å™¨</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (è¦æ ¼/æ•¸é‡)</label>
                        <textarea id="shop-desc" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡</label>
                        <input type="file" id="shop-photo" accept="image/*" class="w-full text-xs">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveShoppingItem()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜</button>
                </div>
            </div>
        </div>
        <div id="add-shop-cat-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">æ–°å¢å¿…è²·åˆ†é¡</h3>
                    <button type="button" onclick="closeAddShopCatModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡åç¨±</label>
                    <input type="text" id="new-shop-cat-name" class="w-full p-2 border border-gray-200 rounded text-sm bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:outline-none focus:border-muji-accent" placeholder="ä¾‹å¦‚ï¼šé›¶é£Ÿã€é›»å™¨...">
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveNewShopCat()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">æ–°å¢</button>
                </div>
            </div>
        </div>
        <!-- ADD CATEGORY MODAL æ–°å¢åˆ†é¡å¡ç‰‡(è¡Œå‰æº–å‚™)-->
        <div id="add-category-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">æ–°å¢åˆ†é¡</h3>
                    <button type="button" onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <input type="text" id="new-category-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="åˆ†é¡åç¨±">
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveNewCategory()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">æ–°å¢</button>
                </div>
            </div>
        </div>
        
        <!-- CONFIRM MODAL (Unified) -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xs p-5 text-center transform scale-95 transition-transform duration-200" id="confirm-box">
                <h3 class="font-bold text-gray-700 dark:text-gray-100 text-lg mb-2">ç¢ºèªæ“ä½œ</h3>
                <p class="text-sm text-gray-500 mb-6" id="confirm-msg">æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3 justify-center">
                    <button type="button" onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition">å–æ¶ˆ</button>
                    <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition shadow-sm">ç¢ºèª</button>
                </div>
            </div>
        </div>
        
        <!-- IMAGE VIEWER åœ–ç‰‡ç¸®æ”¾å¡ç‰‡-->
        <div id="image-view-modal" class="fixed inset-0 z-[80] hidden overflow-hidden">
            <div class="absolute inset-0 bg-black/95 transition-opacity" onclick="closeImageModal()"></div>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="relative w-full h-full flex items-center justify-center overflow-hidden">
                    <img id="image-view-src" src="" class="max-w-full max-h-full object-contain pointer-events-auto cursor-grab transition-transform duration-100 origin-center select-none" draggable="false">
                </div>
            </div>
            <button onclick="closeImageModal()" class="absolute top-6 right-6 w-10 h-10 bg-white dark:bg-gray-800/20 rounded-full text-white flex items-center justify-center hover:bg-white dark:bg-gray-800/40 transition z-50 backdrop-blur-md">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
                <span class="bg-black/50 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm">é›™æŒ‡ç¸®æ”¾</span>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    // --- è¨­å®šè¦–çª—æ§åˆ¶ ---
        function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
    // --- ç³»çµ±å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ ---

        // 1. åŒ¯å‡ºå®Œæ•´å‚™ä»½ (JSON)
        function exportFullBackup() {
            const data = {
                meta: {
                    version: "2.0",
                    date: new Date().toISOString(),
                    app: "Hokkaido_Trip_2025"
                },
                itinerary: JSON.parse(localStorage.getItem('hk_itinerary_v20') || '[]'),
                wallet: JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'),
                shopping: JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'),
                checklist: JSON.parse(localStorage.getItem('hk_checks_v20') || '[]'),
                rate: localStorage.getItem('hk_rate_v1') || '0.22'
            };

            const fileName = `Hokkaido_FullBackup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
        }

        // 2. è§¸ç™¼é‚„åŸ (è®€å–æª”æ¡ˆ)
        function importFullBackup(input) {
            const file = input.files[0];
            if (!file) return;

            // æ¸…ç©º input è®“åŒå€‹æª”æ¡ˆå¯ä»¥é‡è¤‡é¸å–
            input.value = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // ç°¡å–®é©—è­‰æª”æ¡ˆæ ¼å¼
                    if (!data.meta || data.meta.app !== "Hokkaido_Trip_2025") {
                        showToast('éŒ¯èª¤ï¼šé€™ä¸æ˜¯æœ¬ App çš„å‚™ä»½æª”', 'error');
                        return;
                    }

                    // å°‡è®€åˆ°çš„è³‡æ–™æš«å­˜åˆ°å…¨åŸŸè®Šæ•¸ï¼Œç­‰å¾…ä½¿ç”¨è€…ç¢ºèª
                    window.tempRestoreData = data;

                    // è·³å‡ºç¢ºèªè¦–çª—
                    deleteTarget = 'system-restore';
                    document.getElementById('confirm-msg').innerHTML = "è­¦å‘Šï¼šæ­¤å‹•ä½œå°‡<b>è¦†è“‹</b>æ‚¨ç›®å‰æ‰€æœ‰çš„<br>è¡Œç¨‹ã€è¨˜å¸³èˆ‡æ¸…å–®è³‡æ–™ã€‚<br>ç¢ºå®šè¦é‚„åŸå—ï¼Ÿ";
                    document.getElementById('confirm-modal').classList.remove('hidden');
                    setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);

                } catch (err) {
                    console.error(err);
                    showToast('æª”æ¡ˆè®€å–å¤±æ•—', 'error');
                }
            };
            reader.readAsText(file);
        }
    // --- IMAGE ZOOM & PAN LOGIC åœ–ç‰‡æ”¯æ´é›™æŒ‡ç¸®æ”¾ ---
        let imgScale = 1;
        let imgPosX = 0;
        let imgPosY = 0;
        let isDragging = false;
        let startX = 0, startY = 0;
        // é›™æŒ‡ç¸®æ”¾å°ˆç”¨è®Šæ•¸
        let initialPinchDist = 0;
        let startScale = 1;

        // é–‹å•Ÿåœ–ç‰‡
        function openImageModal(src) {
            const modal = document.getElementById('image-view-modal');
            const img = document.getElementById('image-view-src');
            
            img.src = src;
            modal.classList.remove('hidden');
            
            // é‡ç½®ç‹€æ…‹
            resetZoom();
            addZoomListeners(img);
        }
        // é—œé–‰åœ–ç‰‡
        function closeImageModal() {
            const modal = document.getElementById('image-view-modal');
            modal.classList.add('hidden');
            const img = document.getElementById('image-view-src');
            removeZoomListeners(img);
        }
        // é‡ç½®ç¸®æ”¾èˆ‡ä½ç½®   
        function resetZoom() {
            imgScale = 1;
            imgPosX = 0;
            imgPosY = 0;
            initialPinchDist = 0;
            updateImageTransform();
        }
        // æ›´æ–°åœ–ç‰‡çš„ CSS è®Šå½¢
        function updateImageTransform() {
            const img = document.getElementById('image-view-src');
            // é™åˆ¶ä½ç§»ç¯„åœï¼Œé¿å…åœ–ç‰‡é£›å‡ºè¦–çª—å¤ªé  (å¯é¸)
            img.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${imgScale})`;
            img.style.cursor = imgScale > 1 ? 'grab' : 'default';
        }
        // è¨ˆç®—å…©æŒ‡è·é›¢çš„è¼”åŠ©å‡½æ•¸
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy); //ç•¢æ°å®šç†è¨ˆç®—è·é›¢
        }
        // --- åœ–ç‰‡ç¸®æ”¾äº‹ä»¶ç›£è½å™¨ ---
        function addZoomListeners(img) {
            // 1. é›»è…¦ç‰ˆæ»¾è¼ªç¸®æ”¾
            img.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.2 : 0.2;
                let newScale = imgScale + delta;
                newScale = Math.min(Math.max(1, newScale), 5); // é™åˆ¶ 1x ~ 5x
                if (newScale === 1) { imgPosX = 0; imgPosY = 0; }
                imgScale = newScale;
                updateImageTransform();
            };

            // 2. è§¸æ§/æ»‘é¼ æŒ‰ä¸‹
            const startDrag = (x, y) => {
                if (imgScale <= 1) return; 
                isDragging = true;
                startX = x - imgPosX;
                startY = y - imgPosY;
                img.style.cursor = 'grabbing';
            };

            img.onmousedown = (e) => { startDrag(e.clientX, e.clientY); };

            // â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆè§¸æ§é–‹å§‹ (åˆ†è¾¨æ˜¯å–®æŒ‡é‚„æ˜¯é›™æŒ‡) â˜…â˜…â˜…
            img.ontouchstart = (e) => {
                if (e.touches.length === 2) {
                    // --- é›™æŒ‡æ¨¡å¼ï¼šé–‹å§‹ç¸®æ”¾ ---
                    e.preventDefault(); // é˜²æ­¢ç€è¦½å™¨ç¸®æ”¾
                    isDragging = false; // ç¸®æ”¾æ™‚åœæ­¢æ‹–æ›³
                    initialPinchDist = getDistance(e.touches);
                    startScale = imgScale;
                } else if (e.touches.length === 1) {
                    // --- å–®æŒ‡æ¨¡å¼ï¼šé–‹å§‹æ‹–æ›³ ---
                    startDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 3. ç§»å‹•ä¸­
            const doDrag = (x, y) => {
                if (!isDragging) return;
                imgPosX = x - startX;
                imgPosY = y - startY;
                updateImageTransform();
            };

            window.onmousemove = (e) => { if(isDragging) { e.preventDefault(); doDrag(e.clientX, e.clientY); } };

            // â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆç§»å‹• (åŒ…å«é›™æŒ‡ç¸®æ”¾é‚è¼¯) â˜…â˜…â˜…
            window.ontouchmove = (e) => {
                if (e.touches.length === 2 && initialPinchDist > 0) {
                    // --- é›™æŒ‡æåˆè¨ˆç®— ---
                    e.preventDefault();
                    const dist = getDistance(e.touches);
                    const scaleChange = dist / initialPinchDist; // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                    
                    // æ–°çš„ç¸®æ”¾å€¼ = åˆå§‹ç¸®æ”¾å€¼ * è®ŠåŒ–æ¯”ä¾‹
                    let newScale = startScale * scaleChange;
                    
                    // é™åˆ¶ç¯„åœ (1å€ ~ 5å€)
                    imgScale = Math.min(Math.max(1, newScale), 5);
                    updateImageTransform();
                    
                } else if (isDragging && e.touches.length === 1) {
                    // --- å–®æŒ‡æ‹–æ›³ ---
                    // e.preventDefault(); // è¦–æƒ…æ³é–‹å•Ÿï¼Œè‹¥æƒ³ä¿ç•™æ»‘å‹•ç¶²é åŠŸèƒ½å¯é—œé–‰
                    doDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 4. æ”¾é–‹æ‰‹æŒ‡
            const stopDrag = (e) => {
                isDragging = false;
                // å¦‚æœæ˜¯é›™æŒ‡æ”¾é–‹è®Šæˆå–®æŒ‡ï¼Œé‡ç½®ç¸®æ”¾åŸºæº–ï¼Œé¿å…è·³å‹•
                if (e.touches && e.touches.length < 2) {
                    initialPinchDist = 0;
                }
                img.style.cursor = imgScale > 1 ? 'grab' : 'default';
                
                // å¦‚æœç¸®å¤ªå°ï¼Œè‡ªå‹•å½ˆå› 1 å€
                if (imgScale < 1) {
                    imgScale = 1;
                    imgPosX = 0;
                    imgPosY = 0;
                    updateImageTransform();
                }
            };

            window.onmouseup = stopDrag;
            window.ontouchend = stopDrag;
        }
        // --- ç§»é™¤åœ–ç‰‡ç¸®æ”¾äº‹ä»¶ç›£è½å™¨ ---
        function removeZoomListeners(img) {
            img.onwheel = null;
            img.onmousedown = null;
            img.ontouchstart = null;
            window.onmousemove = null;
            window.ontouchmove = null;
            window.onmouseup = null;
            window.ontouchend = null;
        }        
        
    // --- å…¨åŸŸè®Šæ•¸ ---
        let currentShoppingFilter = 'all';
        let itineraryData = [];
        let currentDayIdx = null; 
        let currentEvtIdx = null;
        let currentExpenseId = null; 
        let deleteTarget = null; 
        let deleteExpenseId = null;
        let currentSelectedDayIndex = 0;
        let currentShoppingId = null; 
        let deleteShoppingId = null;
        let deleteChecklistCatIdx = null; 
        let deleteChecklistItemIdx = null;
        
     // --- æ·±è‰²æ¨¡å¼åˆ‡æ›åŠŸèƒ½ ---
        function initDarkMode() {
            // æª¢æŸ¥ LocalStorage æˆ– ç³»çµ±åå¥½
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        // åˆ‡æ›æ·±è‰²æ¨¡å¼
        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
        initDarkMode();// åˆå§‹åŒ–æ·±è‰²æ¨¡å¼è¨­å®š

    // --- è¡Œç¨‹æ—¥æœŸåˆ‡æ›åŠŸèƒ½ ---
        function switchDay(dayIdx) {
            if (typeof dayIdx !== 'number' || dayIdx < 0 || dayIdx >= itineraryData.length) return;
            if (currentSelectedDayIndex === dayIdx) return;
            currentSelectedDayIndex = dayIdx;
            renderDateSelector();
            renderPlan();
            try {
                const container = document.getElementById('date-scroll-container');
                const btns = container ? container.querySelectorAll('button') : [];
                const btn = btns[dayIdx];
                if (btn && typeof btn.scrollIntoView === 'function') {
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            } catch (e) { console.warn('switchDay scroll error', e); }
        }
    // --- é è¨­å¿…è²·æ¸…å–®è³‡æ–™ ---
        const defaultShoppingList = [
            { id: 'm1', type: 'drug', name: 'å¤§æ­£è£½è—¥ å£å…§ç‚è²¼ç‰‡', desc: 'è²¼çš„å«é¡å›ºé†‡ï¼Œå¸é™„åŠ›å¥½', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=å£å…§ç‚' },{ id: 'm2', type: 'drug', name: 'Traful è»Ÿè† PRO QUICK', desc: 'æŠ—ç‚æˆåˆ†ï¼Œå¡—æŠ¹å‹', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Traful' }, { id: 'm3', type: 'drug', name: 'Chocola BB å£å…§ç‚å™´éœ§', desc: 'æ®ºèŒä¿®å¾©ï¼Œè–„è·å‘³', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=BB' }, { id: 'm4', type: 'drug', name: 'å°æ—è£½è—¥ æ¶²é«”çµ†å‰µè†', desc: 'é˜²æ°´éš±å½¢OKç¹ƒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=æ¶²é«”çµ†' }, { id: 'm5', type: 'drug', name: 'EVE Quick DX', desc: 'é€Ÿæ•ˆæ­¢ç—›', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=EVE' }, { id: 'm6', type: 'drug', name: 'Loxonin S Premium', desc: 'å¼·æ•ˆæ­¢ç—›', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Loxonin' }, { id: 'm7', type: 'drug', name: 'PAIR ç—˜ç—˜è—¥è†', desc: 'æ¶ˆç‚æ®ºèŒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=PAIR' }, { id: 'm8', type: 'drug', name: 'Aneron æšˆè»Šè—¥', desc: 'é•·æ•ˆæŒçºŒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Aneron' }, { id: 'm9', type: 'drug', name: 'å“†å•¦Aå¤¢ æšˆè»Šè—¥', desc: 'å…’ç«¥å¯ç”¨ï¼Œæ±½æ°´å‘³', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=å“†å•¦Aå¤¢' }, { id: 'm10', type: 'drug', name: 'DHC é€Ÿæ”»è—è“ V-MAX', desc: 'è­·çœ¼ï¼ŒèŠ±é’ç´ å¢é‡', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCè—è“' }, { id: 'm11', type: 'drug', name: 'é¾è§’æ•£ Direct', desc: 'å…æ°´æœç”¨ï¼Œæ°´èœœæ¡ƒ/è–„è·', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=é¾è§’æ•£' }, { id: 'm12', type: 'drug', name: 'DHC ä¹³é…¸èŒ/ç›Šç”ŸèŒ', desc: 'æ•´è…¸æ¶ˆåŒ–', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCç›Šç”ŸèŒ' }, { id: 'm13', type: 'drug', name: 'DHC è‘‰é»ƒç´ /è¦ç´…ç´ ', desc: 'æŠ—è—å…‰ï¼ŒæŠ—ç–²å‹', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCè‘‰é»ƒ' }, { id: 'm14', type: 'drug', name: 'ROIHI-TSUBOKO', desc: 'æº«æ„Ÿç©´ä½è²¼ç‰‡', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=ç©´ä½è²¼' }, { id: 'm15', type: 'drug', name: 'åˆåˆ©ä»–å‘½ EX Plus', desc: 'ç·©è§£çœ¼ç›ç–²å‹ã€è‚©é ¸åƒµç¡¬', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=åˆåˆ©ä»–å‘½' }, { id: 'm16', type: 'drug', name: 'æ¨‚æ•¦ V é ‚ç´šç´…é‘½', desc: 'æ”¹å–„ä¹¾çœ¼ã€è€èŠ±', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Vç´…é‘½' }, { id: 'm17', type: 'drug', name: 'é½’ç£¨æ’«å­ ç‰™è†', desc: 'å°è˜‡æ‰“ç¾ç™½', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=é½’ç£¨æ’«å­' }, { id: 's1', type: 'souvenir', name: 'ç™½è‰²æˆ€äºº', desc: 'ç¶“å…¸å·§å…‹åŠ›å¤¾å¿ƒ', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=ç™½è‰²æˆ€äºº' }, { id: 's2', type: 'souvenir', name: 'HORI å“ˆå¯†ç“œæœå‡', desc: 'å¤•å¼µå“ˆå¯†ç“œå£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=HORI' }, { id: 's3', type: 'souvenir', name: 'PRESS BUTTER SAND', desc: 'åŒ—æµ·é“é™å®šç‰ç±³å£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=ButterSand' }, { id: 's4', type: 'souvenir', name: 'åŒ—è“æ¨“ é–‹æ‹“å°ç±³è“', desc: 'æµ·é®®å£å‘³ç±³è“', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=åŒ—è“æ¨“' }, { id: 's5', type: 'souvenir', name: 'LeTAO é›™å±¤èµ·å¸è›‹ç³•', desc: 'å¿…è²·ç¶“å…¸', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=LeTAO' }, { id: 's6', type: 'souvenir', name: 'KINOTOYA èµ·å¸å¡”', desc: 'æ–°åƒæ­²æ©Ÿå ´å¿…åƒ', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=KINOTOYA' }, { id: 's7', type: 'souvenir', name: 'Milk Stand ç‰›å¥¶', desc: 'å„åœ°ç‰§å ´ç›´é€', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=MilkStand' }, { id: 's8', type: 'souvenir', name: 'å…­èŠ±äº­ å¥¶æ²¹å¤¾å¿ƒ', desc: 'è˜­å§†è‘¡è„å£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=å…­èŠ±äº­' }, { id: 's9', type: 'souvenir', name: 'å…­èŠ±äº­ é…’ç³–', desc: 'å¯¶çŸ³èˆ¬çš„å¤–è§€', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=é…’ç³–' }, { id: 's10', type: 'souvenir', name: 'Oh! çƒ¤ç‰ç±³', desc: 'æœ­å¹Œå¤§é€šå…¬åœ’åç‰©', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=çƒ¤ç‰ç±³' }, { id: 'o1', type: 'other', name: 'Canon SELPHY CP1500', desc: 'å°å‹å°ç›¸æ©Ÿ', done: false, img: 'https://placehold.co/100x100/e5e7eb/4b5563?text=Canon' } ];
    // --- åˆå§‹åŒ–åŠŸèƒ½ ---
        document.addEventListener('DOMContentLoaded', () => {
            initItinerary(); 
            initChecklist(); 
            initShoppingList(); 
            initWallet(); 
            setupNav();
            renderDateSelector(); 
            renderPlan();

            setInterval(updateRealtimeHighlight, 60000);
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() { this.select(); });
            });
            loadFromCloud();
        });

        // ...existing code...
        
        // --- CLOUD SYNC CONFIG (é›²ç«¯åŒæ­¥è¨­å®š) ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHLVR3OKM4qFoGzqnITcN9kDJq12CEpPyY4b0hn2Frwez4avJbFEasZiVQDKNjvT9K/exec";

        // è®€å–é›²ç«¯è³‡æ–™ï¼ˆä¿®å¾©ç‰ˆæœ¬ï¼‰
        async function loadFromCloud() {
            if (!GAS_API_URL) {
                console.log('é›²ç«¯åŒæ­¥å·²ç¦ç”¨');
                return;
            }
            
            showToast("æ­£åœ¨åŒæ­¥", "info");
            
            try {
                // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                const url = GAS_API_URL + "?t=" + new Date().getTime();
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                
                if (result.status !== 'success' || !result.data) {
                    console.warn('å›æ‡‰ç•°å¸¸:', result);
                    showToast("ç„¡æ–°è³‡æ–™", "normal");
                    return;
                }
                
                const data = result.data;
                let hasUpdate = false;
                
                // æ›´æ–° LocalStorageï¼ˆå¦‚æœé›²ç«¯æœ‰è³‡æ–™ï¼‰
                if (data.hk_itinerary_v20) { 
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(data.hk_itinerary_v20)); 
                    hasUpdate = true; 
                }
                if (data.hk_wallet_v20) { 
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(data.hk_wallet_v20)); 
                    hasUpdate = true; 
                }
            
                if (hasUpdate) {
                    // é‡æ–°åˆå§‹åŒ–ç•«é¢ä»¥é¡¯ç¤ºæ–°è³‡æ–™
                    initItinerary();
                    renderPlan();
                    renderExpenseList();
                    renderShoppingList();
                    renderChecklist();
                    showToast("åŒæ­¥å®Œæˆï¼âœ¨", "success");
                } else {
                    showToast("ç„¡æ–°è³‡æ–™", "normal");
                }
                
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—:", e);
                showToast(`åŒæ­¥å¤±æ•—: ${e.message}`, "error");
            }
        }
        // ä¸Šå‚³è³‡æ–™åˆ°é›²ç«¯ (ä¿®æ­£ç‰ˆï¼šç§»é™¤æ¨™é ­ä»¥é¿å… CORS éŒ¯èª¤)
        async function saveToCloud(key, dataObj) {
            if (!GAS_API_URL) return;
            
            try {
                const payload = {
                    key: key,
                    value: JSON.stringify(dataObj)
                };
                
                // â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šç§»é™¤ headers è¨­å®šï¼Œè®“ç€è¦½å™¨ç”¨é è¨­æ–¹å¼å‚³é€ â˜…â˜…â˜…
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'no-cors' // åŠ å…¥é€™è¡Œï¼Œå¼·è¿«ç€è¦½å™¨å¿½ç•¥è·¨åŸŸæª¢æŸ¥ (é›–ç„¶ç„¡æ³•è®€å–å›å‚³çµæœï¼Œä½†èƒ½ç¢ºä¿è³‡æ–™é€é”)
                });
                
                console.log('å·²ç™¼é€ä¸Šå‚³è«‹æ±‚:', key);
                
            } catch (err) {
                console.error('ä¸Šå‚³ç™¼é€å¤±æ•—:', err);
            }
        }
        // --- TOAST NOTIFICATION FUNCTION ---
        function showToast(message, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';

            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(toast);

            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 3000);
        }

        // --- ITINERARY DATA (Updated with splits and moves) ---
        const defaultItinerary = [
            { date: "12/18 (å››)", day: 1, dateObj: "2025-12-18", weather: { icon: 'fa-cloud', temp: '-1Â°C', desc: 'å¤šé›²' }, events: [ 
                { time: "06:15 ~ 11:00", title: "TPE æ¡ƒåœ’æ©Ÿå ´ T2", type: "transport", note: "é•·æ¦® BR166 (29A-D)", tags: ["èˆªç­", "A321"], story: "è¨˜å¾—ææ—© 2.5 å°æ™‚æŠµé”æ©Ÿå ´å ±åˆ°ã€‚", tips: "é•·æ¦®èˆªç©ºæ«ƒå°åœ¨ç¬¬äºŒèˆªå»ˆ 3 æ¨“ã€‚" }, 
                { time: "11:00 ~ 12:00", title: "CTS æ–°åƒæ­²æ©Ÿå ´", type: "transport", note: "å…¥å¢ƒã€é ˜è¡Œæ", station: "æ–°åƒæ­²ç©ºæ¸¯ç«™" }, 
                { time: "12:15 ~ 13:10", title: "ç§»å‹•ï¼šå‰å¾€é£¯åº—", type: "move", note: "JR å¿«é€Ÿ Airport (37åˆ†) â” æœ­å¹Œç«™è½‰ä¹˜ â” åœ°éµå—åŒ—ç·š (5åˆ†)", tags: ["JR: 12:15/12:27ç™¼"] },
                { time: "13:11 ~ 14:11", title: "æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—", type: "stay", note: "Check-in / å¯„æ”¾è¡Œæ", station: "ä¸­å³¶å…¬åœ’ç«™" }, 
                { time: "14:40 ~ 14:50", title: "ç§»å‹•ï¼šå‰å¾€å¤§é€š", type: "move", note: "åœ°éµå—åŒ—ç·š (å¾€éº»ç”Ÿæ–¹å‘ 2ç«™)", tags: ["è»Šç¨‹ç´„5åˆ†"] },
                { time: "15:00 ~ 16:00", title: "ç´…ç£šå»³èˆ (èˆŠæœ¬å»³èˆ)", type: "spot", note: "å·´æ´›å…‹é¢¨æ ¼ç´…ç£šå»ºç¯‰", station: "å¤§é€šç«™/æœ­å¹Œç«™", tips: "å…¥å…§åƒè§€å…è²»(æ•´ä¿®ä¸­å¯èƒ½åƒ…å¤–è§€)ã€‚" },
                { time: "16:00 ~ 16:15", title: "ç§»å‹•ï¼šæ­¥è¡Œå‰å¾€å¤§é€šå…¬åœ’", type: "move", note: "æ­¥è¡Œç´„10-15åˆ†", tags: ["æ•£æ­¥"] },
                { time: "16:15 ~ 18:00", title: "å¤§é€šå…¬åœ’", type: "spot", note: "ç™½è‰²ç‡ˆæ¨¹ç¯€", station: "å¤§é€šç«™", tips: "æœ€ä½³æ‹ç…§é»åœ¨é›»è¦–å¡”å‰æˆ–å™´æ°´æ± ã€‚" },
                { time: "18:00 ~ 18:20", title: "ç§»å‹•ï¼šæ­¥è¡Œæˆ–åœ°éµ", type: "move", note: "å‰å¾€è–„é‡/å¤§é€šå‘¨é‚Šæ™šé¤", tags: ["æ­¥è¡Œç´„15åˆ†"] },
                { time: "18:32 ~ 19:30", title: "Gyoza no Ohsho", type: "food", note: "æ™šé¤ï¼šé¤ƒå­", tags: ["æ™šé¤"] }, 
                { time: "19:34 ~ 20:34", title: "Matcha Cafe & Sweets RIQ", type: "food", note: "æŠ¹èŒ¶ç”œé»", tags: ["å¿…åƒç”œé»"] }, 
                { time: "20:35 ~ 22:35", title: "ç‹¸å°è·¯å•†åº—è¡—", type: "shop", note: "è—¥å¦ã€ä¼´æ‰‹ç¦®æ¡è²·", station: "ç‹¸å°è·¯ç«™", tags: ["é€›è¡—"] }, 
                { time: "22:35 ~ 23:00", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š (å¾€çœŸé§’å…§æ–¹å‘)", station: "ä¸­å³¶å…¬åœ’ç«™" } 
            ] }, 
            { date: "12/19 (äº”)", day: 2, dateObj: "2025-12-19", weather: { icon: 'fa-snowflake', temp: '-4Â°C', desc: 'å°é›ª' }, events: [ 
                { time: "07:30 ~ 08:30", title: "ç§»å‹•ï¼šå‰å¾€æ»‘é›ªå ´", type: "move", note: "å°ˆè»Šæ¥é€ (è«‹ç¢ºèªé›†åˆé»)", tags: ["å°ˆè»Š"] },
                { time: "08:30 ~ 16:30", title: "æœ­å¹Œæ‰‹ç¨»æ»‘é›ªå ´", type: "spot", note: "æ»‘é›ªé«”é©—", tags: ["é‡é»è¡Œç¨‹"], tips: "åˆå­¸è€…å»ºè­°é ç´„æ•™ç·´ã€‚" }, 
                { time: "16:30 ~ 17:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "å°ˆè»Šæ¥é€", tags: ["å°ˆè»Š"] },
                { time: "17:30 ~ 18:00", title: "å›é£¯åº—æ¢³æ´—", type: "stay", note: "ä¼‘æ¯æ›è£" }, 
                { time: "18:00 ~ 18:15", title: "ç§»å‹•ï¼šå‰å¾€è–„é‡", type: "move", note: "åœ°éµå—åŒ—ç·š (1ç«™)", tags: ["è»Šç¨‹3åˆ†"] },
                { time: "18:16 ~ 19:16", title: "Suage+ Soup Curry", type: "food", note: "åŒ—æµ·é“å¿…åƒæ¹¯å’–å“©", station: "è–„é‡ç«™", tags: ["å¿…é»:è„†çš®çŸ¥åºŠé›"] }, 
                { time: "19:16 ~ 19:29", title: "ç§»å‹•ï¼šå‰å¾€å¤§é€š", type: "move", note: "æ­¥è¡Œæˆ–åœ°ä¸‹è¡—", tags: ["æ­¥è¡Œ10åˆ†"] },
                { time: "19:30 ~ 20:30", title: "æœ­å¹Œåœ°ä¸‹è¡— (Aurora Town)", type: "shop", note: "é€£æ¥å¤§é€šèˆ‡é›»è¦–å¡”çš„åœ°ä¸‹è¡—", station: "å¤§é€šç«™", tags: ["é€›è¡—"] },
                { time: "20:30 ~ 20:40", title: "ç§»å‹•ï¼šæ­¥è¡Œ", type: "move", note: "å‰å¾€é›»è¦–å¡”", tags: ["æ­¥è¡Œ"] },
                { time: "20:40 ~ 21:20", title: "æœ­å¹Œé›»è¦–å¡”", type: "spot", note: "ä¿¯ç°å¤§é€šå…¬åœ’å¤œæ™¯", station: "å¤§é€šç«™", tips: "å¾ä¸‹æ–¹ä»°æ‹ä¹Ÿå¾ˆç¾ã€‚" },
                { time: "21:20 ~ 21:30", title: "ç§»å‹•ï¼šæ­¥è¡Œ", type: "move", note: "å‰å¾€é˜æ¨“ (ç´„5-10åˆ†)", tags: ["æ­¥è¡Œ"] },
                { time: "21:30 ~ 22:00", title: "æœ­å¹Œå¸‚é˜æ¨“", type: "spot", note: "æ—¥æœ¬ç¾å­˜æœ€å¤è€é˜æ¨“", station: "å¤§é€šç«™", tips: "æ™šä¸Šæ‰“ç‡ˆåˆ¥æœ‰ä¸€ç•ªé¢¨å‘³ã€‚" },
                { time: "22:00 ~ 22:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "è¨ˆç¨‹è»Šæˆ–åœ°éµå—åŒ—ç·š" } 
            ] }, 
            { date: "12/20 (å…­)", day: 3, dateObj: "2025-12-20", weather: { icon: 'fa-sun', temp: '-2Â°C', desc: 'æ™´æ™‚å¤šé›²' }, events: [ 
                { time: "07:15 ~ 07:40", title: "ç§»å‹•ï¼šå‰å¾€ä¼è¦‹ç¨»è·", type: "move", note: "å¸‚é›» (ä¸­å³¶å…¬åœ’é€š -> è¥¿ç·š14æ¢)", tags: ["è·¯é¢é›»è»Š"] },
                { time: "07:40 ~ 08:42", title: "ä¼è¦‹ç¨»è·ç¥ç¤¾", type: "spot", note: "åƒæœ¬é³¥å±…", station: "è¥¿ç·š14æ¢", tips: "ç¶²ç¾æ‹ç…§è–åœ°ã€‚" }, 
                { time: "08:42 ~ 09:10", title: "ç§»å‹•ï¼šå‰å¾€åœ“å±±", type: "move", note: "å»ºè­°è¨ˆç¨‹è»Š (ç´„1500å††) æˆ– å…¬è»Š", tags: ["è¨ˆç¨‹è»Šæ¨è–¦"] },
                { time: "10:00 ~ 11:40", title: "ç¾æœˆæ«»å’Œæœ", type: "spot", note: "å’Œæœé«”é©—", station: "åœ“å±±å…¬åœ’ç«™", tags: ["é ç´„è¡Œç¨‹"] }, 
                { time: "11:40 ~ 13:00", title: "åŒ—æµ·é“ç¥å®®", type: "spot", note: "åƒæ‹œ", station: "åœ“å±±å…¬åœ’ç«™" }, 
                { time: "13:00 ~ 14:00", title: "å…­èŠ±äº­ ç¥å®®èŒ¶å±‹åº—", type: "food", note: "ä¼‘æ¯åƒé»å¿ƒ", tags: ["å¿…åƒ:åˆ¤å®˜é¤…"] }, 
                { time: "16:00 ~ 16:47", title: "æ­¸é‚„å’Œæœ", type: "spot", note: "è¿”å›ç¾æœˆæ«»" }, 
                { time: "16:47 ~ 17:15", title: "ç§»å‹•ï¼šå‰å¾€è–„é‡", type: "move", note: "åœ°éµæ±è¥¿ç·š (åœ“å±±å…¬åœ’->å¤§é€š) è½‰ å—åŒ—ç·š" },
                { time: "18:15 ~ 20:00", title: "ç‚­ç«å…œ æˆå‰æ€æ±—", type: "food", note: "åŒ—æµ·é“ç‰¹è‰²çƒ¤è‚‰", tags: ["é ç´„ 18:30"] }, 
                { time: "20:00 ~ 21:00", title: "COCONO SUSUKINO", type: "shop", note: "è–„é‡æ–°åœ°æ¨™", station: "è–„é‡ç«™" }, 
                { time: "21:00 ~ 21:15", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š (1ç«™)" } 
            ] }, 
            { date: "12/21 (æ—¥)", day: 4, dateObj: "2025-12-21", weather: { icon: 'fa-snowflake', temp: '-5Â°C', desc: 'å¤§é›ª' }, events: [ 
                { time: "08:20 ~ 08:35", title: "ç§»å‹•ï¼šå‰å¾€æœ­å¹Œç«™", type: "move", note: "åœ°éµå—åŒ—ç·š", tags: ["æ—©èµ·å‡ºç™¼"] },
                { time: "08:43 ~ 09:18", title: "ç§»å‹•ï¼šå‰å¾€å°æ¨½", type: "move", note: "JR å¿«é€Ÿ Airport (å¾€å°æ¨½)", tags: ["JR"] },
                { time: "09:34 ~ 10:00", title: "ç§»å‹•ï¼šå‰å¾€æ°´æ—é¤¨", type: "move", note: "ä¸­å¤®å·´å£« (ç¥æ´¥ç·š 10/11è·¯)", tags: ["å°æ¨½ç«™å‰æ­ä¹˜"] },
                { time: "10:00 ~ 12:30", title: "å°æ¨½æ°´æ—é¤¨", type: "spot", note: "ä¼éµæ•£æ­¥", tags: ["è¦ªå­æ¨è–¦"] }, 
                { time: "12:40 ~ 13:10", title: "ç§»å‹•ï¼šè¿”å›å°æ¨½ç«™", type: "move", note: "ä¸­å¤®å·´å£«" },
                { time: "13:10 ~ 14:10", title: "å°æ¨½ä¸‰è§’å¸‚å ´", type: "food", note: "æµ·é®®åˆé¤", station: "å°æ¨½ç«™", tags: ["å¿…åƒæµ·é®®"] }, 
                { time: "14:30 ~ 16:30", title: "å°æ¨½å ºç”ºé€šå•†åº—è¡—", type: "shop", note: "ç”œé»èˆ‡ç»ç’ƒ", tags: ["å¿…è²·ä¼´æ‰‹ç¦®"] }, 
                { time: "16:30 ~ 17:30", title: "å…­èŠ±äº­ & åŒ—ä¸€ç¡å­", type: "shop", note: "ç»ç’ƒå·¥è—" }, 
                { time: "17:30 ~ 19:00", title: "å°æ¨½é‹æ²³", type: "spot", note: "æ¬£è³é‹æ²³å¤œæ™¯", station: "å°æ¨½ç«™" }, 
                { time: "19:15 ~ 20:00", title: "ç§»å‹•ï¼šè¿”å›æœ­å¹Œ", type: "move", note: "JR å¿«é€Ÿ Airport" },
                { time: "20:00 ~ 20:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š" }
            ] }, 
            { date: "12/22 (ä¸€)", day: 5, dateObj: "2025-12-22", weather: { icon: 'fa-cloud', temp: '-2Â°C', desc: 'é™°' }, events: [ 
                { time: "08:30 ~ 09:00", title: "ç§»å‹•ï¼šå‰å¾€å ´å¤–å¸‚å ´", type: "move", note: "åœ°éµæ±è¥¿ç·š (äºŒåå››è»’ç«™) + æ­¥è¡Œ" },
                { time: "09:00 ~ 10:00", title: "å ´å¤–å¸‚å ´", type: "food", note: "æµ·é®®ä¸¼æ—©é¤", station: "äºŒåå››è»’ç«™", tags: ["å¿…åƒæµ·é®®"] }, 
                { time: "10:00 ~ 10:45", title: "ç§»å‹•ï¼šå‰å¾€åŒ—æµ·é“å¤§å­¸", type: "move", note: "åœ°éµæ±è¥¿ç·š -> å—åŒ—ç·š (åŒ—12æ¢ç«™)" },
                { time: "10:54 ~ 11:54", title: "åŒ—æµ·é“å¤§å­¸", type: "spot", note: "éŠ€æå¤§é“", station: "åŒ—12æ¢ç«™" }, 
                { time: "11:54 ~ 12:17", title: "ç§»å‹•ï¼šå‰å¾€è«è¨ªç¥ç¤¾", type: "move", note: "åœ°éµæ±è±ç·š (åŒ—13æ¢æ±ç«™)" },
                { time: "12:17 ~ 13:17", title: "è«è¨ªç¥ç¤¾", type: "spot", note: "èŠ±æ‰‹æ°´", station: "åŒ—13æ¢æ±ç«™" }, 
                { time: "13:17 ~ 13:40", title: "ç§»å‹•ï¼šå‰å¾€å•¤é…’åšç‰©é¤¨", type: "move", note: "è¨ˆç¨‹è»Š æˆ– å·´å£« (è‹—ç©—ç«™æ–¹å‘)" },
                { time: "13:40 ~ 14:40", title: "æœ­å¹Œå•¤é…’åšç‰©é¤¨", type: "spot", note: "ç´…ç£šå»ºç¯‰æ‹ç…§", tags: ["æ­·å²"] }, 
                { time: "14:40 ~ 14:58", title: "ç§»å‹•ï¼šå‰å¾€æœ­å¹Œç«™", type: "move", note: "ä¸­å¤®å·´å£« Loop 88 æˆ– æ­¥è¡Œ" },
                { time: "14:58 ~ 16:00", title: "Sapporo Stellar Place", type: "shop", note: "è»Šç«™è³¼ç‰©", station: "æœ­å¹Œç«™" }, 
                { time: "16:03 ~ 17:03", title: "ä¸²é³¥ æœ­å¹Œé§…å‰åº—", type: "food", note: "å¹³åƒ¹ç¾å‘³ä¸²ç‡’", tags: ["å¿…åƒä¸²ç‡’"] }, 
                { time: "17:05 ~ 18:30", title: "BIC CAMERA æœ­å¹Œåº—", type: "shop", note: "é›»å™¨æ¡è²·", station: "æœ­å¹Œç«™" }, 
                { time: "18:30 ~ 19:00", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š" }
            ] }, 
            { date: "12/23 (äºŒ)", day: 6, dateObj: "2025-12-23", weather: { icon: 'fa-plane', temp: '0Â°C', desc: 'è¿”ç¨‹' }, events: [ 
                { time: "08:00 ~ 11:00", title: "Check-out & ç§»å‹•", type: "stay", note: "Check-out" }, 
                { time: "11:00 ~ 12:00", title: "ç§»å‹•ï¼šå‰å¾€æ©Ÿå ´", type: "move", note: "JR å¿«é€Ÿ Airport (37åˆ†)", tags: ["é ç•™æ™‚é–“"] },
                { time: "12:00 ~ 15:00", title: "æ–°åƒæ­²æ©Ÿå ´", type: "shop", note: "æœ€å¾Œæ¡è²·", story: "é€™è£¡ä¸åªæ˜¯æ©Ÿå ´ï¼Œæ›´æ˜¯å€‹è¶…å¤§éŠæ¨‚åœ’ã€‚" }, 
                { time: "15:20 ~ 19:05", title: "BR115 è¿”å°", type: "transport", note: "CTS -> TPE (29G-K)" } 
            ] } 
        ];
        
        
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('focus', function() { this.select(); });
        });
        loadFromCloud();

        function initItinerary() { const stored = localStorage.getItem('hk_itinerary_v20'); if (stored) { itineraryData = JSON.parse(stored); } else { itineraryData = JSON.parse(JSON.stringify(defaultItinerary)); } }
        // --- æ™‚é–“è¨ˆç®—èˆ‡è¼”åŠ©å·¥å…· ---

        // 1. å°‡ "HH:MM" è½‰ç‚º åˆ†é˜æ•¸
        function timeToMin(timeStr) {
            if (!timeStr) return 0;
            const t = timeStr.includes('~') ? timeStr.split('~')[0].trim() : timeStr;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        // 2. å°‡ åˆ†é˜æ•¸ è½‰ç‚º "HH:MM"
        function minToTime(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            if (h >= 24) h = h - 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // 3. å–å¾—è¡Œç¨‹æŒçºŒæ™‚é–“ (åˆ†é˜)
        function getDuration(evt) {
            if (!evt.time || !evt.time.includes('~')) return 60; // é è¨­ 60 åˆ†é˜
            const [start, end] = evt.time.split('~').map(s => s.trim());
            const sMin = timeToMin(start);
            const eMin = timeToMin(end);
            return (eMin > sMin) ? eMin - sMin : 60;
        }
        // --- æ ¸å¿ƒé‚è¼¯ Aï¼šè™•ç†æ’å…¥æ™‚çš„é‡ç–Š (é‡˜å­é‚è¼¯) ---
        // è®“åŸæœ¬çš„è¡Œç¨‹è®“è·¯çµ¦æ–°è¡Œç¨‹
        function resolveInsertConflicts(dayIdx, anchorEvtIdx) {
            const events = itineraryData[dayIdx].events;
            const anchor = events[anchorEvtIdx]; // é€™æ˜¯æˆ‘å€‘å‰›æ–°å¢/ä¿®æ”¹çš„è¡Œç¨‹ (é‡˜å­)
            
            if (!anchor.time || !anchor.time.includes('~')) return;

            const [anchorStartStr, anchorEndStr] = anchor.time.split('~').map(s => s.trim());
            const anchorStart = timeToMin(anchorStartStr);
            const anchorEnd = timeToMin(anchorEndStr);

            events.forEach((evt, idx) => {
                // è·³éè‡ªå·±ï¼Œä¸è¦è‡ªå·±æ’æ–¥è‡ªå·±
                if (idx === anchorEvtIdx) return;
                if (!evt.time || !evt.time.includes('~')) return;

                const [evtStartStr, evtEndStr] = evt.time.split('~').map(s => s.trim());
                const evtStart = timeToMin(evtStartStr);
                const evtEnd = timeToMin(evtEndStr);

                // åˆ¤æ–·é‡ç–Šé‚è¼¯ï¼š
                // å¦‚æœ (èˆŠè¡Œç¨‹é–‹å§‹ < æ–°è¡Œç¨‹çµæŸ) AND (èˆŠè¡Œç¨‹çµæŸ > æ–°è¡Œç¨‹é–‹å§‹) => ç™¼ç”Ÿé‡ç–Š
                const isOverlapping = (evtStart < anchorEnd) && (evtEnd > anchorStart);

                if (isOverlapping) {
                    // è¨ˆç®—èˆŠè¡Œç¨‹åŸæœ¬é•·åº¦
                    const duration = evtEnd - evtStart;

                    // â˜… å¼·åˆ¶é †å»¶é‚è¼¯ï¼š
                    // èˆŠè¡Œç¨‹çš„ã€Œæ–°é–‹å§‹æ™‚é–“ã€ï¼Œå¿…é ˆæ˜¯ã€Œå®ƒåŸæœ¬çš„æ™‚é–“ã€èˆ‡ã€Œæ–°è¡Œç¨‹çµæŸæ™‚é–“ã€å–æœ€å¤§å€¼
                    // ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœå®ƒåŸæœ¬ 10:00 é–‹å§‹ï¼Œä½†æ–°è¡Œç¨‹ä½”ç”¨åˆ° 10:30ï¼Œå®ƒå°±å¾—æ”¹å¾ 10:30 é–‹å§‹
                    const newStart = Math.max(evtStart, anchorEnd);
                    const newEnd = newStart + duration;

                    evt.time = `${minToTime(newStart)} ~ ${minToTime(newEnd)}`;
                }
            });
        }
        function resetItinerary() {
            deleteTarget = 'itinerary-reset';
            document.getElementById('confirm-msg').innerText = "ç¢ºå®šè¦æ¢å¾©é è¨­è¡Œç¨‹å—ï¼Ÿæ‰€æœ‰ä¿®æ”¹å°‡æ¶ˆå¤±ã€‚";
            document.getElementById('confirm-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);
        }

        function renderDateSelector() { const container = document.getElementById('date-scroll-container'); let html = ''; itineraryData.forEach((day, idx) => { const isActive = idx === currentSelectedDayIndex; const activeClass = isActive ? 'bg-muji-accent text-white shadow-md' : 'bg-white dark:bg-gray-800 text-gray-500 hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600'; const dateShort = day.date.split('/')[1]; html += `<button onclick="switchDay(${idx})" class="flex-shrink-0 w-14 h-12 rounded-xl flex flex-col items-center justify-center transition-all ${activeClass} border border-transparent ${!isActive ? 'border-gray-100 dark:border-gray-700' : ''}"><span class="text-xs font-bold leading-none mb-1">Day ${day.day}</span><span class="text-[10px] font-mono leading-none">${dateShort}</span></button>`; }); container.innerHTML = html; }

        let sortableInstance = null; // å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†ç®¡ç†æ‹–æ›³å¯¦ä¾‹

        function renderPlan() { 
            const container = document.getElementById('itinerary-list'); 
            const weatherCard = document.getElementById('plan-weather-card'); 
            const day = itineraryData[currentSelectedDayIndex]; 
            
            // 1. æ¸²æŸ“å¤©æ°£å¡ (ä¿æŒä¸è®Š)
            weatherCard.innerHTML = `<div class="bg-white dark:bg-gray-800 p-2 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex items-center justify-between" style="max-width:360px;margin:6px auto">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-400 dark:text-blue-300 text-lg"><i class="fas ${day.weather.icon}"></i></div>
                    <div>
                        <div class="text-sm font-bold text-gray-700 dark:text-gray-100">${day.date}</div>
                        <div class="text-[10px] text-gray-400">${day.weather.desc}</div>
                    </div>
                </div>
                <div class="text-lg font-bold text-gray-600 dark:text-gray-300 font-mono">${day.weather.temp}</div>
            </div>`; 
            
            let eventsHtml = ''; 
            
            // 2. æ¸²æŸ“è¡Œç¨‹åˆ—è¡¨
            day.events.forEach((evt, evtIdx) => { 
                // --- é¡è‰²é‚è¼¯ ---
                let bgClass = 'bg-white border-l-4 border-gray-200 dark:bg-gray-800 dark:border-gray-600'; 
                let iconClass = 'text-gray-400 fa-map-marker-alt';
                let titleClass = 'text-muji-text dark:text-gray-100';
                let isMove = false;

                if (evt.type === 'transport') { 
                    bgClass = 'bg-muji-transport border-l-4 border-blue-400 dark:bg-blue-900/30 dark:border-blue-500'; 
                    iconClass = 'text-blue-500 dark:text-blue-400 dark:text-blue-300 fa-plane'; 
                } else if (evt.type === 'food') { 
                    bgClass = 'bg-muji-food border-l-4 border-orange-400 dark:bg-orange-900/30 dark:border-orange-500'; 
                    iconClass = 'text-orange-500 dark:text-orange-400 fa-utensils'; 
                } else if (evt.type === 'shop') { 
                    bgClass = 'bg-muji-shop border-l-4 border-pink-400 dark:bg-pink-900/30 dark:border-pink-500'; 
                    iconClass = 'text-pink-500 dark:text-pink-400 fa-shopping-bag'; 
                } else if (evt.type === 'spot') { 
                    bgClass = 'bg-muji-spot border-l-4 border-green-500 dark:bg-green-900/30 dark:border-green-500'; 
                    iconClass = 'text-green-600 dark:text-green-400 fa-camera'; 
                } else if (evt.type === 'stay') { 
                    iconClass = 'text-indigo-400 dark:text-indigo-300 fa-bed'; 
                } else if (evt.type === 'move') { 
                    bgClass = 'bg-gray-50 border-l-2 border-gray-300 py-2 pl-2 dark:bg-stone-800 dark:border-stone-600'; 
                    iconClass = 'text-gray-400 dark:text-stone-400 fa-bus'; 
                    titleClass = 'text-sm text-gray-600 dark:text-stone-200';
                    isMove = true;
                }

                let tagsHtml = ''; 
                if (evt.tags) { 
                    evt.tags.forEach(tag => { 
                        let tagStyle = 'bg-gray-100 dark:bg-gray-900 text-gray-500'; 
                        if (tag.includes('å¿…åƒ')) tagStyle = 'tag-must-eat'; 
                        else if (tag.includes('å¿…è²·')) tagStyle = 'tag-must-buy'; 
                        else if (tag.includes('é ç´„')) tagStyle = 'tag-reserve'; 
                        else if (tag.includes('è»Š') || tag.includes('JR') || tag.includes('å°ˆè»Š')) tagStyle = 'tag-transport'; 
                        tagsHtml += `<span class="text-[10px] px-1.5 py-0.5 rounded mr-1 mb-1 inline-block ${tagStyle}">${tag}</span>`; 
                    }); 
                } 
                
                const eventId = `event-${currentSelectedDayIndex}-${evtIdx}`; 
                // åŠ å…¥ data-idx æ–¹ä¾¿è¿½è¹¤
                const dataAttr = `data-idx="${evtIdx}"`;

                // â˜…â˜…â˜… æ–°å¢ï¼šæ‹–æ›³æ‰‹æŸ„ HTML (å³å´å…©æ¢ç·š) â˜…â˜…â˜…
                const dragHandle = `<div class="drag-handle absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center cursor-grab opacity-20 hover:opacity-100 touch-manipulation z-20 transition-opacity"><i class="fas fa-grip-lines text-gray-500 dark:text-gray-400"></i></div>`;

                if (isMove) {
                    // åŠ å…¥ sortable-item class
                    eventsHtml += `<div class="relative pl-8 timeline-line type-move group sortable-item" ${dataAttr} id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-2 top-3 w-4 text-center z-10"><div class="w-4 h-4 rounded-full bg-gray-200 border border-white flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-[8px] text-white"></i></div></div>
                        <div class="${bgClass} rounded-r-lg relative transition-all duration-300 event-card pr-10">
                            <div class="flex items-center justify-between cursor-pointer" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-xs font-bold text-gray-400 time-display whitespace-nowrap">${evt.time}</span>
                                    <h4 class="text-xs font-bold ${titleClass} truncate">${evt.title}</h4>
                                </div>
                                ${evt.note ? `<div class="text-[10px] text-gray-400 truncate max-w-[120px] transport-detail">${evt.note}</div>` : ''}
                            </div>
                            ${dragHandle}
                        </div>
                    </div>`;
                } else {
                    // åŠ å…¥ sortable-item class
                    eventsHtml += `<div class="relative pl-8 timeline-line group sortable-item" ${dataAttr} id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-0 top-4 w-8 text-center z-10"><div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-xs"></i></div></div>
                        <div class="${bgClass} p-3 rounded-lg shadow-card relative transition-all duration-300 event-card pr-10">
                            <div class="cursor-pointer" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                                <div class="flex justify-between items-start mb-1"><span class="font-mono text-sm font-bold text-gray-500 time-display">${evt.time}</span></div>
                                <h4 class="text-base font-bold ${titleClass} mb-1 leading-tight">${evt.title}</h4>
                                ${evt.station ? `<div class="text-xs text-muji-subtext mb-1"><i class="fas fa-subway mr-1 text-gray-300"></i>${evt.station}</div>` : ''}
                                ${evt.note ? `<p class="text-xs text-gray-500 mb-2 leading-relaxed">${evt.note}</p>` : ''}
                                <div class="flex flex-wrap">${tagsHtml}</div>
                            </div>
                            ${dragHandle}
                        </div>
                    </div>`;
                }
            }); 
            container.innerHTML = eventsHtml; 
            updateRealtimeHighlight(); 

            // â˜…â˜…â˜… 3. åˆå§‹åŒ– SortableJS (æ‹–æ›³é‚è¼¯) â˜…â˜…â˜…
            if (sortableInstance) sortableInstance.destroy(); // åˆ‡æ›æ—¥æœŸæ™‚éŠ·æ¯€èˆŠå¯¦ä¾‹
            
            sortableInstance = Sortable.create(container, {
                handle: '.drag-handle', // åªèƒ½æ‹‰æ‰‹æŸ„
                animation: 200,         // å‹•ç•«é€Ÿåº¦ ms
                ghostClass: 'sortable-ghost', // æ‹–æ›³æ™‚çš„æ®˜å½±æ¨£å¼
                delay: 100,             // é˜²èª¤è§¸å»¶é² (æ‰‹æ©Ÿå‹å–„)
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex === newIndex) return;

                    // (1) èª¿æ•´è³‡æ–™é™£åˆ—é †åº
                    const events = itineraryData[currentSelectedDayIndex].events;
                    const [movedItem] = events.splice(oldIndex, 1);
                    events.splice(newIndex, 0, movedItem);

                    // (2) åŸ·è¡Œã€Œç·Šæ¹Šæ’åˆ—ã€ï¼šé‡æ–°è¨ˆç®—æ‰€æœ‰æ™‚é–“ï¼Œå¡«è£œç©ºç¼º
                    resequenceEvents(currentSelectedDayIndex);

                    // (3) å­˜æª”èˆ‡åŒæ­¥
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
                    saveToCloud('hk_itinerary_v20', itineraryData);
                    
                    // (4) é‡æ–°æ¸²æŸ“ (è®“ç•«é¢ä¸Šé¡¯ç¤ºæ›´æ–°å¾Œçš„æ™‚é–“)
                    renderPlan();
                    showToast('è¡Œç¨‹é †åºåŠæ™‚é–“å·²æ›´æ–°', 'success');
                }
            });
        }

        function updateRealtimeHighlight() { const now = new Date(); const cards = document.querySelectorAll('.timeline-line'); cards.forEach(card => { const dateStr = card.getAttribute('data-date'); const timeStr = card.getAttribute('data-time'); const eventDate = new Date(dateStr); const isSameDate = now.getFullYear() === eventDate.getFullYear() && now.getMonth() === eventDate.getMonth() && now.getDate() === eventDate.getDate(); if (!isSameDate) { removeHighlight(card); return; } const times = timeStr.split('~').map(t => t.trim()); if (times.length < 1) return; const startParts = times[0].split(':'); const startHour = parseInt(startParts[0]); const startMin = parseInt(startParts[1]); let endHour, endMin; if (times.length > 1 && times[1]) { const endParts = times[1].split(':'); endHour = parseInt(endParts[0]); endMin = parseInt(endParts[1]); } else { endHour = startHour + 1; endMin = startMin; } const startTime = new Date(now); startTime.setHours(startHour, startMin, 0); const endTime = new Date(now); endTime.setHours(endHour, endMin, 0); if (now >= startTime && now <= endTime) { addHighlight(card); } else { removeHighlight(card); } }); }
        function addHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); if (!innerCard.classList.contains('event-active')) { innerCard.classList.add('event-active'); icon.classList.add('animate-pulse-slow'); icon.classList.add('bg-muji-highlight'); icon.querySelector('i').style.color = 'white'; innerCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
        function removeHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); innerCard.classList.remove('event-active'); icon.classList.remove('animate-pulse-slow'); icon.classList.remove('bg-muji-highlight'); icon.querySelector('i').style.color = ''; }
        function setupNav() { const btns = document.querySelectorAll('.nav-btn'); const sections = document.querySelectorAll('.tab-content'); btns.forEach(btn => { btn.addEventListener('click', () => { btns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); sections.forEach(s => { s.classList.remove('active'); if(s.id === btn.dataset.target) s.classList.add('active'); }); if(btn.dataset.target === 'lists') updateChecklistProgress(); }); }); }
        
        function deleteEvent() { 
            if (currentDayIdx === null || currentEvtIdx === null || currentEvtIdx < 0) return; 
            deleteTarget = 'itinerary'; 
            document.getElementById('confirm-msg').innerText="ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ"; 
            document.getElementById('confirm-modal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); 
        }
        
        function closeConfirmModal() { 
            const box = document.getElementById('confirm-box');
            box.classList.add('scale-95');
            document.getElementById('confirm-modal').classList.add('hidden'); 
            deleteTarget = null; deleteExpenseId = null; deleteShoppingId = null; deleteChecklistCatIdx = null; deleteChecklistItemIdx = null; 
        }
        
        // --- åŸ·è¡Œåˆªé™¤ (ä¿®æ­£ç‰ˆ) ---
        function executeDelete() { 
            // 1. åˆªé™¤è¡Œç¨‹ (æ”¯æ´éè£œ)
            if (deleteTarget === 'itinerary') { 
                try { 
                    const targetEvent = itineraryData[currentDayIdx].events[currentEvtIdx];
                    let durationToShift = 0;
                    if (targetEvent) durationToShift = getDuration(targetEvent);
                    
                    itineraryData[currentDayIdx].events.splice(currentEvtIdx, 1); 

                    if (durationToShift > 0) shiftEventsBack(currentDayIdx, currentEvtIdx, durationToShift);

                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
                    saveToCloud('hk_itinerary_v20', itineraryData);
                    
                    renderPlan(); 
                    closeModal(); 
                    closeViewModal(); 
                    showToast('è¡Œç¨‹å·²åˆªé™¤ä¸¦èª¿æ•´æ™‚é–“'); 
                } catch(e) { console.error(e); } 
            }
            // â˜…â˜…â˜… æ–°å¢ï¼šç³»çµ±é‚„åŸé‚è¼¯ â˜…â˜…â˜…
            else if (deleteTarget === 'system-restore') {
                const data = window.tempRestoreData;
                if (data) {
                    try {
                        // 1. å¯«å…¥ LocalStorage
                        if(data.itinerary) localStorage.setItem('hk_itinerary_v20', JSON.stringify(data.itinerary));
                        if(data.wallet) localStorage.setItem('hk_wallet_v20', JSON.stringify(data.wallet));
                        if(data.shopping) localStorage.setItem('hk_shopping_v20', JSON.stringify(data.shopping));
                        if(data.checklist) localStorage.setItem('hk_checks_v20', JSON.stringify(data.checklist));
                        if(data.rate) localStorage.setItem('hk_rate_v1', data.rate);

                        // 2. å¼·åˆ¶åŒæ­¥åˆ°é›²ç«¯ (è¦†è“‹é›²ç«¯èˆŠè³‡æ–™)
                        if(data.itinerary) saveToCloud('hk_itinerary_v20', data.itinerary);
                        if(data.wallet) saveToCloud('hk_wallet_v20', data.wallet);
                        // (å…¶ä»–è¼ƒå°çš„è³‡æ–™å¯é¸æ“‡æ€§åŒæ­¥æˆ–ç­‰å¾…ä¸‹æ¬¡è®Šå‹•)

                        showToast('é‚„åŸæˆåŠŸï¼é‡æ–°æ•´ç†ä¸­', 'success');
                        
                        // 3. å»¶é² 1.5 ç§’å¾Œé‡æ–°æ•´ç†é é¢ï¼Œè¼‰å…¥æ–°è³‡æ–™
                        setTimeout(() => {
                            window.tempRestoreData = null;
                            location.reload();
                        }, 1500);
                    } catch(e) {
                        showToast('é‚„åŸéç¨‹ç™¼ç”ŸéŒ¯èª¤', 'error');
                        console.error(e);
                    }
                }
            }
            // ... (ä»¥ä¸‹ç¶­æŒæ‚¨åŸæœ¬çš„å…¶ä»–åˆªé™¤é‚è¼¯) ...
            else if (deleteTarget === 'itinerary-reset') { 
                localStorage.removeItem('hk_itinerary_v20'); 
                initItinerary(); 
                renderDateSelector(); 
                renderPlan(); 
                showToast('è¡Œç¨‹å·²é‡ç½®'); 
            } 
            else if (deleteTarget === 'expense-clear') { 
                localStorage.removeItem('hk_wallet_v20'); 
                saveToCloud('hk_wallet_v20', []);
                renderExpenseList(); 
                showToast('è³‡æ–™å·²æ¸…é™¤'); 
            } 
            else if (deleteTarget === 'expense-single') { 
                let expenses = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                expenses = expenses.filter(e => e.id !== deleteExpenseId); 
                localStorage.setItem('hk_wallet_v20', JSON.stringify(expenses));
                const cleanExpenses = expenses.map(d => ({...d, img: ''}));
                saveToCloud('hk_wallet_v20', cleanExpenses);
                renderExpenseList(); 
                showToast('ç´€éŒ„å·²åˆªé™¤'); 
            } 
            else if (deleteTarget === 'shop-cat') {
                // 1. åˆªé™¤åˆ†é¡æœ¬èº«
                let cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
                cats = cats.filter(c => c.id !== deleteShopCatId);
                localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));

                // 2. é€£å¸¶åˆªé™¤è©²åˆ†é¡ä¸‹çš„æ‰€æœ‰å•†å“ (é¿å…å•†å“æ®˜ç•™è®Šå¹½éˆ)
                let items = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                items = items.filter(i => i.type !== deleteShopCatId);
                localStorage.setItem('hk_shopping_v20', JSON.stringify(items));

                // 3. é‡ç½®ç•«é¢
                currentShoppingFilter = 'all'; // å¼·åˆ¶å›åˆ°ã€Œå…¨éƒ¨ã€ä»¥å…åœç•™åœ¨å·²åˆªé™¤çš„é é¢
                renderShoppingFilters(); // é‡ç¹ªä¸Šæ–¹æŒ‰éˆ•
                renderShoppingList();    // é‡ç¹ªä¸‹æ–¹æ¸…å–®
                
                showToast('å¿…è²·åˆ†é¡å·²åˆªé™¤', 'success');
            }
            else if (deleteTarget === 'shopping') { 
                let list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
                list = list.filter(i => i.id !== deleteShoppingId); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(list)); 
                renderShoppingList(); 
                showToast('å¿…è²·å•†å“å·²åˆªé™¤'); 
            } 
            else if (deleteTarget === 'checklist-cat') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list.splice(deleteChecklistCatIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist(); 
                showToast('è¡Œæåˆ†é¡å·²åˆªé™¤'); 
            } 
            else if (deleteTarget === 'checklist-item') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list[deleteChecklistCatIdx].items.splice(deleteChecklistItemIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
                showToast('æº–å‚™é …ç›®å·²åˆªé™¤'); 
            } 
            closeConfirmModal(); 
        }
            function openViewModal(dayIdx, evtIdx) { 
            const evt = itineraryData[dayIdx].events[evtIdx]; 
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx; 
            document.getElementById('view-title').innerText = evt.title; 
            document.getElementById('view-type').innerText = (evt.type === 'food' ? 'ç¾é£Ÿ' : (evt.type === 'spot' ? 'æ™¯é»' : (evt.type === 'shop' ? 'è³¼ç‰©' : 'äº¤é€š'))); 
            document.getElementById('view-time').innerText = `${evt.time}`; 
            document.getElementById('view-story').innerText = evt.story || "æš«ç„¡è©³ç´°ä»‹ç´¹..."; 
            document.getElementById('view-tips').innerText = evt.tips || "æš«ç„¡ç‰¹åˆ¥æ”»ç•¥..."; 
            document.getElementById('view-note').innerText = evt.note || "-"; 
            
            const mapBtn = document.getElementById('view-map-btn'); 
            
            // â˜…â˜…â˜… ä¿®æ­£é€™è£¡ï¼šåŠ ä¸Š `${` èˆ‡ `}` è®“è®Šæ•¸èƒ½æ­£ç¢ºå¸¶å…¥ â˜…â˜…â˜…
            let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' åŒ—æµ·é“')}`;
            
            mapBtn.href = mapUrl;

            const imgMap = { 'food': 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=800', 'spot': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=800', 'shop': 'https://images.unsplash.com/photo-1472851294608-4151713425a5?q=80&w=800', 'transport': 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=800', 'stay': 'https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=800', 'move': 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=800' }; 
            document.getElementById('view-img').src = imgMap[evt.type] || imgMap['spot']; 
            const modal = document.getElementById('view-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.add('translate-y-0', 'sm:scale-100'); }, 10); 
            document.body.classList.add('modal-active'); 
        }
        function closeViewModal() { const modal = document.getElementById('view-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.remove('translate-y-0', 'sm:scale-100'); setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); }, 250); }
        function switchToEdit() { closeViewModal(); setTimeout(() => { openEditModal(currentDayIdx, currentEvtIdx); }, 300); }
        
        function initWallet() { 
            const savedRate = localStorage.getItem('hk_rate_v1');
            const lastFetch = localStorage.getItem('hk_rate_date');
            const today = new Date().toDateString();

            const dateInput = document.getElementById('expense-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }

            if (savedRate) {
                document.getElementById('exchange-rate').value = savedRate;
            }

            if (lastFetch !== today) {
                fetchExchangeRate();
            } else {
                const time = localStorage.getItem('hk_rate_time');
                if(time) document.getElementById('rate-update-time').innerText = `æ›´æ–°æ–¼: ${time}`;
            }

            renderExpenseList(); 
            
            document.getElementById('jpy-input').addEventListener('input', calculateRate);
            document.getElementById('exchange-rate').addEventListener('input', calculateRate);
        }

        function fetchExchangeRate(manual = false) {
            const statusEl = document.getElementById('rate-update-time');
            if(manual) statusEl.innerText = "æ›´æ–°ä¸­...";
            
            const targetUrl = 'https://tw.rter.info/capi.php';
            
            // Primary: AllOrigins
            const url1 = 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl);
            
            // Fallback: CORS Proxy
            const url2 = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

            const processData = (json, isAllOrigins = false) => {
                let data = json;
                if (isAllOrigins) {
                     data = JSON.parse(json.contents);
                }
                
                if (data.USDTWD && data.USDJPY) {
                    const rate = data.USDTWD.Exrate / data.USDJPY.Exrate;
                    return rate.toFixed(4);
                }
                throw new Error("Data format error");
            };

            fetch(url1)
                .then(res => {
                    if (!res.ok) throw new Error('Proxy 1 failed');
                    return res.json();
                })
                .then(data => {
                     return processData(data, true);
                })
                .catch(err => {
                    console.warn('Primary proxy failed, trying backup...', err);
                    return fetch(url2)
                        .then(res => {
                             if (!res.ok) throw new Error('Proxy 2 failed');
                             return res.json();
                        })
                        .then(data => {
                            return processData(data, false); 
                        });
                })
                .then(finalRate => {
                    document.getElementById('exchange-rate').value = finalRate;
                    
                    localStorage.setItem('hk_rate_v1', finalRate);
                    localStorage.setItem('hk_rate_date', new Date().toDateString());
                    
                    const timeStr = new Date().toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
                    localStorage.setItem('hk_rate_time', timeStr);
                    statusEl.innerText = `æ›´æ–°æ–¼: ${timeStr}`;
                    
                    calculateRate();
                    if(manual) showToast(`åŒ¯ç‡æ›´æ–°: ${finalRate}`, 'success');
                })
                .catch(err => {
                    console.error('All exchange rate sources failed', err);
                    if(manual) showToast('åŒ¯ç‡æ›´æ–°å¤±æ•—', 'error');
                    statusEl.innerText = "æ›´æ–°å¤±æ•—";
                });
        }

        function calculateRate() { 
            const input = document.getElementById('jpy-input').value; 
            const rate = parseFloat(document.getElementById('exchange-rate').value); 
            const output = document.getElementById('twd-output'); 
            try { 
                const clean = input.replace(/[^0-9+\-*/().]/g, ''); 
                if(!clean) { output.innerText = "0"; return; }
                const jpy = Function('"use strict";return (' + clean + ')')(); 
                const twd = Math.round(jpy * rate); 
                output.innerText = twd.toLocaleString(); 
            } catch(e) { output.innerText = "Err"; } 
        }

        function addExpense() { 
            const payer = document.getElementById('expense-payer').value; 
            const type = document.getElementById('expense-type').value; 
            const itemInput = document.getElementById('expense-item');
            const priceInput = document.getElementById('expense-price');
            const dateInput = document.getElementById('expense-date');
            
            const item = itemInput.value; 
            const price = priceInput.value; 
            const currentRate = parseFloat(document.getElementById('exchange-rate').value);
            const fileInput = document.getElementById('expense-photo'); 
            const expenseDate = dateInput.value || new Date().toISOString().split('T')[0];

            if(!item || !price) { showToast("è«‹å¡«å¯«å¿…è¦æ¬„ä½", 'error'); return; } 
            
            const jpyPrice = parseFloat(price);
            const twdPrice = Math.round(jpyPrice * currentRate); 

            const processSave = (img) => { 
                const data = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                data.unshift({ id: Date.now(), payer, type, item, price: jpyPrice, rate: currentRate, twd: twdPrice, img, date: expenseDate }); 
                
                try { 
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(data));
                    const cleanData = data.map(d => ({...d, img: ''}));
                    saveToCloud('hk_wallet_v20', cleanData); 

                    itemInput.value = ''; priceInput.value = ''; fileInput.value = ''; 
                    document.getElementById('photo-label').innerText = 'æ‹ç…§/ä¸Šå‚³'; 
                    renderExpenseList(); 
                    showToast("è¨˜å¸³æˆåŠŸä¸¦åŒæ­¥", 'success');
                } catch(e) { console.error(e); showToast("å„²å­˜éŒ¯èª¤", 'error'); } 
            };
            
            if(fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const maxW = 300; const scale = maxW / img.width; 
                        c.width = maxW; c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        processSave(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else processSave(null); 
        }

        function renderExpenseList() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const container = document.getElementById('expense-list'); 
            let total = 0; 
            let html = ''; 
            
            list.forEach(ex => { 
                const finalTwd = ex.twd !== undefined ? ex.twd : Math.round(ex.price * (ex.rate || 0.22)); 
                const rateUsed = ex.rate !== undefined ? ex.rate : 0.22;
                const displayDate = ex.date ? ex.date.replace(/-/g, '/') : 'Unknown';
                const type = ex.type || 'split'; 
                total += ex.price; 
                
                const payerBadge = ex.payer ? `<span class="text-xs bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-200 px-1 rounded mr-1">[${ex.payer}]</span>` : '';
                const typeBadge = type === 'private' 
                    ? `<span class="text-[10px] bg-gray-400 text-white px-1.5 py-0.5 rounded ml-2">ç§è²»</span>`
                    : `<span class="text-[10px] bg-muji-accent text-white px-1.5 py-0.5 rounded ml-2">å…¬è²»</span>`;

                html += `<div class="flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm relative group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded bg-gray-100 dark:bg-gray-900 flex-shrink-0 bg-cover bg-center border border-gray-200 ${ex.img ? 'cursor-pointer hover:opacity-80 transition' : ''}" style="background-image: url('${ex.img || ''}');" ${ex.img ? `onclick="openImageModal('${ex.img}')"` : ''}>${!ex.img ? '<i class="fas fa-receipt text-gray-300 m-auto h-full flex items-center justify-center"></i>' : ''}</div>
                        <div>
                            <div class="text-sm font-bold text-gray-700 dark:text-gray-100 flex items-center">${payerBadge}${ex.item} ${typeBadge}</div>
                            <div class="text-[10px] text-gray-400">${displayDate} <span class="text-gray-300">| åŒ¯ç‡ ${rateUsed}</span></div>
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <div>
                            <div class="text-sm font-bold">Â¥${ex.price.toLocaleString()}</div>
                            <div class="text-[10px] text-gray-500 font-medium">NT$${finalTwd.toLocaleString()}</div>
                        </div>
                        <div class="flex flex-col gap-2 border-l border-gray-100 dark:border-gray-700 pl-2">
                            <button onclick="openExpenseEdit(${ex.id})" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="confirmDeleteExpense(${ex.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>`; 
            }); 
            container.innerHTML = list.length ? html : '<div class="text-center text-gray-300 text-xs mt-4">å°šç„¡æ¶ˆè²»</div>'; 
            document.getElementById('total-expense').innerText = `Total: Â¥${total.toLocaleString()}`; 
        }        function openExpenseEdit(id) { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const expense = list.find(e => e.id === id); 
            if (!expense) return; 
            currentExpenseId = id; 
            
            document.getElementById('edit-expense-payer').value = expense.payer || 'å°æˆ´'; 
            // è®€å–ä¸¦å¡«å…¥é¡å‹ï¼Œé è¨­ç‚º split
            document.getElementById('edit-expense-type').value = expense.type || 'split'; 
            
            document.getElementById('edit-expense-item').value = expense.item; 
            document.getElementById('edit-expense-price').value = expense.price; 
            
            document.getElementById('edit-expense-date').value = expense.date || new Date().toISOString().split('T')[0];

            const r = expense.rate || 0.22;
            const t = expense.twd || Math.round(expense.price * r);
            
            document.getElementById('edit-expense-rate').value = r;
            document.getElementById('edit-expense-twd').value = t;

            document.getElementById('edit-expense-photo').value = ''; 
            const modal = document.getElementById('expense-edit-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10); 
        }

        function calcTwdInEdit() {
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            const rate = parseFloat(document.getElementById('edit-expense-rate').value) || 0;
            document.getElementById('edit-expense-twd').value = Math.round(jpy * rate);
        }

        function calcRateInEdit() {
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            const twd = parseFloat(document.getElementById('edit-expense-twd').value) || 0;
            if(jpy !== 0) {
                const newRate = twd / jpy;
                document.getElementById('edit-expense-rate').value = newRate.toFixed(4);
            }
        }

        function closeExpenseEditModal() { const modal = document.getElementById('expense-edit-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); currentExpenseId = null; }, 250); }
        
        function saveExpenseEdit() { 
            if (!currentExpenseId) return; 
            const payer = document.getElementById('edit-expense-payer').value; 
            const type = document.getElementById('edit-expense-type').value; 
            const item = document.getElementById('edit-expense-item').value; 
            const price = parseFloat(document.getElementById('edit-expense-price').value); 
            const rate = parseFloat(document.getElementById('edit-expense-rate').value); 
            const twd = parseFloat(document.getElementById('edit-expense-twd').value); 
            const dateVal = document.getElementById('edit-expense-date').value;
            const fileInput = document.getElementById('edit-expense-photo'); 
            
            if (!item || isNaN(price)) { showToast("è«‹å¡«å¯«å®Œæ•´", 'error'); return; } 
            
            const updateList = (newImg) => { 
                const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                const idx = list.findIndex(e => e.id === currentExpenseId); 
                if (idx > -1) { 
                    list[idx] = { ...list[idx], payer, type, item, price, rate, twd, date: dateVal };
                    if (newImg) list[idx].img = newImg; 
                    
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(list)); 
                    const cleanList = list.map(d => ({...d, img: ''}));
                    saveToCloud('hk_wallet_v20', cleanList);
                    
                    renderExpenseList(); 
                    closeExpenseEditModal(); 
                    showToast("ä¿®æ”¹æˆåŠŸä¸¦åŒæ­¥", 'success');
                }   
            };
            
            if (fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const maxW = 300; const scale = maxW / img.width; 
                        c.width = maxW; c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        updateList(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else { updateList(null); } 
        }        
        function confirmDeleteExpense(id) { deleteTarget = 'expense-single'; deleteExpenseId = id; document.getElementById('confirm-msg').innerText="ç¢ºå®šåˆªé™¤æ­¤ç­†æ¶ˆè²»ï¼Ÿ"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        function clearExpenses() { deleteTarget = 'expense-clear'; document.getElementById('confirm-msg').innerText="ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Ÿ"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        
        function exportData() {
            const wallet = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]');
            const shopping = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
            
            let text = "=== åŒ—æµ·é“å†¬æ—… 2025 è³‡æ–™å‚™ä»½ ===\n\n";
            text += "ã€æ”¯å‡ºç´€éŒ„ã€‘\n";
            let totalJpy = 0;
            let totalTwd = 0;
            wallet.forEach(w => {
                const twd = w.twd || Math.round(w.price * (w.rate || 0.22));
                const typeStr = w.type === 'private' ? ' [ç§è²»]' : ''; // æ¨™è¨»ç§è²»
                totalJpy += w.price;
                totalTwd += twd;
                text += `${w.date} [${w.payer}]${typeStr} ${w.item}: Â¥${w.price.toLocaleString()} (NT$${twd.toLocaleString()})\n`;
            });
            text += `------------------\nç¸½è¨ˆ: Â¥${totalJpy.toLocaleString()} (ç´„ NT$${totalTwd.toLocaleString()})\n\n`;
            
            // ... (å¿…è²·æ¸…å–®éƒ¨åˆ†ä¿æŒä¸è®Š) ...
            text += "ã€å¿…è²·æ¸…å–®ã€‘\n";
            shopping.forEach(s => {
                text += `[${s.done ? 'v' : ' '}] ${s.name} - ${s.desc}\n`;
            });

            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Hokkaido_Backup_${new Date().toLocaleDateString().replace(/\//g,'')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function openSplitBillModal() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const members = ['å°æˆ´', 'ä½³æ¬£', 'ä½³è±', 'çŸå»·']; 
            let totals = {}; members.forEach(m => totals[m] = 0); 
            let grandTotal = 0; 
            
            list.forEach(ex => { 
                if (ex.type === 'private') return; // éæ¿¾ç§è²»
                if (totals[ex.payer] !== undefined) { 
                    const amount = ex.twd !== undefined ? ex.twd : Math.round(ex.price * (ex.rate || 0.22));
                    totals[ex.payer] += amount; 
                    grandTotal += amount; 
                } 
            }); 
            
            const average = grandTotal / members.length; 
            let summaryHtml = ''; 
            members.forEach(m => { 
                const paid = totals[m]; 
                const diff = paid - average; 
                const diffClass = diff >= 0 ? 'text-green-600' : 'text-red-500'; 
                summaryHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-50 last:border-0"><span class="font-bold text-gray-700 dark:text-gray-100 w-16">${m}</span><span class="text-xs text-gray-400">å¢Š NT$${paid.toLocaleString()}</span><span class="font-mono ${diffClass} w-24 text-right">${diff >= 0 ? '+' : ''} $${Math.round(diff).toLocaleString()}</span></div>`; 
            });
            
            document.getElementById('split-summary').innerHTML = summaryHtml; 
            document.getElementById('split-average').innerText = `NT$${Math.round(average).toLocaleString()}`; 
            
            // è¨ˆç®—å»ºè­°çµç®—
            let debtors = []; let creditors = []; 
            members.forEach(m => { 
                const diff = totals[m] - average; 
                if (diff < -1) debtors.push({ name: m, amount: -diff }); 
                else if (diff > 1) creditors.push({ name: m, amount: diff }); 
            }); 
            debtors.sort((a, b) => b.amount - a.amount); 
            creditors.sort((a, b) => b.amount - a.amount); 
            
            let planHtml = ''; 
            let i = 0, j = 0; 
            if(debtors.length === 0 && creditors.length === 0) { 
                planHtml = '<div class="text-center text-green-500 font-bold py-2">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼</div>'; 
            } else { 
                while (i < debtors.length && j < creditors.length) { 
                    let debtor = debtors[i]; let creditor = creditors[j]; 
                    let amount = Math.min(debtor.amount, creditor.amount); 
                    planHtml += `<div class="flex items-center justify-between bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded text-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-700 dark:text-gray-100">${debtor.name}</span><i class="fas fa-long-arrow-alt-right text-gray-400"></i><span class="font-bold text-gray-700 dark:text-gray-100">${creditor.name}</span></div><div class="font-mono font-bold text-muji-accent">NT$${Math.round(amount).toLocaleString()}</div></div>`; 
                    debtor.amount -= amount; creditor.amount -= amount; 
                    if (debtor.amount < 1) i++; 
                    if (creditor.amount < 1) j++; 
                } 
            } 
            document.getElementById('split-plan').innerHTML = planHtml; 
            const modal = document.getElementById('split-bill-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10); 
        }        function closeSplitBillModal() { const modal = document.getElementById('split-bill-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 250); }
        
        // --- UPDATED: CHECKLIST LOGIC (Collapsible, Default Closed) ---
        function initChecklist() {
            // è¨­å®šé è¨­æ¸…å–®åˆ†é¡
            const defaultChecklistData = [
            { category: 'éš¨èº«åŒ…åŒ…', items: ['éŒ¢åŒ…','è­·ç…§','è€³æ©Ÿ','è¡Œå‹•é›»æº','å£ç½©','è—¥','è¡›ç”Ÿæ£‰','è³¼ç‰©è¢‹','é›¨å‚˜','è¢–çåŒ…','æ¿•ç´™å·¾',] },
            { category: 'ç™»æ©Ÿè¡Œæ', items: ['è­·ç…§','ç–«è‹—å¡ã€åœ‹éš›è­·ç…§','AirPods ','å£ç½©','é…’ç²¾','ç­†','ä¿æº«æ¯'] },
            { category: 'åŒ–å¦ã€ä¿é¤Šå“', items: ['é˜²æ›¬','ç²‰åº•æ¶²','çœ‰ç­†','å£ç´…','ç²‰æ’²','å¸å¦æ£‰+æ°´','ä¹³æ¶²','è­·å”‡è†','æ¢³å­','é«®åœˆ','éš±çœ¼','æ­¢æ±—åŠ‘'] },
            { category: 'ç›¥æ´—ç”¨å“', items: ['æ´—é¢ä¹³','ç‰™è† ç‰™åˆ·','æ´—è¡£ç²‰ï¼ˆçƒï¼‰','ä¹¾æ·¨å¤¾éˆè¢‹'] },
            { category: 'è¡£æœ', items: ['è¥ªå­','å…§è¡£','ç´™å…§è¤²','ä¸Šè¡£','ä¸‹èº«','ç¡è¡£','æ‹–é‹','å¸½å­','æ‰‹å¥— åœå·¾','ç™¼ç†±è¡£ è¤²','é«’è¡£è¢‹'] },
            { category: '3C', items: ['æ‰‹æ©Ÿå……é›»å™¨','æ‰‹éŒ¶å……é›»å™¨','è¡Œå‹•é›»æº','è±†è…é ­ + type cç·š','ç›¸æ©Ÿå……é›»å™¨','ç›¸æ©Ÿ'] },
            { category: 'åŒ—æµ·é“æ—…è¡Œç”¨å“', items: ['æ¯›å¸½','ç¾½çµ¨å¤–å¥—','ç™¼ç†±è¡£','ç™¼ç†±è¤²','æ‰‹å¥—','é›ªé´ or é˜²æ°´é‹','éš±çœ¼','å¢¨é¡','æ¯›è¡£','åŠæ¡¶è¥ªï¼ˆåˆ°å°è…¿ - æ»‘é›ªç”¨','é•·è¥ª - ä¸€èˆ¬æ­¥è¡Œ','æš–æš–åŒ…'] },

            ];
            
            const rawData = defaultChecklistData.map(cat => ({ 
                category: cat.category, 
                isOpen: false, 
                items: cat.items.map(txt => ({ txt: txt, done: false })) 
            }));
            
            let stored = JSON.parse(localStorage.getItem('hk_checks_v20'));
            
            // ç¢ºä¿ isOpen å±¬æ€§å­˜åœ¨
            if(stored && Array.isArray(stored)) {
                stored.forEach(g => { if(g.isOpen === undefined) g.isOpen = false; });
            }
            
            if(!stored || !Array.isArray(stored) || stored.length === 0) { 
                stored = rawData; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(stored)); 
            }
            renderChecklist();
        }
        // æ›´æ–°é€²åº¦æ¢
        function renderChecklist() {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            const container = document.getElementById('checklist-groups');
            if (!container) return;
            
            let html = ''; 
            let totalItems = 0; 
            let doneItems = 0;

            if (!Array.isArray(list)) { localStorage.removeItem('hk_checks_v20'); initChecklist(); return; }

            list.forEach((group, catIdx) => {
                if (!group || !group.items) return;
                // åˆ¤æ–·åˆ†é¡æ˜¯å¦å±•é–‹                
                const isOpen = group.isOpen === true; 
                const arrowIcon = isOpen ? 'fa-chevron-up' : 'fa-chevron-down';
                const contentDisplay = isOpen ? 'block' : 'hidden';
                const headerRadius = isOpen ? 'rounded-t-lg' : 'rounded-lg';
                const headerBorder = isOpen ? 'border-b border-gray-100 dark:border-gray-700' : '';

                let groupHtml = '';
                group.items.forEach((item, itemIdx) => {
                    totalItems++; if(item.done) doneItems++;
                    groupHtml += `<div onclick="toggleCheck(${catIdx}, ${itemIdx})" class="flex items-center py-2 border-b border-gray-50 last:border-0 group checklist-item active:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition-colors">
                        <div class="flex items-center cursor-pointer flex-1 min-w-0">
                            <input type="checkbox" class="peer hidden pointer-events-none" ${item.done ? 'checked' : ''}>
                            <div class="w-5 h-5 border-2 border-gray-300 rounded-md peer-checked:bg-muji-accent peer-checked:border-muji-accent flex items-center justify-center transition-colors flex-shrink-0 pointer-events-none">
                                <i class="fas fa-check text-white text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                            </div>
                            <span class="ml-3 text-sm text-gray-600 dark:text-gray-300 peer-checked:line-through peer-checked:text-gray-300 transition-colors select-none truncate pointer-events-none">${item.txt}</span>
                        </div>
                        <button onclick="confirmDeleteCheckItem(${catIdx}, ${itemIdx}); event.stopPropagation();" class="text-gray-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    </div>`;
                });

                html += `
                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm transition-all duration-200">
                    <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 ${headerRadius} ${headerBorder} flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:bg-gray-900 transition select-none" onclick="toggleCheckGroup(${catIdx})">
                        <div class="flex items-center gap-2">
                            <i class="fas ${arrowIcon} text-xs text-gray-400 w-4 text-center"></i>
                            <h4 class="font-bold text-gray-700 dark:text-gray-100 text-sm">${group.category} <span class="text-[10px] text-gray-400 font-normal ml-1">(${group.items.filter(i=>i.done).length}/${group.items.length})</span></h4>
                        </div>
                        <button onclick="confirmDeleteCheckCategory(${catIdx}); event.stopPropagation();" class="text-xs text-gray-300 hover:text-red-400 px-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="${contentDisplay} p-3 pt-0">
                        <div class="space-y-0 mt-2">${groupHtml}</div>
                        <div class="mt-2 pt-2 flex items-center border-t border-gray-50">
                            <input type="text" placeholder="æ–°å¢é …ç›®..." class="flex-1 text-xs bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-transparent hover:bg-white dark:bg-gray-800 hover:border-gray-200 focus:bg-white dark:bg-gray-800 focus:border-muji-accent rounded px-2 py-1 outline-none transition" onchange="addCheckItem(${catIdx}, this)">
                            <button class="ml-2 text-muji-accent text-sm w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 dark:bg-gray-900" onclick="addCheckItemBtn(${catIdx}, this.previousElementSibling)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html; 
            updateChecklistProgress(doneItems, totalItems);
        }
        // æ›´æ–°é€²åº¦æ¢
        function toggleCheckGroup(catIdx) {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20'));
            if (list && list[catIdx]) {
                const current = list[catIdx].isOpen === true;
                list[catIdx].isOpen = !current;
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist();
            }
        }
        // æ–°å¢åˆ†é¡
        function openAddCategoryModal() {
            const modal = document.getElementById('add-category-modal');
            const content = modal.querySelector('div'); // å–å¾—å…§å±¤å¡ç‰‡

            modal.classList.remove('hidden');
            // å»¶é²åŸ·è¡Œ CSS å‹•ç•«ï¼Œè®“è¦–çª—æ¼‚äº®æ·¡å…¥
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
                
                // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
                const input = document.getElementById('new-category-name');
                if(input) input.focus();
            }, 10);
        }
        // é—œé–‰æ–°å¢åˆ†é¡è¦–çª—
        function closeAddCategoryModal() {
        const modal = document.getElementById('add-category-modal');
            const content = modal.querySelector('div');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
        // å„²å­˜æ–°åˆ†é¡
        function saveNewCategory() {
        const input = document.getElementById('new-category-name');
            const name = input.value.trim();
            if (!name) { showToast('è«‹è¼¸å…¥åˆ†é¡åç¨±', 'error'); return; }
            
            // é€™è£¡åŸæœ¬å¯« KEYS.CHECKS å°è‡´å ±éŒ¯ï¼Œå·²ä¿®æ­£ç‚ºæ­£ç¢ºçš„ Key
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            
            // æ–°å¢åˆ†é¡ï¼Œé è¨­ç‚ºå±•é–‹ç‹€æ…‹ (isOpen: true)
            list.push({ category: name, isOpen: true, items: [] });
            
            localStorage.setItem('hk_checks_v20', JSON.stringify(list));
            renderChecklist(); // é‡æ–°æ¸²æŸ“ç•«é¢
            
            input.value = '';
            closeAddCategoryModal();
            showToast('åˆ†é¡æ–°å¢æˆåŠŸ', 'success');
        }
        // æ–°å¢æª¢æŸ¥é …ç›®
        function addCheckItem(catIdx, input) {
            const val = input.value.trim();
            if (!val) return;
            
            // ä¿®æ­£ï¼šæ”¹ç”¨å­—ä¸² 'hk_checks_v20'
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            
            if (list[catIdx]) {
                list[catIdx].items.push({ txt: val, done: false });
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist();
                
                // æ–°å¢å¾Œä¿æŒè¼¸å…¥æ¡†èšç„¦ï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
                input.value = '';
                input.focus(); 
            }
        }
        // æ–°å¢æª¢æŸ¥é …ç›®æŒ‰éˆ•
        function addCheckItemBtn(catIdx, input) {
            addCheckItem(catIdx, input);
        }
        // æ–°å¢æª¢æŸ¥é …ç›®
        function toggleCheck(catIdx, itemIdx) { 
            const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
            if (list && list[catIdx] && list[catIdx].items[itemIdx]) { 
                list[catIdx].items[itemIdx].done = !list[catIdx].items[itemIdx].done; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
            } 
        }
        function confirmDeleteCheckCategory(idx) {
            deleteTarget = 'checklist-cat';
            deleteChecklistCatIdx = idx;
            document.getElementById('confirm-msg').innerHTML = "ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ<br>è£¡é¢çš„é …ç›®ä¹Ÿæœƒä¸€èµ·æ¶ˆå¤±ã€‚";
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function confirmDeleteCheckItem(catIdx, itemIdx) {
            deleteTarget = 'checklist-item';
            deleteChecklistCatIdx = catIdx;
            deleteChecklistItemIdx = itemIdx;
            document.getElementById('confirm-msg').innerText = "ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ";
            document.getElementById('confirm-modal').classList.remove('hidden');
        }
        // --- 1. åˆå§‹åŒ–æ¸…å–® ---
        function initShoppingList() { 
            initShoppingCats();
            // å¾æ‰‹æ©Ÿè¨˜æ†¶é«” (localStorage) è®€å–è³‡æ–™
            let stored = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            if (!stored|| stored.length === 0) { 
                stored = JSON.parse(JSON.stringify(defaultShoppingList)); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(stored)); 
            } 
            // åŸ·è¡Œç•«é¢æ¸²æŸ“
            renderShoppingList(); 
        }
        // --- 2. æ¸²æŸ“ (é¡¯ç¤º) æ¸…å–®ç•«é¢ --
        function renderShoppingList() { 
            // è®€å–è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡çµ¦ç©ºé™£åˆ—
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
            const container = document.getElementById('shopping-container'); 
            // è™•ç†ç¯©é¸é‚è¼¯ (å…¨éƒ¨/è—¥å¦/ä¼´æ‰‹ç¦®...)
            let filteredList = list; 
            if (currentShoppingFilter !== 'all') { 
                filteredList = list.filter(item => item.type === currentShoppingFilter); 
            } 
            // å¦‚æœç›®å‰åˆ†é¡æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤ºæ–‡å­—
            if (filteredList.length === 0) { 
                container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">æ²’æœ‰ç›¸é—œé …ç›®</div>'; 
                return; 
            } 
            // ç”Ÿæˆ HTML
            let html = ''; 
            filteredList.forEach((item) => { 
                // åˆ¤æ–·æ˜¯å¦å·²è³¼è²· (done)ï¼ŒåŠ ä¸ŠåŠé€æ˜å’Œç°éšæ•ˆæœ
                const opacityClass = item.done ? 'opacity-50 grayscale' : ''; 
                const lineThrough = item.done ? 'line-through' : ''; 
                // åˆ‡æ›å‹¾é¸åœ–ç¤ºé¡è‰² (ç¶ è‰²/ç°è‰²
                const checkIcon = item.done ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-200'; 
                // çµ„åˆå–®å€‹å•†å“çš„ HTML å¡ç‰‡
                html += `<div class="flex items-start bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm ${opacityClass} transition-all relative group"><div class="w-16 h-16 rounded-md bg-gray-100 dark:bg-gray-900 bg-cover bg-center shrink-0 cursor-pointer" style="background-image: url('${item.img}')" onclick="openImageModal('${item.img}')"></div><div class="flex-1 px-3 min-w-0"><h4 class="text-sm font-bold text-gray-800 dark:text-gray-100 ${lineThrough} truncate">${item.name}</h4><p class="text-[10px] text-gray-500 mt-1 leading-tight line-clamp-2">${item.desc}</p></div><div class="flex flex-col items-center gap-2 ml-2"><button onclick="toggleShoppingCheck('${item.id}')" class="text-xl focus:outline-none"><i class="fas ${checkIcon}"></i></button><div class="flex gap-2 mt-1"><button onclick="openShoppingModal('${item.id}')" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button><button onclick="confirmDeleteShopping('${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div></div>`; 
            }); 
            container.innerHTML = html; 
        }
        // --- 3. åˆ‡æ›åˆ†é¡æŒ‰éˆ• ---
        function filterShopping(type) { 
            currentShoppingFilter = type; // æ›´æ–°ç›®å‰çš„å…¨åŸŸç¯©é¸ç‹€æ…‹
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼ (é€™æ®µæ˜¯åœ¨åš UI åˆ‡æ›ï¼Œè®“é¸ä¸­çš„æŒ‰éˆ•è®Šè‰²)
            const buttons = document.querySelectorAll('#view-shopping button'); 
            buttons.forEach(btn => { 
                if(btn.parentElement.classList.contains('overflow-x-auto')) { 
                    // åˆ¤æ–·æŒ‰éˆ•æ–‡å­—æ˜¯å¦å°æ‡‰ç›®å‰çš„ type
                    if(btn.textContent === (type==='all'?'å…¨éƒ¨':(type==='drug'?'è—¥å¦':(type==='souvenir'?'ä¼´æ‰‹ç¦®':'å…¶ä»–')))) { 
                        // é¸ä¸­æ¨£å¼ (æ·±è‰²èƒŒæ™¯)
                        btn.className = "px-3 py-1 bg-muji-accent text-white rounded-full text-xs whitespace-nowrap shadow-sm"; 
                    } else { 
                        // æœªé¸ä¸­æ¨£å¼ (ç™½è‰²èƒŒæ™¯)
                        btn.className = "px-3 py-1 bg-white dark:bg-gray-800 border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap"; 
                    } 
                } 
            }); 
            renderShoppingList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }
        // --- 4. åˆ‡æ›è³¼è²·ç‹€æ…‹ (æ‰“å‹¾/å–æ¶ˆ) ---
        function toggleShoppingCheck(id) { 
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            const item = list.find(i => i.id === id); // æ‰¾åˆ°è©²å•†å“
            if (item) { 
                item.done = !item.done; // åè½‰ç‹€æ…‹
                localStorage.setItem('hk_shopping_v20', JSON.stringify(list)); // å­˜æª”
                renderShoppingList(); // æ›´æ–°ç•«é¢
            } 
        }
        // --- 5. é–‹å•Ÿæ–°å¢/ç·¨è¼¯è¦–çª— ---
// --- å¿…è²·æ¸…å–®åˆ†é¡ç®¡ç†ç³»çµ± ---

    // 1. åˆå§‹åŒ–åˆ†é¡ (å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œå‰‡å»ºç«‹é è¨­å€¼)
    function initShoppingCats() {
        let cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20'));
        if (!cats || cats.length === 0) {
            cats = [
                { id: 'drug', name: 'è—¥å¦' },
                { id: 'souvenir', name: 'ä¼´æ‰‹ç¦®' },
                { id: 'other', name: 'å…¶ä»–' }
            ];
            localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));
        }
        renderShoppingFilters();
    }

    // 2. æ¸²æŸ“ç¯©é¸æŒ‰éˆ• (åŒ…å«åˆªé™¤æŒ‰éˆ•) ---
    function renderShoppingFilters() {
        const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
        const container = document.getElementById('shopping-filter-container');
        if(!container) return;

        let html = '';
        
        // (A) "å…¨éƒ¨" æŒ‰éˆ• (æ°¸é å­˜åœ¨ï¼Œä¸å¯åˆªé™¤)
        const isAllActive = currentShoppingFilter === 'all';
        html += `<button onclick="filterShopping('all')" class="px-3 py-1 rounded-full text-xs whitespace-nowrap shadow-sm transition-colors flex items-center ${isAllActive ? 'bg-muji-accent text-white' : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-300'}">å…¨éƒ¨</button>`;

        // (B) å‹•æ…‹åˆ†é¡æŒ‰éˆ•
        cats.forEach(cat => {
            const isActive = currentShoppingFilter === cat.id;
            const style = isActive 
                ? 'bg-muji-accent text-white pr-2' // é¸å–æ™‚å³é‚Šå¤šç•™é»ç©ºé–“çµ¦ X æŒ‰éˆ•
                : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-300';
            
            // åªæœ‰åœ¨ã€Œé¸å–ç‹€æ…‹ã€æ‰é¡¯ç¤ºåˆªé™¤éˆ•
            // event.stopPropagation() å¾ˆé‡è¦ï¼Œé¿å…é» X æ™‚åˆè§¸ç™¼ä¸€æ¬¡æŒ‰éˆ•é»æ“Š
            const deleteBtn = isActive 
                ? `<span onclick="confirmDeleteShopCat('${cat.id}'); event.stopPropagation();" class="ml-2 w-4 h-4 flex items-center justify-center bg-white/20 rounded-full hover:bg-red-500 hover:text-white transition cursor-pointer" title="åˆªé™¤æ­¤åˆ†é¡"><i class="fas fa-times text-[10px]"></i></span>` 
                : '';

            html += `<button onclick="filterShopping('${cat.id}')" class="px-3 py-1 rounded-full text-xs whitespace-nowrap shadow-sm transition-colors flex items-center ${style}">
                ${cat.name} ${deleteBtn}
            </button>`;
        });

        // (C) æ–°å¢åˆ†é¡æŒ‰éˆ• (+)
        html += `<button onclick="openAddShopCatModal()" class="w-7 h-6 rounded-full border border-dashed border-gray-400 text-gray-400 flex items-center justify-center hover:border-muji-accent hover:text-muji-accent transition shrink-0"><i class="fas fa-plus text-[10px]"></i></button>`;

        container.innerHTML = html;
    }

    // --- æ–°å¢ï¼šç¢ºèªåˆªé™¤åˆ†é¡çš„å‡½å¼ ---
    let deleteShopCatId = null; // å…¨åŸŸè®Šæ•¸æš«å­˜

    function confirmDeleteShopCat(id) {
        deleteTarget = 'shop-cat'; // è¨­å®šåˆªé™¤ç›®æ¨™ç‚ºã€Œåˆ†é¡ã€
        deleteShopCatId = id;      // è¨˜ä½è¦åˆªé™¤å“ªå€‹ ID
        
        // å‘¼å«ç¢ºèªè¦–çª—
        document.getElementById('confirm-msg').innerHTML = "ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ<br><b>è©²åˆ†é¡ä¸‹çš„æ‰€æœ‰å•†å“ä¹Ÿæœƒè¢«åˆªé™¤ï¼</b>";
        document.getElementById('confirm-modal').classList.remove('hidden');
        setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);
    }
    // 3. ä¿®æ”¹åŸæœ‰çš„ filterShopping ä»¥æ”¯æ´é‡æ–°æ¸²æŸ“æŒ‰éˆ•ç‹€æ…‹
    // (è«‹ç¢ºèªä½ çš„åŸå§‹ç¨‹å¼ç¢¼ä¸­ filterShopping æ˜¯å¦å·²è¢«æ­¤å–ä»£ï¼Œæˆ–æ‰‹å‹•æ›´æ–°å®ƒ)
    const originalFilterShopping = filterShopping; // å‚™ä»½èˆŠçš„è‹¥éœ€è¦
    filterShopping = function(type) {
        currentShoppingFilter = type;
        renderShoppingFilters(); // é‡ç¹ªæŒ‰éˆ•é¡è‰²
        renderShoppingList();    // é‡ç¹ªæ¸…å–®å…§å®¹
    };

    // 4. é–‹å•Ÿ/é—œé–‰æ–°å¢åˆ†é¡è¦–çª—
    function openAddShopCatModal() {
        const modal = document.getElementById('add-shop-cat-modal');
        const content = modal.querySelector('div');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
            document.getElementById('new-shop-cat-name').focus();
        }, 10);
    }

    function closeAddShopCatModal() {
        const modal = document.getElementById('add-shop-cat-modal');
        const content = modal.querySelector('div');
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        setTimeout(() => { modal.classList.add('hidden'); }, 250);
    }

    // 5. å„²å­˜æ–°åˆ†é¡
    function saveNewShopCat() {
        const input = document.getElementById('new-shop-cat-name');
        const name = input.value.trim();
        if(!name) { showToast('è«‹è¼¸å…¥åˆ†é¡åç¨±', 'error'); return; }

        const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
        
        // ç”¢ç”Ÿç°¡æ˜“ ID (ä¾‹å¦‚: cat_173666123)
        const newId = 'cat_' + Date.now();
        
        cats.push({ id: newId, name: name });
        localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));
        
        // é‡æ–°æ¸²æŸ“ä¸¦åˆ‡æ›åˆ°æ–°åˆ†é¡
        renderShoppingFilters();
        filterShopping(newId); // è‡ªå‹•åˆ‡æ›åˆ°æ–°åˆ†é¡
        
        input.value = '';
        closeAddShopCatModal();
        showToast('åˆ†åˆ†é¡æ–°å¢æˆåŠŸ', 'success');
    }

    // â˜…é‡è¦æ›´æ–°â˜…ï¼šä¿®æ”¹é–‹å•Ÿç·¨è¼¯è¦–çª—åŠŸèƒ½ï¼Œè®“ä¸‹æ‹‰é¸å–®(Select)è‡ªå‹•æŠ“å–æœ€æ–°åˆ†é¡
        function openShoppingModal(id) { 
            currentShoppingId = id; 
            const modal = document.getElementById('shopping-edit-modal'); 
            const title = document.getElementById('shopping-modal-title'); 
            const typeSelect = document.getElementById('shop-type');

            // --- å‹•æ…‹ç”Ÿæˆä¸‹æ‹‰é¸å–®é¸é … ---
            const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
            let optionsHtml = '';
            cats.forEach(cat => {
                optionsHtml += `<option value="${cat.id}">${cat.name}</option>`;
            });
            typeSelect.innerHTML = optionsHtml;
            // ---------------------------

            document.getElementById('shop-name').value = ''; 
            // é è¨­é¸å–ç›®å‰çš„ç¯©é¸åˆ†é¡ (å¦‚æœæ˜¯ 'all' å‰‡é¸ç¬¬ä¸€å€‹)
            document.getElementById('shop-type').value = (currentShoppingFilter !== 'all') ? currentShoppingFilter : cats[0].id;
            document.getElementById('shop-desc').value = ''; 
            document.getElementById('shop-photo').value = ''; 

            if(id) { 
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
                const item = list.find(i => i.id === id); 
                if(item) { 
                    title.innerText = "ç·¨è¼¯å¿…è²·"; 
                    document.getElementById('shop-name').value = item.name; 
                    document.getElementById('shop-type').value = item.type; 
                    document.getElementById('shop-desc').value = item.desc; 
                } 
            } else { 
                title.innerText = "æ–°å¢å¿…è²·"; 
            }

            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modal.querySelector('div').classList.remove('scale-95'); 
                modal.querySelector('div').classList.add('scale-100'); 
            }, 10);
        }
        // --- 6. é—œé–‰è¦–çª— ---
        function closeShoppingModal() { 
            const modal = document.getElementById('shopping-edit-modal'); 
            modal.classList.add('opacity-0'); 
            modal.querySelector('div').classList.remove('scale-100'); 
            modal.querySelector('div').classList.add('scale-95'); 
            setTimeout(() => { modal.classList.add('hidden'); currentShoppingId = null; }, 250); 
        }
        // --- 7. å„²å­˜å•†å“ (å«åœ–ç‰‡å£“ç¸®) ---
        function saveShoppingItem() {
            const name = document.getElementById('shop-name').value.trim();
            const type = document.getElementById('shop-type').value;
            const desc = document.getElementById('shop-desc').value.trim();
            const fileInput = document.getElementById('shop-photo');

            if (!name) { alert('è«‹è¼¸å…¥å•†å“åç¨±'); return; }
            //å…§éƒ¨å‡½å¼ï¼šè™•ç†è³‡æ–™å„²å­˜ (æœƒåœ¨åœ–ç‰‡è™•ç†å®Œå¾Œè¢«å‘¼å«)
            const processSave = (img) => {
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                
                if (currentShoppingId) {
                    // --- ç·¨è¼¯æ¨¡å¼ï¼šæ‰¾åˆ°è©²é …ç›®ä¸¦æ›´æ–° --
                    const idx = list.findIndex(i => i.id === currentShoppingId);
                    if (idx > -1) {
                        list[idx].name = name;
                        list[idx].type = type;
                        list[idx].desc = desc;
                        if (img) list[idx].img = img;// åªæœ‰ç•¶æœ‰æ–°åœ–ç‰‡æ™‚æ‰æ›´æ–°
                    }
                } else {
                    // --- æ–°å¢æ¨¡å¼ï¼šå»ºç«‹æ–°ç‰©ä»¶ ---
                    const newItem = {
                        id: 'c' + Date.now(),// ç”¨æ™‚é–“æˆ³è¨˜ç•¶ ID
                        type: type,
                        name: name,
                        desc: desc,
                        done: false,
                        img: img || 'https://placehold.co/100x100/e5e7eb/4b5563?text=No+Img'
                    };
                    list.unshift(newItem);// åŠ åˆ°æœ€å‰é¢
                }

                try {
                    localStorage.setItem('hk_shopping_v20', JSON.stringify(list));
                    renderShoppingList();
                    closeShoppingModal();
                    // å¦‚æœç•¶ä¸‹ä¸åœ¨é€™å€‹åˆ†é¡ï¼Œè‡ªå‹•åˆ‡æ›éå»è®“ä½¿ç”¨è€…çœ‹åˆ°
                    if (currentShoppingFilter !== 'all' && currentShoppingFilter !== type) {
                        filterShopping(type);
                    }
                } catch (e) {
                    alert("å„²å­˜å¤±æ•—");
                    console.error(e);
                }
            };
            // --- åœ–ç‰‡è™•ç†é‚è¼¯ ---
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // ä½¿ç”¨ Canvas é€²è¡Œåœ–ç‰‡å£“ç¸® (å› ç‚º LocalStorage å®¹é‡æœ‰é™)
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        const maxW = 300;
                        const scale = maxW / img.width;
                        c.width = maxW;
                        c.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        processSave(c.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                // æ²’æœ‰ä¸Šå‚³åœ–ç‰‡ï¼Œç›´æ¥å„²å­˜
                processSave(null);
            }
        }
        // --- 8. åˆªé™¤ç¢ºèª ---
        function confirmDeleteShopping(id) { 
            deleteTarget = 'shopping'; // æ¨™è¨˜è¦åˆªé™¤çš„é¡å‹
            deleteShoppingId = id; // æ¨™è¨˜è¦åˆªé™¤çš„ ID
            document.getElementById('confirm-modal').classList.remove('hidden');// å‘¼å«å…±ç”¨çš„ç¢ºèªè¦–çª—
        }
        // --- åˆ‡æ›æ¸…å–®é ç±¤ ---
        function toggleListTab(tab) {
            const viewCheck = document.getElementById('view-checklist');
            const viewShop = document.getElementById('view-shopping');
            const btnCheck = document.getElementById('btn-checklist');
            const btnShop = document.getElementById('btn-shopping');
            
            // --- å®šç¾©æ¨£å¼å­—ä¸² (æœ€ç©©å®šçš„æ–¹æ³•) ---
            
            // 1. ç°è‰² (æœªé¸å–ç‹€æ…‹)
            const styleInactive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-medium text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300";
            
            // 2. ç¶ è‰² (è¡Œå‰æº–å‚™ - é¸å–ç‹€æ…‹)
            const styleCheckActive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-emerald-600 dark:text-emerald-400";
            
            // 3. ç²‰è‰² (å¿…è²·æ¸…å–® - é¸å–ç‹€æ…‹)
            const styleShopActive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-pink-500 dark:text-pink-400";

            if (tab === 'checklist') {
                // åˆ‡æ›å…§å®¹é¡¯ç¤º
                viewCheck.classList.remove('hidden');
                viewShop.classList.add('hidden');
                
                // å¼·åˆ¶å¥—ç”¨æ¨£å¼
                btnCheck.className = styleCheckActive; // å·¦é‚Šè®Šç¶ 
                btnShop.className = styleInactive;     // å³é‚Šè®Šç°
                
            } else {
                // åˆ‡æ›å…§å®¹é¡¯ç¤º
                viewShop.classList.remove('hidden');
                viewCheck.classList.add('hidden');
                
                // å¼·åˆ¶å¥—ç”¨æ¨£å¼
                btnCheck.className = styleInactive;    // å·¦é‚Šè®Šç°
                btnShop.className = styleShopActive;   // å³é‚Šè®Šç²‰ç´…
            }
        }
        function initMemo() { const txt = localStorage.getItem('hk_memo_v2') || ''; if(document.getElementById('memo-area')) { document.getElementById('memo-area').value = txt; renderMemoLinks(txt); } }
        function saveMemo() { const txt = document.getElementById('memo-area').value; localStorage.setItem('hk_memo_v2', txt); renderMemoLinks(txt); alert('å·²å„²å­˜'); }
        function renderMemoLinks(txt) { const matches = txt.match(/(https?:\/\/[^\s]+)/g); const container = document.getElementById('memo-links'); if(matches) { container.innerHTML = matches.map(url => `<a href="${url}" target="_blank" class="block truncate text-xs text-blue-500 bg-blue-50 p-2 rounded hover:bg-blue-100"><i class="fas fa-link mr-1"></i>${url}</a>`).join(''); } else { container.innerHTML = '<span class="text-[10px] text-gray-300">å°šç„¡é€£çµ</span>'; } }
        
        // æ–°å¢ï¼šæ›´æ–°æ¸…å–®é€²åº¦æ¢
        function updateChecklistProgress(doneItems = 0, totalItems = 0) {
            // è‹¥å‘¼å«æ™‚æœªå‚³åƒï¼Œå˜—è©¦å¾ localStorage è¨ˆç®—
            try {
                const bar = document.getElementById('progress-bar');
                const text = document.getElementById('progress-text');
                if (!bar || !text) return;
                if (totalItems === 0) {
                    const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
                    let total = 0, done = 0;
                    list.forEach(g => { if (g.items) g.items.forEach(i => { total++; if (i.done) done++; }); });
                    totalItems = total; doneItems = done;
                }
                const percent = totalItems > 0 ? Math.round((doneItems / totalItems) * 100) : 0;
                bar.style.width = percent + '%';
                text.innerText = percent + '%';
            } catch (e) {
                console.warn('updateChecklistProgress error', e);
            }
        }

        // --- TIME CHAINING LOGIC ---
        // æ–°å¢ï¼šç•¶è¡Œç¨‹çµæŸæ™‚é–“æ”¹è®Šæ™‚ï¼Œè‡ªå‹•èª¿æ•´å¾ŒçºŒè¡Œç¨‹
        function adjustSchedule(dayIdx, changedEvtIdx, newEndTime) {
            const dayEvents = itineraryData[dayIdx].events;
           
            // ç°¡å–®å¯¦ä½œï¼šå¦‚æœä¸‹ä¸€å€‹è¡Œç¨‹æ˜¯äº¤é€šç§»å‹•ï¼Œå˜—è©¦å°‡å…¶é–‹å§‹æ™‚é–“è¨­ç‚ºç•¶å‰çµæŸæ™‚é–“ + ç·©è¡
            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„é‚è¼¯ï¼šå¦‚æœä¸‹ä¸€å€‹è¡Œç¨‹æ˜¯ "äº¤é€šç§»å‹•(move)"ï¼Œå‰‡å°‡å…¶é–‹å§‹æ™‚é–“è¨­ç‚ºç•¶å‰çµæŸæ™‚é–“
            // é€™è£¡åƒ…åšåŸºæœ¬æ™‚é–“å­—ä¸²è™•ç†ï¼Œè‹¥è¦ç²¾ç¢ºéœ€è½‰ Date ç‰©ä»¶
            // ç‚ºäº†ä¸ç ´å£è¤‡é›œè¡Œç¨‹ï¼Œé€™è£¡æš«æ™‚åƒ…ä½œç‚ºæ‰‹å‹•è§¸ç™¼æç¤º
        }

        function openEditModal(dayIdx, evtIdx) {
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx;
            const modal = document.getElementById('edit-modal');
            const content = modal.querySelector('div');
            const btnDelete = document.getElementById('btn-delete');
            const title = document.getElementById('modal-title');
            
            // å–å¾—æ¬„ä½å…ƒä»¶
            const startInput = document.getElementById('edit-start');
            const endInput = document.getElementById('edit-end');
            const durHInput = document.getElementById('edit-duration-h');
            const durMInput = document.getElementById('edit-duration-m');

            if (evtIdx === -1) { 
                // --- æ–°å¢æ¨¡å¼ ---
                title.innerText = "æ–°å¢è¡Œç¨‹"; 
                btnDelete.classList.add('hidden'); 
                
                // é è¨­æ™‚é–“ï¼šæ¥çºŒä¸Šä¸€å€‹è¡Œç¨‹
                const dayEvents = itineraryData[dayIdx].events;
                let defaultStart = "09:00";
                if (dayEvents.length > 0) {
                    const lastEvt = dayEvents[dayEvents.length - 1];
                    if (lastEvt.time && lastEvt.time.includes('~')) {
                        defaultStart = lastEvt.time.split('~')[1].trim();
                    }
                }

                startInput.value = defaultStart; 
                
                // é è¨­åœç•™ 1 å°æ™‚ 0 åˆ†
                durHInput.value = 1;
                durMInput.value = 0;

                // è‡ªå‹•è¨ˆç®—çµæŸæ™‚é–“
                const endMin = timeToMin(defaultStart) + 60;
                endInput.value = minToTime(endMin);

                // æ¸…ç©ºå…¶ä»–æ¬„ä½
                document.getElementById('edit-title').value = ""; 
                document.getElementById('edit-type').value = "spot"; 
                document.getElementById('edit-note').value = ""; 
                document.getElementById('edit-station').value = ""; 
                document.getElementById('edit-tags').value = ""; 
            } 
            else { 
                // --- ç·¨è¼¯æ¨¡å¼ ---
                const evt = itineraryData[dayIdx].events[evtIdx]; 
                title.innerText = "ç·¨è¼¯è¡Œç¨‹"; 
                btnDelete.classList.remove('hidden'); 
                
                const times = evt.time ? evt.time.split('~') : ['','']; 
                const sStr = times[0].trim();
                const eStr = times[1] ? times[1].trim() : '';

                startInput.value = sStr; 
                endInput.value = eStr; 

                // â˜… è‡ªå‹•è¨ˆç®—ç›®å‰çš„åœç•™æ™‚é–“ (æ‹†è§£ç‚º æ™‚:åˆ†)
                if (sStr && eStr) {
                    let diff = timeToMin(eStr) - timeToMin(sStr);
                    if (diff < 0) diff += 1440; // è™•ç†è·¨æ—¥
                    
                    const h = Math.floor(diff / 60);
                    const m = diff % 60;
                    
                    durHInput.value = h;
                    durMInput.value = m;
                } else {
                    durHInput.value = 1;
                    durMInput.value = 0;
                }

                document.getElementById('edit-title').value = evt.title; 
                document.getElementById('edit-type').value = evt.type || 'spot'; 
                document.getElementById('edit-note').value = evt.note || ''; 
                document.getElementById('edit-station').value = evt.station || ''; 
                document.getElementById('edit-tags').value = evt.tags ? evt.tags.join(', ') : ''; 
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
            document.body.classList.add('modal-active');
        }
        // --- æ™‚é–“æ¬„ä½é€£å‹•é‚è¼¯ (æ™‚:åˆ† ç‰ˆ) ---
        function syncTime(source) {
            const startInput = document.getElementById('edit-start');
            const endInput = document.getElementById('edit-end');
            const durHInput = document.getElementById('edit-duration-h');
            const durMInput = document.getElementById('edit-duration-m');

            // å–å¾—ç›®å‰æ•¸å€¼
            const startVal = startInput.value;
            const endVal = endInput.value;
            
            // å–å¾—åœç•™æ™‚é–“ (æ™‚/åˆ†)ï¼Œè‹¥ç‚ºç©ºå‰‡è¦–ç‚º 0
            let h = parseInt(durHInput.value) || 0;
            let m = parseInt(durMInput.value) || 0;
            let totalDurationMin = (h * 60) + m;

            if (!startVal) return; 

            const startMin = timeToMin(startVal);
            
            // é‚è¼¯ A: ä¿®æ”¹ã€Œé–‹å§‹ã€æˆ–ã€Œåœç•™æ™‚é–“(æ™‚/åˆ†)ã€ -> è‡ªå‹•ç®—ã€ŒçµæŸã€
            if (source === 'start' || source === 'duration') {
                if (totalDurationMin === 0 && source === 'start') {
                    // å¦‚æœåªæ˜¯æ”¹é–‹å§‹æ™‚é–“ä¸”æŒçºŒæ™‚é–“ç‚º0ï¼Œé è¨­çµ¦ 60 åˆ†é˜æ–¹ä¾¿æ“ä½œ
                    totalDurationMin = 60;
                    durHInput.value = 1;
                    durMInput.value = 0;
                }
                const newEndMin = startMin + totalDurationMin;
                endInput.value = minToTime(newEndMin);
            }
            
            // é‚è¼¯ B: ä¿®æ”¹ã€ŒçµæŸã€ -> è‡ªå‹•åæ¨ã€Œåœç•™æ™‚é–“ (æ™‚:åˆ†)ã€
            else if (source === 'end') {
                if (!endVal) return;
                const endMin = timeToMin(endVal);
                
                // è™•ç†è·¨æ—¥
                let diff = endMin - startMin;
                if (diff < 0) diff += 24 * 60; 
                
                // æ›ç®—å› æ™‚:åˆ†
                const newH = Math.floor(diff / 60);
                const newM = diff % 60;

                durHInput.value = newH;
                durMInput.value = newM;
            }
        }
        function closeModal() {
            const modal = document.getElementById('edit-modal'); const content = modal.querySelector('div');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); currentDayIdx = null; currentEvtIdx = null; }, 250);
        }
        // --- æ ¸å¿ƒé‚è¼¯ Bï¼šæ•´é«”è‡ªå‹•æ’ç¨‹ (éª¨ç‰Œæ•ˆæ‡‰) ---
        function autoAdjustSchedule(dayIdx) {
            const events = itineraryData[dayIdx].events;

            // 1. ä¾ç…§ã€Œé–‹å§‹æ™‚é–“ã€æ’åº
            events.sort((a, b) => {
                const startA = timeToMin(a.time);
                const startB = timeToMin(b.time);
                return startA - startB;
            });

            // 2. ç¢ºä¿æ²’æœ‰è¡Œç¨‹ã€Œé¨ã€åœ¨å¦ä¸€å€‹è¡Œç¨‹é ­ä¸Š (ç°¡æ˜“éª¨ç‰Œ)
            for (let i = 0; i < events.length - 1; i++) {
                const current = events[i];
                const next = events[i+1];

                if (!current.time || !next.time) continue;

                const [currStart, currEnd] = current.time.split('~').map(s => s.trim());
                if (!currEnd) continue;
                
                const currEndMin = timeToMin(currEnd);
                const nextStartMin = timeToMin(next.time);

                // å¦‚æœ [ç•¶å‰çµæŸ] > [ä¸‹å€‹é–‹å§‹]ï¼Œä»£è¡¨é‚„æœ‰é‡ç–Š (é€šå¸¸æ˜¯ resolveInsertConflicts å¾ŒçºŒç”¢ç”Ÿçš„æ¨æ“ )
                // æŠŠä¸‹ä¸€å€‹è¡Œç¨‹å¾€å¾Œæ¨
                if (currEndMin > nextStartMin) {
                    const nextDuration = getDuration(next);
                    const newNextStart = currEndMin;
                    const newNextEnd = newNextStart + nextDuration;
                    next.time = `${minToTime(newNextStart)} ~ ${minToTime(newNextEnd)}`;
                }
            }
        }
        // --- æ ¸å¿ƒé‚è¼¯ Cï¼šç·Šæ¹Šæ’åˆ— (æ‹–æ›³æ’åºå°ˆç”¨) ---
        // é‡æ–°è¨ˆç®—æ‰€æœ‰è¡Œç¨‹ï¼Œè®“å®ƒå€‘åƒç«è»Šè»Šå»‚ä¸€æ¨£ç·Šå¯†ç›¸é€£ï¼Œå¡«è£œç©ºéš™
        function resequenceEvents(dayIdx) {
            const events = itineraryData[dayIdx].events;
            if (events.length === 0) return;

            // 1. æ‰¾å‡ºç•¶å¤©ã€Œæœ€æ—©ã€çš„é–‹å§‹æ™‚é–“ä½œç‚ºèµ·é» (éŒ¨é»)
            let minStart = 24 * 60; 
            let hasValidTime = false;

            events.forEach(evt => {
                if (evt.time && evt.time.includes('~')) {
                    const start = timeToMin(evt.time.split('~')[0]);
                    if (start < minStart) {
                        minStart = start;
                        hasValidTime = true;
                    }
                }
            });

            // å¦‚æœéƒ½æ²’å¡«æ™‚é–“ï¼Œé è¨­å¾ 09:00 (540åˆ†) é–‹å§‹
            if (!hasValidTime) minStart = 540; 

            // 2. ä¾ç…§ç•¶å‰çš„æ–°é †åºï¼Œé‡æ–°ä¸²æ¥æ™‚é–“
            let currentStart = minStart;

            events.forEach(evt => {
                // å–å¾—è©²è¡Œç¨‹åŸæœ¬çš„æŒçºŒæ™‚é–“ (Duration)
                const duration = getDuration(evt);
                
                // è¨ˆç®—æ–°çš„çµæŸæ™‚é–“
                const newEnd = currentStart + duration;

                // æ›´æ–°æ™‚é–“å­—ä¸²
                evt.time = `${minToTime(currentStart)} ~ ${minToTime(newEnd)}`;

                // ä¸‹ä¸€å€‹è¡Œç¨‹çš„é–‹å§‹ = é€™å€‹è¡Œç¨‹çš„çµæŸ
                currentStart = newEnd;
            });
        }
        // --- åˆªé™¤å¾Œçš„è‡ªå‹•éè£œ (å¸é™„é‚è¼¯) ---
        function shiftEventsBack(dayIdx, startIndex, durationMinutes) {
            const events = itineraryData[dayIdx].events;
            
            // å¾è¢«åˆªé™¤çš„ä½ç½®é–‹å§‹ï¼ŒæŠŠå¾Œé¢æ‰€æœ‰çš„è¡Œç¨‹éƒ½å¾€å‰ç§»
            for (let i = startIndex; i < events.length; i++) {
                const evt = events[i];
                if (!evt.time) continue;

                const parts = evt.time.split('~');
                const startStr = parts[0].trim();
                const endStr = parts[1] ? parts[1].trim() : null;
                if (!startStr) continue;

                const currentStartMin = timeToMin(startStr);
                // å¾€å‰ç§»å‹•ï¼Œä½†ä¸èƒ½å°æ–¼ 0
                const newStartMin = Math.max(0, currentStartMin - durationMinutes);
                
                let newTimeStr = minToTime(newStartMin);

                if (endStr) {
                    const currentEndMin = timeToMin(endStr);
                    const newEndMin = Math.max(0, currentEndMin - durationMinutes);
                    newTimeStr += ` ~ ${minToTime(newEndMin)}`;
                }
                evt.time = newTimeStr;
            }
        }        
        // --- å„²å­˜è¡Œç¨‹ (æ•´åˆç‰ˆ) ---
        function saveEvent() {
            if (currentDayIdx === null) return;
            const start = document.getElementById('edit-start').value;
            const end = document.getElementById('edit-end').value;
            const title = document.getElementById('edit-title').value;

            if (!title) { showToast('è«‹è¼¸å…¥æ¨™é¡Œ', 'error'); return; }

            const originalEvt = (currentEvtIdx > -1) ? itineraryData[currentDayIdx].events[currentEvtIdx] : {};
            
            const newEvent = {
                time: (start && end) ? `${start} ~ ${end}` : (start || ''),
                title,
                type: document.getElementById('edit-type').value,
                note: document.getElementById('edit-note').value,
                station: document.getElementById('edit-station').value,
                tags: document.getElementById('edit-tags').value ? document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(s => s) : [],
                story: originalEvt.story || "",
                tips: originalEvt.tips || ""
            };

            let targetIdx = currentEvtIdx;

            // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ç·¨è¼¯
            if (currentEvtIdx === -1) {
                itineraryData[currentDayIdx].events.push(newEvent);
                targetIdx = itineraryData[currentDayIdx].events.length - 1; // å–å¾—æ–°åŠ å…¥çš„ç´¢å¼•
            } else {
                itineraryData[currentDayIdx].events[currentEvtIdx] = newEvent;
            }

            // â˜… æ­¥é©Ÿ 1: å…ˆåŸ·è¡Œã€Œæ’æ–¥é‚è¼¯ã€
            // ç¢ºä¿æ–°è¡Œç¨‹(targetIdx)æŠŠé‡ç–Šçš„èˆŠè¡Œç¨‹è¸¢é–‹
            resolveInsertConflicts(currentDayIdx, targetIdx);

            // â˜… æ­¥é©Ÿ 2: å†åŸ·è¡Œã€Œå…¨é«”æ’åºèˆ‡æ•´ç†ã€
            // ç¢ºä¿è¢«è¸¢é–‹çš„è¡Œç¨‹æ•´é½Šæ’åˆ—
            autoAdjustSchedule(currentDayIdx);

            // å­˜æª”èˆ‡åŒæ­¥
            localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
            saveToCloud('hk_itinerary_v20', itineraryData);

            renderPlan();
            closeModal();
            showToast("è¡Œç¨‹å·²æ›´æ–°ä¸¦è‡ªå‹•èª¿æ•´", "success");
        }
    </script>   
    <!-- Service Worker Registration with Cache Busting -->
    <script>
        if ('serviceWorker' in navigator) {
            // åªåœ¨ http(s) åŸå§‹ä½ç½®è¨»å†Š Service Workerï¼Œé¿å… file:// æ‹‹éŒ¯
            if (location.protocol === 'http:' || location.protocol === 'https:') {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js?v=' + new Date().getTime())
                        .then((reg) => {
                            console.log('Service Worker è¨»å†ŠæˆåŠŸ:', reg);
                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            console.log('æ–°å…§å®¹å·²ä¸‹è¼‰ï¼Œå³å°‡é‡æ–°æ•´ç†...');
                                            window.location.reload();
                                        }
                                    }
                                };
                            };
                        })
                        .catch((err) => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
                });
            } else {
                console.log('è·³é Service Worker è¨»å†Šï¼ˆé http/https å”å®šï¼‰');
            }
        }
    </script>
</body>
</html>