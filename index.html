<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æµ·é“å†¬æ—… 2025</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#7d6c5e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#f9f9f9', card: '#ffffff', text: '#4a4a4a', subtext: '#8a8a8a',
                            accent: '#7d6c5e', highlight: '#a84a32', border: '#e5e5e5',
                            transport: '#eff6ff', transportText: '#3b82f6',
                            spot: '#f0fdf4', spotText: '#15803d',
                            food: '#fff7ed', foodText: '#c2410c',
                            shop: '#fdf2f8', shopText: '#be185d',
                            active: '#2d3748',
                            move: '#f3f4f6'
                        }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },
                    boxShadow: { 'soft': '0 4px 20px rgba(0, 0, 0, 0.05)', 'card': '0 1px 3px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f9f9f9; color: #4a4a4a; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; animation: fadeIn 0.25s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .timeline-line::before { content: ''; position: absolute; top: 16px; bottom: -16px; left: 18px; width: 2px; background: #e5e5e5; z-index: 0; }
        .timeline-line:last-child::before { display: none; }
        .timeline-line.type-move::before { border-left: 2px dashed #cbd5e1; background: transparent; width: 0; }

        .tag-must-eat { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .tag-must-buy { background-color: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; }
        .tag-reserve { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-transport { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        
        .event-active { background-color: #2d3748 !important; color: white !important; border-left-color: #a84a32 !important; box-shadow: 0 0 15px rgba(45, 55, 72, 0.3); }
        .event-active h4, .event-active .transport-detail { color: white !important; }
        .event-active span, .event-active p, .event-active i { color: #cbd5e0 !important; }
        
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }

        .fab-btn { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .fab-btn:active { transform: scale(0.9); }
        .checklist-item { cursor: pointer; user-select: none; }
        .checklist-item:active { background-color: #f3f4f6; }

        /* Toast Notification */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(45, 55, 72, 0.95); color: white; padding: 12px 20px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; text-align: center; backdrop-filter: blur(4px); pointer-events: auto; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: rgba(220, 38, 38, 0.95); }
        .toast.success { background: rgba(22, 163, 74, 0.95); }

        /* Error Input Animation */
        .input-error { border-color: #ef4444 !important; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Progress Bar */
        #progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex justify-center overflow-hidden font-sans">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- App Container -->
    <div class="w-full max-w-md h-full bg-muji-bg flex flex-col relative shadow-2xl overflow-hidden mx-auto">
        
        <!-- Header -->
        <header class="bg-muji-card px-5 py-4 shadow-sm z-20 flex justify-between items-center shrink-0 border-b border-gray-100 select-none">
            <div>
                <h1 class="text-xl font-serif font-bold text-muji-accent tracking-widest">HOKKAIDO</h1>
                <p class="text-[10px] text-muji-subtext tracking-wider uppercase">Winter Trip 2025</p>
            </div>
            <div class="text-right">
                <div class="w-8 h-8 bg-muji-accent rounded-full flex items-center justify-center text-white shadow-sm" onclick="showToast('æ­¡è¿ä¾†åˆ°åŒ—æµ·é“ï¼è¨˜å¾—ç©¿æš–å’Œé»ã€‚', 'info')">
                    <i class="fas fa-snowflake animate-pulse"></i>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative" id="main-container">
            
            <!-- SECTION: PLAN (è¡Œç¨‹) -->
            <section id="plan" class="tab-content active h-full">
                <div class="flex flex-col h-full p-4 pb-0">
                    <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-3 pb-1" id="date-scroll-container"></div>
                    <div id="plan-weather-card" class="mb-3"></div>
                    <div id="itinerary-list" class="space-y-4 pb-24 flex-1 overflow-y-auto hide-scrollbar pr-1"></div>
                    
                    <button onclick="openEditModal(currentSelectedDayIndex, -1)" class="fab-btn absolute bottom-6 right-4 w-14 h-14 bg-muji-accent text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white">
                        <i class="fas fa-plus text-2xl"></i>
                    </button>
                    <div class="absolute bottom-6 left-4 z-30">
                        <button onclick="resetItinerary()" class="text-[10px] text-gray-300 underline hover:text-red-400 bg-white/80 px-2 py-1 rounded backdrop-blur-sm">æ¢å¾©é è¨­</button>
                    </div>
                </div>
            </section>

            <!-- SECTION: GUIDE (å°è¦½) -->
            <section id="guide" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-20 overflow-y-auto hide-scrollbar">
                    
                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">æœ­å¹Œæ·±åº¦å°è¦½</h2>
                    
                    <h3 class="font-bold text-gray-700 mb-3 mt-2 flex items-center"><i class="fas fa-shopping-basket text-blue-500 mr-2"></i>åœ¨åœ°è¶…å¸‚æ–‡åŒ–é«”é©—</h3>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 mb-6">
                        <p class="text-xs text-gray-500 mb-4 leading-relaxed">é«”é©—æ—¥æœ¬åœ¨åœ°ç”Ÿæ´»æœ€å¥½çš„æ–¹å¼å°±æ˜¯é€›è¶…å¸‚ï¼ä»¥ä¸‹æ¨è–¦è·é›¢æ‚¨ä½å®¿ï¼ˆä¸­å³¶å…¬åœ’ï¼‰èˆ‡ç‹¸å°è·¯è¡Œç¨‹é †è·¯çš„è¶…å¸‚ã€‚</p>
                        <div class="space-y-5">
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800">ğŸ“ é£¯åº—å‘¨é‚Š (ä¸­å³¶å…¬åœ’)</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-blue-600">MaxValu å—7æ¡åº—</span><p class="text-[10px] text-gray-500">24å°æ™‚ç‡Ÿæ¥­ï¼Œè¦æ¨¡ä¸­ç­‰ä½†æ‡‰æœ‰ç›¡æœ‰ã€‚</p></div>
                                    <div><span class="text-xs font-bold text-orange-500">Seicomart</span><p class="text-[10px] text-gray-500">åŒ—æµ·é“æœ€å¼·è¶…å•†ï¼Œå¿…åƒ Hot Chef ç†Ÿé£Ÿã€‚</p></div>
                                </div>
                            </div>
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800">ğŸ“ ç‹¸å°è·¯å‘¨é‚Š</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-yellow-600">MEGA å”å‰è»»å¾·</span><p class="text-[10px] text-gray-500">B1/B2 ç”Ÿé®®è¶…å¸‚å€éå¸¸å¼·å¤§ï¼</p></div>
                                    <div><span class="text-xs font-bold text-green-600">æ¥­å‹™è¶…å¸‚</span><p class="text-[10px] text-gray-500">ä»¥å¤§ä»½é‡ã€è¶…ä½åƒ¹èåã€‚</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3 class="font-bold text-gray-700 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>æœ­å¹Œç§æˆ¿å‚™æ¡ˆ</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">è—»å²©å±±å¤œæ™¯</h4><span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded">æ–°ä¸‰å¤§å¤œæ™¯</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">å¦‚æœå¤©æ°£å¥½ï¼Œé€™è£¡çš„å¤œæ™¯æ¯”é›»è¦–å¡”æ›´å£¯è§€ï¼æ­ä¹˜çºœè»Šä¸Šå±±ï¼Œä¿¯ç°æ•´å€‹æœ­å¹Œå¸‚çš„å¯¶çŸ³èˆ¬ç‡ˆç«ã€‚</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Mt.+Moiwa+Ropeway" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">ç™½è‰²æˆ€äººå…¬åœ’</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">ç«¥è©±å·¥å» </span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">åƒæ˜¯èµ°é€²æŸ¥ç†çš„å·§å…‹åŠ›å·¥å» ï¼å¯ä»¥åƒè§€é¤…ä¹¾ç”Ÿç”¢ç·šï¼Œå†¬å¤©é‚„æœ‰æˆ¶å¤–ç‡ˆé£¾ã€‚</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">æ‹‰éºµä¿¡ç„ (å—6æ¡åº—)</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">æ’éšŠååº—</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">åœ¨åœ°äººæ¨è–¦çš„å‘³å™Œæ‹‰éºµï¼Œå°±åœ¨é£¯åº—é™„è¿‘ï¼Œé©åˆç•¶å®µå¤œï¼</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Ramen+Shingen+Minami+6-jo" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    </div>

                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">å°æ¨½ï¼å ºç”ºé€šæ·±åº¦å°è¦½</h2>
                    <h3 class="font-bold text-gray-700 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>æ®¿å ‚ç´šç”œé» (ä¸€ç´šæˆ°å€)</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">LeTAO æœ¬åº—</h4><span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded">ç”œé»ç‹è€…</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">å°æ¨½çš„ç”œé»ç‹è€…ã€‚å¿…åƒé›™å±¤ä¹³é…ªè›‹ç³• (Double Fromage) èˆ‡æœ¬åº—é™å®šç”Ÿä¹³æ²ã€‚äºŒæ¨“ Cafe æ°£æ°›æ¥µä½³ã€‚</p>
                            <a href="https://maps.app.goo.gl/54aXLQnse6L5XZg87" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">åŒ—è“æ¨“ å°æ¨½æœ¬é¤¨ </h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">çŸ³é€ å€‰åº«</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">å…§éƒ¨å……æ»¿æ­·å²æ„Ÿã€‚å¿…åƒã€Œå¤¢ä¸æ€è­°ã€å¤§æ³¡èŠ™ï¼Œå¤–çš®é…¥è„†å…§é¤¡çˆ†æ¼¿ï¼ŒCPå€¼è¶…é«˜ï¼å¦–ç²¾ä¹‹æ£®å¹´è¼ªè›‹ç³•ä¹Ÿæ˜¯æ‹›ç‰Œã€‚</p>
                            <a href="https://maps.app.goo.gl/Xp6VTXTAbiNfM2H26" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">å…­èŠ±äº­ å°æ¨½é‹æ²³åº—</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">è²·ç”œé»é€å’–å•¡</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">å°±åœ¨åŒ—è“æ¨“éš”å£ã€‚å¿…è²·è˜­å§†è‘¡è„å¥¶æ²¹å¤¾å¿ƒé¤…ä¹¾ï¼Œæœ‰å–®åŒ…è£å¯æŒ‘é¸ã€‚äºŒæ¨“è³¼ç‰©æ»¿é¡å¸¸æœ‰è¶…ä¾¿å®œæˆ–å…è²»å’–å•¡</p>
                            <a href="https://maps.app.goo.gl/fwqHMy3mo1ULhRRY8" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>ç‰¹è‰²IP èˆ‡æ•£æ­¥ç¾é£Ÿ</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">ã‹ã¾æ „ å·¥å ´ç›´ç‡Ÿåº— (Kamaei)</h4><span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-1 rounded">éºµåŒ…æ²</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">é€™æ˜¯å°æ¨½ç•¶åœ°äººä¹Ÿæ„›çš„é­šæ¿è€åº—ï¼é›–ç„¶ç¨å¾®åé›¢å ºç”ºé€šå°¾ç«¯ã‡é»é»ï¼ˆé è¿‘é‹æ²³æœ«ç«¯ï¼‰ï¼Œä½†éå¸¸å€¼å¾—èµ°éå»ã€‚</p>
                            <a href="https://maps.app.goo.gl/7Yga5HtPn211SZDk9" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800">æ˜†å¸ƒå°ˆé–€åº— åˆ©å°»å±‹ Minoya</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">æ¹¯éœœæ˜†å¸ƒ</span></div>
                            <p class="text-xs text-gray-600 mb-2 relative z-10">é–€å£æ‹›ç‰Œå¯«è‘—ã€Œçˆ¸çˆ¸å¦‚æœä¸è²·ï¼Œå°±æ˜¯åª½åª½çš„ä¸å°ï¼ˆãŠçˆ¶ã•ã‚“é ã‹ã‚Šã¾ã™ï¼‰ã€ï¼Œéå¸¸å¹½é»˜çš„åº—å®¶ã€‚</p>
                            <a href="https://maps.app.goo.gl/XW1s3Ygy77Yh1D2u6" target="_blank" class="text-xs text-indigo-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>å°èˆªå»é€™è£¡</a>
                        </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-map mr-2 text-green-500"></i>å°æ¨½å ºç”ºé€šã‚Šå•†åº—è¡—</h3>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1 font-bold">å‰ä¼Šå¡å“‡é¢¨æ ¼åº—å®¶åˆ†å¸ƒåœ–</p>
                            <img src="Otaru.jpg" 
                                 onerror="this.src='https://placehold.co/600x400?text=Otaru+Map'" 
                                 class="w-full rounded-lg shadow-sm border border-gray-100 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50" 
                                 onclick="openImageModal(this.src)">

                        </div>
                    </div>
                           

                </div>
            </section>
            <!-- SECTION: WALLET (éŒ¢åŒ…) -->
            <section id="wallet" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-20 overflow-y-auto hide-scrollbar">
                    
                    <!-- ç²¾ç·»ç‰ˆåŒ¯ç‡å¡ç‰‡ -->
                    <div class="bg-gradient-to-br from-stone-600 to-stone-700 text-white p-3 rounded-xl shadow-lg mb-4 shrink-0 relative overflow-hidden">
                        <div class="flex justify-between items-center mb-1 opacity-90">
                            <div class="flex flex-col">
                                <h3 class="text-[10px] uppercase tracking-widest font-bold">åŒ¯ç‡æ›ç®—</h3>
                                <span id="rate-update-time" class="text-[8px] text-gray-300">æ›´æ–°ä¸­...</span>
                            </div>
                            <div class="text-[10px] bg-white/20 px-2 py-0.5 rounded flex items-center gap-1">
                                <span class="mr-1">x</span>
                                <input type="number" id="exchange-rate" value="0.22" class="w-12 bg-transparent text-center focus:outline-none font-mono font-bold text-yellow-300" step="0.0001" inputmode="decimal" onfocus="this.select()">
                                <button onclick="fetchExchangeRate(true)" class="ml-1 w-4 h-4 flex items-center justify-center bg-white/10 rounded-full hover:bg-white/30 transition"><i class="fas fa-sync-alt text-[8px]"></i></button>
                            </div>
                        </div>
                        <div class="flex items-end gap-2 justify-between">
                            <div class="flex-1">
                                <div class="flex items-baseline border-b border-white/20 pb-1">
                                    <span class="text-xs opacity-60 mr-2">JPY</span>
                                    <input type="number" id="jpy-input" placeholder="0" class="w-full bg-transparent text-xl font-mono font-bold focus:outline-none placeholder-white/30" inputmode="decimal" onfocus="this.select()">
                                </div>
                            </div>
                            <div class="text-white/50 pb-1"><i class="fas fa-arrow-right text-xs"></i></div>
                            <div class="flex-1 text-right">
                                <div class="border-b border-white/20 pb-1">
                                    <div id="twd-output" class="text-2xl font-mono font-bold text-yellow-300 leading-none">0</div>
                                </div>
                            </div>
                            <span class="text-xs opacity-60 pb-1">TWD</span>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-card mb-6 shrink-0">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm flex justify-between">
                            <span>æ–°å¢è¨˜å¸³ <span class="text-[10px] text-gray-400 font-normal">(é–å®šåŒ¯ç‡)</span></span>
                            <!-- æ–°å¢æ—¥æœŸæ¬„ä½ -->
                            <input type="date" id="expense-date" class="text-[10px] border border-gray-200 rounded px-1 text-gray-500 bg-gray-50">
                        </h3>
                        <div class="flex gap-2 mb-3">
                            <select id="expense-payer" class="w-24 px-2 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent"><option value="å°æˆ´">å°æˆ´</option><option value="ä½³æ¬£">ä½³æ¬£</option><option value="ä½³è±">ä½³è±</option><option value="çŸå»·">çŸå»·</option></select>
                            <input type="text" id="expense-item" placeholder="å“é …åç¨±" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent">
                        </div>
                        <div class="flex gap-2 mb-3"><input type="number" id="expense-price" placeholder="é‡‘é¡ (æ—¥å¹£)" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent" onfocus="this.select()"></div>
                        <div class="flex gap-2">
                             <label class="flex-1 flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-pointer hover:bg-gray-200 transition text-sm"><i class="fas fa-camera mr-2"></i> <span id="photo-label">æ‹ç…§</span><input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="document.getElementById('photo-label').innerText = 'å·²é¸æ“‡'"></label>
                            <button onclick="addExpense()" class="flex-1 bg-muji-accent text-white py-2 rounded-lg shadow-sm hover:opacity-90 transition text-sm font-medium"><i class="fas fa-plus mr-1"></i> å„²å­˜</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-2 px-1 shrink-0"><h3 class="font-bold text-gray-600 text-sm">æ”¯å‡ºç´€éŒ„</h3><div class="flex items-center gap-2"><button onclick="openSplitBillModal()" class="text-xs bg-white text-muji-accent border border-muji-accent px-2 py-1 rounded hover:bg-muji-accent hover:text-white transition"><i class="fas fa-calculator mr-1"></i>æŸ¥çœ‹åˆ†å¸³</button><span id="total-expense" class="text-xs font-mono font-bold text-muji-accent">Total: Â¥0</span></div></div>
                    <div class="space-y-3 pb-8 flex-1" id="expense-list"></div>
                    <div class="text-center shrink-0 flex gap-3 justify-center">
                        <button onclick="clearExpenses()" class="text-xs text-red-300 underline py-2">æ¸…é™¤è³‡æ–™</button>
                        <button onclick="exportData()" class="text-xs text-blue-400 underline py-2"><i class="fas fa-file-export mr-1"></i>åŒ¯å‡ºå‚™ä»½ (txt)</button>
                    </div>
                </div>
            </section>

            <!-- SECTION: LISTS (æ¸…å–®) -->
            <section id="lists" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-0">
                    <div class="flex bg-gray-200 p-1 rounded-xl mb-4 shrink-0">
                        <button class="flex-1 py-2 text-sm rounded-lg transition-all font-bold bg-white shadow-sm text-gray-800" id="btn-checklist" onclick="toggleListTab('checklist')">è¡Œå‰æº–å‚™</button>
                        <button class="flex-1 py-2 text-sm rounded-lg transition-all font-medium text-gray-500 hover:text-gray-700" id="btn-shopping" onclick="toggleListTab('shopping')">å¿…è²·æ¸…å–®</button>
                    </div>
                    <div id="view-checklist" class="flex-1 overflow-y-auto hide-scrollbar pb-24">
                         <div class="bg-white rounded-xl shadow-card overflow-hidden mb-4">
                            <div class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-500">æº–å‚™é€²åº¦</span>
                                <div class="flex items-center gap-2"><div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div></div><span id="progress-text" class="text-xs font-mono text-gray-600">0%</span></div>
                            </div>
                            <div id="checklist-groups" class="p-3 space-y-4"></div>
                            <div class="p-3 border-t border-gray-100 bg-gray-50">
                                <button onclick="openAddCategoryModal()" class="w-full py-2 border border-dashed border-gray-300 rounded text-gray-400 text-xs hover:border-muji-accent hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> æ–°å¢åˆ†é¡</button>
                            </div>
                        </div>
                    </div>
                    <div id="view-shopping" class="hidden flex-1 flex flex-col h-full overflow-hidden relative">
                        <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar shrink-0">
                            <button onclick="filterShopping('all')" class="px-3 py-1 bg-muji-accent text-white rounded-full text-xs whitespace-nowrap shadow-sm">å…¨éƒ¨</button>
                            <button onclick="filterShopping('drug')" class="px-3 py-1 bg-white border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap">è—¥å¦</button>
                            <button onclick="filterShopping('souvenir')" class="px-3 py-1 bg-white border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap">ä¼´æ‰‹ç¦®</button>
                            <button onclick="filterShopping('other')" class="px-3 py-1 bg-white border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap">å…¶ä»–</button>
                        </div>
                        <div id="shopping-container" class="flex-1 overflow-y-auto hide-scrollbar space-y-3 pb-24"></div>
                        <button onclick="openShoppingModal(null)" class="fab-btn absolute bottom-24 right-4 w-14 h-14 bg-muji-shopText text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white">
                            <i class="fas fa-plus text-2xl"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- SECTION: INFO -->
            <section id="info" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-20 overflow-y-auto hide-scrollbar">
                    
                    <!-- Flight Info -->
                    <div class="bg-white p-4 rounded-xl shadow-card mb-4 border-l-4 border-blue-400 shrink-0">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-plane mr-2 text-blue-400"></i>èˆªç­è³‡è¨Š</h3></div>
                        <div class="mb-3 pb-3 border-b border-gray-100">
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">å»ç¨‹ 12/18 (å››)</span></div>
                            <div class="flex justify-between items-end mb-1"><span class="block text-lg font-bold text-gray-800">06:15 TPE</span><i class="fas fa-plane text-gray-300 transform rotate-90"></i><span class="block text-lg font-bold text-gray-800">11:00 CTS</span></div>
                            <div class="text-[10px] text-gray-500">BR166 | Airbus A321 (29A-D)</div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1"><span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">å›ç¨‹ 12/23 (äºŒ)</span></div>
                            <div class="flex justify-between items-end mb-1"><span class="block text-lg font-bold text-gray-800">15:20 CTS</span><i class="fas fa-plane text-gray-300 transform rotate-90"></i><span class="block text-lg font-bold text-gray-800">19:05 TPE</span></div>
                            <div class="text-[10px] text-gray-500">BR115 | Boeing (29F-K)</div>
                        </div>
                    </div>
                    
                    <!-- Hotel Info Card -->
                    <div class="bg-white p-5 rounded-xl shadow-card mb-4 border-l-4 border-indigo-400 shrink-0">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-hotel mr-2 text-indigo-400"></i>ä½å®¿è³‡è¨Š</h3>
                            <a href="https://www.google.com/maps/search/?api=1&query=æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—" target="_blank" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition"><i class="fas fa-location-arrow mr-1"></i>å°èˆª</a>
                        </div>
                        <div class="space-y-3">
                            <div><h4 class="font-bold text-base text-gray-800">æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—</h4><p class="text-xs text-gray-500">Hotel JAL City Sapporo Nakajima Park</p></div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <p class="text-xs text-gray-400 mb-1">æ—¥æ–‡åœ°å€</p>
                                <p class="text-lg font-bold text-gray-800 leading-relaxed select-all">ã€’064-0808 <br>åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒºå—ï¼˜æ¡è¥¿ï¼“ä¸ç›®ï¼‘âˆ’ï¼’ï¼•</p>
                            </div>
                            <div><p class="text-xs text-gray-400 mb-1">è‹±æ–‡åœ°å€</p><p class="text-xs text-gray-600 font-mono">1-25, Minami 8-jo Nishi 3-chome, Chuo-ku, Sapporo 064-0808</p></div>
                        </div>
                    </div>

                    <!-- Emergency Contact (NEW) -->
                    <div class="bg-white p-4 rounded-xl shadow-card mb-4 border-l-4 border-red-500 shrink-0">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-exclamation-circle mr-2 text-red-500"></i>ç·Šæ€¥è¯çµ¡</h3></div>
                        <div class="space-y-3">
                             <div>
                                <p class="text-xs text-gray-500 mb-1 font-bold">å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•æœ­å¹Œåˆ†è™•</p>
                                <div class="flex items-center justify-between bg-red-50 p-2 rounded">
                                    <a href="tel:+81112222930" class="text-sm font-bold text-red-600"><i class="fas fa-phone mr-2"></i>+81-11-222-2930</a>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1">åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®å€åŒ—4æ¢è¥¿4ä¸ç›®1ç•ªåœ° ä¼Šè—¤å¤§æ¨“5æ¨“</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•æœ­å¹Œåˆ†è™•" target="_blank" class="text-[10px] text-blue-500 underline mt-1 block"><i class="fas fa-location-arrow mr-1"></i>å°èˆª</a>
                            </div>
                        </div>
                    </div>

                    <!-- Transportation Maps -->
                    <div class="bg-white p-4 rounded-xl shadow-card mb-4 border-l-4 border-green-500 shrink-0">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-map mr-2 text-green-500"></i>äº¤é€šè·¯ç·šåœ–</h3>
                        </div>
                        <div class="space-y-3">
                            <div><p class="text-xs text-gray-500 mb-1 font-bold">æœ­å¹Œåœ°éµè·¯ç·šåœ–</p><img src="route_map_h_t.jpg" onerror="this.src='https://placehold.co/600x400?text=Subway+Map'" class="w-full rounded-lg shadow-sm border border-gray-100 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50" onclick="openImageModal(this.src)"></div>
                            <div><p class="text-xs text-gray-500 mb-1 font-bold">JR åŒ—æµ·é“è¿‘éƒŠè·¯ç·šåœ–</p><img src="route_map_sapporo.jpg" onerror="this.src='https://placehold.co/600x400?text=JR+Map'" class="w-full rounded-lg shadow-sm border border-gray-100 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50" onclick="openImageModal(this.src)"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6 shrink-0">
                        <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition"><i class="fas fa-cloud-sun text-3xl text-blue-400"></i><span class="text-sm font-bold text-gray-600">å¤©æ°£é å ±</span></a>
                        <a href="tel:119" class="bg-red-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition"><i class="fas fa-ambulance text-3xl text-red-400"></i><span class="text-sm font-bold text-gray-600">ç·Šæ€¥ 119</span></a>
                    </div>
                </div>
            </section>

        </main>

        <!-- Navbar -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center py-1 px-1 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] z-30 shrink-0 min-h-[60px] select-none pb-safe">
            <button class="nav-btn group w-1/5" data-target="info"><div class="flex flex-col items-center gap-0.5"><div class="w-9 h-7 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10"><i class="fas fa-info-circle text-base text-gray-400 group-[.active]:text-muji-accent transition-colors"></i></div><span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent">è³‡è¨Š</span></div></button>
            <button class="nav-btn group w-1/5" data-target="lists"><div class="flex flex-col items-center gap-0.5"><div class="w-9 h-7 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10"><i class="fas fa-check-square text-base text-gray-400 group-[.active]:text-muji-accent transition-colors"></i></div><span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent">æ¸…å–®</span></div></button>
            <button class="nav-btn active group w-1/5" data-target="plan"><div class="flex flex-col items-center gap-0.5 transition-all"><div class="w-11 h-9 rounded-2xl flex items-center justify-center bg-gray-200 group-[.active]:bg-muji-accent shadow-sm group-[.active]:shadow-md group-[.active]:scale-105 transition-all duration-300"><i class="fas fa-map-marked-alt text-lg text-gray-400 group-[.active]:text-white transition-colors"></i></div><span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent group-[.active]:font-bold">è¡Œç¨‹</span></div></button>
            <button class="nav-btn group w-1/5" data-target="wallet"><div class="flex flex-col items-center gap-0.5"><div class="w-9 h-7 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10"><i class="fas fa-wallet text-base text-gray-400 group-[.active]:text-muji-accent transition-colors"></i></div><span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent">éŒ¢åŒ…</span></div></button>
            <button class="nav-btn group w-1/5" data-target="guide"><div class="flex flex-col items-center gap-0.5"><div class="w-9 h-7 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10"><i class="fas fa-book-reader text-base text-gray-400 group-[.active]:text-muji-accent transition-colors"></i></div><span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent">å°è¦½</span></div></button>
        </nav>

        <!-- MODALS -->
        <div id="view-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden opacity-0 transition-opacity flex items-end sm:items-center justify-center"><div class="bg-white rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-sm max-h-[85vh] overflow-hidden transform translate-y-full sm:translate-y-0 sm:scale-95 transition-transform duration-300 flex flex-col"><div class="h-32 bg-gray-200 relative shrink-0"><img id="view-img" src="" class="w-full h-full object-cover"><button onclick="closeViewModal()" class="absolute top-3 right-3 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur-sm hover:bg-black/50 transition"><i class="fas fa-times"></i></button><button onclick="switchToEdit()" class="absolute top-3 right-12 w-8 h-8 bg-white/90 rounded-full text-gray-600 flex items-center justify-center shadow-sm hover:text-muji-accent transition"><i class="fas fa-pen text-xs"></i></button></div><div class="p-5 overflow-y-auto"><div class="flex justify-between items-start mb-3"><h3 class="text-xl font-bold text-gray-800 leading-tight" id="view-title">æ¨™é¡Œ</h3><span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded" id="view-type">é¡å‹</span></div><div class="flex items-center text-sm text-gray-500 mb-4 font-mono"><i class="far fa-clock mr-2 text-muji-accent"></i> <span id="view-time">00:00</span></div><div class="mb-4"><h4 class="text-xs font-bold text-muji-accent uppercase tracking-wider mb-2 border-b pb-1">ä»‹ç´¹ & æ•…äº‹</h4><p class="text-sm text-gray-600 leading-relaxed text-justify" id="view-story">æš«ç„¡ä»‹ç´¹...</p></div><div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-100"><h4 class="text-xs font-bold text-yellow-700 mb-2 flex items-center"><i class="fas fa-lightbulb mr-2"></i>æ”»ç•¥ & æ¨è–¦</h4><p class="text-sm text-yellow-800 leading-relaxed" id="view-tips">æš«ç„¡æ”»ç•¥...</p></div><div class="mb-6"><h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">å‚™è¨»</h4><p class="text-sm text-gray-500" id="view-note">-</p></div><a href="#" id="view-map-btn" target="_blank" class="block w-full bg-muji-accent text-white text-center py-3 rounded-lg font-bold shadow-md hover:opacity-90 transition"><i class="fas fa-location-arrow mr-2"></i> é–‹å•Ÿ Google Maps</a></div></div></div>
        
        <!-- EDIT MODAL -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold text-gray-700" id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3><button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="p-5 space-y-4">
            <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label><input type="time" id="edit-start" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ™‚é–“</label><input type="time" id="edit-end" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none"></div></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label><select id="edit-type" class="w-full p-2 border border-gray-200 rounded text-sm"><option value="move">äº¤é€šç§»å‹• (è»Šç¨‹)</option><option value="spot">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shop">è³¼ç‰©</option><option value="transport">äº¤é€š (è»Šç«™/æ©Ÿå ´)</option><option value="stay">ä½å®¿</option></select></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ¨™é¡Œ <span class="text-red-500">*</span></label><input type="text" id="edit-title" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="å¿…å¡«"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (æˆ–äº¤é€šæ–¹å¼)</label><textarea id="edit-note" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æœ€è¿‘è»Šç«™ (é¸å¡«)</label><input type="text" id="edit-station" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ¨™ç±¤</label><input type="text" id="edit-tags" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
            <div class="text-[10px] text-gray-400 bg-gray-50 p-2 rounded">ğŸ’¡ æç¤ºï¼šä¿®æ”¹çµæŸæ™‚é–“å¾Œï¼Œå¾ŒçºŒçš„äº¤é€šèˆ‡è¡Œç¨‹æ™‚é–“æœƒè‡ªå‹•é †å»¶ã€‚</div>
        </div><div class="p-4 border-t border-gray-100 flex gap-3"><button type="button" onclick="deleteEvent()" id="btn-delete" class="px-4 py-2 bg-red-50 text-red-500 rounded text-sm hidden">åˆªé™¤</button><button type="button" onclick="saveEvent()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜</button></div></div></div>

        <!-- EXPENSE EDIT MODAL -->
        <div id="expense-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold text-gray-700">ç·¨è¼¯æ”¯å‡º</h3><button type="button" onclick="closeExpenseEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="p-5 space-y-4">
            <div class="flex gap-2"><div class="w-1/3"><label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label><select id="edit-expense-payer" class="w-full p-2 border border-gray-200 rounded text-sm"><option value="å°æˆ´">å°æˆ´</option><option value="ä½³æ¬£">ä½³æ¬£</option><option value="ä½³è±">ä½³è±</option><option value="çŸå»·">çŸå»·</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">å“é … <span class="text-red-500">*</span></label><input type="text" id="edit-expense-item" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="å¿…å¡«"></div></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥æœŸ</label><input type="date" id="edit-expense-date" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50"></div>
            <div class="grid grid-cols-2 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">æ—¥å¹£é‡‘é¡ <span class="text-red-500">*</span></label><input type="number" id="edit-expense-price" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50" oninput="calcTwdInEdit()" placeholder="0" onfocus="this.select()"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">ç•¶æ™‚åŒ¯ç‡</label><input type="number" id="edit-expense-rate" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50" step="0.0001" oninput="calcTwdInEdit()" onfocus="this.select()"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å°å¹£é‡‘é¡ (å¯å¾®èª¿)</label><input type="number" id="edit-expense-twd" class="w-full p-2 border border-gray-200 rounded text-sm font-bold text-muji-accent" oninput="calcRateInEdit()" onfocus="this.select()"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">ç…§ç‰‡</label><input type="file" id="edit-expense-photo" accept="image/*" class="w-full text-xs"></div></div><div class="p-4 border-t border-gray-100 flex gap-3"><button type="button" onclick="saveExpenseEdit()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜ä¿®æ”¹</button></div></div></div>
        
        <!-- SPLIT BILL MODAL -->
        <div id="split-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold text-gray-700">åˆ†å¸³çµæœ</h3><button type="button" onclick="closeSplitBillModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="p-5"><div class="mb-6"><h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å„äººä»£å¢Šç¸½é¡ (ä»¥å°å¹£è¨ˆ)</h4><div id="split-summary" class="space-y-2 text-sm"></div><div class="mt-3 pt-2 border-t border-gray-100 text-right"><span class="text-xs text-gray-400 mr-2">å¹³å‡:</span><span id="split-average" class="font-bold text-muji-text"></span></div></div><div><h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å»ºè­°çµç®— (å°å¹£)</h4><div id="split-plan" class="space-y-2"></div></div></div></div></div>
        
        <!-- SHOPPING MODAL -->
        <div id="shopping-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold text-gray-700" id="shopping-modal-title">æ–°å¢å¿…è²·</h3><button type="button" onclick="closeShoppingModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="p-5 space-y-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">å•†å“åç¨± <span class="text-red-500">*</span></label><input type="text" id="shop-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="å¿…å¡«"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡</label><select id="shop-type" class="w-full p-2 border border-gray-200 rounded text-sm"><option value="drug">è—¥å¦ä¿å¥</option><option value="souvenir">ä¼´æ‰‹ç¦®</option><option value="other">å…¶ä»–/é›»å™¨</option></select></div><div><label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨» (è¦æ ¼/æ•¸é‡)</label><textarea id="shop-desc" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea></div><div><label class="block text-xs font-bold text-gray-500 mb-1">åœ–ç‰‡</label><input type="file" id="shop-photo" accept="image/*" class="w-full text-xs"></div></div><div class="p-4 border-t border-gray-100 flex gap-3"><button type="button" onclick="saveShoppingItem()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">å„²å­˜</button></div></div></div>
        
        <!-- ADD CATEGORY MODAL -->
        <div id="add-category-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200"><div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"><h3 class="font-bold text-gray-700">æ–°å¢åˆ†é¡</h3><button type="button" onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="p-5"><input type="text" id="new-category-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="åˆ†é¡åç¨±"></div><div class="p-4 border-t border-gray-100 flex gap-3"><button type="button" onclick="saveNewCategory()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">æ–°å¢</button></div></div></div>
        
        <!-- CONFIRM MODAL (Unified) -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4"><div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-5 text-center transform scale-95 transition-transform duration-200" id="confirm-box"><h3 class="font-bold text-gray-700 text-lg mb-2">ç¢ºèªæ“ä½œ</h3><p class="text-sm text-gray-500 mb-6" id="confirm-msg">æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p><div class="flex gap-3 justify-center"><button type="button" onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition">å–æ¶ˆ</button><button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition shadow-sm">ç¢ºèª</button></div></div></div>
        
        <!-- IMAGE VIEWER -->
        <div id="image-view-modal" class="fixed inset-0 z-[80] hidden overflow-hidden"> <div class="absolute inset-0 bg-black/95 transition-opacity" onclick="closeImageModal()"></div> <div class="absolute inset-0 flex items-center justify-center pointer-events-none"> <div class="relative w-full h-full flex items-center justify-center overflow-hidden"> <img id="image-view-src" src="" class="max-w-full max-h-full object-contain pointer-events-auto cursor-grab transition-transform duration-100 origin-center select-none" draggable="false"> </div> </div> <button onclick="closeImageModal()" class="absolute top-6 right-6 w-10 h-10 bg-white/20 rounded-full text-white flex items-center justify-center hover:bg-white/40 transition z-50 backdrop-blur-md"> <i class="fas fa-times text-lg"></i> </button> <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none"> <span class="bg-black/50 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm">é›™æ“Š/æ»¾è¼ªç¸®æ”¾ â€¢ æ‹–æ›³ç§»å‹•</span> </div> </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // --- IMAGE ZOOM & PAN LOGIC (å‡ç´šç‰ˆï¼šæ”¯æ´é›™æŒ‡ç¸®æ”¾) ---
        let imgScale = 1;
        let imgPosX = 0;
        let imgPosY = 0;
        let isDragging = false;
        let startX = 0, startY = 0;
        
        // é›™æŒ‡ç¸®æ”¾å°ˆç”¨è®Šæ•¸
        let initialPinchDist = 0;
        let startScale = 1;

        // é–‹å•Ÿåœ–ç‰‡
        function openImageModal(src) {
            const modal = document.getElementById('image-view-modal');
            const img = document.getElementById('image-view-src');
            
            img.src = src;
            modal.classList.remove('hidden');
            
            // é‡ç½®ç‹€æ…‹
            resetZoom();
            addZoomListeners(img);
        }

        // é—œé–‰åœ–ç‰‡
        function closeImageModal() {
            const modal = document.getElementById('image-view-modal');
            modal.classList.add('hidden');
            const img = document.getElementById('image-view-src');
            removeZoomListeners(img);
        }

        function resetZoom() {
            imgScale = 1;
            imgPosX = 0;
            imgPosY = 0;
            initialPinchDist = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            const img = document.getElementById('image-view-src');
            // é™åˆ¶ä½ç§»ç¯„åœï¼Œé¿å…åœ–ç‰‡é£›å‡ºè¦–çª—å¤ªé  (å¯é¸)
            img.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${imgScale})`;
            img.style.cursor = imgScale > 1 ? 'grab' : 'default';
        }

        // è¨ˆç®—å…©æŒ‡è·é›¢çš„è¼”åŠ©å‡½æ•¸
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy); //ç•¢æ°å®šç†è¨ˆç®—è·é›¢
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---
        function addZoomListeners(img) {
            // 1. é›»è…¦ç‰ˆæ»¾è¼ªç¸®æ”¾
            img.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.2 : 0.2;
                let newScale = imgScale + delta;
                newScale = Math.min(Math.max(1, newScale), 5); // é™åˆ¶ 1x ~ 5x
                if (newScale === 1) { imgPosX = 0; imgPosY = 0; }
                imgScale = newScale;
                updateImageTransform();
            };

            // 2. è§¸æ§/æ»‘é¼ æŒ‰ä¸‹
            const startDrag = (x, y) => {
                if (imgScale <= 1) return; 
                isDragging = true;
                startX = x - imgPosX;
                startY = y - imgPosY;
                img.style.cursor = 'grabbing';
            };

            img.onmousedown = (e) => { startDrag(e.clientX, e.clientY); };

            // â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆè§¸æ§é–‹å§‹ (åˆ†è¾¨æ˜¯å–®æŒ‡é‚„æ˜¯é›™æŒ‡) â˜…â˜…â˜…
            img.ontouchstart = (e) => {
                if (e.touches.length === 2) {
                    // --- é›™æŒ‡æ¨¡å¼ï¼šé–‹å§‹ç¸®æ”¾ ---
                    e.preventDefault(); // é˜²æ­¢ç€è¦½å™¨ç¸®æ”¾
                    isDragging = false; // ç¸®æ”¾æ™‚åœæ­¢æ‹–æ›³
                    initialPinchDist = getDistance(e.touches);
                    startScale = imgScale;
                } else if (e.touches.length === 1) {
                    // --- å–®æŒ‡æ¨¡å¼ï¼šé–‹å§‹æ‹–æ›³ ---
                    startDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 3. ç§»å‹•ä¸­
            const doDrag = (x, y) => {
                if (!isDragging) return;
                imgPosX = x - startX;
                imgPosY = y - startY;
                updateImageTransform();
            };

            window.onmousemove = (e) => { if(isDragging) { e.preventDefault(); doDrag(e.clientX, e.clientY); } };

            // â˜…â˜…â˜… æ‰‹æ©Ÿç‰ˆç§»å‹• (åŒ…å«é›™æŒ‡ç¸®æ”¾é‚è¼¯) â˜…â˜…â˜…
            window.ontouchmove = (e) => {
                if (e.touches.length === 2 && initialPinchDist > 0) {
                    // --- é›™æŒ‡æåˆè¨ˆç®— ---
                    e.preventDefault();
                    const dist = getDistance(e.touches);
                    const scaleChange = dist / initialPinchDist; // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                    
                    // æ–°çš„ç¸®æ”¾å€¼ = åˆå§‹ç¸®æ”¾å€¼ * è®ŠåŒ–æ¯”ä¾‹
                    let newScale = startScale * scaleChange;
                    
                    // é™åˆ¶ç¯„åœ (1å€ ~ 5å€)
                    imgScale = Math.min(Math.max(1, newScale), 5);
                    updateImageTransform();
                    
                } else if (isDragging && e.touches.length === 1) {
                    // --- å–®æŒ‡æ‹–æ›³ ---
                    // e.preventDefault(); // è¦–æƒ…æ³é–‹å•Ÿï¼Œè‹¥æƒ³ä¿ç•™æ»‘å‹•ç¶²é åŠŸèƒ½å¯é—œé–‰
                    doDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 4. æ”¾é–‹æ‰‹æŒ‡
            const stopDrag = (e) => {
                isDragging = false;
                // å¦‚æœæ˜¯é›™æŒ‡æ”¾é–‹è®Šæˆå–®æŒ‡ï¼Œé‡ç½®ç¸®æ”¾åŸºæº–ï¼Œé¿å…è·³å‹•
                if (e.touches && e.touches.length < 2) {
                    initialPinchDist = 0;
                }
                img.style.cursor = imgScale > 1 ? 'grab' : 'default';
                
                // å¦‚æœç¸®å¤ªå°ï¼Œè‡ªå‹•å½ˆå› 1 å€
                if (imgScale < 1) {
                    imgScale = 1;
                    imgPosX = 0;
                    imgPosY = 0;
                    updateImageTransform();
                }
            };

            window.onmouseup = stopDrag;
            window.ontouchend = stopDrag;
        }

        function removeZoomListeners(img) {
            img.onwheel = null;
            img.onmousedown = null;
            img.ontouchstart = null;
            window.onmousemove = null;
            window.ontouchmove = null;
            window.onmouseup = null;
            window.ontouchend = null;
        }        
        
        // --- GLOBAL VARIABLES (åªå®£å‘Šä¸€æ¬¡) ---
        let currentShoppingFilter = 'all';
        let itineraryData = [];
        let currentDayIdx = null; 
        let currentEvtIdx = null;
        let currentExpenseId = null; 
        let deleteTarget = null; 
        let deleteExpenseId = null;
        let currentSelectedDayIndex = 0;
        let currentShoppingId = null; 
        let deleteShoppingId = null;
        let deleteChecklistCatIdx = null; 
        let deleteChecklistItemIdx = null;

        // â˜… å°‡ switchDay ç§»åˆ°å…¨åŸŸä½œç”¨åŸŸï¼ˆåªå®šç¾©ä¸€æ¬¡ï¼‰
        function switchDay(dayIdx) {
            if (typeof dayIdx !== 'number' || dayIdx < 0 || dayIdx >= itineraryData.length) return;
            if (currentSelectedDayIndex === dayIdx) return;
            currentSelectedDayIndex = dayIdx;
            renderDateSelector();
            renderPlan();
            try {
                const container = document.getElementById('date-scroll-container');
                const btns = container ? container.querySelectorAll('button') : [];
                const btn = btns[dayIdx];
                if (btn && typeof btn.scrollIntoView === 'function') {
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            } catch (e) { console.warn('switchDay scroll error', e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initItinerary(); 
            initChecklist(); 
            initShoppingList(); 
            initWallet(); 
            setupNav();
            renderDateSelector(); 
            renderPlan();

            setInterval(updateRealtimeHighlight, 60000);
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() { this.select(); });
            });
            loadFromCloud();
        });

        // ...existing code...
        
        // --- CLOUD SYNC CONFIG (é›²ç«¯åŒæ­¥è¨­å®š) ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHLVR3OKM4qFoGzqnITcN9kDJq12CEpPyY4b0hn2Frwez4avJbFEasZiVQDKNjvT9K/exec";

        // è®€å–é›²ç«¯è³‡æ–™ï¼ˆä¿®å¾©ç‰ˆæœ¬ï¼‰
        async function loadFromCloud() {
            if (!GAS_API_URL) {
                console.log('é›²ç«¯åŒæ­¥å·²ç¦ç”¨');
                return;
            }
            
            showToast("æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...", "info");
            
            try {
                // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                const url = GAS_API_URL + "?t=" + new Date().getTime();
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                
                if (result.status !== 'success' || !result.data) {
                    console.warn('é›²ç«¯å›æ‡‰ç•°å¸¸:', result);
                    showToast("é›²ç«¯ç„¡æ–°è³‡æ–™", "normal");
                    return;
                }
                
                const data = result.data;
                let hasUpdate = false;
                
                // æ›´æ–° LocalStorageï¼ˆå¦‚æœé›²ç«¯æœ‰è³‡æ–™ï¼‰
                if (data.hk_itinerary_v20) { 
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(data.hk_itinerary_v20)); 
                    hasUpdate = true; 
                }
                if (data.hk_wallet_v20) { 
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(data.hk_wallet_v20)); 
                    hasUpdate = true; 
                }
                if (data.hk_shopping_v20) { 
                    localStorage.setItem('hk_shopping_v20', JSON.stringify(data.hk_shopping_v20)); 
                    hasUpdate = true; 
                }
                if (data.hk_checks_v20) { 
                    localStorage.setItem('hk_checks_v20', JSON.stringify(data.hk_checks_v20)); 
                    hasUpdate = true; 
                }
                
                if (hasUpdate) {
                    // é‡æ–°åˆå§‹åŒ–ç•«é¢ä»¥é¡¯ç¤ºæ–°è³‡æ–™
                    initItinerary();
                    renderPlan();
                    renderExpenseList();
                    renderShoppingList();
                    renderChecklist();
                    showToast("è³‡æ–™åŒæ­¥å®Œæˆï¼âœ¨", "success");
                } else {
                    showToast("é›²ç«¯ç›®å‰ç„¡æ–°è³‡æ–™", "normal");
                }
                
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—:", e);
                showToast(`åŒæ­¥å¤±æ•—: ${e.message}`, "error");
            }
        }
        // ä¸Šå‚³è³‡æ–™åˆ°é›²ç«¯ (ä¿®æ­£ç‰ˆï¼šç§»é™¤æ¨™é ­ä»¥é¿å… CORS éŒ¯èª¤)
        async function saveToCloud(key, dataObj) {
            if (!GAS_API_URL) return;
            
            try {
                const payload = {
                    key: key,
                    value: JSON.stringify(dataObj)
                };
                
                // â˜…â˜…â˜… ä¿®æ”¹é‡é»ï¼šç§»é™¤ headers è¨­å®šï¼Œè®“ç€è¦½å™¨ç”¨é è¨­æ–¹å¼å‚³é€ â˜…â˜…â˜…
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'no-cors' // åŠ å…¥é€™è¡Œï¼Œå¼·è¿«ç€è¦½å™¨å¿½ç•¥è·¨åŸŸæª¢æŸ¥ (é›–ç„¶ç„¡æ³•è®€å–å›å‚³çµæœï¼Œä½†èƒ½ç¢ºä¿è³‡æ–™é€é”)
                });
                
                console.log('å·²ç™¼é€ä¸Šå‚³è«‹æ±‚:', key);
                
            } catch (err) {
                console.error('ä¸Šå‚³ç™¼é€å¤±æ•—:', err);
            }
        }
        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';

            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(toast);

            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 3000);
        }

        // --- ITINERARY DATA (Updated with splits and moves) ---
        const defaultItinerary = [
            { date: "12/18 (å››)", day: 1, dateObj: "2025-12-18", weather: { icon: 'fa-cloud', temp: '-1Â°C', desc: 'å¤šé›²' }, events: [ 
                { time: "06:15 ~ 11:00", title: "TPE æ¡ƒåœ’æ©Ÿå ´ T2", type: "transport", note: "é•·æ¦® BR166 (29A-D)", tags: ["èˆªç­", "A321"], story: "è¨˜å¾—ææ—© 2.5 å°æ™‚æŠµé”æ©Ÿå ´å ±åˆ°ã€‚", tips: "é•·æ¦®èˆªç©ºæ«ƒå°åœ¨ç¬¬äºŒèˆªå»ˆ 3 æ¨“ã€‚" }, 
                { time: "11:00 ~ 12:00", title: "CTS æ–°åƒæ­²æ©Ÿå ´", type: "transport", note: "å…¥å¢ƒã€é ˜è¡Œæ", station: "æ–°åƒæ­²ç©ºæ¸¯ç«™" }, 
                { time: "12:15 ~ 13:10", title: "ç§»å‹•ï¼šå‰å¾€é£¯åº—", type: "move", note: "JR å¿«é€Ÿ Airport (37åˆ†) â” æœ­å¹Œç«™è½‰ä¹˜ â” åœ°éµå—åŒ—ç·š (5åˆ†)", tags: ["JR: 12:15/12:27ç™¼"] },
                { time: "13:11 ~ 14:11", title: "æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—", type: "stay", note: "Check-in / å¯„æ”¾è¡Œæ", station: "ä¸­å³¶å…¬åœ’ç«™" }, 
                { time: "14:40 ~ 14:50", title: "ç§»å‹•ï¼šå‰å¾€å¤§é€š", type: "move", note: "åœ°éµå—åŒ—ç·š (å¾€éº»ç”Ÿæ–¹å‘ 2ç«™)", tags: ["è»Šç¨‹ç´„5åˆ†"] },
                { time: "15:00 ~ 16:00", title: "ç´…ç£šå»³èˆ (èˆŠæœ¬å»³èˆ)", type: "spot", note: "å·´æ´›å…‹é¢¨æ ¼ç´…ç£šå»ºç¯‰", station: "å¤§é€šç«™/æœ­å¹Œç«™", tips: "å…¥å…§åƒè§€å…è²»(æ•´ä¿®ä¸­å¯èƒ½åƒ…å¤–è§€)ã€‚" },
                { time: "16:00 ~ 16:15", title: "ç§»å‹•ï¼šæ­¥è¡Œå‰å¾€å¤§é€šå…¬åœ’", type: "move", note: "æ­¥è¡Œç´„10-15åˆ†", tags: ["æ•£æ­¥"] },
                { time: "16:15 ~ 18:00", title: "å¤§é€šå…¬åœ’", type: "spot", note: "ç™½è‰²ç‡ˆæ¨¹ç¯€", station: "å¤§é€šç«™", tips: "æœ€ä½³æ‹ç…§é»åœ¨é›»è¦–å¡”å‰æˆ–å™´æ°´æ± ã€‚" },
                { time: "18:00 ~ 18:20", title: "ç§»å‹•ï¼šæ­¥è¡Œæˆ–åœ°éµ", type: "move", note: "å‰å¾€è–„é‡/å¤§é€šå‘¨é‚Šæ™šé¤", tags: ["æ­¥è¡Œç´„15åˆ†"] },
                { time: "18:32 ~ 19:30", title: "Gyoza no Ohsho", type: "food", note: "æ™šé¤ï¼šé¤ƒå­", tags: ["æ™šé¤"] }, 
                { time: "19:34 ~ 20:34", title: "Matcha Cafe & Sweets RIQ", type: "food", note: "æŠ¹èŒ¶ç”œé»", tags: ["å¿…åƒç”œé»"] }, 
                { time: "20:35 ~ 22:35", title: "ç‹¸å°è·¯å•†åº—è¡—", type: "shop", note: "è—¥å¦ã€ä¼´æ‰‹ç¦®æ¡è²·", station: "ç‹¸å°è·¯ç«™", tags: ["é€›è¡—"] }, 
                { time: "22:35 ~ 23:00", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š (å¾€çœŸé§’å…§æ–¹å‘)", station: "ä¸­å³¶å…¬åœ’ç«™" } 
            ] }, 
            { date: "12/19 (äº”)", day: 2, dateObj: "2025-12-19", weather: { icon: 'fa-snowflake', temp: '-4Â°C', desc: 'å°é›ª' }, events: [ 
                { time: "07:30 ~ 08:30", title: "ç§»å‹•ï¼šå‰å¾€æ»‘é›ªå ´", type: "move", note: "å°ˆè»Šæ¥é€ (è«‹ç¢ºèªé›†åˆé»)", tags: ["å°ˆè»Š"] },
                { time: "08:30 ~ 16:30", title: "æœ­å¹Œæ‰‹ç¨»æ»‘é›ªå ´", type: "spot", note: "æ»‘é›ªé«”é©—", tags: ["é‡é»è¡Œç¨‹"], tips: "åˆå­¸è€…å»ºè­°é ç´„æ•™ç·´ã€‚" }, 
                { time: "16:30 ~ 17:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "å°ˆè»Šæ¥é€", tags: ["å°ˆè»Š"] },
                { time: "17:30 ~ 18:00", title: "å›é£¯åº—æ¢³æ´—", type: "stay", note: "ä¼‘æ¯æ›è£" }, 
                { time: "18:00 ~ 18:15", title: "ç§»å‹•ï¼šå‰å¾€è–„é‡", type: "move", note: "åœ°éµå—åŒ—ç·š (1ç«™)", tags: ["è»Šç¨‹3åˆ†"] },
                { time: "18:16 ~ 19:16", title: "Suage+ Soup Curry", type: "food", note: "åŒ—æµ·é“å¿…åƒæ¹¯å’–å“©", station: "è–„é‡ç«™", tags: ["å¿…é»:è„†çš®çŸ¥åºŠé›"] }, 
                { time: "19:16 ~ 19:29", title: "ç§»å‹•ï¼šå‰å¾€å¤§é€š", type: "move", note: "æ­¥è¡Œæˆ–åœ°ä¸‹è¡—", tags: ["æ­¥è¡Œ10åˆ†"] },
                { time: "19:30 ~ 20:30", title: "æœ­å¹Œåœ°ä¸‹è¡— (Aurora Town)", type: "shop", note: "é€£æ¥å¤§é€šèˆ‡é›»è¦–å¡”çš„åœ°ä¸‹è¡—", station: "å¤§é€šç«™", tags: ["é€›è¡—"] },
                { time: "20:30 ~ 20:40", title: "ç§»å‹•ï¼šæ­¥è¡Œ", type: "move", note: "å‰å¾€é›»è¦–å¡”", tags: ["æ­¥è¡Œ"] },
                { time: "20:40 ~ 21:20", title: "æœ­å¹Œé›»è¦–å¡”", type: "spot", note: "ä¿¯ç°å¤§é€šå…¬åœ’å¤œæ™¯", station: "å¤§é€šç«™", tips: "å¾ä¸‹æ–¹ä»°æ‹ä¹Ÿå¾ˆç¾ã€‚" },
                { time: "21:20 ~ 21:30", title: "ç§»å‹•ï¼šæ­¥è¡Œ", type: "move", note: "å‰å¾€é˜æ¨“ (ç´„5-10åˆ†)", tags: ["æ­¥è¡Œ"] },
                { time: "21:30 ~ 22:00", title: "æœ­å¹Œå¸‚é˜æ¨“", type: "spot", note: "æ—¥æœ¬ç¾å­˜æœ€å¤è€é˜æ¨“", station: "å¤§é€šç«™", tips: "æ™šä¸Šæ‰“ç‡ˆåˆ¥æœ‰ä¸€ç•ªé¢¨å‘³ã€‚" },
                { time: "22:00 ~ 22:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "è¨ˆç¨‹è»Šæˆ–åœ°éµå—åŒ—ç·š" } 
            ] }, 
            { date: "12/20 (å…­)", day: 3, dateObj: "2025-12-20", weather: { icon: 'fa-sun', temp: '-2Â°C', desc: 'æ™´æ™‚å¤šé›²' }, events: [ 
                { time: "07:15 ~ 07:40", title: "ç§»å‹•ï¼šå‰å¾€ä¼è¦‹ç¨»è·", type: "move", note: "å¸‚é›» (ä¸­å³¶å…¬åœ’é€š -> è¥¿ç·š14æ¢)", tags: ["è·¯é¢é›»è»Š"] },
                { time: "07:40 ~ 08:42", title: "ä¼è¦‹ç¨»è·ç¥ç¤¾", type: "spot", note: "åƒæœ¬é³¥å±…", station: "è¥¿ç·š14æ¢", tips: "ç¶²ç¾æ‹ç…§è–åœ°ã€‚" }, 
                { time: "08:42 ~ 09:10", title: "ç§»å‹•ï¼šå‰å¾€åœ“å±±", type: "move", note: "å»ºè­°è¨ˆç¨‹è»Š (ç´„1500å††) æˆ– å…¬è»Š", tags: ["è¨ˆç¨‹è»Šæ¨è–¦"] },
                { time: "10:00 ~ 11:40", title: "ç¾æœˆæ«»å’Œæœ", type: "spot", note: "å’Œæœé«”é©—", station: "åœ“å±±å…¬åœ’ç«™", tags: ["é ç´„è¡Œç¨‹"] }, 
                { time: "11:40 ~ 13:00", title: "åŒ—æµ·é“ç¥å®®", type: "spot", note: "åƒæ‹œ", station: "åœ“å±±å…¬åœ’ç«™" }, 
                { time: "13:00 ~ 14:00", title: "å…­èŠ±äº­ ç¥å®®èŒ¶å±‹åº—", type: "food", note: "ä¼‘æ¯åƒé»å¿ƒ", tags: ["å¿…åƒ:åˆ¤å®˜é¤…"] }, 
                { time: "16:00 ~ 16:47", title: "æ­¸é‚„å’Œæœ", type: "spot", note: "è¿”å›ç¾æœˆæ«»" }, 
                { time: "16:47 ~ 17:15", title: "ç§»å‹•ï¼šå‰å¾€è–„é‡", type: "move", note: "åœ°éµæ±è¥¿ç·š (åœ“å±±å…¬åœ’->å¤§é€š) è½‰ å—åŒ—ç·š" },
                { time: "18:15 ~ 20:00", title: "ç‚­ç«å…œ æˆå‰æ€æ±—", type: "food", note: "åŒ—æµ·é“ç‰¹è‰²çƒ¤è‚‰", tags: ["é ç´„ 18:30"] }, 
                { time: "20:00 ~ 21:00", title: "COCONO SUSUKINO", type: "shop", note: "è–„é‡æ–°åœ°æ¨™", station: "è–„é‡ç«™" }, 
                { time: "21:00 ~ 21:15", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š (1ç«™)" } 
            ] }, 
            { date: "12/21 (æ—¥)", day: 4, dateObj: "2025-12-21", weather: { icon: 'fa-snowflake', temp: '-5Â°C', desc: 'å¤§é›ª' }, events: [ 
                { time: "08:20 ~ 08:35", title: "ç§»å‹•ï¼šå‰å¾€æœ­å¹Œç«™", type: "move", note: "åœ°éµå—åŒ—ç·š", tags: ["æ—©èµ·å‡ºç™¼"] },
                { time: "08:43 ~ 09:18", title: "ç§»å‹•ï¼šå‰å¾€å°æ¨½", type: "move", note: "JR å¿«é€Ÿ Airport (å¾€å°æ¨½)", tags: ["JR"] },
                { time: "09:34 ~ 10:00", title: "ç§»å‹•ï¼šå‰å¾€æ°´æ—é¤¨", type: "move", note: "ä¸­å¤®å·´å£« (ç¥æ´¥ç·š 10/11è·¯)", tags: ["å°æ¨½ç«™å‰æ­ä¹˜"] },
                { time: "10:00 ~ 12:30", title: "å°æ¨½æ°´æ—é¤¨", type: "spot", note: "ä¼éµæ•£æ­¥", tags: ["è¦ªå­æ¨è–¦"] }, 
                { time: "12:40 ~ 13:10", title: "ç§»å‹•ï¼šè¿”å›å°æ¨½ç«™", type: "move", note: "ä¸­å¤®å·´å£«" },
                { time: "13:10 ~ 14:10", title: "å°æ¨½ä¸‰è§’å¸‚å ´", type: "food", note: "æµ·é®®åˆé¤", station: "å°æ¨½ç«™", tags: ["å¿…åƒæµ·é®®"] }, 
                { time: "14:30 ~ 16:30", title: "å°æ¨½å ºç”ºé€šå•†åº—è¡—", type: "shop", note: "ç”œé»èˆ‡ç»ç’ƒ", tags: ["å¿…è²·ä¼´æ‰‹ç¦®"] }, 
                { time: "16:30 ~ 17:30", title: "å…­èŠ±äº­ & åŒ—ä¸€ç¡å­", type: "shop", note: "ç»ç’ƒå·¥è—" }, 
                { time: "17:30 ~ 19:00", title: "å°æ¨½é‹æ²³", type: "spot", note: "æ¬£è³é‹æ²³å¤œæ™¯", station: "å°æ¨½ç«™" }, 
                { time: "19:15 ~ 20:00", title: "ç§»å‹•ï¼šè¿”å›æœ­å¹Œ", type: "move", note: "JR å¿«é€Ÿ Airport" },
                { time: "20:00 ~ 20:30", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š" }
            ] }, 
            { date: "12/22 (ä¸€)", day: 5, dateObj: "2025-12-22", weather: { icon: 'fa-cloud', temp: '-2Â°C', desc: 'é™°' }, events: [ 
                { time: "08:30 ~ 09:00", title: "ç§»å‹•ï¼šå‰å¾€å ´å¤–å¸‚å ´", type: "move", note: "åœ°éµæ±è¥¿ç·š (äºŒåå››è»’ç«™) + æ­¥è¡Œ" },
                { time: "09:00 ~ 10:00", title: "å ´å¤–å¸‚å ´", type: "food", note: "æµ·é®®ä¸¼æ—©é¤", station: "äºŒåå››è»’ç«™", tags: ["å¿…åƒæµ·é®®"] }, 
                { time: "10:00 ~ 10:45", title: "ç§»å‹•ï¼šå‰å¾€åŒ—æµ·é“å¤§å­¸", type: "move", note: "åœ°éµæ±è¥¿ç·š -> å—åŒ—ç·š (åŒ—12æ¢ç«™)" },
                { time: "10:54 ~ 11:54", title: "åŒ—æµ·é“å¤§å­¸", type: "spot", note: "éŠ€æå¤§é“", station: "åŒ—12æ¢ç«™" }, 
                { time: "11:54 ~ 12:17", title: "ç§»å‹•ï¼šå‰å¾€è«è¨ªç¥ç¤¾", type: "move", note: "åœ°éµæ±è±ç·š (åŒ—13æ¢æ±ç«™)" },
                { time: "12:17 ~ 13:17", title: "è«è¨ªç¥ç¤¾", type: "spot", note: "èŠ±æ‰‹æ°´", station: "åŒ—13æ¢æ±ç«™" }, 
                { time: "13:17 ~ 13:40", title: "ç§»å‹•ï¼šå‰å¾€å•¤é…’åšç‰©é¤¨", type: "move", note: "è¨ˆç¨‹è»Š æˆ– å·´å£« (è‹—ç©—ç«™æ–¹å‘)" },
                { time: "13:40 ~ 14:40", title: "æœ­å¹Œå•¤é…’åšç‰©é¤¨", type: "spot", note: "ç´…ç£šå»ºç¯‰æ‹ç…§", tags: ["æ­·å²"] }, 
                { time: "14:40 ~ 14:58", title: "ç§»å‹•ï¼šå‰å¾€æœ­å¹Œç«™", type: "move", note: "ä¸­å¤®å·´å£« Loop 88 æˆ– æ­¥è¡Œ" },
                { time: "14:58 ~ 16:00", title: "Sapporo Stellar Place", type: "shop", note: "è»Šç«™è³¼ç‰©", station: "æœ­å¹Œç«™" }, 
                { time: "16:03 ~ 17:03", title: "ä¸²é³¥ æœ­å¹Œé§…å‰åº—", type: "food", note: "å¹³åƒ¹ç¾å‘³ä¸²ç‡’", tags: ["å¿…åƒä¸²ç‡’"] }, 
                { time: "17:05 ~ 18:30", title: "BIC CAMERA æœ­å¹Œåº—", type: "shop", note: "é›»å™¨æ¡è²·", station: "æœ­å¹Œç«™" }, 
                { time: "18:30 ~ 19:00", title: "ç§»å‹•ï¼šè¿”å›é£¯åº—", type: "move", note: "åœ°éµå—åŒ—ç·š" }
            ] }, 
            { date: "12/23 (äºŒ)", day: 6, dateObj: "2025-12-23", weather: { icon: 'fa-plane', temp: '0Â°C', desc: 'è¿”ç¨‹' }, events: [ 
                { time: "08:00 ~ 11:00", title: "Check-out & ç§»å‹•", type: "stay", note: "Check-out" }, 
                { time: "11:00 ~ 12:00", title: "ç§»å‹•ï¼šå‰å¾€æ©Ÿå ´", type: "move", note: "JR å¿«é€Ÿ Airport (37åˆ†)", tags: ["é ç•™æ™‚é–“"] },
                { time: "12:00 ~ 15:00", title: "æ–°åƒæ­²æ©Ÿå ´", type: "shop", note: "æœ€å¾Œæ¡è²·", story: "é€™è£¡ä¸åªæ˜¯æ©Ÿå ´ï¼Œæ›´æ˜¯å€‹è¶…å¤§éŠæ¨‚åœ’ã€‚" }, 
                { time: "15:20 ~ 19:05", title: "BR115 è¿”å°", type: "transport", note: "CTS -> TPE (29G-K)" } 
            ] } 
        ];
        
        const defaultShoppingList = [ { id: 'm1', type: 'drug', name: 'å¤§æ­£è£½è—¥ å£å…§ç‚è²¼ç‰‡', desc: 'è²¼çš„å«é¡å›ºé†‡ï¼Œå¸é™„åŠ›å¥½', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=å£å…§ç‚' }, { id: 'm2', type: 'drug', name: 'Traful è»Ÿè† PRO QUICK', desc: 'æŠ—ç‚æˆåˆ†ï¼Œå¡—æŠ¹å‹', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Traful' }, { id: 'm3', type: 'drug', name: 'Chocola BB å£å…§ç‚å™´éœ§', desc: 'æ®ºèŒä¿®å¾©ï¼Œè–„è·å‘³', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=BB' }, { id: 'm4', type: 'drug', name: 'å°æ—è£½è—¥ æ¶²é«”çµ†å‰µè†', desc: 'é˜²æ°´éš±å½¢OKç¹ƒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=æ¶²é«”çµ†' }, { id: 'm5', type: 'drug', name: 'EVE Quick DX', desc: 'é€Ÿæ•ˆæ­¢ç—›', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=EVE' }, { id: 'm6', type: 'drug', name: 'Loxonin S Premium', desc: 'å¼·æ•ˆæ­¢ç—›', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Loxonin' }, { id: 'm7', type: 'drug', name: 'PAIR ç—˜ç—˜è—¥è†', desc: 'æ¶ˆç‚æ®ºèŒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=PAIR' }, { id: 'm8', type: 'drug', name: 'Aneron æšˆè»Šè—¥', desc: 'é•·æ•ˆæŒçºŒ', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Aneron' }, { id: 'm9', type: 'drug', name: 'å“†å•¦Aå¤¢ æšˆè»Šè—¥', desc: 'å…’ç«¥å¯ç”¨ï¼Œæ±½æ°´å‘³', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=å“†å•¦Aå¤¢' }, { id: 'm10', type: 'drug', name: 'DHC é€Ÿæ”»è—è“ V-MAX', desc: 'è­·çœ¼ï¼ŒèŠ±é’ç´ å¢é‡', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCè—è“' }, { id: 'm11', type: 'drug', name: 'é¾è§’æ•£ Direct', desc: 'å…æ°´æœç”¨ï¼Œæ°´èœœæ¡ƒ/è–„è·', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=é¾è§’æ•£' }, { id: 'm12', type: 'drug', name: 'DHC ä¹³é…¸èŒ/ç›Šç”ŸèŒ', desc: 'æ•´è…¸æ¶ˆåŒ–', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCç›Šç”ŸèŒ' }, { id: 'm13', type: 'drug', name: 'DHC è‘‰é»ƒç´ /è¦ç´…ç´ ', desc: 'æŠ—è—å…‰ï¼ŒæŠ—ç–²å‹', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHCè‘‰é»ƒ' }, { id: 'm14', type: 'drug', name: 'ROIHI-TSUBOKO', desc: 'æº«æ„Ÿç©´ä½è²¼ç‰‡', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=ç©´ä½è²¼' }, { id: 'm15', type: 'drug', name: 'åˆåˆ©ä»–å‘½ EX Plus', desc: 'ç·©è§£çœ¼ç›ç–²å‹ã€è‚©é ¸åƒµç¡¬', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=åˆåˆ©ä»–å‘½' }, { id: 'm16', type: 'drug', name: 'æ¨‚æ•¦ V é ‚ç´šç´…é‘½', desc: 'æ”¹å–„ä¹¾çœ¼ã€è€èŠ±', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Vç´…é‘½' }, { id: 'm17', type: 'drug', name: 'é½’ç£¨æ’«å­ ç‰™è†', desc: 'å°è˜‡æ‰“ç¾ç™½', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=é½’ç£¨æ’«å­' }, { id: 's1', type: 'souvenir', name: 'ç™½è‰²æˆ€äºº', desc: 'ç¶“å…¸å·§å…‹åŠ›å¤¾å¿ƒ', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=ç™½è‰²æˆ€äºº' }, { id: 's2', type: 'souvenir', name: 'HORI å“ˆå¯†ç“œæœå‡', desc: 'å¤•å¼µå“ˆå¯†ç“œå£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=HORI' }, { id: 's3', type: 'souvenir', name: 'PRESS BUTTER SAND', desc: 'åŒ—æµ·é“é™å®šç‰ç±³å£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=ButterSand' }, { id: 's4', type: 'souvenir', name: 'åŒ—è“æ¨“ é–‹æ‹“å°ç±³è“', desc: 'æµ·é®®å£å‘³ç±³è“', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=åŒ—è“æ¨“' }, { id: 's5', type: 'souvenir', name: 'LeTAO é›™å±¤èµ·å¸è›‹ç³•', desc: 'å¿…è²·ç¶“å…¸', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=LeTAO' }, { id: 's6', type: 'souvenir', name: 'KINOTOYA èµ·å¸å¡”', desc: 'æ–°åƒæ­²æ©Ÿå ´å¿…åƒ', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=KINOTOYA' }, { id: 's7', type: 'souvenir', name: 'Milk Stand ç‰›å¥¶', desc: 'å„åœ°ç‰§å ´ç›´é€', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=MilkStand' }, { id: 's8', type: 'souvenir', name: 'å…­èŠ±äº­ å¥¶æ²¹å¤¾å¿ƒ', desc: 'è˜­å§†è‘¡è„å£å‘³', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=å…­èŠ±äº­' }, { id: 's9', type: 'souvenir', name: 'å…­èŠ±äº­ é…’ç³–', desc: 'å¯¶çŸ³èˆ¬çš„å¤–è§€', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=é…’ç³–' }, { id: 's10', type: 'souvenir', name: 'Oh! çƒ¤ç‰ç±³', desc: 'æœ­å¹Œå¤§é€šå…¬åœ’åç‰©', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=çƒ¤ç‰ç±³' }, { id: 'o1', type: 'other', name: 'Canon SELPHY CP1500', desc: 'å°å‹å°ç›¸æ©Ÿ', done: false, img: 'https://placehold.co/100x100/e5e7eb/4b5563?text=Canon' } ];
             // Init Wallet inputs focus
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() { this.select(); });
            });
            loadFromCloud();

        function initItinerary() { const stored = localStorage.getItem('hk_itinerary_v20'); if (stored) { itineraryData = JSON.parse(stored); } else { itineraryData = JSON.parse(JSON.stringify(defaultItinerary)); } }
        
        function resetItinerary() {
            deleteTarget = 'itinerary-reset';
            document.getElementById('confirm-msg').innerText = "ç¢ºå®šè¦æ¢å¾©é è¨­è¡Œç¨‹å—ï¼Ÿæ‰€æœ‰ä¿®æ”¹å°‡æ¶ˆå¤±ã€‚";
            document.getElementById('confirm-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);
        }

        function renderDateSelector() { const container = document.getElementById('date-scroll-container'); let html = ''; itineraryData.forEach((day, idx) => { const isActive = idx === currentSelectedDayIndex; const activeClass = isActive ? 'bg-muji-accent text-white shadow-md' : 'bg-white text-gray-500 hover:bg-gray-50'; const dateShort = day.date.split('/')[1]; html += `<button onclick="switchDay(${idx})" class="flex-shrink-0 w-14 h-12 rounded-xl flex flex-col items-center justify-center transition-all ${activeClass} border border-transparent ${!isActive ? 'border-gray-100' : ''}"><span class="text-xs font-bold leading-none mb-1">Day ${day.day}</span><span class="text-[10px] font-mono leading-none">${dateShort}</span></button>`; }); container.innerHTML = html; }

        function renderPlan() { 
            const container = document.getElementById('itinerary-list'); 
            const weatherCard = document.getElementById('plan-weather-card'); 
            const day = itineraryData[currentSelectedDayIndex]; 
            weatherCard.innerHTML = `<div class="bg-white p-2 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between" style="max-width:360px;margin:6px auto">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center text-blue-400 text-lg"><i class="fas ${day.weather.icon}"></i></div>
                    <div>
                        <div class="text-sm font-bold text-gray-700">${day.date}</div>
                        <div class="text-[10px] text-gray-400">${day.weather.desc}</div>
                    </div>
                </div>
                <div class="text-lg font-bold text-gray-600 font-mono">${day.weather.temp}</div>
            </div>`; 
            
            let eventsHtml = ''; 
            day.events.forEach((evt, evtIdx) => { 
                let bgClass = 'bg-white border-l-4 border-gray-200'; 
                let iconClass = 'text-gray-400 fa-map-marker-alt'; 
                let titleClass = 'text-muji-text'; 
                let isMove = false;

                if (evt.type === 'transport') { bgClass = 'bg-muji-transport border-l-4 border-blue-400'; iconClass = 'text-blue-500 fa-plane'; } 
                else if (evt.type === 'food') { bgClass = 'bg-muji-food border-l-4 border-orange-400'; iconClass = 'text-orange-500 fa-utensils'; } 
                else if (evt.type === 'shop') { bgClass = 'bg-muji-shop border-l-4 border-pink-400'; iconClass = 'text-pink-500 fa-shopping-bag'; } 
                else if (evt.type === 'spot') { bgClass = 'bg-muji-spot border-l-4 border-green-500'; iconClass = 'text-green-600 fa-camera'; } 
                else if (evt.type === 'stay') { iconClass = 'text-indigo-400 fa-bed'; }
                else if (evt.type === 'move') { 
                    bgClass = 'bg-gray-50 border-l-2 border-gray-300 py-2 pl-2'; 
                    iconClass = 'text-gray-400 fa-bus'; 
                    titleClass = 'text-sm text-gray-600';
                    isMove = true;
                }

                let tagsHtml = ''; 
                if (evt.tags) { 
                    evt.tags.forEach(tag => { 
                        let tagStyle = 'bg-gray-100 text-gray-500'; 
                        if (tag.includes('å¿…åƒ')) tagStyle = 'tag-must-eat'; 
                        else if (tag.includes('å¿…è²·')) tagStyle = 'tag-must-buy'; 
                        else if (tag.includes('é ç´„')) tagStyle = 'tag-reserve'; 
                        else if (tag.includes('è»Š') || tag.includes('JR') || tag.includes('å°ˆè»Š')) tagStyle = 'tag-transport'; 
                        tagsHtml += `<span class="text-[10px] px-1.5 py-0.5 rounded mr-1 mb-1 inline-block ${tagStyle}">${tag}</span>`; 
                    }); 
                } 
                
                const eventId = `event-${currentSelectedDayIndex}-${evtIdx}`; 
                const timelineType = isMove ? 'type-move' : '';
                
                if (isMove) {
                    eventsHtml += `<div class="relative pl-8 timeline-line ${timelineType} group" id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-2 top-3 w-4 text-center z-10"><div class="w-4 h-4 rounded-full bg-gray-200 border border-white flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-[8px] text-white"></i></div></div>
                        <div class="${bgClass} rounded-r-lg relative cursor-pointer hover:bg-gray-100 transition-all duration-300 event-card" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-xs font-bold text-gray-400 time-display whitespace-nowrap">${evt.time}</span>
                                    <h4 class="text-xs font-bold ${titleClass} truncate">${evt.title}</h4>
                                </div>
                                ${evt.note ? `<div class="text-[10px] text-gray-400 truncate max-w-[120px] transport-detail">${evt.note}</div>` : ''}
                            </div>
                        </div>
                    </div>`;
                } else {
                    eventsHtml += `<div class="relative pl-8 timeline-line group" id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-0 top-4 w-8 text-center z-10"><div class="w-8 h-8 rounded-full bg-white border border-gray-100 shadow-sm flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-xs"></i></div></div>
                        <div class="${bgClass} p-3 rounded-lg shadow-card relative cursor-pointer hover:shadow-md transition-all duration-300 event-card" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                            <div class="flex justify-between items-start mb-1"><span class="font-mono text-sm font-bold text-gray-500 time-display">${evt.time}</span><div class="flex gap-2"></div></div>
                            <h4 class="text-base font-bold ${titleClass} mb-1 leading-tight">${evt.title}</h4>
                            ${evt.station ? `<div class="text-xs text-muji-subtext mb-1"><i class="fas fa-subway mr-1 text-gray-300"></i>${evt.station}</div>` : ''}
                            ${evt.note ? `<p class="text-xs text-gray-500 mb-2 leading-relaxed">${evt.note}</p>` : ''}
                            <div class="flex flex-wrap">${tagsHtml}</div>
                        </div>
                    </div>`;
                }
            }); 
            container.innerHTML = eventsHtml; 
            updateRealtimeHighlight(); 
        }

        function updateRealtimeHighlight() { const now = new Date(); const cards = document.querySelectorAll('.timeline-line'); cards.forEach(card => { const dateStr = card.getAttribute('data-date'); const timeStr = card.getAttribute('data-time'); const eventDate = new Date(dateStr); const isSameDate = now.getFullYear() === eventDate.getFullYear() && now.getMonth() === eventDate.getMonth() && now.getDate() === eventDate.getDate(); if (!isSameDate) { removeHighlight(card); return; } const times = timeStr.split('~').map(t => t.trim()); if (times.length < 1) return; const startParts = times[0].split(':'); const startHour = parseInt(startParts[0]); const startMin = parseInt(startParts[1]); let endHour, endMin; if (times.length > 1 && times[1]) { const endParts = times[1].split(':'); endHour = parseInt(endParts[0]); endMin = parseInt(endParts[1]); } else { endHour = startHour + 1; endMin = startMin; } const startTime = new Date(now); startTime.setHours(startHour, startMin, 0); const endTime = new Date(now); endTime.setHours(endHour, endMin, 0); if (now >= startTime && now <= endTime) { addHighlight(card); } else { removeHighlight(card); } }); }
        function addHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); if (!innerCard.classList.contains('event-active')) { innerCard.classList.add('event-active'); icon.classList.add('animate-pulse-slow'); icon.classList.add('bg-muji-highlight'); icon.querySelector('i').style.color = 'white'; innerCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
        function removeHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); innerCard.classList.remove('event-active'); icon.classList.remove('animate-pulse-slow'); icon.classList.remove('bg-muji-highlight'); icon.querySelector('i').style.color = ''; }
        function setupNav() { const btns = document.querySelectorAll('.nav-btn'); const sections = document.querySelectorAll('.tab-content'); btns.forEach(btn => { btn.addEventListener('click', () => { btns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); sections.forEach(s => { s.classList.remove('active'); if(s.id === btn.dataset.target) s.classList.add('active'); }); if(btn.dataset.target === 'lists') updateChecklistProgress(); }); }); }
        
        function deleteEvent() { 
            if (currentDayIdx === null || currentEvtIdx === null || currentEvtIdx < 0) return; 
            deleteTarget = 'itinerary'; 
            document.getElementById('confirm-msg').innerText="ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ"; 
            document.getElementById('confirm-modal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); 
        }
        
        function closeConfirmModal() { 
            const box = document.getElementById('confirm-box');
            box.classList.add('scale-95');
            document.getElementById('confirm-modal').classList.add('hidden'); 
            deleteTarget = null; deleteExpenseId = null; deleteShoppingId = null; deleteChecklistCatIdx = null; deleteChecklistItemIdx = null; 
        }
        
        function executeDelete() { 
            // åˆªé™¤è¡Œç¨‹
            if (deleteTarget === 'itinerary') { 
                try { 
                    itineraryData[currentDayIdx].events.splice(currentEvtIdx, 1); 
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
                    
                    // â˜… åŒæ­¥ â˜…
                    saveToCloud('hk_itinerary_v20', itineraryData);
                    
                    renderPlan(); 
                    closeModal(); 
                    closeViewModal(); 
                    showToast('è¡Œç¨‹å·²åˆªé™¤ä¸¦åŒæ­¥'); 
                } catch(e) { console.error(e); } 
            } 
            // é‡ç½®è¡Œç¨‹ (ä¿æŒåŸæ¨£ï¼Œæˆ–è¦–éœ€æ±‚åŒæ­¥)
            else if (deleteTarget === 'itinerary-reset') { 
                localStorage.removeItem('hk_itinerary_v20'); 
                initItinerary(); 
                renderDateSelector(); 
                renderPlan(); 
                showToast('è¡Œç¨‹å·²é‡ç½®'); 
            } 
            // æ¸…é™¤æ‰€æœ‰è¨˜å¸³
            else if (deleteTarget === 'expense-clear') { 
                localStorage.removeItem('hk_wallet_v20'); 
                
                // â˜… åŒæ­¥ (å‚³é€ç©ºé™£åˆ—) â˜…
                saveToCloud('hk_wallet_v20', []);
                
                renderExpenseList(); 
                showToast('è³‡æ–™å·²æ¸…é™¤ä¸¦åŒæ­¥'); 
            } 
            // åˆªé™¤å–®ç­†è¨˜å¸³
            else if (deleteTarget === 'expense-single') { 
                let expenses = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                expenses = expenses.filter(e => e.id !== deleteExpenseId); 
                localStorage.setItem('hk_wallet_v20', JSON.stringify(expenses));
                
                // â˜… åŒæ­¥ (ç§»é™¤åœ–ç‰‡å¾Œä¸Šå‚³) â˜…
                const cleanExpenses = expenses.map(d => ({...d, img: ''}));
                saveToCloud('hk_wallet_v20', cleanExpenses);
                
                renderExpenseList(); 
                showToast('ç´€éŒ„å·²åˆªé™¤ä¸¦åŒæ­¥'); 
            } 
            // è³¼ç‰©èˆ‡æ¸…å–®åˆªé™¤ (æ‚¨èªªä¸éœ€è¦åŒæ­¥ï¼Œä¿æŒåŸæ¨£å³å¯ï¼Œæˆ–ä¾ç…§å‰è¿°é‚è¼¯åŠ ä¸Šå»)
            else if (deleteTarget === 'shopping') { 
                let list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
                list = list.filter(i => i.id !== deleteShoppingId); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(list)); 
                renderShoppingList(); 
                showToast('é …ç›®å·²åˆªé™¤'); 
            } 
            else if (deleteTarget === 'checklist-cat') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list.splice(deleteChecklistCatIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist(); 
                showToast('åˆ†é¡å·²åˆªé™¤'); 
            } 
            else if (deleteTarget === 'checklist-item') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list[deleteChecklistCatIdx].items.splice(deleteChecklistItemIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
                showToast('é …ç›®å·²åˆªé™¤'); 
            } 
            closeConfirmModal(); 
        }
        
        function openViewModal(dayIdx, evtIdx) { 
            const evt = itineraryData[dayIdx].events[evtIdx]; 
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx; 
            document.getElementById('view-title').innerText = evt.title; 
            document.getElementById('view-type').innerText = (evt.type === 'food' ? 'ç¾é£Ÿ' : (evt.type === 'spot' ? 'æ™¯é»' : (evt.type === 'shop' ? 'è³¼ç‰©' : 'äº¤é€š'))); 
            document.getElementById('view-time').innerText = `${evt.time}`; 
            document.getElementById('view-story').innerText = evt.story || "æš«ç„¡è©³ç´°ä»‹ç´¹..."; 
            document.getElementById('view-tips').innerText = evt.tips || "æš«ç„¡ç‰¹åˆ¥æ”»ç•¥..."; 
            document.getElementById('view-note').innerText = evt.note || "-"; 
            
            const mapBtn = document.getElementById('view-map-btn'); 
            let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' åŒ—æµ·é“')}`;

            if (evt.type === 'move') {
                let origin = null, destination = null;
                const HOTEL = 'æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—';

                if (dayIdx >= 1 && dayIdx <= 5) {
                    let isFirstMove = true;
                    for (let k = 0; k < evtIdx; k++) {
                        if (itineraryData[dayIdx].events[k].type === 'move') {
                            isFirstMove = false;
                            break;
                        }
                    }
                    if (isFirstMove) {
                        origin = HOTEL;
                    }
                }

                if (evt.title.includes('è¿”å›é£¯åº—')) {
                    destination = HOTEL;
                }
                
                if (!origin) {
                    let pD = dayIdx, pE = evtIdx - 1;
                    while(pD >= 0) {
                        if (pE < 0) {
                            pD--;
                            if (pD >= 0) pE = itineraryData[pD].events.length - 1;
                            continue;
                        }
                        const cand = itineraryData[pD].events[pE];
                        if (cand.type !== 'move') { origin = cand.title; break; }
                        pE--;
                    }
                }
                
                if (!destination) {
                    let nD = dayIdx, nE = evtIdx + 1;
                    while(nD < itineraryData.length) {
                        if (nE >= itineraryData[nD].events.length) {
                            nD++;
                            nE = 0;
                            continue;
                        }
                        const cand = itineraryData[nD].events[nE];
                        if (cand.type !== 'move') { destination = cand.title; break; }
                        nE++;
                    }
                }

                if (origin && destination) {
                    mapUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin + ' åŒ—æµ·é“')}&destination=${encodeURIComponent(destination + ' åŒ—æµ·é“')}&travelmode=transit`;
                } else if (destination) {
                    mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination + ' åŒ—æµ·é“')}&travelmode=transit`;
                }
            }

            mapBtn.href = mapUrl;

            const imgMap = { 'food': 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=800', 'spot': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=800', 'shop': 'https://images.unsplash.com/photo-1472851294608-4151713425a5?q=80&w=800', 'transport': 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=800', 'stay': 'https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=800', 'move': 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=800' }; 
            document.getElementById('view-img').src = imgMap[evt.type] || imgMap['spot']; 
            const modal = document.getElementById('view-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.add('translate-y-0', 'sm:scale-100'); }, 10); 
            document.body.classList.add('modal-active'); 
        }
        function closeViewModal() { const modal = document.getElementById('view-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.remove('translate-y-0', 'sm:scale-100'); setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); }, 250); }
        function switchToEdit() { closeViewModal(); setTimeout(() => { openEditModal(currentDayIdx, currentEvtIdx); }, 300); }
        
        function initWallet() { 
            const savedRate = localStorage.getItem('hk_rate_v1');
            const lastFetch = localStorage.getItem('hk_rate_date');
            const today = new Date().toDateString();

            const dateInput = document.getElementById('expense-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }

            if (savedRate) {
                document.getElementById('exchange-rate').value = savedRate;
            }

            if (lastFetch !== today) {
                fetchExchangeRate();
            } else {
                const time = localStorage.getItem('hk_rate_time');
                if(time) document.getElementById('rate-update-time').innerText = `æ›´æ–°æ–¼: ${time}`;
            }

            renderExpenseList(); 
            
            document.getElementById('jpy-input').addEventListener('input', calculateRate);
            document.getElementById('exchange-rate').addEventListener('input', calculateRate);
        }

        function fetchExchangeRate(manual = false) {
            const statusEl = document.getElementById('rate-update-time');
            if(manual) statusEl.innerText = "æ›´æ–°ä¸­...";
            
            const targetUrl = 'https://tw.rter.info/capi.php';
            
            // Primary: AllOrigins
            const url1 = 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl);
            
            // Fallback: CORS Proxy
            const url2 = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

            const processData = (json, isAllOrigins = false) => {
                let data = json;
                if (isAllOrigins) {
                     data = JSON.parse(json.contents);
                }
                
                if (data.USDTWD && data.USDJPY) {
                    const rate = data.USDTWD.Exrate / data.USDJPY.Exrate;
                    return rate.toFixed(4);
                }
                throw new Error("Data format error");
            };

            fetch(url1)
                .then(res => {
                    if (!res.ok) throw new Error('Proxy 1 failed');
                    return res.json();
                })
                .then(data => {
                     return processData(data, true);
                })
                .catch(err => {
                    console.warn('Primary proxy failed, trying backup...', err);
                    return fetch(url2)
                        .then(res => {
                             if (!res.ok) throw new Error('Proxy 2 failed');
                             return res.json();
                        })
                        .then(data => {
                            return processData(data, false); 
                        });
                })
                .then(finalRate => {
                    document.getElementById('exchange-rate').value = finalRate;
                    
                    localStorage.setItem('hk_rate_v1', finalRate);
                    localStorage.setItem('hk_rate_date', new Date().toDateString());
                    
                    const timeStr = new Date().toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
                    localStorage.setItem('hk_rate_time', timeStr);
                    statusEl.innerText = `æ›´æ–°æ–¼: ${timeStr}`;
                    
                    calculateRate();
                    if(manual) showToast(`åŒ¯ç‡æ›´æ–°: ${finalRate}`, 'success');
                })
                .catch(err => {
                    console.error('All exchange rate sources failed', err);
                    if(manual) showToast('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯', 'error');
                    statusEl.innerText = "æ›´æ–°å¤±æ•—";
                });
        }

        function calculateRate() { 
            const input = document.getElementById('jpy-input').value; 
            const rate = parseFloat(document.getElementById('exchange-rate').value); 
            const output = document.getElementById('twd-output'); 
            try { 
                const clean = input.replace(/[^0-9+\-*/().]/g, ''); 
                if(!clean) { output.innerText = "0"; return; }
                const jpy = Function('"use strict";return (' + clean + ')')(); 
                const twd = Math.round(jpy * rate); 
                output.innerText = twd.toLocaleString(); 
            } catch(e) { output.innerText = "Err"; } 
        }

        function addExpense() { 
            const payer = document.getElementById('expense-payer').value; 
            const itemInput = document.getElementById('expense-item');
            const priceInput = document.getElementById('expense-price');
            const dateInput = document.getElementById('expense-date');
            
            const item = itemInput.value; 
            const price = priceInput.value; 
            const currentRate = parseFloat(document.getElementById('exchange-rate').value);
            const fileInput = document.getElementById('expense-photo'); 
            
            const expenseDate = dateInput.value || new Date().toISOString().split('T')[0];

            if(!item || !price) { 
                if(!item) itemInput.classList.add('input-error');
                if(!price) priceInput.classList.add('input-error');
                showToast("è«‹å¡«å¯«å¿…è¦æ¬„ä½", 'error');
                setTimeout(() => {
                    itemInput.classList.remove('input-error');
                    priceInput.classList.remove('input-error');
                }, 500);
                return; 
            } 
            
            const jpyPrice = parseFloat(price);
            const twdPrice = Math.round(jpyPrice * currentRate); 

            const processSave = (img) => { 
                    const data = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                    data.unshift({ 
                        id: Date.now(), 
                        payer, 
                        item, 
                        price: jpyPrice, 
                        rate: currentRate, 
                        twd: twdPrice,     
                        img, 
                        date: expenseDate 
                    }); 
                    try { 
                        // 1. å­˜æœ¬æ©Ÿ (åŒ…å«åœ–ç‰‡)
                        localStorage.setItem('hk_wallet_v20', JSON.stringify(data));
                        
                        // â˜…â˜…â˜… 2. åŒæ­¥é›²ç«¯ (ç§»é™¤åœ–ç‰‡ä»¥ç¢ºä¿æˆåŠŸ) â˜…â˜…â˜…
                        // Google Sheets å­˜ä¸ä¸‹å¤§åœ–ç‰‡ï¼Œæˆ‘å€‘æŠŠ img æ¬„ä½æ¸…ç©ºå†ä¸Šå‚³
                        const cleanData = data.map(d => ({...d, img: ''}));
                        saveToCloud('hk_wallet_v20', cleanData); 

                        document.getElementById('expense-item').value = ''; 
                        document.getElementById('expense-price').value = ''; 
                        fileInput.value = ''; 
                        document.getElementById('photo-label').innerText = 'æ‹ç…§/ä¸Šå‚³'; 
                        renderExpenseList(); 
                        showToast("è¨˜å¸³æˆåŠŸä¸¦åŒæ­¥", 'success');
                    } catch(e) { 
                        console.error(e);
                        showToast("å„²å­˜ç©ºé–“å·²æ»¿", 'error'); 
                    } 
                };
            
            if(fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); 
                        const ctx = c.getContext('2d'); 
                        const maxW = 300; 
                        const scale = maxW / img.width; 
                        c.width = maxW; 
                        c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        processSave(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else processSave(null); 
        }
        
        function renderExpenseList() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const container = document.getElementById('expense-list'); 
            let total = 0; 
            let html = ''; 
            
            list.forEach(ex => { 
                const finalTwd = ex.twd !== undefined ? ex.twd : Math.round(ex.price * 0.22); 
                const rateUsed = ex.rate !== undefined ? ex.rate : 0.22;
                const displayDate = ex.date && ex.date.includes('-') ? ex.date.replace(/-/g, '/') : (ex.date || 'Unknown');

                total += ex.price; 
                const payerBadge = ex.payer ? `<span class="text-xs bg-gray-200 text-gray-600 px-1 rounded mr-1">[${ex.payer}]</span>` : ''; 
                
                html += `<div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-100 shadow-sm relative group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded bg-gray-100 flex-shrink-0 bg-cover bg-center border border-gray-200 ${ex.img ? 'cursor-pointer hover:opacity-80 transition' : ''}" style="background-image: url('${ex.img || ''}');" ${ex.img ? `onclick="openImageModal('${ex.img}')"` : ''}>${!ex.img ? '<i class="fas fa-receipt text-gray-300 m-auto h-full flex items-center justify-center"></i>' : ''}</div>
                        <div>
                            <div class="text-sm font-bold text-gray-700">${payerBadge}${ex.item}</div>
                            <div class="text-[10px] text-gray-400">${displayDate} <span class="text-gray-300">| åŒ¯ç‡ ${rateUsed}</span></div>
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <div>
                            <div class="text-sm font-bold">Â¥${ex.price.toLocaleString()}</div>
                            <div class="text-[10px] text-gray-500 font-medium">NT$${finalTwd.toLocaleString()}</div>
                        </div>
                        <div class="flex flex-col gap-2 border-l border-gray-100 pl-2">
                            <button onclick="openExpenseEdit(${ex.id})" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="confirmDeleteExpense(${ex.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>`; 
            }); 
            container.innerHTML = list.length ? html : '<div class="text-center text-gray-300 text-xs mt-4">å°šç„¡æ¶ˆè²»</div>'; 
            document.getElementById('total-expense').innerText = `Total: Â¥${total.toLocaleString()}`; 
        }

        function openExpenseEdit(id) { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const expense = list.find(e => e.id === id); 
            if (!expense) return; 
            currentExpenseId = id; 
            
            document.getElementById('edit-expense-payer').value = expense.payer || 'å°æˆ´'; 
            document.getElementById('edit-expense-item').value = expense.item; 
            document.getElementById('edit-expense-price').value = expense.price; 
            
            document.getElementById('edit-expense-date').value = expense.date || new Date().toISOString().split('T')[0];

            const r = expense.rate || 0.22;
            const t = expense.twd || Math.round(expense.price * r);
            
            document.getElementById('edit-expense-rate').value = r;
            document.getElementById('edit-expense-twd').value = t;

            document.getElementById('edit-expense-photo').value = ''; 
            const modal = document.getElementById('expense-edit-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10); 
        }

        function calcTwdInEdit() {
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            const rate = parseFloat(document.getElementById('edit-expense-rate').value) || 0;
            document.getElementById('edit-expense-twd').value = Math.round(jpy * rate);
        }

        function calcRateInEdit() {
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            const twd = parseFloat(document.getElementById('edit-expense-twd').value) || 0;
            if(jpy !== 0) {
                const newRate = twd / jpy;
                document.getElementById('edit-expense-rate').value = newRate.toFixed(4);
            }
        }

        function closeExpenseEditModal() { const modal = document.getElementById('expense-edit-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); currentExpenseId = null; }, 250); }
        
        function saveExpenseEdit() { 
            if (!currentExpenseId) return; 
            const payer = document.getElementById('edit-expense-payer').value; 
            const item = document.getElementById('edit-expense-item').value; 
            const price = parseFloat(document.getElementById('edit-expense-price').value); 
            const rate = parseFloat(document.getElementById('edit-expense-rate').value); 
            const twd = parseFloat(document.getElementById('edit-expense-twd').value); 
            const dateVal = document.getElementById('edit-expense-date').value;
            const fileInput = document.getElementById('edit-expense-photo'); 
            
            if (!item || isNaN(price)) { showToast("è«‹å¡«å¯«å®Œæ•´", 'error'); return; } 
            
            const updateList = (newImg) => { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const idx = list.findIndex(e => e.id === currentExpenseId); 
            if (idx > -1) { 
                list[idx].payer = payer; 
                list[idx].item = item; 
                list[idx].price = price; 
                list[idx].rate = rate; 
                list[idx].twd = twd;
                list[idx].date = dateVal;
                if (newImg) list[idx].img = newImg; 
                
                // 1. å­˜æœ¬æ©Ÿ
                localStorage.setItem('hk_wallet_v20', JSON.stringify(list)); 
                
                // â˜…â˜…â˜… 2. åŒæ­¥é›²ç«¯ (ç§»é™¤åœ–ç‰‡) â˜…â˜…â˜…
                const cleanList = list.map(d => ({...d, img: ''}));
                saveToCloud('hk_wallet_v20', cleanList);
                
                renderExpenseList(); 
                closeExpenseEditModal(); 
                showToast("ä¿®æ”¹æˆåŠŸä¸¦åŒæ­¥", 'success');
                }   
            };
            
            if (fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); 
                        const ctx = c.getContext('2d'); 
                        const maxW = 300; 
                        const scale = maxW / img.width; 
                        c.width = maxW; 
                        c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        updateList(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else { updateList(null); } 
        }
        
        function confirmDeleteExpense(id) { deleteTarget = 'expense-single'; deleteExpenseId = id; document.getElementById('confirm-msg').innerText="ç¢ºå®šåˆªé™¤æ­¤ç­†æ¶ˆè²»ï¼Ÿ"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        function clearExpenses() { deleteTarget = 'expense-clear'; document.getElementById('confirm-msg').innerText="ç¢ºå®šæ¸…é™¤æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Ÿ"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        
        function exportData() {
            const wallet = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]');
            const shopping = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
            
            let text = "=== åŒ—æµ·é“å†¬æ—… 2025 è³‡æ–™å‚™ä»½ ===\n\n";
            text += "ã€æ”¯å‡ºç´€éŒ„ã€‘\n";
            let totalJpy = 0;
            let totalTwd = 0;
            wallet.forEach(w => {
                const twd = w.twd || Math.round(w.price * (w.rate || 0.22));
                totalJpy += w.price;
                totalTwd += twd;
                // ä½¿ç”¨æ–°æ ¼å¼æ—¥æœŸ
                text += `${w.date} [${w.payer}] ${w.item}: Â¥${w.price.toLocaleString()} (NT$${twd.toLocaleString()})\n`;
            });
            text += `------------------\nç¸½è¨ˆ: Â¥${totalJpy.toLocaleString()} (ç´„ NT$${totalTwd.toLocaleString()})\n\n`;
            
            text += "ã€å¿…è²·æ¸…å–®ã€‘\n";
            shopping.forEach(s => {
                text += `[${s.done ? 'v' : ' '}] ${s.name} - ${s.desc}\n`;
            });

            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Hokkaido_Backup_${new Date().toLocaleDateString().replace(/\//g,'')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openSplitBillModal() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const members = ['å°æˆ´', 'ä½³æ¬£', 'ä½³è±', 'çŸå»·']; 
            let totals = {}; members.forEach(m => totals[m] = 0); 
            let grandTotal = 0; 
            
            list.forEach(ex => { 
                if (totals[ex.payer] !== undefined) { 
                    const amount = ex.twd !== undefined ? ex.twd : Math.round(ex.price * 0.22);
                    totals[ex.payer] += amount; 
                    grandTotal += amount; 
                } 
            }); 
            
            const average = grandTotal / members.length; 
            
            let summaryHtml = ''; 
            members.forEach(m => { 
                const paid = totals[m]; 
                const diff = paid - average; 
                const diffClass = diff >= 0 ? 'text-green-600' : 'text-red-500'; 
                const diffSign = diff >= 0 ? '+' : ''; 
                summaryHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-50 last:border-0"><span class="font-bold text-gray-700 w-16">${m}</span><span class="text-xs text-gray-400">å¢Š NT$${paid.toLocaleString()}</span><span class="font-mono ${diffClass} w-24 text-right">${diffSign} $${Math.round(diff).toLocaleString()}</span></div>`; 
            });
            
            document.getElementById('split-summary').innerHTML = summaryHtml; 
            document.getElementById('split-average').innerText = `NT$${Math.round(average).toLocaleString()}`; 
            
            let debtors = []; let creditors = []; 
            members.forEach(m => { 
                const diff = totals[m] - average; 
                if (diff < -1) debtors.push({ name: m, amount: -diff }); 
                else if (diff > 1) creditors.push({ name: m, amount: diff }); 
            }); 
            debtors.sort((a, b) => b.amount - a.amount); 
            creditors.sort((a, b) => b.amount - a.amount); 
            
            let planHtml = ''; 
            let i = 0, j = 0; 
            if(debtors.length === 0 && creditors.length === 0) { 
                planHtml = '<div class="text-center text-green-500 font-bold py-2">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼</div>'; 
            } else { 
                while (i < debtors.length && j < creditors.length) { 
                    let debtor = debtors[i]; 
                    let creditor = creditors[j]; 
                    let amount = Math.min(debtor.amount, creditor.amount); 
                    planHtml += `<div class="flex items-center justify-between bg-gray-50 p-2 rounded text-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-700">${debtor.name}</span><i class="fas fa-long-arrow-alt-right text-gray-400"></i><span class="font-bold text-gray-700">${creditor.name}</span></div><div class="font-mono font-bold text-muji-accent">NT$${Math.round(amount).toLocaleString()}</div></div>`; 
                    debtor.amount -= amount; 
                    creditor.amount -= amount; 
                    if (debtor.amount < 1) i++; 
                    if (creditor.amount < 1) j++; 
                } 
            } 
            document.getElementById('split-plan').innerHTML = planHtml; 
            const modal = document.getElementById('split-bill-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10); 
        }
        function closeSplitBillModal() { const modal = document.getElementById('split-bill-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); }, 250); }
        
        // --- UPDATED: CHECKLIST LOGIC (Collapsible, Default Closed) ---
        function initChecklist() {
            // è¨­å®šé è¨­æ¸…å–®åˆ†é¡
            const defaultChecklistData = [
            { category: 'éš¨èº«åŒ…åŒ…', items: ['éŒ¢åŒ…','è­·ç…§','è€³æ©Ÿ','è¡Œå‹•é›»æº','å£ç½©','è—¥','è¡›ç”Ÿæ£‰','è³¼ç‰©è¢‹','é›¨å‚˜','è¢–çåŒ…','æ¿•ç´™å·¾',] },
            { category: 'ç™»æ©Ÿè¡Œæ', items: ['è­·ç…§','ç–«è‹—å¡ã€åœ‹éš›è­·ç…§','AirPods ','å£ç½©','é…’ç²¾','ç­†','ä¿æº«æ¯'] },
            { category: 'åŒ–å¦ã€ä¿é¤Šå“', items: ['é˜²æ›¬','ç²‰åº•æ¶²','çœ‰ç­†','å£ç´…','ç²‰æ’²','å¸å¦æ£‰+æ°´','ä¹³æ¶²','è­·å”‡è†','æ¢³å­','é«®åœˆ','éš±çœ¼','æ­¢æ±—åŠ‘'] },
            { category: 'ç›¥æ´—ç”¨å“', items: ['æ´—é¢ä¹³','ç‰™è† ç‰™åˆ·','æ´—è¡£ç²‰ï¼ˆçƒï¼‰','ä¹¾æ·¨å¤¾éˆè¢‹'] },
            { category: 'è¡£æœ', items: ['è¥ªå­','å…§è¡£','ç´™å…§è¤²','ä¸Šè¡£','ä¸‹èº«','ç¡è¡£','æ‹–é‹','å¸½å­','æ‰‹å¥— åœå·¾','ç™¼ç†±è¡£ è¤²','é«’è¡£è¢‹'] },
            { category: '3C', items: ['æ‰‹æ©Ÿå……é›»å™¨','æ‰‹éŒ¶å……é›»å™¨','è¡Œå‹•é›»æº','è±†è…é ­ + type cç·š','ç›¸æ©Ÿå……é›»å™¨','ç›¸æ©Ÿ'] },
            { category: 'åŒ—æµ·é“æ—…è¡Œç”¨å“', items: ['æ¯›å¸½','ç¾½çµ¨å¤–å¥—','ç™¼ç†±è¡£','ç™¼ç†±è¤²','æ‰‹å¥—','é›ªé´ or é˜²æ°´é‹','éš±çœ¼','å¢¨é¡','æ¯›è¡£','åŠæ¡¶è¥ªï¼ˆåˆ°å°è…¿ - æ»‘é›ªç”¨','é•·è¥ª - ä¸€èˆ¬æ­¥è¡Œ','æš–æš–åŒ…'] },

            ];
            
            const rawData = defaultChecklistData.map(cat => ({ 
                category: cat.category, 
                isOpen: false, 
                items: cat.items.map(txt => ({ txt: txt, done: false })) 
            }));
            
            let stored = JSON.parse(localStorage.getItem('hk_checks_v20'));
            
            // ç¢ºä¿ isOpen å±¬æ€§å­˜åœ¨
            if(stored && Array.isArray(stored)) {
                stored.forEach(g => { if(g.isOpen === undefined) g.isOpen = false; });
            }
            
            if(!stored || !Array.isArray(stored) || stored.length === 0) { 
                stored = rawData; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(stored)); 
            }
            renderChecklist();
        }

        function renderChecklist() {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            const container = document.getElementById('checklist-groups');
            if (!container) return;
            
            let html = ''; 
            let totalItems = 0; 
            let doneItems = 0;

            if (!Array.isArray(list)) { localStorage.removeItem('hk_checks_v20'); initChecklist(); return; }

            list.forEach((group, catIdx) => {
                if (!group || !group.items) return;
                
                // Collapse logic
                const isOpen = group.isOpen === true; 
                const arrowIcon = isOpen ? 'fa-chevron-up' : 'fa-chevron-down';
                const contentDisplay = isOpen ? 'block' : 'hidden';
                const headerRadius = isOpen ? 'rounded-t-lg' : 'rounded-lg';
                const headerBorder = isOpen ? 'border-b border-gray-100' : '';

                let groupHtml = '';
                group.items.forEach((item, itemIdx) => {
                    totalItems++; if(item.done) doneItems++;
                    groupHtml += `<div onclick="toggleCheck(${catIdx}, ${itemIdx})" class="flex items-center py-2 border-b border-gray-50 last:border-0 group checklist-item active:bg-gray-50 transition-colors">
                        <div class="flex items-center cursor-pointer flex-1 min-w-0">
                            <input type="checkbox" class="peer hidden pointer-events-none" ${item.done ? 'checked' : ''}>
                            <div class="w-5 h-5 border-2 border-gray-300 rounded-md peer-checked:bg-muji-accent peer-checked:border-muji-accent flex items-center justify-center transition-colors flex-shrink-0 pointer-events-none">
                                <i class="fas fa-check text-white text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                            </div>
                            <span class="ml-3 text-sm text-gray-600 peer-checked:line-through peer-checked:text-gray-300 transition-colors select-none truncate pointer-events-none">${item.txt}</span>
                        </div>
                        <button onclick="confirmDeleteCheckItem(${catIdx}, ${itemIdx}); event.stopPropagation();" class="text-gray-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    </div>`;
                });

                html += `
                <div class="bg-white border border-gray-100 rounded-lg shadow-sm transition-all duration-200">
                    <div class="p-3 bg-gray-50 ${headerRadius} ${headerBorder} flex justify-between items-center cursor-pointer hover:bg-gray-100 transition select-none" onclick="toggleCheckGroup(${catIdx})">
                        <div class="flex items-center gap-2">
                            <i class="fas ${arrowIcon} text-xs text-gray-400 w-4 text-center"></i>
                            <h4 class="font-bold text-gray-700 text-sm">${group.category} <span class="text-[10px] text-gray-400 font-normal ml-1">(${group.items.filter(i=>i.done).length}/${group.items.length})</span></h4>
                        </div>
                        <button onclick="confirmDeleteCheckCategory(${catIdx}); event.stopPropagation();" class="text-xs text-gray-300 hover:text-red-400 px-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="${contentDisplay} p-3 pt-0">
                        <div class="space-y-0 mt-2">${groupHtml}</div>
                        <div class="mt-2 pt-2 flex items-center border-t border-gray-50">
                            <input type="text" placeholder="æ–°å¢é …ç›®..." class="flex-1 text-xs bg-gray-50 border border-transparent hover:bg-white hover:border-gray-200 focus:bg-white focus:border-muji-accent rounded px-2 py-1 outline-none transition" onchange="addCheckItem(${catIdx}, this)">
                            <button class="ml-2 text-muji-accent text-sm w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100" onclick="addCheckItemBtn(${catIdx}, this.previousElementSibling)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html; 
            updateChecklistProgress(doneItems, totalItems);
        }

        function toggleCheckGroup(catIdx) {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20'));
            if (list && list[catIdx]) {
                const current = list[catIdx].isOpen === true;
                list[catIdx].isOpen = !current;
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist();
            }
        }

        function addCheckItemBtn(catIdx, input) {
            addCheckItem(catIdx, input);
        }

        function toggleCheck(catIdx, itemIdx) { 
            const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
            if (list && list[catIdx] && list[catIdx].items[itemIdx]) { 
                list[catIdx].items[itemIdx].done = !list[catIdx].items[itemIdx].done; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
            } 
        }

        function initShoppingList() { 
            let stored = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            if (!stored) { 
                stored = JSON.parse(JSON.stringify(defaultShoppingList)); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(stored)); 
            } 
            renderShoppingList(); 
        }
        function renderShoppingList() { 
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
            const container = document.getElementById('shopping-container'); 
            let filteredList = list; 
            if (currentShoppingFilter !== 'all') { 
                filteredList = list.filter(item => item.type === currentShoppingFilter); 
            } 
            if (filteredList.length === 0) { 
                container.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">æ²’æœ‰ç›¸é—œé …ç›®</div>'; 
                return; 
            } 
            let html = ''; 
            filteredList.forEach((item) => { 
                const opacityClass = item.done ? 'opacity-50 grayscale' : ''; 
                const lineThrough = item.done ? 'line-through' : ''; 
                const checkIcon = item.done ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-200'; 
                html += `<div class="flex items-start bg-white p-3 rounded-lg border border-gray-100 shadow-sm ${opacityClass} transition-all relative group"><div class="w-16 h-16 rounded-md bg-gray-100 bg-cover bg-center shrink-0 cursor-pointer" style="background-image: url('${item.img}')" onclick="openImageModal('${item.img}')"></div><div class="flex-1 px-3 min-w-0"><h4 class="text-sm font-bold text-gray-800 ${lineThrough} truncate">${item.name}</h4><p class="text-[10px] text-gray-500 mt-1 leading-tight line-clamp-2">${item.desc}</p></div><div class="flex flex-col items-center gap-2 ml-2"><button onclick="toggleShoppingCheck('${item.id}')" class="text-xl focus:outline-none"><i class="fas ${checkIcon}"></i></button><div class="flex gap-2 mt-1"><button onclick="openShoppingModal('${item.id}')" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button><button onclick="confirmDeleteShopping('${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div></div>`; 
            }); 
            container.innerHTML = html; 
        }
        function filterShopping(type) { 
            currentShoppingFilter = type; 
            const buttons = document.querySelectorAll('#view-shopping button'); 
            buttons.forEach(btn => { 
                if(btn.parentElement.classList.contains('overflow-x-auto')) { 
                    if(btn.textContent === (type==='all'?'å…¨éƒ¨':(type==='drug'?'è—¥å¦':(type==='souvenir'?'ä¼´æ‰‹ç¦®':'å…¶ä»–')))) { 
                        btn.className = "px-3 py-1 bg-muji-accent text-white rounded-full text-xs whitespace-nowrap shadow-sm"; 
                    } else { 
                        btn.className = "px-3 py-1 bg-white border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap"; 
                    } 
                } 
            }); 
            renderShoppingList(); 
        }
        function toggleShoppingCheck(id) { 
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            const item = list.find(i => i.id === id); 
            if (item) { 
                item.done = !item.done; 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(list)); 
                renderShoppingList(); 
            } 
        }
        function openShoppingModal(id) { 
            currentShoppingId = id; 
            const modal = document.getElementById('shopping-edit-modal'); 
            const title = document.getElementById('shopping-modal-title'); 
            document.getElementById('shop-name').value = ''; 
            document.getElementById('shop-type').value = 'drug'; 
            document.getElementById('shop-desc').value = ''; 
            document.getElementById('shop-photo').value = ''; 
            if(id) { 
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
                const item = list.find(i => i.id === id); 
                if(item) { 
                    title.innerText = "ç·¨è¼¯å¿…è²·"; 
                    document.getElementById('shop-name').value = item.name; 
                    document.getElementById('shop-type').value = item.type; 
                    document.getElementById('shop-desc').value = item.desc; 
                } 
            } else { 
                title.innerText = "æ–°å¢å¿…è²·"; 
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }
        function closeShoppingModal() { 
            const modal = document.getElementById('shopping-edit-modal'); 
            modal.classList.add('opacity-0'); 
            modal.querySelector('div').classList.remove('scale-100'); 
            modal.querySelector('div').classList.add('scale-95'); 
            setTimeout(() => { modal.classList.add('hidden'); currentShoppingId = null; }, 250); 
        }
        function saveShoppingItem() {
            const name = document.getElementById('shop-name').value.trim();
            const type = document.getElementById('shop-type').value;
            const desc = document.getElementById('shop-desc').value.trim();
            const fileInput = document.getElementById('shop-photo');

            if (!name) { alert('è«‹è¼¸å…¥å•†å“åç¨±'); return; }

            const processSave = (img) => {
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                
                if (currentShoppingId) {
                    // ä¿®æ”¹ç¾æœ‰
                    const idx = list.findIndex(i => i.id === currentShoppingId);
                    if (idx > -1) {
                        list[idx].name = name;
                        list[idx].type = type;
                        list[idx].desc = desc;
                        if (img) list[idx].img = img;
                    }
                } else {
                    // æ–°å¢
                    const newItem = {
                        id: 'c' + Date.now(),
                        type: type,
                        name: name,
                        desc: desc,
                        done: false,
                        img: img || 'https://placehold.co/100x100/e5e7eb/4b5563?text=No+Img'
                    };
                    list.unshift(newItem);
                }

                try {
                    localStorage.setItem('hk_shopping_v20', JSON.stringify(list));
                    renderShoppingList();
                    closeShoppingModal();
                    if (currentShoppingFilter !== 'all' && currentShoppingFilter !== type) {
                        filterShopping(type);
                    }
                } catch (e) {
                    alert("å„²å­˜å¤±æ•—");
                    console.error(e);
                }
            };

            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        const maxW = 300;
                        const scale = maxW / img.width;
                        c.width = maxW;
                        c.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        processSave(c.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processSave(null);
            }
        }

        function confirmDeleteShopping(id) { deleteTarget = 'shopping'; deleteShoppingId = id; document.getElementById('confirm-modal').classList.remove('hidden'); }
        function toggleListTab(tab) { const viewCheck = document.getElementById('view-checklist'); const viewShop = document.getElementById('view-shopping'); const btnCheck = document.getElementById('btn-checklist'); const btnShop = document.getElementById('btn-shopping'); if (tab === 'checklist') { viewCheck.classList.remove('hidden'); viewShop.classList.add('hidden'); btnCheck.classList.add('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnCheck.classList.remove('text-gray-500'); btnShop.classList.remove('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnShop.classList.add('text-gray-500'); } else { viewShop.classList.remove('hidden'); viewCheck.classList.add('hidden'); btnShop.classList.add('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnShop.classList.remove('text-gray-500'); btnCheck.classList.remove('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnCheck.classList.add('text-gray-500'); } }
        function initMemo() { const txt = localStorage.getItem('hk_memo_v2') || ''; if(document.getElementById('memo-area')) { document.getElementById('memo-area').value = txt; renderMemoLinks(txt); } }
        function saveMemo() { const txt = document.getElementById('memo-area').value; localStorage.setItem('hk_memo_v2', txt); renderMemoLinks(txt); alert('å·²å„²å­˜'); }
        function renderMemoLinks(txt) { const matches = txt.match(/(https?:\/\/[^\s]+)/g); const container = document.getElementById('memo-links'); if(matches) { container.innerHTML = matches.map(url => `<a href="${url}" target="_blank" class="block truncate text-xs text-blue-500 bg-blue-50 p-2 rounded hover:bg-blue-100"><i class="fas fa-link mr-1"></i>${url}</a>`).join(''); } else { container.innerHTML = '<span class="text-[10px] text-gray-300">å°šç„¡é€£çµ</span>'; } }
        
        // æ–°å¢ï¼šæ›´æ–°æ¸…å–®é€²åº¦æ¢
        function updateChecklistProgress(doneItems = 0, totalItems = 0) {
            // è‹¥å‘¼å«æ™‚æœªå‚³åƒï¼Œå˜—è©¦å¾ localStorage è¨ˆç®—
            try {
                const bar = document.getElementById('progress-bar');
                const text = document.getElementById('progress-text');
                if (!bar || !text) return;
                if (totalItems === 0) {
                    const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
                    let total = 0, done = 0;
                    list.forEach(g => { if (g.items) g.items.forEach(i => { total++; if (i.done) done++; }); });
                    totalItems = total; doneItems = done;
                }
                const percent = totalItems > 0 ? Math.round((doneItems / totalItems) * 100) : 0;
                bar.style.width = percent + '%';
                text.innerText = percent + '%';
            } catch (e) {
                console.warn('updateChecklistProgress error', e);
            }
        }

        // --- TIME CHAINING LOGIC ---
        // æ–°å¢ï¼šç•¶è¡Œç¨‹çµæŸæ™‚é–“æ”¹è®Šæ™‚ï¼Œè‡ªå‹•èª¿æ•´å¾ŒçºŒè¡Œç¨‹
        function adjustSchedule(dayIdx, changedEvtIdx, newEndTime) {
            const dayEvents = itineraryData[dayIdx].events;
           
            // ç°¡å–®å¯¦ä½œï¼šå¦‚æœä¸‹ä¸€å€‹è¡Œç¨‹æ˜¯äº¤é€šç§»å‹•ï¼Œå˜—è©¦å°‡å…¶é–‹å§‹æ™‚é–“è¨­ç‚ºç•¶å‰çµæŸæ™‚é–“ + ç·©è¡
            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„é‚è¼¯ï¼šå¦‚æœä¸‹ä¸€å€‹è¡Œç¨‹æ˜¯ "äº¤é€šç§»å‹•(move)"ï¼Œå‰‡å°‡å…¶é–‹å§‹æ™‚é–“è¨­ç‚ºç•¶å‰çµæŸæ™‚é–“
            // é€™è£¡åƒ…åšåŸºæœ¬æ™‚é–“å­—ä¸²è™•ç†ï¼Œè‹¥è¦ç²¾ç¢ºéœ€è½‰ Date ç‰©ä»¶
            // ç‚ºäº†ä¸ç ´å£è¤‡é›œè¡Œç¨‹ï¼Œé€™è£¡æš«æ™‚åƒ…ä½œç‚ºæ‰‹å‹•è§¸ç™¼æç¤º
        }

        function openEditModal(dayIdx, evtIdx) {
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx;
            const modal = document.getElementById('edit-modal');
            const content = modal.querySelector('div');
            const btnDelete = document.getElementById('btn-delete');
            const title = document.getElementById('modal-title');
            if (evtIdx === -1) { 
                title.innerText = "æ–°å¢è¡Œç¨‹"; 
                btnDelete.classList.add('hidden'); 
                document.getElementById('edit-start').value = ""; 
                document.getElementById('edit-end').value = ""; 
                document.getElementById('edit-title').value = ""; 
                document.getElementById('edit-type').value = "spot"; 
                document.getElementById('edit-note').value = ""; 
                document.getElementById('edit-station').value = ""; 
                document.getElementById('edit-tags').value = ""; 
            } 
            else { 
                const evt = itineraryData[dayIdx].events[evtIdx]; 
                title.innerText = "ç·¨è¼¯è¡Œç¨‹"; 
                btnDelete.classList.remove('hidden'); 
                const times = evt.time ? evt.time.split(' ~ ') : ['','']; 
                document.getElementById('edit-start').value = times[0].trim() || ''; 
                document.getElementById('edit-end').value = times[1] ? times[1].trim() : ''; 
                document.getElementById('edit-title').value = evt.title; 
                document.getElementById('edit-type').value = evt.type || 'spot'; 
                document.getElementById('edit-note').value = evt.note || ''; 
                document.getElementById('edit-station').value = evt.station || ''; 
                document.getElementById('edit-tags').value = evt.tags ? evt.tags.join(', ') : ''; 
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
            document.body.classList.add('modal-active');
        }
        function closeModal() {
            const modal = document.getElementById('edit-modal'); const content = modal.querySelector('div');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); currentDayIdx = null; currentEvtIdx = null; }, 250);
        }
        
        // SAVE EVENT WITH TIME CHAINING (Simple Implementation)
        function saveEvent() {
            if (currentDayIdx === null) return;
            const start = document.getElementById('edit-start').value;
            const end = document.getElementById('edit-end').value;
            const title = document.getElementById('edit-title').value;

            if (!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }

            const originalEvt = (currentEvtIdx > -1) ? itineraryData[currentDayIdx].events[currentEvtIdx] : {};
            
            // å»ºç«‹æ–°äº‹ä»¶ç‰©ä»¶
            const newEvent = {
                time: (start && end) ? `${start} ~ ${end}` : (start || ''),
                title,
                type: document.getElementById('edit-type').value,
                note: document.getElementById('edit-note').value,
                station: document.getElementById('edit-station').value,
                tags: document.getElementById('edit-tags').value ? document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(s => s) : [],
                story: originalEvt.story || "",
                tips: originalEvt.tips || ""
            };

            // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ç·¨è¼¯
            if (currentEvtIdx === -1) {
                itineraryData[currentDayIdx].events.push(newEvent);
                // é‡æ–°æ’åº
                itineraryData[currentDayIdx].events.sort((a, b) => a.time.localeCompare(b.time));
            } else {
                itineraryData[currentDayIdx].events[currentEvtIdx] = newEvent;
            }

            // 1. å­˜å…¥æœ¬æ©Ÿ
            localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));

            // â˜…â˜…â˜… 2. åŒæ­¥åˆ°é›²ç«¯ â˜…â˜…â˜…
            saveToCloud('hk_itinerary_v20', itineraryData);

            renderPlan();
            closeModal();
            showToast("è¡Œç¨‹å·²æ›´æ–°ä¸¦åŒæ­¥", "success");
        }
        
        // SMART TIME CHAINING: å¦‚æœä¿®æ”¹äº†çµæŸæ™‚é–“ï¼Œè‡ªå‹•èª¿æ•´ä¸‹ä¸€å€‹è¡Œç¨‹çš„é–‹å§‹æ™‚é–“
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„é‚è¼¯ï¼šå¦‚æœä¸‹ä¸€å€‹è¡Œç¨‹æ˜¯ "äº¤é€šç§»å‹•(move)"ï¼Œå‰‡å°‡å…¶é–‹å§‹æ™‚é–“è¨­ç‚ºç•¶å‰çµæŸæ™‚é–“
        // é€™è£¡åƒ…åšåŸºæœ¬æ™‚é–“å­—ä¸²è™•ç†ï¼Œè‹¥è¦ç²¾ç¢ºéœ€è½‰ Date ç‰©ä»¶
        // ç‚ºäº†ä¸ç ´å£è¤‡é›œè¡Œç¨‹ï¼Œé€™è£¡æš«æ™‚åƒ…ä½œç‚ºæ‰‹å‹•è§¸ç™¼æç¤º
    </script>   
    <!-- Service Worker Registration with Cache Busting -->
    <script>
        if ('serviceWorker' in navigator) {
            // åªåœ¨ http(s) åŸå§‹ä½ç½®è¨»å†Š Service Workerï¼Œé¿å… file:// æ‹‹éŒ¯
            if (location.protocol === 'http:' || location.protocol === 'https:') {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js?v=' + new Date().getTime())
                        .then((reg) => {
                            console.log('Service Worker è¨»å†ŠæˆåŠŸ:', reg);
                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            console.log('æ–°å…§å®¹å·²ä¸‹è¼‰ï¼Œå³å°‡é‡æ–°æ•´ç†...');
                                            window.location.reload();
                                        }
                                    }
                                };
                            };
                        })
                        .catch((err) => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
                });
            } else {
                console.log('è·³é Service Worker è¨»å†Šï¼ˆé http/https å”å®šï¼‰');
            }
        }
    </script>
</body>
</html>