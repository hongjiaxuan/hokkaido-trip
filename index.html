<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北海道冬旅 2025</title>
    
    <!-- PWA 漸進式網路應用程式設定 -->
    <meta name="theme-color" content="#7d6c5e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    
    <!-- Google Fonts中文字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // 將系統預設的 gray 覆蓋為暖灰色 (Stone) 
                        gray: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917', 950: '#0c0a09'
                        },
                        muji: {
                            bg: '#f9f9f9', card: '#ffffff', text: '#4a4a4a', subtext: '#8a8a8a',
                            accent: 'var(--muji-accent)', highlight: '#a84a32', border: '#e5e5e5',
                            transport: '#eff6ff', transportText: '#3b82f6',// 自訂交通顏色
                            spot: '#f0fdf4', spotText: '#15803d',// 自訂景點顏色
                            food: '#fff7ed', foodText: '#c2410c',// 自訂美食顏色
                            shop: '#fdf2f8', shopText: '#be185d',// 自訂購物顏色
                            active: '#2d3748',// 自訂行程選取顏色
                            move: '#f3f4f6'// 自訂移動中顏色
                        }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },// 自訂字體
                    boxShadow: { 'soft': '0 4px 20px rgba(0, 0, 0, 0.05)', 'card': '0 1px 3px rgba(0,0,0,0.1)' }// 自訂陰影
                }
            }
        }
    </script>

    <style>
        body { -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        /* 隱藏滾動條 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Tab 內容切換 */
        .tab-content { display: none !important; }
        .tab-content.active { display: block !important; animation: fadeIn 0.25s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* 行程時間軸樣式 */
        .timeline-line::before { content: ''; position: absolute; top: 16px; bottom: -16px; left: 18px; width: 2px; background: #e5e5e5; z-index: 0; }
        .timeline-line:last-child::before { display: none; }
        .timeline-line.type-move::before { border-left: 2px dashed #cbd5e1; background: transparent; width: 0; }
        /* 標籤樣式 */
        .tag-must-eat { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .tag-must-buy { background-color: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; }
        .tag-reserve { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-transport { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        /* Event Active 事件狀態定義 */
        .event-active { background-color: #2d3748 !important; color: white !important; border-left-color: #a84a32 !important; box-shadow: 0 0 15px rgba(45, 55, 72, 0.3); }
        .event-active h4, .event-active .transport-detail { color: white !important; }
        .event-active span, .event-active p, .event-active i { color: #cbd5e0 !important; }
        /* Pulse Animation 脈衝動畫*/
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        /* Floating Action Button 浮動按鈕*/
        .fab-btn { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .fab-btn:active { transform: scale(0.9); }
        /* Checklist Item 清單項目*/
        .checklist-item { cursor: pointer; user-select: none; }
        .checklist-item:active { background-color: #f3f4f6; }
        /* Toast Notification 彈出通知*/
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-direction: column;align-items: center; gap: 10px; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: rgba(45, 55, 72, 0.95); color: white; padding: 8px 16px; border-radius: 50px; font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(-20px); transition: all 0.2s ease; text-align: center; backdrop-filter: blur(4px); pointer-events: auto; display: inline-flex; width: auto;max-width: 80%;align-items: center; justify-content: center; gap: 6px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: rgba(220, 38, 38, 0.95); }
        .toast.success { background: rgba(22, 163, 74, 0.95); }
        /* Error Input Animation錯誤輸入動畫*/
        .input-error { border-color: #ef4444 !important; animation: shake 0.3s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        /* Progress Bar 進度條*/
        #progress-bar { transition: width 0.3s ease; }
        /* --- 深色模式標籤優化 (更新版：低光害霓虹風格) --- */
        /* 背景變深 (0.3 -> 0.2)，文字變亮，邊框改為半透明 */
        .dark .tag-must-eat { background-color: rgba(124, 45, 18, 0.4); color: #fdba74; border: 1px solid rgba(253, 186, 116, 0.2); }
        .dark .tag-must-buy { background-color: rgba(131, 24, 67, 0.4); color: #fbcfe8; border: 1px solid rgba(251, 207, 232, 0.2); }
        .dark .tag-reserve { background-color: rgba(113, 63, 18, 0.4); color: #fde047; border: 1px solid rgba(253, 224, 71, 0.2); }
        .dark .tag-transport { background-color: rgba(30, 58, 138, 0.4); color: #93c5fd; border: 1px solid rgba(147, 197, 253, 0.2); }
        
        /* 深色模式下的 Event Active 狀態微調 */
        /* 選取時改為深灰色底，搭配奶茶色邊框，文字維持白色 */
        .dark .event-active { background-color: #262626 !important; border-left-color: #d6d3d1 !important; }
        .dark .event-active h4, .dark .event-active span { color: #f5f5f4 !important; }
        
        /* --- 深色模式卡片層次優化 (新增) --- */
        /* 在深色模式下，幫卡片加上微弱的邊框，取代看不見的陰影 */
        .dark .shadow-card, .dark .shadow-sm, .dark .shadow-lg {
            box-shadow: none !important; /* 移除無用的陰影 */
            border: 1px solid rgba(255, 255, 255, 0.1); /* 加上 10% 白色的細邊框 */
        }        /* --- 拖曳排序樣式 --- */
        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        /* 防止拖曳時選取到文字 */
        .sortable-item { user-select: none; }
        /* 拖曳中的半透明效果 */
        .sortable-ghost { opacity: 0.4; background: #f3f4f6; }
        /* --- 核心配色變數 (新增) --- */
        :root {
            /* 淺色模式：原本的深褐灰色 */
            --muji-accent: #7d6c5e;
        }
        .dark {
            /* 深色模式：改為明亮的奶茶色/淺卡其色，解決對比度不足的問題 */
            --muji-accent: #d6d3d1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-screen flex justify-center overflow-hidden font-sans">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- App Container -->
    <div class="w-full max-w-md h-full bg-muji-bg dark:bg-gray-900 flex flex-col relative shadow-2xl overflow-hidden mx-auto">
        
        <!-- Header -->
        <header class="bg-muji-card px-5 py-4 shadow-sm z-20 flex justify-between items-center shrink-0 border-b border-gray-100 select-none dark:bg-gray-800 dark:border-gray-700">            
            <div>
                <h1 class="text-xl font-serif font-bold text-muji-accent dark:text-stone-200 tracking-widest">HOKKAIDO</h1>
                <p class="text-[10px] text-muji-subtext dark:text-stone-400 tracking-wider uppercase">Winter Trip 2025</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openSettingsModal()" class="w-8 h-8 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200 hover:text-gray-700 dark:text-gray-100 transition shadow-sm">
                    <i class="fas fa-cog"></i>
                </button>
                <div id="header-user-icon" class="w-8 h-8 bg-muji-accent rounded-full flex items-center justify-center text-white shadow-sm cursor-pointer overflow-hidden transition-transform active:scale-90" onclick="showToast('歡迎來到北海道！', 'info')">
                    <i class="fas fa-snowflake animate-pulse"></i>
                </div>  
            </div>
        </header>
        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative pb-20" id="main-container">

            <!-- SECTION: PLAN (行程) -->
            <section id="plan" class="tab-content active h-full">
                <div class="flex flex-col h-full p-4 pb-0 relative">
                    <div class="flex overflow-x-auto hide-scrollbar gap-2 mb-3 pb-1" id="date-scroll-container"></div>
                    <div id="plan-weather-card" class="mb-3"></div>
                    <div id="itinerary-list" class="space-y-4 pb-24 flex-1 overflow-y-auto hide-scrollbar pr-1"></div>
                    
                    <button onclick="openEditModal(currentSelectedDayIndex, -1)" class="fab-btn absolute bottom-6 right-4 w-14 h-14 bg-muji-accent text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white">
                        <i class="fas fa-plus text-2xl"></i>
                    </button>
                    <div class="absolute bottom-6 left-4 z-30">
                        <button onclick="resetItinerary()" class="text-[10px] text-gray-300 underline hover:text-red-400 bg-white dark:bg-gray-800/80 px-2 py-1 rounded backdrop-blur-sm">恢復預設</button>
                    </div>
                </div>
            </section>

            <!-- SECTION: GUIDE (導覽) -->
            <section id="guide" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
                    
                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">札幌深度導覽</h2>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-2 flex items-center"><i class="fas fa-shopping-basket text-blue-500 mr-2"></i>在地超市文化體驗</h3>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-blue-100 dark:border-blue-900/50 mb-6">
                        <p class="text-xs text-gray-500 mb-4 leading-relaxed">體驗日本在地生活最好的方式就是逛超市！以下推薦距離您住宿（中島公園）與狸小路行程順路的超市。</p>
                        <div class="space-y-5">
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-100 dark:text-gray-200">📍 飯店周邊 (中島公園)</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-blue-600 dark:text-blue-400 dark:text-blue-300">MaxValu 南7条店</span><p class="text-[10px] text-gray-500">24小時營業，規模中等但應有盡有。</p></div>
                                    <div><span class="text-xs font-bold text-orange-500">Seicomart</span><p class="text-[10px] text-gray-500">北海道最強超商，必吃 Hot Chef 熟食。</p></div>
                                </div>
                            </div>
                            <div class="border-l-2 border-blue-300 pl-3">
                                <h4 class="text-sm font-bold text-gray-800 dark:text-gray-100">📍 狸小路周邊</h4>
                                <div class="mt-2 space-y-2">
                                    <div><span class="text-xs font-bold text-yellow-600">MEGA 唐吉軻德</span><p class="text-[10px] text-gray-500">B1/B2 生鮮超市區非常強大！</p></div>
                                    <div><span class="text-xs font-bold text-green-600">業務超市</span><p class="text-[10px] text-gray-500">以大份量、超低價聞名。</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>札幌私房備案</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">藻岩山夜景</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">新三大夜景</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">如果天氣好，這裡的夜景比電視塔更壯觀！搭乘纜車上山，俯瞰整個札幌市的寶石般燈火。</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Mt.+Moiwa+Ropeway" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">白色戀人公園</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">童話工廠</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">像是走進查理的巧克力工廠！可以參觀餅乾生產線，冬天還有戶外燈飾。</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Shiroi+Koibito+Park" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">拉麵信玄 (南6条店)</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">排隊名店</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">在地人推薦的味噌拉麵，就在飯店附近，適合當宵夜！</p>
                            <a href="https://www.google.com/maps/search/?api=1&query=Ramen+Shingen+Minami+6-jo" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                    </div>

                    <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">小樽．堺町通深度導覽</h2>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>殿堂級甜點 (一級戰區)</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">LeTAO 本店</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">甜點王者</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">小樽的甜點王者。必吃雙層乳酪蛋糕 (Double Fromage) 與本店限定生乳捲。二樓 Cafe 氣氛極佳。</p>
                            <a href="https://maps.app.goo.gl/54aXLQnse6L5XZg87" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">北菓樓 小樽本館 </h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">石造倉庫</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">內部充滿歷史感。必吃「夢不思議」大泡芙，外皮酥脆內餡爆漿，CP值超高！妖精之森年輪蛋糕也是招牌。</p>
                            <a href="https://maps.app.goo.gl/Xp6VTXTAbiNfM2H26" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-orange-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-orange-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">六花亭 小樽運河店</h4><span class="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded">買甜點送咖啡</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">就在北菓樓隔壁。必買蘭姆葡萄奶油夾心餅乾，有單包裝可挑選。二樓購物滿額常有超便宜或免費咖啡</p>
                            <a href="https://maps.app.goo.gl/fwqHMy3mo1ULhRRY8" target="_blank" class="text-xs text-orange-500 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                    </div>
                    <h3 class="font-bold text-gray-700 dark:text-gray-100 mb-3 mt-4 flex items-center"><i class="fas fa-map-signs text-indigo-500 mr-2"></i>特色IP 與散步美食</h3>
                    <div class="space-y-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-indigo-100 dark:border-indigo-900/50 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-50 dark:bg-indigo-900/20 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">かま栄 工場直營店 (Kamaei)</h4><span class="text-[10px] bg-indigo-100 dark:bg-indigo-900/40 text-indigo-600 px-2 py-1 rounded">麵包捲</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">這是小樽當地人也愛的魚板老店！雖然稍微偏離堺町通尾端㇐點點（靠近運河末端），但非常值得走過去。</p>
                            <a href="https://maps.app.goo.gl/3J1EwY88hqdqmryR9" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-pink-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-pink-50 rounded-bl-full -mr-8 -mt-8"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10"><h4 class="font-bold text-gray-800 dark:text-gray-100">昆布專門店 利尻屋 Minoya</h4><span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-1 rounded">湯霜昆布</span></div>
                            <p class="text-xs text-gray-600 dark:text-gray-300 mb-2 relative z-10">門口招牌寫著「爸爸如果不買，就是媽媽的不對（お父さん預かります）」，非常幽默的店家。</p>
                            <a href="https://maps.app.goo.gl/jBdJE7QKRcwz926G6" target="_blank" class="text-xs text-indigo-500 dark:text-indigo-400 font-bold flex items-center relative z-10"><i class="fas fa-location-arrow mr-1"></i>導航去這裡</a>
                        </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-green-500 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700 dark:text-gray-100 text-sm"><i class="fas fa-map mr-2 text-green-500"></i>小樽堺町通り商店街</h3>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-1 font-bold">吉伊卡哇風格店家分布圖</p>
                            <img src="Otaru.jpg" 
                                 onerror="this.src='https://placehold.co/600x400?text=Otaru+Map'" 
                                 class="w-full rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 cursor-pointer hover:opacity-90 transition object-cover bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600" 
                                 onclick="openImageModal(this.src)">

                        </div>
                    </div>
                           

                </div>
            </section>
            <!-- SECTION: WALLET (錢包) -->
            <section id="wallet" class="tab-content h-full">
                <div class="flex flex-col h-full relative">
                    
                    <div class="shrink-0 z-20 bg-muji-bg dark:bg-gray-900 shadow-sm border-b border-gray-100 dark:border-gray-800 px-4 pt-4 pb-3 transition-colors relative select-text">
                        
                        <div class="bg-gradient-to-br from-stone-600 to-stone-700 text-white p-3 rounded-xl shadow-lg mb-3 relative overflow-hidden">
                            <div class="flex justify-between items-center mb-1 opacity-90">
                                <div class="flex flex-col">
                                    <h3 class="text-[10px] uppercase tracking-widest font-bold text-stone-200">匯率換算</h3>
                                    <span id="rate-update-time" class="text-[8px] text-stone-300">更新中...</span>
                                </div>
                                <div class="text-[10px] bg-white dark:bg-black/30 px-2 py-0.5 rounded flex items-center gap-1 shadow-sm">
                                    <span class="mr-1 text-stone-400 dark:text-stone-500">x</span>
                                    <input type="number" id="exchange-rate" value="0.22" class="w-12 bg-transparent text-center focus:outline-none font-mono font-bold text-stone-700 dark:text-yellow-300 select-text" step="0.0001" inputmode="decimal" onfocus="this.select()">
                                    <button onclick="fetchExchangeRate(true)" class="ml-1 w-4 h-4 flex items-center justify-center bg-gray-100 dark:bg-white/10 rounded-full hover:bg-gray-200 dark:hover:bg-white/20 transition">
                                        <i class="fas fa-sync-alt text-[8px] text-stone-500 dark:text-stone-300"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-end gap-2 justify-between">
                                <div class="flex-1">
                                    <div class="flex items-baseline border-b border-white/20 pb-1">
                                        <span class="text-xs opacity-60 mr-2 text-stone-300">JPY</span>
                                        <input type="number" id="jpy-input" placeholder="0" class="w-full bg-transparent text-xl font-mono font-bold focus:outline-none placeholder-white/20 text-white select-text" inputmode="decimal" onfocus="this.select()">
                                    </div>
                                </div>
                                <div class="text-white/30 pb-1"><i class="fas fa-arrow-right text-xs"></i></div>
                                <div class="flex-1 text-right">
                                    <div class="border-b border-white/20 pb-1">
                                        <div id="twd-output" class="text-2xl font-mono font-bold text-yellow-300 leading-none">0</div>
                                    </div>
                                </div>
                                <span class="text-xs opacity-60 pb-1 text-stone-300">TWD</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-card border border-gray-100 dark:border-gray-700 w-full">
                            
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <select id="expense-payer" class="w-full px-1 py-1.5 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none focus:border-muji-accent">
                                    <option value="小戴">小戴</option>
                                    <option value="佳欣">佳欣</option>
                                    <option value="佳萱">佳萱</option>
                                    <option value="玟廷">玟廷</option>
                                </select>
                                <select id="expense-type" class="w-full px-1 py-1.5 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none focus:border-muji-accent">
                                    <option value="split">公費</option>
                                    <option value="private">私費</option>
                                </select>
                                <input type="date" id="expense-date" class="w-full px-1 py-1.5 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs text-gray-500 text-center focus:outline-none focus:border-muji-accent p-0 select-text">
                            </div>

                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <input type="text" id="expense-item" placeholder="品項名稱" class="w-full min-w-0 px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-100 focus:outline-none focus:border-muji-accent select-text">
                                
                                <input type="number" id="expense-price" placeholder=" ¥ 金額" class="w-full min-w-0 px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-100 focus:outline-none focus:border-muji-accent select-text" onfocus="this.select()">
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <label class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 rounded-lg cursor-pointer hover:bg-gray-200 transition text-sm font-bold">
                                    <i class="fas fa-camera"></i>
                                    <span id="photo-label" class="text-xs">拍照</span>
                                    <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="document.getElementById('photo-label').innerText = '已選'; document.getElementById('photo-label').classList.add('text-muji-accent');">
                                </label>
                                
                                <button onclick="addExpense()" class="w-full bg-muji-accent text-white px-3 py-2 rounded-lg shadow-sm hover:opacity-90 transition text-sm font-bold flex items-center justify-center gap-2">
                                    <i class="fas fa-plus"></i> 儲存
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="expense-container" class="flex-1 overflow-y-auto hide-scrollbar px-4 pt-2 pb-48">
                        <div class="flex justify-between items-center mb-2 px-1 shrink-0">
                            <h3 class="font-bold text-gray-600 dark:text-gray-300 text-sm">支出紀錄</h3>
                            <div class="flex items-center gap-2">
                                <button onclick="openSplitBillModal()" class="text-xs bg-white dark:bg-gray-800 text-muji-accent border border-muji-accent px-2 py-1 rounded hover:bg-muji-accent hover:text-white transition"><i class="fas fa-calculator mr-1"></i>查看分帳</button>
                                <span id="total-expense" class="text-xs font-mono font-bold text-muji-accent">Total: ¥0</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3" id="expense-list"></div>
                        
                        <div class="flex flex-col gap-3 mt-4">
                            <div class="flex justify-center gap-4 text-[10px] text-gray-300">
                                <button onclick="exportData()" class="hover:text-gray-500 transition">匯出純文字 (TXT)</button>
                                <span class="text-gray-200">|</span>
                                <button onclick="clearExpenses()" class="hover:text-red-300 transition">清除記帳</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- SECTION: LISTS (清單) -->
            <section id="lists" class="tab-content h-full">
                <div class="flex flex-col h-full p-4 pb-0 relative">
                    
                    <div class="flex bg-gray-100 dark:bg-gray-800 p-1 rounded-xl mb-4 shrink-0 border border-gray-200 dark:border-gray-700 transition-colors">
                        <button id="btn-checklist" onclick="toggleListTab('checklist')" class="flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-emerald-600 dark:text-emerald-400">
                            <i class="fas fa-clipboard-check mr-1"></i> 行前準備
                        </button>
                        
                        <button id="btn-shopping" onclick="toggleListTab('shopping')" class="flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-medium text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-shopping-cart mr-1"></i> 必買清單
                        </button>
                    </div>

                    <div id="view-checklist" class="flex-1 overflow-y-auto hide-scrollbar pb-24">
                         <div class="bg-white dark:bg-gray-800 rounded-xl shadow-card overflow-hidden mb-4">
                            <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-500">準備進度</span>
                                <div class="flex items-center gap-2"><div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden"><div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div></div><span id="progress-text" class="text-xs font-mono text-gray-600 dark:text-gray-300">0%</span></div>
                            </div>
                            <div id="checklist-groups" class="p-3 space-y-4 pb-6"></div>
                        </div>
                    </div>

                    <div id="view-shopping" class="hidden flex-1 flex flex-col h-full overflow-hidden relative">
                        <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar shrink-0 items-center" id="shopping-filter-container"></div>
                        <div id="shopping-container" class="flex-1 overflow-y-auto hide-scrollbar space-y-3 pb-24"></div>
                    </div>

                    <button id="fab-checklist" onclick="openAddCategoryModal()" class="fab-btn absolute bottom-6 right-4 w-14 h-14 bg-emerald-500 text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white transition-transform duration-300">
                        <i class="fas fa-plus text-2xl"></i>
                    </button>

                    <button id="fab-shopping" onclick="openShoppingModal(null)" class="fab-btn absolute bottom-6 right-4 w-14 h-14 bg-muji-shopText text-white rounded-full shadow-xl flex items-center justify-center z-30 hover:bg-opacity-90 border-2 border-white transition-transform duration-300 hidden">
                        <i class="fas fa-plus text-2xl"></i>
                    </button>

                </div>
            </section>
            <!-- SECTION: INFO 旅遊資訊-->
            <section id="info" class="tab-content h-full">
                <div class="flex flex-col h-full p-3 pb-16 overflow-y-auto hide-scrollbar">
                    
                    <div class="flex items-center gap-2 mb-2 px-1 shrink-0">
                        <i class="fas fa-ticket-alt text-muji-accent text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">機票</h2>
                    </div>
                        
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card overflow-hidden mb-1 relative shrink-0">
                        <div class="absolute top-[70%] -left-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        <div class="absolute top-[70%] -right-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        
                        <div class="p-4 pb-2">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="bg-muji-accent text-white text-[10px] px-2 py-0.5 rounded font-bold tracking-wider">去程</span>
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400">12/18 (四)</span>
                                </div>
                                <i class="fas fa-plane-departure text-gray-300"></i>
                            </div>
                            
                            <div class="flex justify-between items-center mb-1">
                                <div>
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">06:15</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">TPE 台北</div>
                                </div>
                                <div class="flex-1 px-2 flex flex-col items-center">
                                    <span class="text-[9px] text-gray-400 mb-0.5">3h 45m</span>
                                    <div class="w-full h-[1px] bg-gray-300 relative">
                                        <div class="absolute right-0 -top-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                                    </div>
                                    <span class="text-[10px] text-muji-accent font-bold mt-0.5">BR166</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">11:00</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">CTS 札幌</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center bg-gray-50 dark:bg-stone-900 p-1.5 rounded-lg border border-gray-100 dark:border-stone-700">
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">機型</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">A321</div>
                                </div>
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">座位</div>
                                    <div class="text-[10px] font-bold text-muji-accent">29 A-D</div>
                                </div>
                                <div class="text-center w-1/3">
                                    <div class="text-[9px] text-gray-400">航廈</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">T2</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-card overflow-hidden mb-1 relative shrink-0 opacity-95 hover:opacity-100 transition">
                        <div class="absolute top-[64%] -left-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        <div class="absolute top-[64%] -right-3 w-6 h-6 bg-muji-bg dark:bg-gray-900 rounded-full z-10"></div>
                        
                        <div class="p-4 pb-2">
                            <div class="flex justify-between items-start mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="bg-gray-500 text-white text-[10px] px-2 py-0.5 rounded font-bold tracking-wider">回程</span>
                                    <span class="text-xs font-bold text-gray-500 dark:text-gray-400">12/23 (二)</span>
                                </div>
                                <i class="fas fa-plane-arrival text-gray-300"></i>
                            </div>
                            
                            <div class="flex justify-between items-center mb-1">
                                <div>
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">15:20</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">CTS 札幌</div>
                                </div>
                                <div class="flex-1 px-2 flex flex-col items-center">
                                    <span class="text-[9px] text-gray-400 mb-0.5">4h 45m</span>
                                    <div class="w-full h-[1px] bg-gray-300 relative">
                                        <div class="absolute left-0 -top-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-bold mt-0.5">BR115</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 leading-none">19:05</div>
                                    <div class="text-[10px] font-bold text-gray-400 mt-1">TPE 台北</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center bg-gray-50 dark:bg-stone-900 p-1.5 rounded-lg border border-gray-100 dark:border-stone-700">
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">機型</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">787-10</div>
                                </div>
                                <div class="text-center w-1/3 border-r border-gray-200 dark:border-stone-600">
                                    <div class="text-[9px] text-gray-400">座位</div>
                                    <div class="text-[10px] font-bold text-muji-accent">29 F-K</div>
                                </div>
                                <div class="text-center w-1/3">
                                    <div class="text-[9px] text-gray-400">航廈</div>
                                    <div class="text-[10px] font-bold text-gray-700 dark:text-gray-200">國際線</div>
                                </div>
                            </div>
                        </div>

                        <div class="px-4 py-2 bg-gray-50 dark:bg-black/40">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-1.5" title="託運: 2件/人 (各23kg)">
                                    <i class="fas fa-suitcase-rolling text-gray-400 text-xs"></i>
                                    <div class="flex flex-col">
                                        <span class="text-[9px] font-bold text-gray-500 dark:text-gray-400 leading-none">託運 2件(23kg)</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-1.5" title="隨身: 7kg">
                                    <i class="fas fa-briefcase text-gray-400 text-xs"></i>
                                    <div class="flex flex-col">
                                        <span class="text-[9px] font-bold text-gray-500 dark:text-gray-400 leading-none">隨身 7kg</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                <span class="text-xs font-bold text-muji-highlight font-mono">NT$ 28,780/人</span>
                                    </div>
                            </div>
                        </div>

                    </div>                    
                    <div class="flex items-center gap-2 mb-2 px-1 mt-2 shrink-0">
                        <i class="fas fa-hotel text-indigo-400 text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">住宿資訊</h2>
                    </div>

                    <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-card mb-4 border-l-4 border-indigo-400 shrink-0">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-base text-gray-800 dark:text-gray-100 leading-tight">札幌中島公園日航都市酒店</h4>
                                <p class="text-[10px] text-gray-400 mt-1">Hotel JAL City Sapporo Nakajima Park</p>
                            </div>
                            <a href="https://maps.app.goo.gl/somelink" target="_blank" class="w-8 h-8 rounded-full bg-indigo-50 dark:bg-indigo-900/40 text-indigo-500 flex items-center justify-center hover:bg-indigo-100 transition shadow-sm">
                                <i class="fas fa-location-arrow text-xs"></i>
                            </a>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="bg-indigo-50 dark:bg-indigo-900/20 p-2 rounded-lg text-center border border-indigo-100 dark:border-indigo-900/50">
                                <div class="text-[10px] text-indigo-400 mb-1 font-bold">CHECK-IN</div>
                                <div class="text-xl font-bold text-indigo-600 dark:text-indigo-300 font-mono">12/18 15:00</div>
                            </div>
                            <div class="bg-gray-50 dark:bg-stone-900 p-2 rounded-lg text-center border border-gray-100 dark:border-stone-700">
                                <div class="text-[10px] text-gray-400 mb-1 font-bold">CHECK-OUT</div>
                                <div class="text-xl font-bold text-gray-600 dark:text-gray-300 font-mono">12/23 11:00</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded border border-gray-200">
                                <p class="text-xs text-gray-400 mb-1 flex justify-between">
                                    <span>日文地址</span>
                                    <span class="text-[9px] bg-gray-200 dark:bg-gray-700 px-1 rounded text-gray-500">長按複製</span>
                                </p>
                                <p class="text-base font-bold text-gray-800 dark:text-gray-100 leading-relaxed select-all">〒064-0808 <br>北海道札幌市中央区南８条西３丁目１−２５</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mb-4 px-1 mt-2 shrink-0">
                         <i class="fas fa-shield-alt text-red-400 text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">緊急協助</h2>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-card mb-4 border-l-4 border-red-500 shrink-0">
                        <div class="space-y-3">
                             <div>
                                <h4 class="font-bold text-base text-gray-800 dark:text-gray-100 leading-tight">台北駐日經濟文化代表處札幌分處</p>
                                <div class="flex items-center justify-between bg-red-50 dark:bg-red-900/20 p-1 rounded-lg border border-red-100 dark:border-red-900/30">
                                    <a href="tel:+81112222930" class="text-lg font-bold text-red-600 dark:text-red-400 font-mono">
                                    <i class="fas fa-phone mr-2"></i>+81-11-222-2930</a>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-2">北海道札幌市中央區北4條西4丁目1番地 伊藤大樓5樓</p>
                            </div>
                        </div>
                    </div>
                    <!-- Transportation Maps 交通路線 -->
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">
                        <i class="fas fa-map mr-2 text-green-500"></i>交通路線圖
                        </h2>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-card mb-4 border-l-4 border-green-500 shrink-0">
                        <div class="grid grid-cols-2 gap-3">
                            
                            <div class="cursor-pointer group" onclick="openImageModal(this.querySelector('img').src)">
                                <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm aspect-video relative bg-gray-100 dark:bg-gray-900">
                                    <img src="route_map_h_t.jpg" 
                                         onerror="this.src='https://placehold.co/600x400?text=Subway+Map'" 
                                         class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i class="fas fa-search-plus text-white text-lg drop-shadow-md"></i>
                                    </div>
                                </div>
                                <p class="text-[10px] text-center text-gray-500 mt-1.5 font-bold group-hover:text-green-600 transition-colors">札幌地鐵路線圖</p>
                            </div>

                            <div class="cursor-pointer group" onclick="openImageModal(this.querySelector('img').src)">
                                <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm aspect-video relative bg-gray-100 dark:bg-gray-900">
                                    <img src="route_map_sapporo.jpg" 
                                         onerror="this.src='https://placehold.co/600x400?text=JR+Map'" 
                                         class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                    <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i class="fas fa-search-plus text-white text-lg drop-shadow-md"></i>
                                    </div>
                                </div>
                                <p class="text-[10px] text-center text-gray-500 mt-1.5 font-bold group-hover:text-green-600 transition-colors">JR 近郊路線圖</p>
                            </div>

                        </div>
                    </div>
                   <!-- Shopping Coupons 購物優惠券 -->
                    <div class="flex items-center gap-2 mb-3 px-1 mt-6 shrink-0">
                        <i class="fas fa-tags text-pink-500 text-lg"></i>
                        <h2 class="text-lg font-bold text-gray-700 dark:text-gray-100">購物優惠券</h2>
                    </div>

                    <div class="grid grid-cols-4 gap-3 mb-8 shrink-0">
                        
                        <button onclick="openImageModal('札幌藥妝.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-pink-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-pink-50 dark:bg-pink-900/30 flex items-center justify-center text-pink-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-capsules"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">札幌藥妝</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高5%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('Sundrug.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-blue-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-capsules"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">SUNDRUG</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高7%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('EDION.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-red-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center text-red-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">EDION</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高7%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('松本清.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-yellow-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-yellow-50 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 group-hover:scale-110 transition-transform">
                                <i class="fas fa-capsules"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">松本清</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高7%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('鶴羽藥妝.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-yellow-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-yellow-50 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 group-hover:scale-110 transition-transform">
                                <i class="fas fa-capsules"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">鶴羽藥妝</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高7%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('大丸百貨.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-pink-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-pink-50 dark:bg-pink-900/30 flex items-center justify-center text-pink-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">大丸百貨</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高5%</div>
                            </div>
                        </button>
                        <button onclick="openImageModal('BicCamera.jpg')" class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col items-center justify-center gap-2 hover:shadow-md hover:border-red-300 transition group h-24">
                            <div class="w-8 h-8 rounded-full bg-red-50 dark:bg-red-900/30 flex items-center justify-center text-red-500 group-hover:scale-110 transition-transform">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="text-center leading-tight">
                                <div class="text-xs font-bold text-gray-700 dark:text-gray-100">BicCamera</div>
                                <div class="text-[9px] text-gray-400 mt-0.5">10+最高7%</div>
                            </div>
                        </button>

                        </div>

                    </div>
                </div>
            </section>

        </main>

        <!-- Navbar 導覽列 -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-t border-gray-200/50 dark:border-gray-700/50 flex justify-around items-center py-1 px-1 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-40 shrink-0 min-h-[60px] select-none pb-safe transition-all duration-300">
            <button class="nav-btn group w-1/5" data-target="info">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-info-circle text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">資訊</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="lists">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-check-square text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">清單</span>
                </div>
            </button>

            <button class="nav-btn active group w-1/5" data-target="plan">
                <div class="flex flex-col items-center gap-0.5 transition-all">
                    <div class="w-11 h-9 rounded-2xl flex items-center justify-center shadow-sm group-[.active]:shadow-md group-[.active]:scale-105 transition-all duration-300 bg-gray-200 group-[.active]:bg-muji-accent dark:bg-gray-700 dark:group-[.active]:bg-gray-600">
                        <i class="fas fa-map-marked-alt text-lg text-gray-400 group-[.active]:text-white dark:text-gray-400 dark:group-[.active]:text-gray-50 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent group-[.active]:font-bold dark:group-[.active]:text-gray-200 transition-colors">行程</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="wallet">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-wallet text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">錢包</span>
                </div>
            </button>

            <button class="nav-btn group w-1/5" data-target="guide">
                <div class="flex flex-col items-center gap-0.5">
                    <div class="w-9 h-7 rounded-xl flex items-center justify-center transition-colors group-[.active]:bg-muji-accent/10 dark:group-[.active]:bg-gray-700">
                        <i class="fas fa-book-reader text-base text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors"></i>
                    </div>
                    <span class="text-[9px] font-medium text-gray-400 group-[.active]:text-muji-accent dark:group-[.active]:text-gray-200 transition-colors">導覽</span>
                </div>
            </button>
        </nav>
        <!-- MODALS 行程資料卡 -->
        <div id="view-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden opacity-0 transition-opacity flex items-end sm:items-center justify-center">
            <div class="bg-white dark:bg-gray-800 rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-sm max-h-[85vh] overflow-hidden transform translate-y-full sm:translate-y-0 sm:scale-95 transition-transform duration-300 flex flex-col">
                <div class="h-32 bg-gray-200 relative shrink-0">
                    <img id="view-img" src="" class="w-full h-full object-cover">
                    <button onclick="closeViewModal()" class="absolute top-3 right-3 w-8 h-8 bg-black/30 rounded-full text-white flex items-center justify-center backdrop-blur-sm hover:bg-black/50 transition">
                    <i class="fas fa-times"></i>
                    </button>
                    <button onclick="switchToEdit()" class="absolute top-3 right-12 w-8 h-8 bg-white dark:bg-gray-800/90 rounded-full text-gray-600 dark:text-gray-300 flex items-center justify-center shadow-sm hover:text-muji-accent transition">
                    <i class="fas fa-pen text-xs"></i></button>
                </div>
                <div class="p-5 overflow-y-auto">
                <div class="flex justify-between items-start mb-3"><h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 leading-tight" id="view-title">標題</h3>
                    <span class="text-xs bg-gray-100 dark:bg-gray-900 text-gray-500 px-2 py-1 rounded" id="view-type">類型</span></div>
                <div class="flex items-center text-sm text-gray-500 mb-4 font-mono">
                    <i class="far fa-clock mr-2 text-muji-accent"></i>
                    <span id="view-time">00:00</span>
                </div>
                <div class="mb-4">
                    <h4 class="text-xs font-bold text-muji-accent uppercase tracking-wider mb-2 border-b pb-1">介紹 & 故事</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed text-justify" id="view-story">暫無介紹...</p>
                </div>
                <div class="mb-4 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <h4 class="text-xs font-bold text-yellow-700 mb-2 flex items-center">
                    <i class="fas fa-lightbulb mr-2"></i>攻略 & 推薦</h4>
                    <p class="text-sm text-yellow-800 leading-relaxed" id="view-tips">暫無攻略...</p>
                </div>
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">備註</h4>
                    <p class="text-sm text-gray-500" id="view-note">-</p>
                </div>
                <a href="#" id="view-map-btn" target="_blank" class="block w-full bg-muji-accent text-white text-center py-3 rounded-lg font-bold shadow-md hover:opacity-90 transition">
                <i class="fas fa-location-arrow mr-2"></i> 開啟 Google Maps</a>
                </div>
            </div>
        </div>
        
        <!-- EDIT MODAL 新增行程卡片-->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100" id="modal-title">編輯行程</h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="bg-gray-50 dark:bg-stone-900/50 p-3 rounded-lg border border-gray-100 dark:border-stone-700 mb-2">
                        <div class="flex items-end gap-3 mb-3">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">開始時間</label>
                                <input type="time" id="edit-start" oninput="syncTime('start')" class="w-full p-2 border border-gray-200 rounded text-base bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:border-muji-accent focus:outline-none shadow-sm">
                            </div>
                            <div class="pb-3 text-gray-300 dark:text-gray-600">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1">結束時間</label>
                                <input type="time" id="edit-end" oninput="syncTime('end')" class="w-full p-2 border border-gray-200 rounded text-base bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:border-muji-accent focus:outline-none shadow-sm">
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-200 dark:border-stone-700">
                            <label class="text-xs font-bold text-gray-400 shrink-0 mr-1">預計停留</label>
                            <div class="flex-1 flex items-center gap-2">
                                <div class="relative flex-1">
                                    <input type="number" id="edit-duration-h" oninput="syncTime('duration')" placeholder="0" min="0" class="w-full p-1.5 pl-2 pr-6 border border-gray-200 rounded text-sm text-center font-mono font-bold text-muji-accent dark:text-muji-accent bg-white dark:bg-stone-800 dark:border-stone-600 focus:border-muji-accent focus:outline-none">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 leading-5 pointer-events-none">H</span>
                                </div>
                                <span class="text-gray-300 font-bold">:</span>
                                <div class="relative flex-1">
                                    <input type="number" id="edit-duration-m" oninput="syncTime('duration')" placeholder="0" min="0" max="59" class="w-full p-1.5 pl-2 pr-6 border border-gray-200 rounded text-sm text-center font-mono font-bold text-muji-accent dark:text-muji-accent bg-white dark:bg-stone-800 dark:border-stone-600 focus:border-muji-accent focus:outline-none">
                                    <span class="absolute right-2 top-1.5 text-[10px] text-gray-400 leading-5 pointer-events-none">M</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">類型</label><select id="edit-type" class="w-full p-2 border border-gray-200 rounded text-sm"><option value="move">交通移動 (車程)</option><option value="spot">景點</option><option value="food">美食</option><option value="shop">購物</option><option value="transport">交通 (車站/機場)</option><option value="stay">住宿</option></select></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">標題 <span class="text-red-500">*</span></label><input type="text" id="edit-title" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="必填"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">備註</label><textarea id="edit-note" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">交通</label><input type="text" id="edit-station" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">標籤</label><input type="text" id="edit-tags" class="w-full p-2 border border-gray-200 rounded text-sm"></div>
                    <div class="text-[10px] text-gray-400 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded">💡 提示：修改結束時間後，後續的交通與行程時間會自動順延。</div>
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="deleteEvent()" id="btn-delete" class="px-4 py-2 bg-red-50 text-red-500 rounded text-sm hidden">刪除</button>
                    <button type="button" onclick="saveEvent()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">儲存</button>
                </div>
            </div>
        </div>

        <!-- EXPENSE EDIT MODAL 新增記帳卡片-->
        <div id="expense-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">編輯支出</h3>
                    <button type="button" onclick="closeExpenseEditModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-card border border-gray-100 dark:border-gray-700">
                    
                    <div class="flex gap-2 mb-3">
                        <select id="edit-expense-payer" class="w-1/4 px-1 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none focus:border-muji-accent">
                            <option value="小戴">小戴</option>
                            <option value="佳欣">佳欣</option>
                            <option value="佳萱">佳萱</option>
                            <option value="玟廷">玟廷</option>
                        </select>
                        <select id="edit-expense-type" class="w-1/4 px-1 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none focus:border-muji-accent">
                            <option value="split">公費</option>
                            <option value="private">私費</option>
                        </select>
                        <input type="date" id="edit-expense-date" class="flex-1 px-1 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-xs text-gray-500 text-center focus:outline-none focus:border-muji-accent">
                    </div>

                    <div class="mb-3">
                        <input type="text" id="edit-expense-item" placeholder="品項名稱" class="w-full px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-100 focus:outline-none focus:border-muji-accent select-text">
                    </div>

                    <div class="flex gap-2">
                        <div class="relative flex-[1.5]">
                            <input type="number" id="edit-expense-price" placeholder="日幣金額" class="w-full px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-100 focus:outline-none focus:border-muji-accent select-text" oninput="calcTwdInEdit()" onfocus="this.select()">
                            <span class="absolute right-2 top-2.5 text-[10px] text-gray-400 pointer-events-none">JPY</span>
                        </div>

                        <div class="relative flex-1">
                            <input type="number" id="edit-expense-rate" placeholder="匯率" step="0.0001" class="w-full px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-500 dark:text-gray-300 text-center focus:outline-none focus:border-muji-accent select-text" oninput="calcTwdInEdit()" onfocus="this.select()">
                            <span class="absolute right-2 top-2.5 text-[10px] text-gray-400 pointer-events-none">匯率</span>
                        </div>

                        <div id="edit-qty-wrapper" class="hidden w-16 relative shrink-0">
                            <input type="number" id="edit-expense-qty" placeholder="1" class="w-full px-3 py-2 bg-gray-50 dark:bg-stone-900 border border-gray-200 dark:border-stone-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-100 text-center focus:outline-none focus:border-muji-accent select-text">
                            <span class="absolute right-2 top-2.5 text-[10px] text-gray-400 pointer-events-none">個</span>
                        </div>
                        
                        <input type="hidden" id="edit-expense-twd">
                    </div>

                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 bg-gray-50 dark:bg-stone-900 rounded-b-xl">
                    
                    <label class="shrink-0 flex items-center justify-center gap-1.5 px-3 py-2.5 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg cursor-pointer hover:bg-gray-300 dark:hover:bg-gray-600 transition text-sm font-bold">
                        <i class="fas fa-camera"></i>
                        <span id="edit-photo-label" class="text-xs whitespace-nowrap">照片</span>
                        <input type="file" id="edit-expense-photo" accept="image/*" class="hidden" onchange="document.getElementById('edit-photo-label').innerText = '已選'; document.getElementById('edit-photo-label').classList.add('text-muji-accent');">
                    </label>

                    <button type="button" onclick="saveExpenseEdit()" class="flex-1 px-4 py-2.5 bg-muji-accent text-white rounded-lg text-sm font-bold shadow-sm hover:opacity-90 transition flex items-center justify-center gap-2">
                        <i class="fas fa-check"></i> 儲存
                    </button>
                </div>
            </div>
        </div>
        <!-- SETTINGS MODAL 設定卡片-->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200 overflow-hidden">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">系統設定</h3>
                    <button type="button" onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="p-5 space-y-6">
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">使用者設定</h4>
                        <div class="bg-gray-50 dark:bg-stone-900 border border-gray-100 dark:border-gray-700 rounded-lg p-3">
                            <p class="text-[10px] text-gray-400 mb-3">點擊頭像選擇使用者 (目前：<span id="current-default-user" class="font-bold text-muji-accent">未設定</span>)</p>
                            <div id="user-selector-container" class="flex justify-between items-center px-2"></div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-100 dark:border-gray-700"></div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">外觀設定</h4>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 dark:bg-stone-900 dark:border-stone-700 p-3 rounded-lg border border-gray-100 dark:border-gray-700 dark:border-gray-600">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 dark:bg-gray-600 flex items-center justify-center shadow-sm text-yellow-500 dark:text-gray-300">
                                    <i class="fas fa-moon dark:hidden"></i>
                                    <i class="fas fa-sun hidden dark:inline"></i>
                                </div>
                                <div>
                                    <h5 class="text-sm font-bold text-gray-700 dark:text-gray-100 dark:text-gray-200">深色模式</h5>
                                    <p class="text-[10px] text-gray-400 dark:text-gray-400">減輕夜間眼睛疲勞</p>
                                </div>
                            </div>
                            <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none bg-gray-200 dark:bg-muji-accent">
                                <span class="sr-only">Toggle Dark Mode</span>
                                <span id="dark-mode-toggle-circle" class="inline-block h-4 w-4 transform rounded-full bg-white dark:bg-gray-800 transition-transform translate-x-1 dark:translate-x-6"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-100 dark:border-gray-700 dark:border-gray-700"></div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">資料備份與轉移</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="exportFullBackup()" class="flex flex-col items-center justify-center gap-2 py-3 bg-gray-600 text-white rounded-lg text-xs font-bold shadow-sm hover:bg-gray-700 transition">
                                <i class="fas fa-download text-lg"></i> 
                                <span>下載備份 (JSON)</span>
                            </button>
                            <button onclick="document.getElementById('backup-upload-setting').click()" class="flex flex-col items-center justify-center gap-2 py-3 bg-white dark:bg-gray-800 border border-gray-300 text-gray-700 dark:text-gray-100 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition">
                                <i class="fas fa-upload text-muji-accent text-lg"></i>
                                <span>還原備份</span>
                            </button>
                            <input type="file" id="backup-upload-setting" accept=".json" class="hidden" onchange="importFullBackup(this)">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 text-center">下載的 JSON 檔案可用於新手機或電腦還原完整行程。</p>
                    </div>
                  


                    <div class="border-t border-gray-100 dark:border-gray-700"></div>
                      <div>
                        <h4 class="text-xs font-bold text-red-300 uppercase tracking-wider mb-3">重置與清除</h4>
                        <div class="space-y-2">
                            <button onclick="resetItinerary()" class="w-full text-left px-4 py-3 bg-red-50 text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition flex justify-between items-center">
                                <span><i class="fas fa-calendar-times mr-2"></i>恢復預設行程</span>
                                <i class="fas fa-chevron-right opacity-30"></i>
                            </button>
                            <button onclick="clearExpenses()" class="w-full text-left px-4 py-3 bg-red-50 text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition flex justify-between items-center">
                                <span><i class="fas fa-coins mr-2"></i>清除所有記帳</span>
                                <i class="fas fa-chevron-right opacity-30"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 text-center border-t border-gray-100 dark:border-gray-700">
                    <p class="text-[10px] text-gray-300">App Version 2.0.1</p>
                </div>
            </div>
        </div>
        <!-- SPLIT BILL MODAL 分帳結果卡片-->
        <div id="split-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">分帳結果</h3>
                    <button type="button" onclick="closeSplitBillModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">各人代墊總額 (台幣)</h4>
                        <div id="split-summary" class="space-y-2 text-sm"></div>
                        <div class="mt-3 pt-2 border-t border-gray-100 dark:border-gray-700 text-right">
                            <span class="text-xs text-gray-400 mr-2">平均：</span>
                            <span id="split-average" class="font-bold text-muji-text"></span>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">建議結算 (台幣)</h4>
                        <div id="split-plan" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SHOPPING MODAL 新增必買卡片-->
        <div id="shopping-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100" id="shopping-modal-title">新增必買</h3>
                    <button type="button" onclick="closeShoppingModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">商品名稱<span class="text-red-500">*</span></label>
                        <input type="text" id="shop-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="必填">
                    </div>
                    
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">單價 (日幣)</label>
                        <input type="number" id="shop-price" class="w-full h-9 p-0 text-center border-t border-b border-gray-200 rounded text-sm font-bold" placeholder="輸入預設單價">
                        </div>
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-gray-500 mb-1">數量</label>
                            <div class="flex items-center">
                                <button onclick="adjShopQty(-1)" class="w-8 h-9 border border-gray-200 rounded-l bg-gray-100 hover:bg-gray-200 text-gray-500"><i class="fas fa-minus text-xs"></i></button>
                                <input type="number" id="shop-qty" class="w-full h-9 p-0 text-center border-t border-b border-gray-200 text-sm font-bold" value="1" readonly>
                                <button onclick="adjShopQty(1)" class="w-8 h-9 border border-gray-200 rounded-r bg-gray-100 hover:bg-gray-200 text-gray-500"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">分類</label>
                        <select id="shop-type" class="w-full p-2 border border-gray-200 rounded text-sm">
                            </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">備註 (規格/型號)</label>
                        <textarea id="shop-desc" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">圖片</label>
                        <input type="file" id="shop-photo" accept="image/*" class="w-full text-xs">
                    </div>
                </div>  
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveShoppingItem()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">儲存</button>
                </div>
            </div>
        </div>
        <div id="add-shop-cat-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">新增必買分類</h3>
                    <button type="button" onclick="closeAddShopCatModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <label class="block text-xs font-bold text-gray-500 mb-1">分類名稱</label>
                    <input type="text" id="new-shop-cat-name" class="w-full p-2 border border-gray-200 rounded text-sm bg-white dark:bg-stone-800 dark:border-stone-600 dark:text-white focus:outline-none focus:border-muji-accent" placeholder="例如：零食、電器...">
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveNewShopCat()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">新增</button>
                </div>
            </div>
        </div>
        <!-- ADD CATEGORY MODAL 新增分類卡片(行前準備)-->
        <div id="add-category-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 rounded-t-xl">
                    <h3 class="font-bold text-gray-700 dark:text-gray-100">新增分類</h3>
                    <button type="button" onclick="closeAddCategoryModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <input type="text" id="new-category-name" class="w-full p-2 border border-gray-200 rounded text-sm" placeholder="分類名稱">
                </div>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700 flex gap-3">
                    <button type="button" onclick="saveNewCategory()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold shadow-sm hover:opacity-90 transition">新增</button>
                </div>
            </div>
        </div>
        
        <!-- CONFIRM MODAL (Unified) -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xs p-5 text-center transform scale-95 transition-transform duration-200" id="confirm-box">
                <h3 class="font-bold text-gray-700 dark:text-gray-100 text-lg mb-2">確認操作</h3>
                <p class="text-sm text-gray-500 mb-6" id="confirm-msg">此動作無法復原。</p>
                <div class="flex gap-3 justify-center">
                    <button type="button" onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition">取消</button>
                    <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition shadow-sm">確認</button>
                </div>
            </div>
        </div>
        
        <!-- IMAGE VIEWER 圖片縮放卡片-->
        <div id="image-view-modal" class="fixed inset-0 z-[80] hidden overflow-hidden">
            <div class="absolute inset-0 bg-black/95 transition-opacity" onclick="closeImageModal()"></div>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="relative w-full h-full flex items-center justify-center overflow-hidden">
                    <img id="image-view-src" src="" class="max-w-full max-h-full object-contain pointer-events-auto cursor-grab transition-transform duration-100 origin-center select-none" draggable="false">
                </div>
            </div>
            <button onclick="closeImageModal()" class="absolute top-6 right-6 w-10 h-10 bg-white dark:bg-gray-800/20 rounded-full text-white flex items-center justify-center hover:bg-white dark:bg-gray-800/40 transition z-50 backdrop-blur-md">
                <i class="fas fa-times text-lg"></i>
            </button>
            <div class="absolute bottom-6 left-0 right-0 text-center pointer-events-none">
                <span class="bg-black/50 text-white text-[10px] px-3 py-1 rounded-full backdrop-blur-sm">雙指縮放</span>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    // --- 使用者設定 (頭像設定) ---
    const APP_USERS = [
        { name: '小戴', img: './images/dai.jpg' },
        { name: '佳欣', img: './images/shin.jpg' },
        { name: '佳萱', img: './images/shuan.jpg' },
        { name: '玟廷', img: './images/ting.jpg' }
    ];
    // --- 更新 Header 頭像 ---
    function updateHeaderAvatar() {
        const container = document.getElementById('header-user-icon');
        if (!container) return;

        // 1. 讀取目前設定的使用者
        const currentName = localStorage.getItem('hk_default_user') || '小戴';
        
        // 2. 從設定檔中找到對應的圖片資料
        const userObj = APP_USERS.find(u => u.name === currentName);

        if (userObj && userObj.img) {
            // 3. 如果有圖片，就換成 img 標籤
            container.innerHTML = `<img src="${userObj.img}" class="w-full h-full object-cover" alt="${currentName}">`;
        } else {
            // 4. 如果找不到 (防呆)，維持原本的雪花
            container.innerHTML = `<i class="fas fa-snowflake animate-pulse"></i>`;
        }
    }
    
    // --- 設定視窗控制 ---
        function openSettingsModal() {
            renderUserSelector();
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
        // --- 使用者設定邏輯 ---

        // 1. 渲染使用者選擇器 (在開啟設定視窗時呼叫)
        function renderUserSelector() {
            const container = document.getElementById('user-selector-container');
            const currentLabel = document.getElementById('current-default-user');
            
            // 讀取目前設定，預設為 '小戴'
            const defaultUser = localStorage.getItem('hk_default_user') || '小戴';
            if(currentLabel) currentLabel.innerText = defaultUser;

            let html = '';
            APP_USERS.forEach(user => {
                const isSelected = user.name === defaultUser;
                // 選中時顯示外框 (Ring)
                const activeClass = isSelected 
                    ? 'ring-2 ring-offset-2 ring-muji-accent dark:ring-offset-gray-800 scale-110 opacity-100' 
                    : 'opacity-60 hover:opacity-100 grayscale hover:grayscale-0';
                
                html += `
                <button onclick="setDefaultUser('${user.name}')" class="flex flex-col items-center gap-1 transition-all duration-200 transform ${activeClass}">
                    <img src="${user.img}" class="w-10 h-10 rounded-full object-cover border border-gray-200 dark:border-gray-600 shadow-sm">
                    <span class="text-[10px] font-bold text-gray-600 dark:text-gray-300">${user.name}</span>
                </button>`;
            });
            
            if(container) container.innerHTML = html;
        }

        function setDefaultUser(name) {
            localStorage.setItem('hk_default_user', name);
            renderUserSelector(); 
            showToast(`使用者已改為：${name}`, 'success');

            // ★★★ 新增：同步更新錢包頁面上的下拉選單 ★★★
            const inlinePayer = document.getElementById('expense-payer');
            if(inlinePayer) inlinePayer.value = name;
            updateHeaderAvatar();
        }
    // --- 系統備份與還原功能 ---

        // 1. 匯出完整備份 (JSON) - 修正版
        function exportFullBackup() {
            const data = {
                meta: {
                    version: "2.0",
                    date: new Date().toISOString(),
                    app: "Hokkaido_Trip_2025"
                },
                // 共用資料
                itinerary: JSON.parse(localStorage.getItem('hk_itinerary_v20') || '[]'),
                wallet: JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'),
                
                // 私人資料 (必買)
                shopping: JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'), // 商品清單
                shopCats: JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]'), // ★★★ 補上：必買分類 ★★★
                
                // 私人資料 (行前)
                // 註：行前清單的結構本身就包含分類 (category) 與項目 (items)，所以備份這一個就夠了
                checklist: JSON.parse(localStorage.getItem('hk_checks_v20') || '[]'), 
                
                rate: localStorage.getItem('hk_rate_v1') || '0.22'
            };

            const fileName = `Hokkaido_FullBackup_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('備份檔案已下載', 'success');
        }

        // 2. 觸發還原 (讀取檔案)
        function importFullBackup(input) {
            const file = input.files[0];
            if (!file) return;

            // 清空 input 讓同個檔案可以重複選取
            input.value = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    // 簡單驗證檔案格式
                    if (!data.meta || data.meta.app !== "Hokkaido_Trip_2025") {
                        showToast('錯誤：這不是本 App 的備份檔', 'error');
                        return;
                    }

                    // 將讀到的資料暫存到全域變數，等待使用者確認
                    window.tempRestoreData = data;

                    // 跳出確認視窗
                    deleteTarget = 'system-restore';
                    document.getElementById('confirm-msg').innerHTML = "警告：此動作將<b>覆蓋</b>您目前所有的<br>行程、記帳與清單資料。<br>確定要還原嗎？";
                    document.getElementById('confirm-modal').classList.remove('hidden');
                    setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);

                } catch (err) {
                    console.error(err);
                    showToast('檔案讀取失敗', 'error');
                }
            };
            reader.readAsText(file);
        }
    // --- IMAGE ZOOM & PAN LOGIC 圖片支援雙指縮放 ---
        let imgScale = 1;
        let imgPosX = 0;
        let imgPosY = 0;
        let isDragging = false;
        let startX = 0, startY = 0;
        // 雙指縮放專用變數
        let initialPinchDist = 0;
        let startScale = 1;

        // 開啟圖片
        function openImageModal(src) {
            const modal = document.getElementById('image-view-modal');
            const img = document.getElementById('image-view-src');
            
            img.src = src;
            modal.classList.remove('hidden');
            
            // 重置狀態
            resetZoom();
            addZoomListeners(img);
        }
        // 關閉圖片
        function closeImageModal() {
            const modal = document.getElementById('image-view-modal');
            modal.classList.add('hidden');
            const img = document.getElementById('image-view-src');
            removeZoomListeners(img);
        }
        // 重置縮放與位置   
        function resetZoom() {
            imgScale = 1;
            imgPosX = 0;
            imgPosY = 0;
            initialPinchDist = 0;
            updateImageTransform();
        }
        // 更新圖片的 CSS 變形
        function updateImageTransform() {
            const img = document.getElementById('image-view-src');
            // 限制位移範圍，避免圖片飛出視窗太遠 (可選)
            img.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${imgScale})`;
            img.style.cursor = imgScale > 1 ? 'grab' : 'default';
        }
        // 計算兩指距離的輔助函數
        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy); //畢氏定理計算距離
        }
        // --- 圖片縮放事件監聽器 ---
        function addZoomListeners(img) {
            // 1. 電腦版滾輪縮放
            img.onwheel = (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.2 : 0.2;
                let newScale = imgScale + delta;
                newScale = Math.min(Math.max(1, newScale), 5); // 限制 1x ~ 5x
                if (newScale === 1) { imgPosX = 0; imgPosY = 0; }
                imgScale = newScale;
                updateImageTransform();
            };

            // 2. 觸控/滑鼠按下
            const startDrag = (x, y) => {
                if (imgScale <= 1) return; 
                isDragging = true;
                startX = x - imgPosX;
                startY = y - imgPosY;
                img.style.cursor = 'grabbing';
            };

            img.onmousedown = (e) => { startDrag(e.clientX, e.clientY); };

            // ★★★ 手機版觸控開始 (分辨是單指還是雙指) ★★★
            img.ontouchstart = (e) => {
                if (e.touches.length === 2) {
                    // --- 雙指模式：開始縮放 ---
                    e.preventDefault(); // 防止瀏覽器縮放
                    isDragging = false; // 縮放時停止拖曳
                    initialPinchDist = getDistance(e.touches);
                    startScale = imgScale;
                } else if (e.touches.length === 1) {
                    // --- 單指模式：開始拖曳 ---
                    startDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 3. 移動中
            const doDrag = (x, y) => {
                if (!isDragging) return;
                imgPosX = x - startX;
                imgPosY = y - startY;
                updateImageTransform();
            };

            window.onmousemove = (e) => { if(isDragging) { e.preventDefault(); doDrag(e.clientX, e.clientY); } };

            // ★★★ 手機版移動 (包含雙指縮放邏輯) ★★★
            window.ontouchmove = (e) => {
                if (e.touches.length === 2 && initialPinchDist > 0) {
                    // --- 雙指捏合計算 ---
                    e.preventDefault();
                    const dist = getDistance(e.touches);
                    const scaleChange = dist / initialPinchDist; // 計算縮放比例
                    
                    // 新的縮放值 = 初始縮放值 * 變化比例
                    let newScale = startScale * scaleChange;
                    
                    // 限制範圍 (1倍 ~ 5倍)
                    imgScale = Math.min(Math.max(1, newScale), 5);
                    updateImageTransform();
                    
                } else if (isDragging && e.touches.length === 1) {
                    // --- 單指拖曳 ---
                    // e.preventDefault(); // 視情況開啟，若想保留滑動網頁功能可關閉
                    doDrag(e.touches[0].clientX, e.touches[0].clientY);
                }
            };

            // 4. 放開手指
            const stopDrag = (e) => {
                isDragging = false;
                // 如果是雙指放開變成單指，重置縮放基準，避免跳動
                if (e.touches && e.touches.length < 2) {
                    initialPinchDist = 0;
                }
                img.style.cursor = imgScale > 1 ? 'grab' : 'default';
                
                // 如果縮太小，自動彈回 1 倍
                if (imgScale < 1) {
                    imgScale = 1;
                    imgPosX = 0;
                    imgPosY = 0;
                    updateImageTransform();
                }
            };

            window.onmouseup = stopDrag;
            window.ontouchend = stopDrag;
        }
        // --- 移除圖片縮放事件監聽器 ---
        function removeZoomListeners(img) {
            img.onwheel = null;
            img.onmousedown = null;
            img.ontouchstart = null;
            window.onmousemove = null;
            window.ontouchmove = null;
            window.onmouseup = null;
            window.ontouchend = null;
        }        
        
    // --- 全域變數 ---
        let currentShoppingFilter = 'all';
        let itineraryData = [];
        let currentDayIdx = null; 
        let currentEvtIdx = null;
        let currentExpenseId = null; 
        let deleteTarget = null; 
        let deleteExpenseId = null;
        let currentSelectedDayIndex = 0;
        let currentShoppingId = null; 
        let deleteShoppingId = null;
        let deleteChecklistCatIdx = null; 
        let deleteChecklistItemIdx = null;
        let pendingShoppingId = null;
        
     // --- 深色模式切換功能 ---
        function initDarkMode() {
            // 檢查 LocalStorage 或 系統偏好
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        // 切換深色模式
        function toggleDarkMode() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
        initDarkMode();// 初始化深色模式設定

    // --- 行程日期切換功能 ---
        function switchDay(dayIdx) {
            if (typeof dayIdx !== 'number' || dayIdx < 0 || dayIdx >= itineraryData.length) return;
            if (currentSelectedDayIndex === dayIdx) return;
            currentSelectedDayIndex = dayIdx;
            renderDateSelector();
            renderPlan();
            try {
                const container = document.getElementById('date-scroll-container');
                const btns = container ? container.querySelectorAll('button') : [];
                const btn = btns[dayIdx];
                if (btn && typeof btn.scrollIntoView === 'function') {
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            } catch (e) { console.warn('switchDay scroll error', e); }
        }
    // --- 預設必買清單資料 ---
        const defaultShoppingList = [
            { id: 'm1', type: 'drug', name: '大正製藥 口內炎貼片', desc: '貼的含類固醇，吸附力好', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=口內炎' },{ id: 'm2', type: 'drug', name: 'Traful 軟膏 PRO QUICK', desc: '抗炎成分，塗抹型', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Traful' }, { id: 'm3', type: 'drug', name: 'Chocola BB 口內炎噴霧', desc: '殺菌修復，薄荷味', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=BB' }, { id: 'm4', type: 'drug', name: '小林製藥 液體絆創膏', desc: '防水隱形OK繃', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=液體絆' }, { id: 'm5', type: 'drug', name: 'EVE Quick DX', desc: '速效止痛', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=EVE' }, { id: 'm6', type: 'drug', name: 'Loxonin S Premium', desc: '強效止痛', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Loxonin' }, { id: 'm7', type: 'drug', name: 'PAIR 痘痘藥膏', desc: '消炎殺菌', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=PAIR' }, { id: 'm8', type: 'drug', name: 'Aneron 暈車藥', desc: '長效持續', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=Aneron' }, { id: 'm9', type: 'drug', name: '哆啦A夢 暈車藥', desc: '兒童可用，汽水味', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=哆啦A夢' }, { id: 'm10', type: 'drug', name: 'DHC 速攻藍莓 V-MAX', desc: '護眼，花青素增量', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHC藍莓' }, { id: 'm11', type: 'drug', name: '龍角散 Direct', desc: '免水服用，水蜜桃/薄荷', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=龍角散' }, { id: 'm12', type: 'drug', name: 'DHC 乳酸菌/益生菌', desc: '整腸消化', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHC益生菌' }, { id: 'm13', type: 'drug', name: 'DHC 葉黃素/蝦紅素', desc: '抗藍光，抗疲勞', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=DHC葉黃' }, { id: 'm14', type: 'drug', name: 'ROIHI-TSUBOKO', desc: '溫感穴位貼片', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=穴位貼' }, { id: 'm15', type: 'drug', name: '合利他命 EX Plus', desc: '緩解眼睛疲勞、肩頸僵硬', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=合利他命' }, { id: 'm16', type: 'drug', name: '樂敦 V 頂級紅鑽', desc: '改善乾眼、老花', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=V紅鑽' }, { id: 'm17', type: 'drug', name: '齒磨撫子 牙膏', desc: '小蘇打美白', done: false, img: 'https://placehold.co/100x100/e2e8f0/4a4a4a?text=齒磨撫子' }, { id: 's1', type: 'souvenir', name: '白色戀人', desc: '經典巧克力夾心', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=白色戀人' }, { id: 's2', type: 'souvenir', name: 'HORI 哈密瓜果凍', desc: '夕張哈密瓜口味', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=HORI' }, { id: 's3', type: 'souvenir', name: 'PRESS BUTTER SAND', desc: '北海道限定玉米口味', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=ButterSand' }, { id: 's4', type: 'souvenir', name: '北菓樓 開拓小米菓', desc: '海鮮口味米菓', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=北菓樓' }, { id: 's5', type: 'souvenir', name: 'LeTAO 雙層起司蛋糕', desc: '必買經典', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=LeTAO' }, { id: 's6', type: 'souvenir', name: 'KINOTOYA 起司塔', desc: '新千歲機場必吃', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=KINOTOYA' }, { id: 's7', type: 'souvenir', name: 'Milk Stand 牛奶', desc: '各地牧場直送', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=MilkStand' }, { id: 's8', type: 'souvenir', name: '六花亭 奶油夾心', desc: '蘭姆葡萄口味', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=六花亭' }, { id: 's9', type: 'souvenir', name: '六花亭 酒糖', desc: '寶石般的外觀', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=酒糖' }, { id: 's10', type: 'souvenir', name: 'Oh! 烤玉米', desc: '札幌大通公園名物', done: false, img: 'https://placehold.co/100x100/fde68a/854d0e?text=烤玉米' }, { id: 'o1', type: 'other', name: 'Canon SELPHY CP1500', desc: '小型印相機', done: false, img: 'https://placehold.co/100x100/e5e7eb/4b5563?text=Canon' } ];
    // --- 初始化功能 ---
        document.addEventListener('DOMContentLoaded', () => {
            initItinerary(); 
            initChecklist(); 
            initShoppingList(); 
            initWallet(); 
            setupNav();
            renderDateSelector(); 
            renderPlan();
            updateHeaderAvatar(); 
            setInterval(updateRealtimeHighlight, 60000);
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() { this.select(); });
            });
            loadFromCloud();
        });

        // ...existing code...
        
        // --- CLOUD SYNC CONFIG (雲端同步設定) ---
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxHLVR3OKM4qFoGzqnITcN9kDJq12CEpPyY4b0hn2Frwez4avJbFEasZiVQDKNjvT9K/exec";

        // 讀取雲端資料
        async function loadFromCloud() {
            if (!GAS_API_URL) {
                console.log('雲端同步已禁用');
                return;
            }
            
            showToast("正在同步", "info");
            
            try {
                // 加上時間戳記避免快取
                const url = GAS_API_URL + "?t=" + new Date().getTime();
                const res = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const result = await res.json();
                
                if (result.status !== 'success' || !result.data) {
                    console.warn('回應異常:', result);
                    showToast("無新資料", "normal");
                    return;
                }
                
                const data = result.data;
                let hasUpdate = false;
                
                // 更新 LocalStorage（如果雲端有資料）
                if (data.hk_itinerary_v20) { 
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(data.hk_itinerary_v20)); 
                    hasUpdate = true; 
                }
                if (data.hk_wallet_v20) { 
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(data.hk_wallet_v20)); 
                    hasUpdate = true; 
                }
            
                if (hasUpdate) {
                    // 重新初始化畫面以顯示新資料
                    initItinerary();
                    renderPlan();
                    renderExpenseList();
                    renderShoppingList();
                    renderChecklist();
                    showToast("同步完成！✨", "success");
                } else {
                    showToast("無新資料", "normal");
                }
                
            } catch (e) {
                console.error("同步失敗:", e);
                showToast(`同步失敗: ${e.message}`, "error");
            }
        }
        // 上傳資料到雲端 (修正版：移除標頭以避免 CORS 錯誤)
        async function saveToCloud(key, dataObj) {
            if (!GAS_API_URL) return;
            
            try {
                const payload = {
                    key: key,
                    value: JSON.stringify(dataObj)
                };
                
                // ★★★ 修改重點：移除 headers 設定，讓瀏覽器用預設方式傳送 ★★★
                const res = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'no-cors' // 加入這行，強迫瀏覽器忽略跨域檢查 (雖然無法讀取回傳結果，但能確保資料送達)
                });
                
                console.log('已發送上傳請求:', key);
                
            } catch (err) {
                console.error('上傳發送失敗:', err);
            }
        }
        // --- TOAST NOTIFICATION FUNCTION ---
        function showToast(message, type = 'normal') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'fa-info-circle';
            if(type === 'success') icon = 'fa-check-circle';
            if(type === 'error') icon = 'fa-exclamation-circle';

            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(toast);

            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 300);
            }, 2000);
        }

        // --- ITINERARY DATA (Updated with splits and moves) ---
        const defaultItinerary = [
            { date: "12/18 (四)", day: 1, dateObj: "2025-12-18", weather: { icon: 'fa-cloud', temp: '-1°C', desc: '多雲' }, events: [ 
                { time: "06:15 ~ 11:00", title: "TPE 桃園機場 T2", type: "transport", note: "長榮 BR166 (29A-D)", tags: ["航班", "A321"], story: "記得提早 2.5 小時抵達機場報到。", tips: "長榮航空櫃台在第二航廈 3 樓。" }, 
                { time: "11:00 ~ 12:00", title: "CTS 新千歲機場", type: "transport", note: "入境、領行李", station: "新千歲空港站" }, 
                { time: "12:15 ~ 13:10", title: "移動：前往飯店", type: "move", note: "JR 快速 Airport (37分) ➔ 札幌站轉乘 ➔ 地鐵南北線 (5分)", tags: ["JR: 12:15/12:27發"] },
                { time: "13:11 ~ 14:11", title: "札幌中島公園日航都市酒店", type: "stay", note: "Check-in / 寄放行李", station: "中島公園站" }, 
                { time: "14:40 ~ 14:50", title: "移動：前往大通", type: "move", note: "地鐵南北線 (往麻生方向 2站)", tags: ["車程約5分"] },
                { time: "15:00 ~ 16:00", title: "紅磚廳舍 (舊本廳舍)", type: "spot", note: "巴洛克風格紅磚建築", station: "大通站/札幌站", tips: "入內參觀免費(整修中可能僅外觀)。" },
                { time: "16:00 ~ 16:15", title: "移動：步行前往大通公園", type: "move", note: "步行約10-15分", tags: ["散步"] },
                { time: "16:15 ~ 18:00", title: "大通公園", type: "spot", note: "白色燈樹節", station: "大通站", tips: "最佳拍照點在電視塔前或噴水池。" },
                { time: "18:00 ~ 18:20", title: "移動：步行或地鐵", type: "move", note: "前往薄野/大通周邊晚餐", tags: ["步行約15分"] },
                { time: "18:32 ~ 19:30", title: "Gyoza no Ohsho", type: "food", note: "晚餐：餃子", tags: ["晚餐"] }, 
                { time: "19:34 ~ 20:34", title: "Matcha Cafe & Sweets RIQ", type: "food", note: "抹茶甜點", tags: ["必吃甜點"] }, 
                { time: "20:35 ~ 22:35", title: "狸小路商店街", type: "shop", note: "藥妝、伴手禮採買", station: "狸小路站", tags: ["逛街"] }, 
                { time: "22:35 ~ 23:00", title: "移動：返回飯店", type: "move", note: "地鐵南北線 (往真駒內方向)", station: "中島公園站" } 
            ] }, 
            { date: "12/19 (五)", day: 2, dateObj: "2025-12-19", weather: { icon: 'fa-snowflake', temp: '-4°C', desc: '小雪' }, events: [ 
                { time: "07:30 ~ 08:30", title: "移動：前往滑雪場", type: "move", note: "專車接送 (請確認集合點)", tags: ["專車"] },
                { time: "08:30 ~ 16:30", title: "札幌手稻滑雪場", type: "spot", note: "滑雪體驗", tags: ["重點行程"], tips: "初學者建議預約教練。" }, 
                { time: "16:30 ~ 17:30", title: "移動：返回飯店", type: "move", note: "專車接送", tags: ["專車"] },
                { time: "17:30 ~ 18:00", title: "回飯店梳洗", type: "stay", note: "休息換裝" }, 
                { time: "18:00 ~ 18:15", title: "移動：前往薄野", type: "move", note: "地鐵南北線 (1站)", tags: ["車程3分"] },
                { time: "18:16 ~ 19:16", title: "Suage+ Soup Curry", type: "food", note: "北海道必吃湯咖哩", station: "薄野站", tags: ["必點:脆皮知床雞"] }, 
                { time: "19:16 ~ 19:29", title: "移動：前往大通", type: "move", note: "步行或地下街", tags: ["步行10分"] },
                { time: "19:30 ~ 20:30", title: "札幌地下街 (Aurora Town)", type: "shop", note: "連接大通與電視塔的地下街", station: "大通站", tags: ["逛街"] },
                { time: "20:30 ~ 20:40", title: "移動：步行", type: "move", note: "前往電視塔", tags: ["步行"] },
                { time: "20:40 ~ 21:20", title: "札幌電視塔", type: "spot", note: "俯瞰大通公園夜景", station: "大通站", tips: "從下方仰拍也很美。" },
                { time: "21:20 ~ 21:30", title: "移動：步行", type: "move", note: "前往鐘樓 (約5-10分)", tags: ["步行"] },
                { time: "21:30 ~ 22:00", title: "札幌市鐘樓", type: "spot", note: "日本現存最古老鐘樓", station: "大通站", tips: "晚上打燈別有一番風味。" },
                { time: "22:00 ~ 22:30", title: "移動：返回飯店", type: "move", note: "計程車或地鐵南北線" } 
            ] }, 
            { date: "12/20 (六)", day: 3, dateObj: "2025-12-20", weather: { icon: 'fa-sun', temp: '-2°C', desc: '晴時多雲' }, events: [ 
                { time: "07:15 ~ 07:40", title: "移動：前往伏見稻荷", type: "move", note: "市電 (中島公園通 -> 西線14條)", tags: ["路面電車"] },
                { time: "07:40 ~ 08:42", title: "伏見稻荷神社", type: "spot", note: "千本鳥居", station: "西線14條", tips: "網美拍照聖地。" }, 
                { time: "08:42 ~ 09:10", title: "移動：前往圓山", type: "move", note: "建議計程車 (約1500円) 或 公車", tags: ["計程車推薦"] },
                { time: "10:00 ~ 11:40", title: "美月櫻和服", type: "spot", note: "和服體驗", station: "圓山公園站", tags: ["預約行程"] }, 
                { time: "11:40 ~ 13:00", title: "北海道神宮", type: "spot", note: "參拜", station: "圓山公園站" }, 
                { time: "13:00 ~ 14:00", title: "六花亭 神宮茶屋店", type: "food", note: "休息吃點心", tags: ["必吃:判官餅"] }, 
                { time: "16:00 ~ 16:47", title: "歸還和服", type: "spot", note: "返回美月櫻" }, 
                { time: "16:47 ~ 17:15", title: "移動：前往薄野", type: "move", note: "地鐵東西線 (圓山公園->大通) 轉 南北線" },
                { time: "18:15 ~ 20:00", title: "炭火兜 成吉思汗", type: "food", note: "北海道特色烤肉", tags: ["預約 18:30"] }, 
                { time: "20:00 ~ 21:00", title: "COCONO SUSUKINO", type: "shop", note: "薄野新地標", station: "薄野站" }, 
                { time: "21:00 ~ 21:15", title: "移動：返回飯店", type: "move", note: "地鐵南北線 (1站)" } 
            ] }, 
            { date: "12/21 (日)", day: 4, dateObj: "2025-12-21", weather: { icon: 'fa-snowflake', temp: '-5°C', desc: '大雪' }, events: [ 
                { time: "08:20 ~ 08:35", title: "移動：前往札幌站", type: "move", note: "地鐵南北線", tags: ["早起出發"] },
                { time: "08:43 ~ 09:18", title: "移動：前往小樽", type: "move", note: "JR 快速 Airport (往小樽)", tags: ["JR"] },
                { time: "09:34 ~ 10:00", title: "移動：前往水族館", type: "move", note: "中央巴士 (祝津線 10/11路)", tags: ["小樽站前搭乘"] },
                { time: "10:00 ~ 12:30", title: "小樽水族館", type: "spot", note: "企鵝散步", tags: ["親子推薦"] }, 
                { time: "12:40 ~ 13:10", title: "移動：返回小樽站", type: "move", note: "中央巴士" },
                { time: "13:10 ~ 14:10", title: "小樽三角市場", type: "food", note: "海鮮午餐", station: "小樽站", tags: ["必吃海鮮"] }, 
                { time: "14:30 ~ 16:30", title: "小樽堺町通商店街", type: "shop", note: "甜點與玻璃", tags: ["必買伴手禮"] }, 
                { time: "16:30 ~ 17:30", title: "六花亭 & 北一硝子", type: "shop", note: "玻璃工藝" }, 
                { time: "17:30 ~ 19:00", title: "小樽運河", type: "spot", note: "欣賞運河夜景", station: "小樽站" }, 
                { time: "19:15 ~ 20:00", title: "移動：返回札幌", type: "move", note: "JR 快速 Airport" },
                { time: "20:00 ~ 20:30", title: "移動：返回飯店", type: "move", note: "地鐵南北線" }
            ] }, 
            { date: "12/22 (一)", day: 5, dateObj: "2025-12-22", weather: { icon: 'fa-cloud', temp: '-2°C', desc: '陰' }, events: [ 
                { time: "08:30 ~ 09:00", title: "移動：前往場外市場", type: "move", note: "地鐵東西線 (二十四軒站) + 步行" },
                { time: "09:00 ~ 10:00", title: "場外市場", type: "food", note: "海鮮丼早餐", station: "二十四軒站", tags: ["必吃海鮮"] }, 
                { time: "10:00 ~ 10:45", title: "移動：前往北海道大學", type: "move", note: "地鐵東西線 -> 南北線 (北12條站)" },
                { time: "10:54 ~ 11:54", title: "北海道大學", type: "spot", note: "銀杏大道", station: "北12條站" }, 
                { time: "11:54 ~ 12:17", title: "移動：前往諏訪神社", type: "move", note: "地鐵東豐線 (北13條東站)" },
                { time: "12:17 ~ 13:17", title: "諏訪神社", type: "spot", note: "花手水", station: "北13條東站" }, 
                { time: "13:17 ~ 13:40", title: "移動：前往啤酒博物館", type: "move", note: "計程車 或 巴士 (苗穗站方向)" },
                { time: "13:40 ~ 14:40", title: "札幌啤酒博物館", type: "spot", note: "紅磚建築拍照", tags: ["歷史"] }, 
                { time: "14:40 ~ 14:58", title: "移動：前往札幌站", type: "move", note: "中央巴士 Loop 88 或 步行" },
                { time: "14:58 ~ 16:00", title: "Sapporo Stellar Place", type: "shop", note: "車站購物", station: "札幌站" }, 
                { time: "16:03 ~ 17:03", title: "串鳥 札幌駅前店", type: "food", note: "平價美味串燒", tags: ["必吃串燒"] }, 
                { time: "17:05 ~ 18:30", title: "BIC CAMERA 札幌店", type: "shop", note: "電器採買", station: "札幌站" }, 
                { time: "18:30 ~ 19:00", title: "移動：返回飯店", type: "move", note: "地鐵南北線" }
            ] }, 
            { date: "12/23 (二)", day: 6, dateObj: "2025-12-23", weather: { icon: 'fa-plane', temp: '0°C', desc: '返程' }, events: [ 
                { time: "08:00 ~ 11:00", title: "Check-out & 移動", type: "stay", note: "Check-out" }, 
                { time: "11:00 ~ 12:00", title: "移動：前往機場", type: "move", note: "JR 快速 Airport (37分)", tags: ["預留時間"] },
                { time: "12:00 ~ 15:00", title: "新千歲機場", type: "shop", note: "最後採買", story: "這裡不只是機場，更是個超大遊樂園。" }, 
                { time: "15:20 ~ 19:05", title: "BR115 返台", type: "transport", note: "CTS -> TPE (29G-K)" } 
            ] } 
        ];
        
        
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('focus', function() { this.select(); });
        });
        // --- 容量檢測與管理 ---
        function checkStorageSpace() {
            let total = 0;
            for (let x in localStorage) {
                if (!localStorage.hasOwnProperty(x)) continue;
                total += ((localStorage[x].length + x.length) * 2);
            }
            // 換算成 KB
            const totalKB = (total / 1024).toFixed(2);
            // 假設上限 5MB (約 5120KB)
            const percent = Math.min(100, (totalKB / 5120) * 100).toFixed(1);
            
            console.log(`已用空間: ${totalKB} KB (${percent}%)`);
            return percent;
        }

        // 修改原本的 saveToCloud 或 saveXXX 函式，在儲存前檢查
        function validateStorage() {
            const usage = checkStorageSpace();
            if (usage > 90) {
                showToast('警告：儲存空間即將額滿，請刪除舊圖片', 'error');
                return false;
            }
            return true;
        }
        // --- 行程初始化 ---
        function initItinerary() { 
            const stored = localStorage.getItem('hk_itinerary_v20');
            if (stored) { itineraryData = JSON.parse(stored);}
            else { itineraryData = JSON.parse(JSON.stringify(defaultItinerary));
                
             } 
        }

        // --- 工具：產生空狀態 HTML ---
        function getEmptyStateHtml(message, icon = 'fa-box-open') {
            return `
            <div class="flex flex-col items-center justify-center py-10 opacity-60">
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-3">
                    <i class="fas ${icon} text-2xl text-gray-300 dark:text-gray-500"></i>
                </div>
                <p class="text-sm text-gray-400 font-bold">${message}</p>
                <p class="text-xs text-gray-300 mt-1">點擊 + 按鈕新增</p>
            </div>`;
        }
        // --- 時間計算與輔助工具 ---

        // 1. 將 "HH:MM" 轉為 分鐘數
        function timeToMin(timeStr) {
            if (!timeStr) return 0;
            const t = timeStr.includes('~') ? timeStr.split('~')[0].trim() : timeStr;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        // 2. 將 分鐘數 轉為 "HH:MM"
        function minToTime(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            if (h >= 24) h = h - 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // 3. 取得行程持續時間 (分鐘)
        function getDuration(evt) {
            if (!evt.time || !evt.time.includes('~')) return 60; // 預設 60 分鐘
            const [start, end] = evt.time.split('~').map(s => s.trim());
            const sMin = timeToMin(start);
            const eMin = timeToMin(end);
            return (eMin > sMin) ? eMin - sMin : 60;
        }
        // --- 核心邏輯 A：處理插入時的重疊 (釘子邏輯) ---
        // 讓原本的行程讓路給新行程
        function resolveInsertConflicts(dayIdx, anchorEvtIdx) {
            const events = itineraryData[dayIdx].events;
            const anchor = events[anchorEvtIdx]; // 這是我們剛新增/修改的行程 (釘子)
            
            if (!anchor.time || !anchor.time.includes('~')) return;

            const [anchorStartStr, anchorEndStr] = anchor.time.split('~').map(s => s.trim());
            const anchorStart = timeToMin(anchorStartStr);
            const anchorEnd = timeToMin(anchorEndStr);

            events.forEach((evt, idx) => {
                // 跳過自己，不要自己排斥自己
                if (idx === anchorEvtIdx) return;
                if (!evt.time || !evt.time.includes('~')) return;

                const [evtStartStr, evtEndStr] = evt.time.split('~').map(s => s.trim());
                const evtStart = timeToMin(evtStartStr);
                const evtEnd = timeToMin(evtEndStr);

                // 判斷重疊邏輯：
                // 如果 (舊行程開始 < 新行程結束) AND (舊行程結束 > 新行程開始) => 發生重疊
                const isOverlapping = (evtStart < anchorEnd) && (evtEnd > anchorStart);

                if (isOverlapping) {
                    // 計算舊行程原本長度
                    const duration = evtEnd - evtStart;

                    // ★ 強制順延邏輯：
                    // 舊行程的「新開始時間」，必須是「它原本的時間」與「新行程結束時間」取最大值
                    // 也就是說，如果它原本 10:00 開始，但新行程佔用到 10:30，它就得改從 10:30 開始
                    const newStart = Math.max(evtStart, anchorEnd);
                    const newEnd = newStart + duration;

                    evt.time = `${minToTime(newStart)} ~ ${minToTime(newEnd)}`;
                }
            });
        }
        function resetItinerary() {
            deleteTarget = 'itinerary-reset';
            document.getElementById('confirm-msg').innerText = "確定要恢復預設行程嗎？所有修改將消失。";
            document.getElementById('confirm-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);
        }

        function renderDateSelector() { const container = document.getElementById('date-scroll-container'); let html = ''; itineraryData.forEach((day, idx) => { const isActive = idx === currentSelectedDayIndex; const activeClass = isActive ? 'bg-muji-accent text-white shadow-md' : 'bg-white dark:bg-gray-800 text-gray-500 hover:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600'; const dateShort = day.date.split('/')[1]; html += `<button onclick="switchDay(${idx})" class="flex-shrink-0 w-14 h-12 rounded-xl flex flex-col items-center justify-center transition-all ${activeClass} border border-transparent ${!isActive ? 'border-gray-100 dark:border-gray-700' : ''}"><span class="text-xs font-bold leading-none mb-1">Day ${day.day}</span><span class="text-[10px] font-mono leading-none">${dateShort}</span></button>`; }); container.innerHTML = html; }

        let sortableInstance = null; // 全域變數，用來管理拖曳實例

        function renderPlan() { 
            const container = document.getElementById('itinerary-list'); 
            const weatherCard = document.getElementById('plan-weather-card'); 
            const day = itineraryData[currentSelectedDayIndex]; 
            
            // 1. 渲染天氣卡-根據不同天氣代碼換背景色 (簡易版)
            let weatherBg = 'from-blue-400 to-blue-300';
            if (day.weather.icon.includes('sun')) weatherBg = 'from-orange-400 to-yellow-300';
            if (day.weather.icon.includes('cloud')) weatherBg = 'from-gray-400 to-gray-300';
            if (day.weather.icon.includes('snowflake')) weatherBg = 'from-indigo-400 to-blue-300';
            weatherCard.innerHTML = `
            <div class="relative overflow-hidden rounded-xl shadow-lg mb-3 p-3 text-white bg-gradient-to-br ${weatherBg}">
                
                <div class="absolute -right-2 -top-4 text-white opacity-20 text-6xl">
                    <i class="fas ${day.weather.icon}"></i>
                </div>
                
                <div class="relative z-10 flex justify-between items-center w-full">
                    
                    <div class="flex items-center gap-3">
                        <div class="text-sm font-bold opacity-90 shrink-0">${day.date}</div>
                        
                        <div class="text-sm font-medium flex items-center gap-1">
                            <i class="fas ${day.weather.icon} text-lg"></i>
                            <span>${day.weather.desc}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 shrink-0">
                        <div class="text-xl font-bold flex items-center">
                            ${day.weather.temp}
                        </div>
                        
                        <div class="text-right">
                             <a href="https://www.google.com/search?q=札幌天氣+${day.date.split('(')[0]}" target="_blank" class="text-[10px] bg-white/20 hover:bg-white/30 px-2 py-1 rounded backdrop-blur-sm transition">
                                <i class="fas fa-search mr-1"></i>查預報
                            </a>
                        </div>
                    </div>

                </div>
            </div>`;
            let eventsHtml = ''; 
            
            // 2. 渲染行程列表
            day.events.forEach((evt, evtIdx) => { 
                // --- 顏色邏輯 ---
                let bgClass = 'bg-white border-l-4 border-gray-200 dark:bg-gray-800 dark:border-gray-600'; 
                let iconClass = 'text-gray-400 fa-map-marker-alt';
                let titleClass = 'text-muji-text dark:text-gray-100';
                let isMove = false;

                if (evt.type === 'transport') { 
                    bgClass = 'bg-muji-transport border-l-4 border-blue-400 dark:bg-blue-900/30 dark:border-blue-500'; 
                    iconClass = 'text-blue-500 dark:text-blue-400 dark:text-blue-300 fa-plane'; 
                } else if (evt.type === 'food') { 
                    bgClass = 'bg-muji-food border-l-4 border-orange-400 dark:bg-orange-900/30 dark:border-orange-500'; 
                    iconClass = 'text-orange-500 dark:text-orange-400 fa-utensils'; 
                } else if (evt.type === 'shop') { 
                    bgClass = 'bg-muji-shop border-l-4 border-pink-400 dark:bg-pink-900/30 dark:border-pink-500'; 
                    iconClass = 'text-pink-500 dark:text-pink-400 fa-shopping-bag'; 
                } else if (evt.type === 'spot') { 
                    bgClass = 'bg-muji-spot border-l-4 border-green-500 dark:bg-green-900/30 dark:border-green-500'; 
                    iconClass = 'text-green-600 dark:text-green-400 fa-camera'; 
                } else if (evt.type === 'stay') { 
                    iconClass = 'text-indigo-400 dark:text-indigo-300 fa-bed'; 
                } else if (evt.type === 'move') { 
                    bgClass = 'bg-gray-50 border-l-2 border-gray-300 py-2 pl-2 dark:bg-stone-800 dark:border-stone-600'; 
                    iconClass = 'text-gray-400 dark:text-stone-400 fa-bus'; 
                    titleClass = 'text-sm text-gray-600 dark:text-stone-200';
                    isMove = true;
                }

                let tagsHtml = ''; 
                if (evt.tags) { 
                    evt.tags.forEach(tag => { 
                        let tagStyle = 'bg-gray-100 dark:bg-gray-900 text-gray-500'; 
                        if (tag.includes('必吃')) tagStyle = 'tag-must-eat'; 
                        else if (tag.includes('必買')) tagStyle = 'tag-must-buy'; 
                        else if (tag.includes('預約')) tagStyle = 'tag-reserve'; 
                        else if (tag.includes('車') || tag.includes('JR') || tag.includes('專車')) tagStyle = 'tag-transport'; 
                        tagsHtml += `<span class="text-[10px] px-1.5 py-0.5 rounded mr-1 mb-1 inline-block ${tagStyle}">${tag}</span>`; 
                    }); 
                } 
                
                const eventId = `event-${currentSelectedDayIndex}-${evtIdx}`; 
                // 加入 data-idx 方便追蹤
                const dataAttr = `data-idx="${evtIdx}"`;

                // ★★★ 新增：拖曳手柄 HTML (右側兩條線) ★★★
                const dragHandle = `<div class="drag-handle absolute right-0 top-0 bottom-0 w-10 flex items-center justify-center cursor-grab opacity-20 hover:opacity-100 touch-manipulation z-20 transition-opacity"><i class="fas fa-grip-lines text-gray-500 dark:text-gray-400"></i></div>`;

                if (isMove) {
                    // 加入 sortable-item class
                    eventsHtml += `<div class="relative pl-8 timeline-line type-move group sortable-item" ${dataAttr} id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-2 top-3 w-4 text-center z-10"><div class="w-4 h-4 rounded-full bg-gray-200 border border-white flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-[8px] text-white"></i></div></div>
                        <div class="${bgClass} rounded-r-lg relative transition-all duration-300 event-card pr-10">
                            <div class="flex items-center justify-between cursor-pointer" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-xs font-bold text-gray-400 time-display whitespace-nowrap">${evt.time}</span>
                                    <h4 class="text-xs font-bold ${titleClass} truncate">${evt.title}</h4>
                                </div>
                                ${evt.note ? `<div class="text-[10px] text-gray-400 truncate max-w-[120px] transport-detail">${evt.note}</div>` : ''}
                            </div>
                            ${dragHandle}
                        </div>
                    </div>`;
                } else {
                    // 加入 sortable-item class
                    eventsHtml += `<div class="relative pl-8 timeline-line group sortable-item" ${dataAttr} id="${eventId}" data-time="${evt.time}" data-date="${day.dateObj}">
                        <div class="absolute left-0 top-4 w-8 text-center z-10"><div class="w-8 h-8 rounded-full bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 shadow-sm flex items-center justify-center indicator-icon"><i class="fas ${iconClass} text-xs"></i></div></div>
                        <div class="${bgClass} p-3 rounded-lg shadow-card relative transition-all duration-300 event-card pr-10">
                            <div class="cursor-pointer" onclick="openViewModal(${currentSelectedDayIndex}, ${evtIdx})">
                                <div class="flex justify-between items-start mb-1"><span class="font-mono text-sm font-bold text-gray-500 time-display">${evt.time}</span></div>
                                <h4 class="text-base font-bold ${titleClass} mb-1 leading-tight">${evt.title}</h4>
                                ${evt.station ? `<div class="text-xs text-muji-subtext mb-1"><i class="fas fa-subway mr-1 text-gray-300"></i>${evt.station}</div>` : ''}
                                ${evt.note ? `<p class="text-xs text-gray-500 mb-2 leading-relaxed">${evt.note}</p>` : ''}
                                <div class="flex flex-wrap">${tagsHtml}</div>
                            </div>
                            ${dragHandle}
                        </div>
                    </div>`;
                }
            }); 
            container.innerHTML = eventsHtml; 
            updateRealtimeHighlight(); 

            // ★★★ 3. 初始化 SortableJS (拖曳邏輯) ★★★
            if (sortableInstance) sortableInstance.destroy(); // 切換日期時銷毀舊實例
            
            sortableInstance = Sortable.create(container, {
                handle: '.drag-handle', // 只能拉手柄
                animation: 200,         // 動畫速度 ms
                ghostClass: 'sortable-ghost', // 拖曳時的殘影樣式
                delay: 100,             // 防誤觸延遲 (手機友善)
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex === newIndex) return;

                    // (1) 調整資料陣列順序
                    const events = itineraryData[currentSelectedDayIndex].events;
                    const [movedItem] = events.splice(oldIndex, 1);
                    events.splice(newIndex, 0, movedItem);

                    // (2) 執行「緊湊排列」：重新計算所有時間，填補空缺
                    resequenceEvents(currentSelectedDayIndex);

                    // (3) 存檔與同步
                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
                    saveToCloud('hk_itinerary_v20', itineraryData);
                    
                    // (4) 重新渲染 (讓畫面上顯示更新後的時間)
                    renderPlan();
                    showToast('行程順序及時間已更新', 'success');
                }
            });
        }
        function updateRealtimeHighlight() { const now = new Date(); const cards = document.querySelectorAll('.timeline-line'); cards.forEach(card => { const dateStr = card.getAttribute('data-date'); const timeStr = card.getAttribute('data-time'); const eventDate = new Date(dateStr); const isSameDate = now.getFullYear() === eventDate.getFullYear() && now.getMonth() === eventDate.getMonth() && now.getDate() === eventDate.getDate(); if (!isSameDate) { removeHighlight(card); return; } const times = timeStr.split('~').map(t => t.trim()); if (times.length < 1) return; const startParts = times[0].split(':'); const startHour = parseInt(startParts[0]); const startMin = parseInt(startParts[1]); let endHour, endMin; if (times.length > 1 && times[1]) { const endParts = times[1].split(':'); endHour = parseInt(endParts[0]); endMin = parseInt(endParts[1]); } else { endHour = startHour + 1; endMin = startMin; } const startTime = new Date(now); startTime.setHours(startHour, startMin, 0); const endTime = new Date(now); endTime.setHours(endHour, endMin, 0); if (now >= startTime && now <= endTime) { addHighlight(card); } else { removeHighlight(card); } }); }
        function addHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); if (!innerCard.classList.contains('event-active')) { innerCard.classList.add('event-active'); icon.classList.add('animate-pulse-slow'); icon.classList.add('bg-muji-highlight'); icon.querySelector('i').style.color = 'white'; innerCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
        function removeHighlight(card) { const innerCard = card.querySelector('.event-card'); const icon = card.querySelector('.indicator-icon'); innerCard.classList.remove('event-active'); icon.classList.remove('animate-pulse-slow'); icon.classList.remove('bg-muji-highlight'); icon.querySelector('i').style.color = ''; }
        // --- 改寫後的導覽列控制 (包含圓餅圖切換邏輯) ---
        function setupNav() {
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetId = btn.dataset.target;
                    switchTab(targetId);
                });
            });
        }

        function switchTab(tabId) {
            // 1. 處理按鈕樣式
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                if(b.dataset.target === tabId) b.classList.add('active');
            });

            // 2. 處理內容顯示
            document.querySelectorAll('.tab-content').forEach(s => {
                s.classList.remove('active');
                if(s.id === tabId) s.classList.add('active');
            });

            // 3. 特殊邏輯：如果是清單頁，更新進度條
            if(tabId === 'lists') {
                updateChecklistProgress();
            }
        }        
        function deleteEvent() { 
            if (currentDayIdx === null || currentEvtIdx === null || currentEvtIdx < 0) return; 
            deleteTarget = 'itinerary'; 
            document.getElementById('confirm-msg').innerText="確定刪除此行程？"; 
            document.getElementById('confirm-modal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); 
        }
        
        function closeConfirmModal() { 
            const box = document.getElementById('confirm-box');
            box.classList.add('scale-95');
            document.getElementById('confirm-modal').classList.add('hidden'); 
            deleteTarget = null; deleteExpenseId = null; deleteShoppingId = null; deleteChecklistCatIdx = null; deleteChecklistItemIdx = null; 
        }
        
        // --- 執行刪除 (修正版) ---
        function executeDelete() { 
            // 1. 刪除行程 (支援遞補)
            if (deleteTarget === 'itinerary') { 
                try { 
                    const targetEvent = itineraryData[currentDayIdx].events[currentEvtIdx];
                    let durationToShift = 0;
                    if (targetEvent) durationToShift = getDuration(targetEvent);
                    
                    itineraryData[currentDayIdx].events.splice(currentEvtIdx, 1); 

                    if (durationToShift > 0) shiftEventsBack(currentDayIdx, currentEvtIdx, durationToShift);

                    localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
                    saveToCloud('hk_itinerary_v20', itineraryData);
                    
                    renderPlan(); 
                    closeModal(); 
                    closeViewModal(); 
                    showToast('行程已刪除並調整時間'); 
                } catch(e) { console.error(e); } 
            }
            // 系統還原邏輯 (含必買分類修正)
            else if (deleteTarget === 'system-restore') {
                const data = window.tempRestoreData;
                if (data) {
                    try {
                        // 1. 寫入 LocalStorage (還原所有資料到手機)
                        if(data.itinerary) localStorage.setItem('hk_itinerary_v20', JSON.stringify(data.itinerary));
                        if(data.wallet) localStorage.setItem('hk_wallet_v20', JSON.stringify(data.wallet));
                        
                        // 還原私人資料
                        if(data.shopping) localStorage.setItem('hk_shopping_v20', JSON.stringify(data.shopping));
                        // ★★★ 補上：還原必買分類 ★★★
                        if(data.shopCats) localStorage.setItem('hk_shop_cats_v20', JSON.stringify(data.shopCats)); 
                        
                        if(data.checklist) localStorage.setItem('hk_checks_v20', JSON.stringify(data.checklist));
                        if(data.rate) localStorage.setItem('hk_rate_v1', data.rate);

                        // 2. 強制同步到雲端 (僅同步行程與錢包，私人資料不傳)
                        if(data.itinerary) saveToCloud('hk_itinerary_v20', data.itinerary);
                        if(data.wallet) saveToCloud('hk_wallet_v20', data.wallet);

                        showToast('還原成功！重新整理中', 'success');
                        
                        setTimeout(() => {
                            window.tempRestoreData = null;
                            location.reload();
                        }, 1500);
                    } catch(e) {
                        showToast('還原過程發生錯誤', 'error');
                        console.error(e);
                    }
                }
            }           
            else if (deleteTarget === 'itinerary-reset') { 
                localStorage.removeItem('hk_itinerary_v20'); 
                initItinerary(); 
                renderDateSelector(); 
                renderPlan(); 
                showToast('行程已重置'); 
            } 
            else if (deleteTarget === 'expense-clear') { 
                localStorage.removeItem('hk_wallet_v20'); 
                saveToCloud('hk_wallet_v20', []);
                renderExpenseList(); 
                showToast('資料已清除'); 
            } 
            else if (deleteTarget === 'expense-single') { 
                let expenses = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                expenses = expenses.filter(e => e.id !== deleteExpenseId); 
                localStorage.setItem('hk_wallet_v20', JSON.stringify(expenses));
                const cleanExpenses = expenses.map(d => ({...d, img: ''}));
                saveToCloud('hk_wallet_v20', cleanExpenses);
                renderExpenseList(); 
                showToast('紀錄已刪除'); 
            } 
            else if (deleteTarget === 'shop-cat') {
                // 1. 刪除分類本身
                let cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
                cats = cats.filter(c => c.id !== deleteShopCatId);
                localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));

                // 2. 連帶刪除該分類下的所有商品 (避免商品殘留變幽靈)
                let items = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                items = items.filter(i => i.type !== deleteShopCatId);
                localStorage.setItem('hk_shopping_v20', JSON.stringify(items));

                // 3. 重置畫面
                currentShoppingFilter = 'all'; // 強制回到「全部」以免停留在已刪除的頁面
                renderShoppingFilters(); // 重繪上方按鈕
                renderShoppingList();    // 重繪下方清單
                
                showToast('必買分類已刪除', 'success');
            }
            else if (deleteTarget === 'shopping') { 
                let list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
                list = list.filter(i => i.id !== deleteShoppingId); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(list)); 
                renderShoppingList(); 
                showToast('必買商品已刪除'); 
            } 
            else if (deleteTarget === 'checklist-cat') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list.splice(deleteChecklistCatIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist(); 
                showToast('行李分類已刪除'); 
            } 
            else if (deleteTarget === 'checklist-item') { 
                const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
                list[deleteChecklistCatIdx].items.splice(deleteChecklistItemIdx, 1); 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
                showToast('準備項目已刪除'); 
            } 
            closeConfirmModal(); 
        }
            function openViewModal(dayIdx, evtIdx) { 
            const evt = itineraryData[dayIdx].events[evtIdx]; 
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx; 
            document.getElementById('view-title').innerText = evt.title; 
            document.getElementById('view-type').innerText = (evt.type === 'food' ? '美食' : (evt.type === 'spot' ? '景點' : (evt.type === 'shop' ? '購物' : '交通'))); 
            document.getElementById('view-time').innerText = `${evt.time}`; 
            document.getElementById('view-story').innerText = evt.story || "暫無詳細介紹..."; 
            document.getElementById('view-tips').innerText = evt.tips || "暫無特別攻略..."; 
            document.getElementById('view-note').innerText = evt.note || "-"; 
            
            const mapBtn = document.getElementById('view-map-btn'); 
            
            // ★★★ 修正這裡：加上 `${` 與 `}` 讓變數能正確帶入 ★★★
            let mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' 北海道')}`;
            
            mapBtn.href = mapUrl;

            const imgMap = { 'food': 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=800', 'spot': 'https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=800', 'shop': 'https://images.unsplash.com/photo-1472851294608-4151713425a5?q=80&w=800', 'transport': 'https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=800', 'stay': 'https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=800', 'move': 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?q=80&w=800' }; 
            document.getElementById('view-img').src = imgMap[evt.type] || imgMap['spot']; 
            const modal = document.getElementById('view-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.add('translate-y-0', 'sm:scale-100'); }, 10); 
            document.body.classList.add('modal-active'); 
        }
        function closeViewModal() { const modal = document.getElementById('view-modal'); modal.classList.add('opacity-0'); modal.querySelector('div').classList.add('translate-y-full', 'sm:scale-95'); modal.querySelector('div').classList.remove('translate-y-0', 'sm:scale-100'); setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); }, 250); }
        function switchToEdit() { closeViewModal(); setTimeout(() => { openEditModal(currentDayIdx, currentEvtIdx); }, 300); }
        
        function initWallet() { 
            // 1. 匯率與日期設定 (原程式碼)
            const savedRate = localStorage.getItem('hk_rate_v1');
            const lastFetch = localStorage.getItem('hk_rate_date');
            const today = new Date().toDateString();

            const dateInput = document.getElementById('expense-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }

            // ★★★ 2. 新增：載入預設付款人到「頁面上的輸入框」 ★★★
            // 這是修正 "錢包記帳畫面未變動" 的關鍵
            const defaultUser = localStorage.getItem('hk_default_user') || '小戴';
            const inlinePayer = document.getElementById('expense-payer'); // 注意 ID 是 expense-payer (非 edit-...)
            if (inlinePayer) {
                inlinePayer.value = defaultUser;
            }

            // 3. 匯率顯示 (原程式碼)
            if (savedRate) {
                document.getElementById('exchange-rate').value = savedRate;
            }

            if (lastFetch !== today) {
                fetchExchangeRate();
            } else {
                const time = localStorage.getItem('hk_rate_time');
                if(time) document.getElementById('rate-update-time').innerText = `更新於: ${time}`;
            }

            renderExpenseList(); 
            
            document.getElementById('jpy-input').addEventListener('input', calculateRate);
            document.getElementById('exchange-rate').addEventListener('input', calculateRate);
        }
        function fetchExchangeRate(manual = false) {
            const statusEl = document.getElementById('rate-update-time');
            if(manual) statusEl.innerText = "更新中...";
            
            const targetUrl = 'https://tw.rter.info/capi.php';
            
            // Primary: AllOrigins
            const url1 = 'https://api.allorigins.win/get?url=' + encodeURIComponent(targetUrl);
            
            // Fallback: CORS Proxy
            const url2 = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

            const processData = (json, isAllOrigins = false) => {
                let data = json;
                if (isAllOrigins) {
                     data = JSON.parse(json.contents);
                }
                
                if (data.USDTWD && data.USDJPY) {
                    const rate = data.USDTWD.Exrate / data.USDJPY.Exrate;
                    return rate.toFixed(4);
                }
                throw new Error("Data format error");
            };

            fetch(url1)
                .then(res => {
                    if (!res.ok) throw new Error('Proxy 1 failed');
                    return res.json();
                })
                .then(data => {
                     return processData(data, true);
                })
                .catch(err => {
                    console.warn('Primary proxy failed, trying backup...', err);
                    return fetch(url2)
                        .then(res => {
                             if (!res.ok) throw new Error('Proxy 2 failed');
                             return res.json();
                        })
                        .then(data => {
                            return processData(data, false); 
                        });
                })
                .then(finalRate => {
                    document.getElementById('exchange-rate').value = finalRate;
                    
                    localStorage.setItem('hk_rate_v1', finalRate);
                    localStorage.setItem('hk_rate_date', new Date().toDateString());
                    
                    const timeStr = new Date().toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'});
                    localStorage.setItem('hk_rate_time', timeStr);
                    statusEl.innerText = `更新於: ${timeStr}`;
                    
                    calculateRate();
                    if(manual) showToast(`匯率更新: ${finalRate}`, 'success');
                })
                .catch(err => {
                    console.error('All exchange rate sources failed', err);
                    if(manual) showToast('匯率更新失敗', 'error');
                    statusEl.innerText = "更新失敗";
                });
        }

        function calculateRate() { 
            const input = document.getElementById('jpy-input').value; 
            const rate = parseFloat(document.getElementById('exchange-rate').value); 
            const output = document.getElementById('twd-output'); 
            try { 
                const clean = input.replace(/[^0-9+\-*/().]/g, ''); 
                if(!clean) { output.innerText = "0"; return; }
                const jpy = Function('"use strict";return (' + clean + ')')(); 
                const twd = Math.round(jpy * rate); 
                output.innerText = twd.toLocaleString(); 
            } catch(e) { output.innerText = "Err"; } 
        }

        function addExpense() { 
            if (!validateStorage()) return; // 如果空間爆了就阻止儲存
            const payer = document.getElementById('expense-payer').value; 
            const type = document.getElementById('expense-type').value; 
            const itemInput = document.getElementById('expense-item');
            const priceInput = document.getElementById('expense-price');
            const dateInput = document.getElementById('expense-date');
            
            const item = itemInput.value; 
            const price = priceInput.value; 
            const currentRate = parseFloat(document.getElementById('exchange-rate').value);
            const fileInput = document.getElementById('expense-photo'); 
            const expenseDate = dateInput.value || new Date().toISOString().split('T')[0];

            if(!item || !price) { showToast("請填寫必要欄位", 'error'); return; } 
            
            const jpyPrice = parseFloat(price);
            const twdPrice = Math.round(jpyPrice * currentRate); 

            const processSave = (img) => { 
                const data = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                data.unshift({ id: Date.now(), payer, type, item, price: jpyPrice, rate: currentRate, twd: twdPrice, img, date: expenseDate }); 
                
                try { 
                    localStorage.setItem('hk_wallet_v20', JSON.stringify(data));
                    const cleanData = data.map(d => ({...d, img: ''}));
                    saveToCloud('hk_wallet_v20', cleanData); 

                    itemInput.value = ''; priceInput.value = ''; fileInput.value = ''; 
                    document.getElementById('photo-label').innerText = '拍照/上傳'; 
                    renderExpenseList(); 
                    showToast("記帳成功並同步", 'success');
                } catch(e) { console.error(e); showToast("儲存錯誤", 'error'); } 
            };
            
            if(fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const maxW = 300; const scale = maxW / img.width; 
                        c.width = maxW; c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        processSave(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else processSave(null); 
        }

        function renderExpenseList() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const container = document.getElementById('expense-list'); 
            let total = 0; 
            let html = ''; 
            
            list.forEach(ex => { 
                const finalTwd = ex.twd !== undefined ? ex.twd : Math.round(ex.price * (ex.rate || 0.22)); 
                const rateUsed = ex.rate !== undefined ? ex.rate : 0.22;
                const displayDate = ex.date ? ex.date.replace(/-/g, '/') : 'Unknown';
                const type = ex.type || 'split'; 
                total += ex.price; 
                
                const payerBadge = ex.payer ? `<span class="text-xs bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-200 px-1 rounded mr-1">[${ex.payer}]</span>` : '';
                const typeBadge = type === 'private' 
                    ? `<span class="text-[10px] bg-gray-400 text-white px-1.5 py-0.5 rounded ml-2">私費</span>`
                    : `<span class="text-[10px] bg-muji-accent text-white px-1.5 py-0.5 rounded ml-2">公費</span>`;

                html += `<div class="flex items-center justify-between bg-white dark:bg-gray-800 p-1 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm relative group">
                    <div class="flex items-center gap-3">
                        
                        <div class="w-8 h-8 rounded bg-gray-100 dark:bg-gray-900 flex-shrink-0 bg-cover bg-center border border-gray-200 ${ex.img ? 'cursor-pointer hover:opacity-80 transition' : ''}" style="background-image: url('${ex.img || ''}');" ${ex.img ? `onclick="openImageModal('${ex.img}')"` : ''}>${!ex.img ? '<i class="fas fa-receipt text-gray-300 m-auto h-full flex items-center justify-center text-sm"></i>' : ''}</div>
                        
                        <div>
                            <div class="text-sm font-bold text-gray-700 dark:text-gray-100 flex items-center">${payerBadge}${ex.item} ${typeBadge}</div>
                            <div class="text-[10px] text-gray-400">${displayDate} <span class="text-gray-300">| 匯率 ${rateUsed}</span></div>
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-3">
                        <div>
                            <div class="text-sm font-bold text-gray-700 dark:text-gray-100">¥${ex.price.toLocaleString()}</div>
                            <div class="text-[10px] text-gray-500 font-medium">NT$${finalTwd.toLocaleString()}</div>
                        </div>
                        <div class="flex flex-col gap-1 border-l border-gray-100 dark:border-gray-700 pl-2">
                            <button onclick="openExpenseEdit(${ex.id})" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="confirmDeleteExpense(${ex.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>`;
            }); 
            
            // ★★★ 修正重點：加上這段判斷，把 HTML 塞回容器 ★★★
            if (list.length === 0) {
                container.innerHTML = getEmptyStateHtml('尚無消費紀錄', 'fa-receipt');
            } else {
                container.innerHTML = html;
            }
            const totalEl = document.getElementById('total-expense');
            if (totalEl) {
                // 這裡可以自訂顯示格式，例如加上 'Total: ' 前綴
                totalEl.innerText = `¥${total.toLocaleString()}`;
            }
        }

// --- 開啟新增記帳視窗 (一般模式) ---
        function openExpenseModal() {
            currentExpenseId = null; // 新增模式
            
            // 1. 讀取預設付款人 (設定功能連動)
            const payerSelect = document.getElementById('edit-expense-payer');
            const defaultUser = localStorage.getItem('hk_default_user') || '小戴';
            if (payerSelect) payerSelect.value = defaultUser;

            // 2. 重置其他欄位
            document.getElementById('edit-expense-type').value = 'split'; // 預設公費
            document.getElementById('edit-expense-item').value = '';
            document.getElementById('edit-expense-price').value = '';
            
            // ★★★ 3. 強制隱藏數量欄位 (一般記帳不需要) ★★★
            const qtyWrapper = document.getElementById('edit-qty-wrapper');
            if(qtyWrapper) qtyWrapper.classList.add('hidden');
            document.getElementById('edit-expense-qty').value = '1'; 

            // 4. 匯率與日期設定
            const currentRate = localStorage.getItem('hk_rate_v1') || 0.22;
            document.getElementById('edit-expense-rate').value = currentRate;
            document.getElementById('edit-expense-twd').value = '';
            
            document.getElementById('edit-expense-date').value = new Date().toISOString().split('T')[0];
            
            // 5. 照片欄位重置
            document.getElementById('edit-expense-photo').value = '';
            const photoText = document.getElementById('edit-photo-text');
            if(photoText) photoText.innerText = '照片';
            // 移除選取時的綠色外框
            const photoLabel = document.querySelector('#edit-expense-photo').parentElement;
            if(photoLabel) photoLabel.classList.remove('ring-2', 'ring-muji-accent');

            // 6. 設定標題
            const modal = document.getElementById('expense-edit-modal');
            modal.querySelector('h3').innerText = "新增支出";
            
            // 7. 顯示視窗
            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modal.querySelector('div').classList.remove('scale-95'); 
                modal.querySelector('div').classList.add('scale-100'); 
            }, 10);
        }
        // --- 開啟編輯記帳視窗 (編輯模式) ---
        function openExpenseEdit(id) { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const expense = list.find(e => e.id === id); 
            if (!expense) return; 
            
            currentExpenseId = id; 
            
            // 1. 填入基本資料
            document.getElementById('edit-expense-payer').value = expense.payer || '小戴'; 
            document.getElementById('edit-expense-type').value = expense.type || 'split'; 
            document.getElementById('edit-expense-item').value = expense.item; 
            document.getElementById('edit-expense-price').value = expense.price; 
            document.getElementById('edit-expense-date').value = expense.date || new Date().toISOString().split('T')[0];

            // 2. 處理匯率與台幣
            const r = expense.rate || 0.22;
            const t = expense.twd || Math.round(expense.price * r);
            document.getElementById('edit-expense-rate').value = r;
            document.getElementById('edit-expense-twd').value = t;

            // ★★★ 3. 關鍵修正：強制隱藏數量欄位 ★★★
            // 因為這是編輯「已存在的記帳」，不需要修改購買數量
            document.getElementById('edit-qty-wrapper').classList.add('hidden');
            document.getElementById('edit-expense-qty').value = '1';

            // 4. 重置標題
            const modal = document.getElementById('expense-edit-modal');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "編輯支出";

            // 5. 圖片與顯示
            document.getElementById('edit-expense-photo').value = ''; 
            const label = document.getElementById('edit-photo-label');
            if(label) label.innerText = expense.img ? '更換照片' : '補傳照片';

            modal.classList.remove('hidden'); 
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modal.querySelector('div').classList.remove('scale-95'); 
                modal.querySelector('div').classList.add('scale-100'); 
            }, 10); 
        }

// --- 自動計算台幣 (當日幣或匯率變動時觸發) ---
        function calcTwdInEdit() {
            // 取得日幣金額
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            // 取得目前輸入框中的匯率
            const rate = parseFloat(document.getElementById('edit-expense-rate').value) || 0;
            
            // 計算並寫入隱藏的台幣欄位
            document.getElementById('edit-expense-twd').value = Math.round(jpy * rate);
        }

        function calcRateInEdit() {
            const jpy = parseFloat(document.getElementById('edit-expense-price').value) || 0;
            const twd = parseFloat(document.getElementById('edit-expense-twd').value) || 0;
            if(jpy !== 0) {
                const newRate = twd / jpy;
                document.getElementById('edit-expense-rate').value = newRate.toFixed(4);
            }
        }

        function closeExpenseEditModal() { 
            const modal = document.getElementById('expense-edit-modal'); 
            modal.classList.add('opacity-0'); 
            modal.querySelector('div').classList.remove('scale-100'); 
            modal.querySelector('div').classList.add('scale-95'); 
            setTimeout(() => { 
                modal.classList.add('hidden'); 
                currentExpenseId = null; 
                
                // ★★★ 新增：如果是取消，也要清空暫存 ID ★★★
                pendingShoppingId = null; 
                
            }, 250); 
        }       
        // --- 儲存編輯或新增的記帳資料  --- 
        function saveExpenseEdit() { 
            // 1. 取得欄位資料
            const payer = document.getElementById('edit-expense-payer').value; 
            const type = document.getElementById('edit-expense-type').value; 
            const item = document.getElementById('edit-expense-item').value; 
            const price = parseFloat(document.getElementById('edit-expense-price').value); 
            const rate = parseFloat(document.getElementById('edit-expense-rate').value); 
            const twd = parseFloat(document.getElementById('edit-expense-twd').value); 
            const dateVal = document.getElementById('edit-expense-date').value;
            const fileInput = document.getElementById('edit-expense-photo'); 
            
            // ★ 讀取數量 (若欄位隱藏或空白，預設為 1，避免除以 0)
            const qtyInput = document.getElementById('edit-expense-qty');
            const newQty = parseInt(qtyInput.value) || 1;

            // 2. 驗證
            if (!item || isNaN(price)) { showToast("請填寫完整", 'error'); return; } 
            
            // 3. 存檔邏輯
            const processSave = (newImg) => { 
                const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
                
                if (currentExpenseId) {
                    // 修改模式
                    const idx = list.findIndex(e => e.id === currentExpenseId); 
                    if (idx > -1) { 
                        const finalImg = newImg !== null ? newImg : list[idx].img;
                        list[idx] = { ...list[idx], payer, type, item, price, rate, twd, date: dateVal, img: finalImg };
                        showToast("修改成功", 'success');
                    }
                } else {
                    // 新增模式
                    const newId = Date.now();
                    list.unshift({ id: newId, payer, type, item, price, rate, twd, date: dateVal, img: newImg || '' });
                    showToast("記帳成功", 'success');
                }

                // 4. 更新記帳資料庫
                localStorage.setItem('hk_wallet_v20', JSON.stringify(list)); 
                const cleanList = list.map(d => ({...d, img: ''}));
                saveToCloud('hk_wallet_v20', cleanList);
                renderExpenseList(); 
                
                // ★★★ 5. 連動：回填數量與計算單價 ★★★
                if (pendingShoppingId) {
                    const shopList = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                    const shopItem = shopList.find(i => i.id === pendingShoppingId);
                    
                    if (shopItem) {
                        shopItem.done = true; // 打勾
                        
                        // 回填新的數量
                        shopItem.qty = newQty; 
                        
                        // 回填新的單價 (總金額 / 數量，並四捨五入)
                        if (newQty > 0) {
                            shopItem.price = Math.round(price / newQty);
                        }

                        localStorage.setItem('hk_shopping_v20', JSON.stringify(shopList));
                        
                        // 更新清單畫面
                        const viewShopping = document.getElementById('view-shopping');
                        if (viewShopping && !viewShopping.classList.contains('hidden')) {
                            renderShoppingList();
                        }
                        showToast("已更新必買清單金額與數量", 'success');
                    }
                    pendingShoppingId = null; // 重置
                }
                // ★★★★★★★★★★★★★★★★★★★★★★★★★

                closeExpenseEditModal(); 
            };
            
            // 6. 圖片處理
            if (fileInput.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d'); 
                        const maxW = 300; const scale = maxW / img.width; 
                        c.width = maxW; c.height = img.height * scale; 
                        ctx.drawImage(img, 0, 0, c.width, c.height); 
                        processSave(c.toDataURL('image/jpeg', 0.3)); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(fileInput.files[0]); 
            } else { 
                processSave(null); 
            } 
        }
        // --- 刪除消費紀錄確認視窗 ---
        function confirmDeleteExpense(id) { deleteTarget = 'expense-single'; deleteExpenseId = id; document.getElementById('confirm-msg').innerText="確定刪除此筆消費？"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        // --- 清除所有記帳資料確認視窗 ---
        function clearExpenses() { deleteTarget = 'expense-clear'; document.getElementById('confirm-msg').innerText="確定清除所有記帳資料？"; document.getElementById('confirm-modal').classList.remove('hidden'); setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10); }
        // --- 匯出記帳與必買清單資料 ---
        function exportData() {
            const wallet = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]');
            const shopping = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
            
            let text = "=== 北海道冬旅 2025 資料備份 ===\n\n";
            text += "【支出紀錄】\n";
            let totalJpy = 0;
            let totalTwd = 0;
            wallet.forEach(w => {
                const twd = w.twd || Math.round(w.price * (w.rate || 0.22));
                const typeStr = w.type === 'private' ? ' [私費]' : ''; // 標註私費
                totalJpy += w.price;
                totalTwd += twd;
                text += `${w.date} [${w.payer}]${typeStr} ${w.item}: ¥${w.price.toLocaleString()} (NT$${twd.toLocaleString()})\n`;
            });
            text += `------------------\n總計: ¥${totalJpy.toLocaleString()} (約 NT$${totalTwd.toLocaleString()})\n\n`;
            
            // ... (必買清單部分保持不變) ...
            text += "【必買清單】\n";
            shopping.forEach(s => {
                text += `[${s.done ? 'v' : ' '}] ${s.name} - ${s.desc}\n`;
            });

            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Hokkaido_Backup_${new Date().toLocaleDateString().replace(/\//g,'')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function openSplitBillModal() { 
            const list = JSON.parse(localStorage.getItem('hk_wallet_v20') || '[]'); 
            const members = ['小戴', '佳欣', '佳萱', '玟廷']; 
            let totals = {}; members.forEach(m => totals[m] = 0); 
            let grandTotal = 0; 
            
            list.forEach(ex => { 
                if (ex.type === 'private') return; // 過濾私費
                if (totals[ex.payer] !== undefined) { 
                    const amount = ex.twd !== undefined ? ex.twd : Math.round(ex.price * (ex.rate || 0.22));
                    totals[ex.payer] += amount; 
                    grandTotal += amount; 
                } 
            }); 
            
            const average = grandTotal / members.length; 
            let summaryHtml = ''; 
            members.forEach(m => { 
                const paid = totals[m]; 
                const diff = paid - average; 
                const diffClass = diff >= 0 ? 'text-green-600' : 'text-red-500'; 
                summaryHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-50 last:border-0"><span class="font-bold text-gray-700 dark:text-gray-100 w-16">${m}</span><span class="text-xs text-gray-400">墊 NT$${paid.toLocaleString()}</span><span class="font-mono ${diffClass} w-24 text-right">${diff >= 0 ? '+' : ''} $${Math.round(diff).toLocaleString()}</span></div>`; 
            });
            
            document.getElementById('split-summary').innerHTML = summaryHtml; 
            document.getElementById('split-average').innerText = `NT$${Math.round(average).toLocaleString()}`; 
            
            // 計算建議結算
            let debtors = []; let creditors = []; 
            members.forEach(m => { 
                const diff = totals[m] - average; 
                if (diff < -1) debtors.push({ name: m, amount: -diff }); 
                else if (diff > 1) creditors.push({ name: m, amount: diff }); 
            }); 
            debtors.sort((a, b) => b.amount - a.amount); 
            creditors.sort((a, b) => b.amount - a.amount); 
            
            let planHtml = ''; 
            let i = 0, j = 0; 
            if(debtors.length === 0 && creditors.length === 0) { 
                planHtml = '<div class="text-center text-green-500 font-bold py-2">目前收支平衡！</div>'; 
            } else { 
                while (i < debtors.length && j < creditors.length) { 
                    let debtor = debtors[i]; let creditor = creditors[j]; 
                    let amount = Math.min(debtor.amount, creditor.amount); 
                    planHtml += `<div class="flex items-center justify-between bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 p-2 rounded text-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-700 dark:text-gray-100">${debtor.name}</span><i class="fas fa-long-arrow-alt-right text-gray-400"></i><span class="font-bold text-gray-700 dark:text-gray-100">${creditor.name}</span></div><div class="font-mono font-bold text-muji-accent">NT$${Math.round(amount).toLocaleString()}</div></div>`; 
                    debtor.amount -= amount; creditor.amount -= amount; 
                    if (debtor.amount < 1) i++; 
                    if (creditor.amount < 1) j++; 
                } 
            } 
            document.getElementById('split-plan').innerHTML = planHtml; 
            const modal = document.getElementById('split-bill-modal'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10); 
        }        
        function closeSplitBillModal() {
            const modal = document.getElementById('split-bill-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 250);
        }
        
        // --- UPDATED: CHECKLIST LOGIC (Collapsible, Default Closed) ---
        function initChecklist() {
            // 設定預設清單分類
            const defaultChecklistData = [
            { category: '隨身包包', items: ['錢包','護照','耳機','行動電源','口罩','藥','衛生棉','購物袋','雨傘','袖珍包','濕紙巾',] },
            { category: '登機行李', items: ['護照','疫苗卡、國際護照','AirPods ','口罩','酒精','筆','保溫杯'] },
            { category: '化妝、保養品', items: ['防曬','粉底液','眉筆','口紅','粉撲','卸妝棉+水','乳液','護唇膏','梳子','髮圈','隱眼','止汗劑'] },
            { category: '盥洗用品', items: ['洗面乳','牙膏 牙刷','洗衣粉（球）','乾淨夾鏈袋'] },
            { category: '衣服', items: ['襪子','內衣','紙內褲','上衣','下身','睡衣','拖鞋','帽子','手套 圍巾','發熱衣 褲','髒衣袋'] },
            { category: '3C', items: ['手機充電器','手錶充電器','行動電源','豆腐頭 + type c線','相機充電器','相機'] },
            { category: '北海道旅行用品', items: ['毛帽','羽絨外套','發熱衣','發熱褲','手套','雪靴 or 防水鞋','隱眼','墨鏡','毛衣','半桶襪（到小腿 - 滑雪用','長襪 - 一般步行','暖暖包'] },

            ];
            
            const rawData = defaultChecklistData.map(cat => ({ 
                category: cat.category, 
                isOpen: false, 
                items: cat.items.map(txt => ({ txt: txt, done: false })) 
            }));
            
            let stored = JSON.parse(localStorage.getItem('hk_checks_v20'));
            
            // 確保 isOpen 屬性存在
            if(stored && Array.isArray(stored)) {
                stored.forEach(g => { if(g.isOpen === undefined) g.isOpen = false; });
            }
            
            if(!stored || !Array.isArray(stored) || stored.length === 0) { 
                stored = rawData; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(stored)); 
            }
            renderChecklist();
        }
        // 更新進度條
        function renderChecklist() {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            const container = document.getElementById('checklist-groups');
            if (!container) return;
            
            let html = ''; 
            let totalItems = 0; 
            let doneItems = 0;

            if (!Array.isArray(list)) { localStorage.removeItem('hk_checks_v20'); initChecklist(); return; }

            list.forEach((group, catIdx) => {
                if (!group || !group.items) return;
                // 判斷分類是否展開                
                const isOpen = group.isOpen === true; 
                const arrowIcon = isOpen ? 'fa-chevron-up' : 'fa-chevron-down';
                const contentDisplay = isOpen ? 'block' : 'hidden';
                const headerRadius = isOpen ? 'rounded-t-lg' : 'rounded-lg';
                const headerBorder = isOpen ? 'border-b border-gray-100 dark:border-gray-700' : '';

                let groupHtml = '';
                group.items.forEach((item, itemIdx) => {
                    totalItems++; if(item.done) doneItems++;
                    groupHtml += `<div onclick="toggleCheck(${catIdx}, ${itemIdx})" class="flex items-center py-2 border-b border-gray-50 last:border-0 group checklist-item active:bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 transition-colors">
                        <div class="flex items-center cursor-pointer flex-1 min-w-0">
                            <input type="checkbox" class="peer hidden pointer-events-none" ${item.done ? 'checked' : ''}>
                            <div class="w-5 h-5 border-2 border-gray-300 rounded-md peer-checked:bg-muji-accent peer-checked:border-muji-accent flex items-center justify-center transition-colors flex-shrink-0 pointer-events-none">
                                <i class="fas fa-check text-white text-xs opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                            </div>
                            <span class="ml-3 text-sm text-gray-600 dark:text-gray-300 peer-checked:line-through peer-checked:text-gray-300 transition-colors select-none truncate pointer-events-none">${item.txt}</span>
                        </div>
                        <button onclick="confirmDeleteCheckItem(${catIdx}, ${itemIdx}); event.stopPropagation();" class="text-gray-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                    </div>`;
                });

                html += `
                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-sm transition-all duration-200">
                    <div class="p-3 bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 ${headerRadius} ${headerBorder} flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:bg-gray-900 transition select-none" onclick="toggleCheckGroup(${catIdx})">
                        <div class="flex items-center gap-2">
                            <i class="fas ${arrowIcon} text-xs text-gray-400 w-4 text-center"></i>
                            <h4 class="font-bold text-gray-700 dark:text-gray-100 text-sm">${group.category} <span class="text-[10px] text-gray-400 font-normal ml-1">(${group.items.filter(i=>i.done).length}/${group.items.length})</span></h4>
                        </div>
                        <button onclick="confirmDeleteCheckCategory(${catIdx}); event.stopPropagation();" class="text-xs text-gray-300 hover:text-red-400 px-2"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="${contentDisplay} p-3 pt-0">
                        <div class="space-y-0 mt-2">${groupHtml}</div>
                        <div class="mt-2 pt-2 flex items-center border-t border-gray-50">
                            <input type="text" placeholder="新增項目..." class="flex-1 text-xs bg-gray-50 dark:bg-stone-900 dark:border-stone-700 dark:text-white dark:border-gray-600 border border-transparent hover:bg-white dark:bg-gray-800 hover:border-gray-200 focus:bg-white dark:bg-gray-800 focus:border-muji-accent rounded px-2 py-1 outline-none transition" onchange="addCheckItem(${catIdx}, this)">
                            <button class="ml-2 text-muji-accent text-sm w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 dark:bg-gray-900" onclick="addCheckItemBtn(${catIdx}, this.previousElementSibling)"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html; 
            updateChecklistProgress(doneItems, totalItems);
        }
        // 更新進度條
        function toggleCheckGroup(catIdx) {
            const list = JSON.parse(localStorage.getItem('hk_checks_v20'));
            if (list && list[catIdx]) {
                const current = list[catIdx].isOpen === true;
                list[catIdx].isOpen = !current;
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist();
            }
        }
        // 新增分類
        function openAddCategoryModal() {
            const modal = document.getElementById('add-category-modal');
            const content = modal.querySelector('div'); // 取得內層卡片

            modal.classList.remove('hidden');
            // 延遲執行 CSS 動畫，讓視窗漂亮淡入
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
                
                // 自動聚焦輸入框
                const input = document.getElementById('new-category-name');
                if(input) input.focus();
            }, 10);
        }
        // 關閉新增分類視窗
        function closeAddCategoryModal() {
        const modal = document.getElementById('add-category-modal');
            const content = modal.querySelector('div');

            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 250);
        }
        // 儲存新分類
        function saveNewCategory() {
        const input = document.getElementById('new-category-name');
            const name = input.value.trim();
            if (!name) { showToast('請輸入分類名稱', 'error'); return; }
            
            // 這裡原本寫 KEYS.CHECKS 導致報錯，已修正為正確的 Key
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            
            // 新增分類，預設為展開狀態 (isOpen: true)
            list.push({ category: name, isOpen: true, items: [] });
            
            localStorage.setItem('hk_checks_v20', JSON.stringify(list));
            renderChecklist(); // 重新渲染畫面
            
            input.value = '';
            closeAddCategoryModal();
            showToast('分類新增成功', 'success');
        }
        // 新增檢查項目
        function addCheckItem(catIdx, input) {
            const val = input.value.trim();
            if (!val) return;
            
            // 修正：改用字串 'hk_checks_v20'
            const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
            
            if (list[catIdx]) {
                list[catIdx].items.push({ txt: val, done: false });
                localStorage.setItem('hk_checks_v20', JSON.stringify(list));
                renderChecklist();
                
                // 新增後保持輸入框聚焦，方便連續輸入
                input.value = '';
                input.focus(); 
            }
        }
        // 新增檢查項目按鈕
        function addCheckItemBtn(catIdx, input) {
            addCheckItem(catIdx, input);
        }
        // 新增檢查項目
        function toggleCheck(catIdx, itemIdx) { 
            const list = JSON.parse(localStorage.getItem('hk_checks_v20')); 
            if (list && list[catIdx] && list[catIdx].items[itemIdx]) { 
                list[catIdx].items[itemIdx].done = !list[catIdx].items[itemIdx].done; 
                localStorage.setItem('hk_checks_v20', JSON.stringify(list)); 
                renderChecklist(); 
            } 
        }
        function confirmDeleteCheckCategory(idx) {
            deleteTarget = 'checklist-cat';
            deleteChecklistCatIdx = idx;
            document.getElementById('confirm-msg').innerHTML = "確定刪除此分類？<br>裡面的項目也會一起消失。";
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function confirmDeleteCheckItem(catIdx, itemIdx) {
            deleteTarget = 'checklist-item';
            deleteChecklistCatIdx = catIdx;
            deleteChecklistItemIdx = itemIdx;
            document.getElementById('confirm-msg').innerText = "確定刪除此項目？";
            document.getElementById('confirm-modal').classList.remove('hidden');
        }
        // --- 1. 初始化清單 ---
        function initShoppingList() { 
            initShoppingCats();
            // 從手機記憶體 (localStorage) 讀取資料
            let stored = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            if (!stored|| stored.length === 0) { 
                stored = JSON.parse(JSON.stringify(defaultShoppingList)); 
                localStorage.setItem('hk_shopping_v20', JSON.stringify(stored)); 
            } 
            // 執行畫面渲染
            renderShoppingList(); 
        }
        // --- 2. 渲染 (顯示) 清單畫面 --
        function renderShoppingList() { 
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]'); 
            const container = document.getElementById('shopping-container'); 
            
            let filteredList = list; 
            if (currentShoppingFilter !== 'all') { 
                filteredList = list.filter(item => item.type === currentShoppingFilter); 
            } 
            
            if (filteredList.length === 0) { 
                container.innerHTML = getEmptyStateHtml('尚無必買商品', 'fa-shopping-basket'); 
                return; 
            } 

            let html = ''; 
            filteredList.forEach((item) => { 
                const opacityClass = item.done ? 'opacity-50 grayscale' : ''; 
                const lineThrough = item.done ? 'line-through' : ''; 
                const checkIcon = item.done ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-200'; 
                
                // ★★★ 計算與顯示金額邏輯 ★★★
                const price = item.price || 0;
                const qty = item.qty || 1;
                const total = price * qty;
                
                // 如果有價格才顯示
                let priceHtml = '';
                if (price > 0) {
                    priceHtml = `
                    <div class="mt-1 flex items-center gap-2 text-[10px] text-gray-500 font-mono bg-gray-50 dark:bg-stone-900 inline-block px-1.5 py-0.5 rounded border border-gray-100 dark:border-gray-700">
                        <span>¥${price.toLocaleString()}</span>
                        <span class="text-gray-300">x</span>
                        <span>${qty}</span>
                        <span class="text-gray-300">=</span>
                        <span class="font-bold text-muji-shopText">¥${total.toLocaleString()}</span>
                    </div>`;
                } else if (qty > 1) {
                     // 沒寫價格但有寫數量
                     priceHtml = `<div class="mt-1 inline-block px-1.5 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-[10px] text-gray-500 dark:text-gray-300">數量: ${qty}</div>`;
                }
                // ★★★★★★★★★★★★★★★★★★

        html += `
                <div class="flex items-start bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm ${opacityClass} transition-all relative group sortable-item" data-id="${item.id}">
                    
                    <div class="drag-handle self-center mr-3 text-gray-300 hover:text-muji-accent cursor-grab active:cursor-grabbing p-1">
                        <i class="fas fa-grip-vertical"></i>
                    </div>

                    <div class="w-16 h-16 rounded-md bg-gray-100 dark:bg-gray-900 bg-cover bg-center shrink-0 cursor-pointer" style="background-image: url('${item.img}')" onclick="openImageModal('${item.img}')"></div>
                    
                    <div class="flex-1 px-3 min-w-0">
                        <h4 class="text-sm font-bold text-gray-800 dark:text-gray-100 ${lineThrough} truncate">${item.name}</h4>
                        <p class="text-[10px] text-gray-500 mt-0.5 leading-tight line-clamp-1">${item.desc}</p>
                        ${priceHtml} 
                    </div>
                    
                    <div class="flex flex-col items-center gap-2 ml-2 pt-1">
                        <button onclick="toggleShoppingCheck('${item.id}')" class="text-xl focus:outline-none transition-transform active:scale-90">
                            <i class="fas ${checkIcon}"></i>
                        </button>
                        <div class="flex gap-2 mt-1">
                            <button onclick="openShoppingModal('${item.id}')" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="confirmDeleteShopping('${item.id}')" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html; 
            // ★★★ 新增：必買清單拖曳初始化 (全分類通用) ★★★
            if (window.shopSortable) window.shopSortable.destroy();

            window.shopSortable = Sortable.create(container, {
                handle: '.drag-handle', // 指定只能拉這個手柄
                animation: 150,
                ghostClass: 'bg-gray-100', // 拖曳時的殘影背景
                delay: 100, // 手機防誤觸
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    // 拖曳結束後，執行存檔
                    handleShopSortWithFilter();
                }
            });
        }
// --- 處理必買清單排序 (支援分類篩選的填空演算法) ---
        function handleShopSortWithFilter() {
            // 1. 讀取原始大清單
            const fullList = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
            
            // 2. 取得目前畫面上排序後的 ID 列表 (從 DOM 抓取)
            const container = document.getElementById('shopping-container');
            const newOrderIds = Array.from(container.children).map(el => el.getAttribute('data-id'));

            // 3. 找出這些項目在原始清單中的「索引位置 (Slots)」
            // 這些是我們要回填的坑洞
            let slots = [];
            fullList.forEach((item, index) => {
                // 如果這個項目存在於目前的篩選畫面中
                if (newOrderIds.includes(item.id)) {
                    slots.push(index);
                }
            });

            // 4. 開始回填
            // slots 陣列記錄了原本的索引 (例如 [0, 2, 5])
            // newOrderIds 記錄了新的商品順序 (例如 [C, A, B])
            // 我們要把 C 填入 0, A 填入 2, B 填入 5
            
            slots.forEach((originalIndex, i) => {
                const targetId = newOrderIds[i]; // 取得新順序中的第 i 個 ID
                const itemData = fullList.find(item => item.id === targetId); // 找回該 ID 的完整資料
                
                // 將資料填回原始清單的坑洞中
                // 注意：這裡我們直接修改 fullList 的指定位置
                // 為了避免 find 找不到 (理論上不會)，加個保險
                if (itemData) {
                    // 因為 find 是傳參考 (Reference)，直接賦值可能會錯亂，建議重新構建
                    // 但因為我們要「覆蓋」該位置，所以直接指派是最快的方法
                    // 但要注意：fullList[originalIndex] 必須被「新順序的物件」取代
                    
                    // 技巧：我們不能直接用 find 出來的物件，因為它位置已經變了
                    // 我們需要一個暫存 map 或是每次重新 find
                    // 更高效的寫法：
                }
            });

            // --- 優化版回填演算法 ---
            // 1. 先把目前畫面上的項目資料抓出來，依照新順序排好
            const sortedItems = newOrderIds.map(id => fullList.find(item => item.id === id));
            
            // 2. 依序填入原本的坑洞
            slots.forEach((slotIndex, i) => {
                fullList[slotIndex] = sortedItems[i];
            });

            // 5. 存檔
            localStorage.setItem('hk_shopping_v20', JSON.stringify(fullList));
            
            showToast('排序已更新', 'success');
        }
        // --- 3. 切換分類按鈕 ---
        function filterShopping(type) { 
            currentShoppingFilter = type; // 更新目前的全域篩選狀態
            // 更新按鈕樣式 (這段是在做 UI 切換，讓選中的按鈕變色)
            const buttons = document.querySelectorAll('#view-shopping button'); 
            buttons.forEach(btn => { 
                if(btn.parentElement.classList.contains('overflow-x-auto')) { 
                    // 判斷按鈕文字是否對應目前的 type
                    if(btn.textContent === (type==='all'?'全部':(type==='drug'?'藥妝':(type==='souvenir'?'伴手禮':'其他')))) { 
                        // 選中樣式 (深色背景)
                        btn.className = "px-3 py-1 bg-muji-accent text-white rounded-full text-xs whitespace-nowrap shadow-sm"; 
                    } else { 
                        // 未選中樣式 (白色背景)
                        btn.className = "px-3 py-1 bg-white dark:bg-gray-800 border border-gray-200 text-gray-500 rounded-full text-xs whitespace-nowrap"; 
                    } 
                } 
            }); 
            renderShoppingList(); // 重新渲染列表
        }
        // --- 4. 切換購買狀態 (修改版：連動記帳) ---
        function toggleShoppingCheck(id) { 
            const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
            const item = list.find(i => i.id === id); 
            
            if (item) { 
                // 情境 A: 使用者想「取消勾選」 (原本是已購買 -> 改成未購買)
                // 直接執行，不需要問
                if (item.done) {
                    item.done = false;
                    localStorage.setItem('hk_shopping_v20', JSON.stringify(list));
                    renderShoppingList();
                } 
                // 情境 B: 使用者想「打勾」 (原本是未購買 -> 改成已購買)
                // 觸發連動記帳流程
                else {
                    pendingShoppingId = id; // 1. 記住這個商品 ID
                    promptExpenseForShopping(item); // 2. 開啟記帳視窗
                }
            } 
        }
// --- 連動：開啟記帳視窗並帶入商品資料 (含數量) ---
        function promptExpenseForShopping(item) {
            // 1. 開啟視窗
            openExpenseModal(); 
            
            // 2. 修改標題
            const modal = document.getElementById('expense-edit-modal');
            const title = modal.querySelector('h3');
            if(title) title.innerText = "新增記帳 (來自必買清單)";

            // 3. 填入商品名稱
            document.getElementById('edit-expense-item').value = item.name;

            // ★★★ 4. 顯示並填入數量欄位 ★★★
            const qtyWrapper = document.getElementById('edit-qty-wrapper');
            const qtyInput = document.getElementById('edit-expense-qty');
            
            // 移除 hidden 讓它跑出來
            qtyWrapper.classList.remove('hidden');
            // 填入原本清單設定的數量 (預設為 1)
            qtyInput.value = item.qty || 1;

            // 5. 計算總價 (單價 x 數量)
            const total = (item.price || 0) * (item.qty || 1);
            if (total > 0) {
                document.getElementById('edit-expense-price').value = total;
                if (typeof calcTwdInEdit === 'function') calcTwdInEdit();
            }
            
            // 6. 預設分類為「私費」
            document.getElementById('edit-expense-type').value = 'private'; 
        }
    // --- 5. 開啟新增/編輯視窗 ---
    // --- 必買清單分類管理系統 ---

    // 1. 初始化分類 (如果沒有資料，則建立預設值)
    function initShoppingCats() {
        let cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20'));
        if (!cats || cats.length === 0) {
            cats = [
                { id: 'drug', name: '藥妝' },
                { id: 'souvenir', name: '伴手禮' },
                { id: 'other', name: '其他' }
            ];
            localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));
        }
        renderShoppingFilters();
    }

    // 2. 渲染篩選按鈕 (包含刪除按鈕) ---
    function renderShoppingFilters() {
        const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
        const container = document.getElementById('shopping-filter-container');
        if(!container) return;

        let html = '';
        
        // (A) "全部" 按鈕 (永遠存在，不可刪除)
        const isAllActive = currentShoppingFilter === 'all';
        html += `<button onclick="filterShopping('all')" class="px-3 py-1 rounded-full text-xs whitespace-nowrap shadow-sm transition-colors flex items-center ${isAllActive ? 'bg-muji-accent text-white' : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-300'}">全部</button>`;

        // (B) 動態分類按鈕
        cats.forEach(cat => {
            const isActive = currentShoppingFilter === cat.id;
            const style = isActive 
                ? 'bg-muji-accent text-white pr-2' // 選取時右邊多留點空間給 X 按鈕
                : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 text-gray-500 dark:text-gray-300';
            
            // 只有在「選取狀態」才顯示刪除鈕
            // event.stopPropagation() 很重要，避免點 X 時又觸發一次按鈕點擊
            const deleteBtn = isActive 
                ? `<span onclick="confirmDeleteShopCat('${cat.id}'); event.stopPropagation();" class="ml-2 w-4 h-4 flex items-center justify-center bg-white/20 rounded-full hover:bg-red-500 hover:text-white transition cursor-pointer" title="刪除此分類"><i class="fas fa-times text-[10px]"></i></span>` 
                : '';

            html += `<button onclick="filterShopping('${cat.id}')" class="px-3 py-1 rounded-full text-xs whitespace-nowrap shadow-sm transition-colors flex items-center ${style}">
                ${cat.name} ${deleteBtn}
            </button>`;
        });

        // (C) 新增分類按鈕 (+)
        html += `<button onclick="openAddShopCatModal()" class="w-7 h-6 rounded-full border border-dashed border-gray-400 text-gray-400 flex items-center justify-center hover:border-muji-accent hover:text-muji-accent transition shrink-0"><i class="fas fa-plus text-[10px]"></i></button>`;

        container.innerHTML = html;
    }

    // --- 新增：確認刪除分類的函式 ---
    let deleteShopCatId = null; // 全域變數暫存

    function confirmDeleteShopCat(id) {
        deleteTarget = 'shop-cat'; // 設定刪除目標為「分類」
        deleteShopCatId = id;      // 記住要刪除哪個 ID
        
        // 呼叫確認視窗
        document.getElementById('confirm-msg').innerHTML = "確定刪除此分類？<br><b>該分類下的所有商品也會被刪除！</b>";
        document.getElementById('confirm-modal').classList.remove('hidden');
        setTimeout(() => document.getElementById('confirm-box').classList.remove('scale-95'), 10);
    }
    // 3. 修改原有的 filterShopping 以支援重新渲染按鈕狀態
    // (請確認你的原始程式碼中 filterShopping 是否已被此取代，或手動更新它)
    const originalFilterShopping = filterShopping; // 備份舊的若需要
    filterShopping = function(type) {
        currentShoppingFilter = type;
        renderShoppingFilters(); // 重繪按鈕顏色
        renderShoppingList();    // 重繪清單內容
    };

    // 4. 開啟/關閉新增分類視窗
    function openAddShopCatModal() {
        const modal = document.getElementById('add-shop-cat-modal');
        const content = modal.querySelector('div');
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
            document.getElementById('new-shop-cat-name').focus();
        }, 10);
    }

    function closeAddShopCatModal() {
        const modal = document.getElementById('add-shop-cat-modal');
        const content = modal.querySelector('div');
        modal.classList.add('opacity-0');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        setTimeout(() => { modal.classList.add('hidden'); }, 250);
    }

    // 5. 儲存新分類
    function saveNewShopCat() {
        const input = document.getElementById('new-shop-cat-name');
        const name = input.value.trim();
        if(!name) { showToast('請輸入分類名稱', 'error'); return; }

        const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
        
        // 產生簡易 ID (例如: cat_173666123)
        const newId = 'cat_' + Date.now();
        
        cats.push({ id: newId, name: name });
        localStorage.setItem('hk_shop_cats_v20', JSON.stringify(cats));
        
        // 重新渲染並切換到新分類
        renderShoppingFilters();
        filterShopping(newId); // 自動切換到新分類
        
        input.value = '';
        closeAddShopCatModal();
        showToast('分分類新增成功', 'success');
    }
    // 必買清單數量調整
        function adjShopQty(delta) {
            const input = document.getElementById('shop-qty');
            let val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            input.value = val;
        }

    // ★重要更新★：修改開啟編輯視窗功能，讓下拉選單(Select)自動抓取最新分類
        function openShoppingModal(id) { 
            currentShoppingId = id; 
            const modal = document.getElementById('shopping-edit-modal'); 
            const title = document.getElementById('shopping-modal-title'); 
            const typeSelect = document.getElementById('shop-type');

            // --- 動態生成下拉選單選項 ---
            const cats = JSON.parse(localStorage.getItem('hk_shop_cats_v20') || '[]');
            let optionsHtml = '';
            cats.forEach(cat => {
                optionsHtml += `<option value="${cat.id}">${cat.name}</option>`;
            });
            typeSelect.innerHTML = optionsHtml;
            // ---------------------------

            // 重置欄位
            document.getElementById('shop-name').value = ''; 
            document.getElementById('shop-price').value = ''; // 重置價格
            document.getElementById('shop-qty').value = '1';  // 重置數量
            
            // 預設選取目前的篩選分類
            document.getElementById('shop-type').value = (currentShoppingFilter !== 'all') ? currentShoppingFilter : cats[0].id;
            document.getElementById('shop-desc').value = ''; 
            document.getElementById('shop-photo').value = ''; 

            if(id) { 
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20')); 
                const item = list.find(i => i.id === id); 
                if(item) { 
                    title.innerText = "編輯必買"; 
                    document.getElementById('shop-name').value = item.name; 
                    
                    // ★★★ 填入舊資料 ★★★
                    document.getElementById('shop-price').value = item.price || '';
                    document.getElementById('shop-qty').value = item.qty || 1;
                    // ★★★★★★★★★★★★★
                    
                    document.getElementById('shop-type').value = item.type; 
                    document.getElementById('shop-desc').value = item.desc; 
                } 
            } else { 
                title.innerText = "新增必買"; 
            }

            modal.classList.remove('hidden');
            setTimeout(() => { 
                modal.classList.remove('opacity-0'); 
                modal.querySelector('div').classList.remove('scale-95'); 
                modal.querySelector('div').classList.add('scale-100'); 
            }, 10);
        }
        // --- 6. 關閉視窗 ---
        function closeShoppingModal() { 
            const modal = document.getElementById('shopping-edit-modal'); 
            modal.classList.add('opacity-0'); 
            modal.querySelector('div').classList.remove('scale-100'); 
            modal.querySelector('div').classList.add('scale-95'); 
            setTimeout(() => { modal.classList.add('hidden'); currentShoppingId = null; }, 250); 
        }
        // --- 7. 儲存商品 (含圖片壓縮) ---
        function saveShoppingItem() {
            if (!validateStorage()) return; // 如果空間爆了就阻止儲存
            const name = document.getElementById('shop-name').value.trim();
            const type = document.getElementById('shop-type').value;
            const desc = document.getElementById('shop-desc').value.trim();
            
            // ★★★ 讀取新欄位 ★★★
            const price = parseFloat(document.getElementById('shop-price').value) || 0;
            const qty = parseInt(document.getElementById('shop-qty').value) || 1;
            // ★★★★★★★★★★★★★
            
            const fileInput = document.getElementById('shop-photo');

            if (!name) { showToast('請輸入商品名稱', 'error'); return; }
            
            const processSave = (img) => {
                const list = JSON.parse(localStorage.getItem('hk_shopping_v20') || '[]');
                
                if (currentShoppingId) {
                    const idx = list.findIndex(i => i.id === currentShoppingId);
                    if (idx > -1) {
                        list[idx].name = name;
                        list[idx].type = type;
                        list[idx].desc = desc;
                        // 更新數值
                        list[idx].price = price;
                        list[idx].qty = qty;
                        
                        if (img) list[idx].img = img;
                    }
                } else {
                    const newItem = {
                        id: 'c' + Date.now(),
                        type: type,
                        name: name,
                        desc: desc,
                        // 儲存數值
                        price: price,
                        qty: qty,
                        done: false,
                        img: img || 'https://placehold.co/100x100/e5e7eb/4b5563?text=No+Img'
                    };
                    list.unshift(newItem);
                }

                try {
                    localStorage.setItem('hk_shopping_v20', JSON.stringify(list));
                    renderShoppingList();
                    closeShoppingModal();
                    if (currentShoppingFilter !== 'all' && currentShoppingFilter !== type) {
                        filterShopping(type);
                    }
                    showToast('儲存成功', 'success');
                } catch (e) {
                    showToast("儲存失敗", 'error');
                }
            };
            
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        const ctx = c.getContext('2d');
                        const maxW = 300;
                        const scale = maxW / img.width;
                        c.width = maxW;
                        c.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        processSave(c.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                processSave(null);
            }
        }
        // --- 8. 刪除確認 ---
        function confirmDeleteShopping(id) { 
            deleteTarget = 'shopping'; // 標記要刪除的類型
            deleteShoppingId = id; // 標記要刪除的 ID
            document.getElementById('confirm-modal').classList.remove('hidden');// 呼叫共用的確認視窗
        }
        // --- 新增切換清單頁籤 ---
        function toggleListTab(tab) {
            const viewCheck = document.getElementById('view-checklist');
            const viewShop = document.getElementById('view-shopping');
            
            const btnCheck = document.getElementById('btn-checklist');
            const btnShop = document.getElementById('btn-shopping');
            
            // 取得懸浮按鈕
            const fabCheck = document.getElementById('fab-checklist');
            const fabShop = document.getElementById('fab-shopping');
            
            // 定義樣式
            const styleInactive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-medium text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300";
            const styleCheckActive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-emerald-600 dark:text-emerald-400";
            const styleShopActive = "flex-1 py-2 text-sm rounded-lg transition-all duration-300 font-bold bg-white dark:bg-stone-900 dark:border-stone-700 shadow-sm text-pink-500 dark:text-pink-400";

            if (tab === 'checklist') {
                // 1. 顯示行前準備
                viewCheck.classList.remove('hidden');
                viewShop.classList.add('hidden');
                
                // 2. 切換上方按鈕樣式
                btnCheck.className = styleCheckActive;
                btnShop.className = styleInactive;
                
                // 3. 切換懸浮按鈕 (顯示綠色+，隱藏粉色+)
                if(fabCheck) fabCheck.classList.remove('hidden');
                if(fabShop) fabShop.classList.add('hidden');
                
            } else {
                // 1. 顯示必買清單
                viewShop.classList.remove('hidden');
                viewCheck.classList.add('hidden');
                
                // 2. 切換上方按鈕樣式
                btnCheck.className = styleInactive;
                btnShop.className = styleShopActive;
                
                // 3. 切換懸浮按鈕 (隱藏綠色+，顯示粉色+)
                if(fabCheck) fabCheck.classList.add('hidden');
                if(fabShop) fabShop.classList.remove('hidden');
            }
        }
        function initMemo() { const txt = localStorage.getItem('hk_memo_v2') || ''; if(document.getElementById('memo-area')) { document.getElementById('memo-area').value = txt; renderMemoLinks(txt); } }
        function saveMemo() { const txt = document.getElementById('memo-area').value; localStorage.setItem('hk_memo_v2', txt); renderMemoLinks(txt); alert('已儲存'); }
        function renderMemoLinks(txt) { const matches = txt.match(/(https?:\/\/[^\s]+)/g); const container = document.getElementById('memo-links'); if(matches) { container.innerHTML = matches.map(url => `<a href="${url}" target="_blank" class="block truncate text-xs text-blue-500 bg-blue-50 p-2 rounded hover:bg-blue-100"><i class="fas fa-link mr-1"></i>${url}</a>`).join(''); } else { container.innerHTML = '<span class="text-[10px] text-gray-300">尚無連結</span>'; } }
        
        // 新增：更新清單進度條
        function updateChecklistProgress(doneItems = 0, totalItems = 0) {
            // 若呼叫時未傳參，嘗試從 localStorage 計算
            try {
                const bar = document.getElementById('progress-bar');
                const text = document.getElementById('progress-text');
                if (!bar || !text) return;
                if (totalItems === 0) {
                    const list = JSON.parse(localStorage.getItem('hk_checks_v20') || '[]');
                    let total = 0, done = 0;
                    list.forEach(g => { if (g.items) g.items.forEach(i => { total++; if (i.done) done++; }); });
                    totalItems = total; doneItems = done;
                }
                const percent = totalItems > 0 ? Math.round((doneItems / totalItems) * 100) : 0;
                bar.style.width = percent + '%';
                text.innerText = percent + '%';
            } catch (e) {
                console.warn('updateChecklistProgress error', e);
            }
        }

        // --- TIME CHAINING LOGIC ---
        // 新增：當行程結束時間改變時，自動調整後續行程
        function adjustSchedule(dayIdx, changedEvtIdx, newEndTime) {
            const dayEvents = itineraryData[dayIdx].events;
           
            // 簡單實作：如果下一個行程是交通移動，嘗試將其開始時間設為當前結束時間 + 緩衝
            // 這裡做一個簡單的邏輯：如果下一個行程是 "交通移動(move)"，則將其開始時間設為當前結束時間
            // 這裡僅做基本時間字串處理，若要精確需轉 Date 物件
            // 為了不破壞複雜行程，這裡暫時僅作為手動觸發提示
        }

        function openEditModal(dayIdx, evtIdx) {
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx;
            const modal = document.getElementById('edit-modal');
            const content = modal.querySelector('div');
            const btnDelete = document.getElementById('btn-delete');
            const title = document.getElementById('modal-title');
            
            // 取得欄位元件
            const startInput = document.getElementById('edit-start');
            const endInput = document.getElementById('edit-end');
            const durHInput = document.getElementById('edit-duration-h');
            const durMInput = document.getElementById('edit-duration-m');

            if (evtIdx === -1) { 
                // --- 新增模式 ---
                title.innerText = "新增行程"; 
                btnDelete.classList.add('hidden'); 
                
                // 預設時間：接續上一個行程
                const dayEvents = itineraryData[dayIdx].events;
                let defaultStart = "09:00";
                if (dayEvents.length > 0) {
                    const lastEvt = dayEvents[dayEvents.length - 1];
                    if (lastEvt.time && lastEvt.time.includes('~')) {
                        defaultStart = lastEvt.time.split('~')[1].trim();
                    }
                }

                startInput.value = defaultStart; 
                
                // 預設停留 1 小時 0 分
                durHInput.value = 1;
                durMInput.value = 0;

                // 自動計算結束時間
                const endMin = timeToMin(defaultStart) + 60;
                endInput.value = minToTime(endMin);

                // 清空其他欄位
                document.getElementById('edit-title').value = ""; 
                document.getElementById('edit-type').value = "spot"; 
                document.getElementById('edit-note').value = ""; 
                document.getElementById('edit-station').value = ""; 
                document.getElementById('edit-tags').value = ""; 
            } 
            else { 
                // --- 編輯模式 ---
                const evt = itineraryData[dayIdx].events[evtIdx]; 
                title.innerText = "編輯行程"; 
                btnDelete.classList.remove('hidden'); 
                
                const times = evt.time ? evt.time.split('~') : ['','']; 
                const sStr = times[0].trim();
                const eStr = times[1] ? times[1].trim() : '';

                startInput.value = sStr; 
                endInput.value = eStr; 

                // ★ 自動計算目前的停留時間 (拆解為 時:分)
                if (sStr && eStr) {
                    let diff = timeToMin(eStr) - timeToMin(sStr);
                    if (diff < 0) diff += 1440; // 處理跨日
                    
                    const h = Math.floor(diff / 60);
                    const m = diff % 60;
                    
                    durHInput.value = h;
                    durMInput.value = m;
                } else {
                    durHInput.value = 1;
                    durMInput.value = 0;
                }

                document.getElementById('edit-title').value = evt.title; 
                document.getElementById('edit-type').value = evt.type || 'spot'; 
                document.getElementById('edit-note').value = evt.note || ''; 
                document.getElementById('edit-station').value = evt.station || ''; 
                document.getElementById('edit-tags').value = evt.tags ? evt.tags.join(', ') : ''; 
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
            document.body.classList.add('modal-active');
        }
        // --- 時間欄位連動邏輯 (時:分 版) ---
        function syncTime(source) {
            const startInput = document.getElementById('edit-start');
            const endInput = document.getElementById('edit-end');
            const durHInput = document.getElementById('edit-duration-h');
            const durMInput = document.getElementById('edit-duration-m');

            // 取得目前數值
            const startVal = startInput.value;
            const endVal = endInput.value;
            
            // 取得停留時間 (時/分)，若為空則視為 0
            let h = parseInt(durHInput.value) || 0;
            let m = parseInt(durMInput.value) || 0;
            let totalDurationMin = (h * 60) + m;

            if (!startVal) return; 

            const startMin = timeToMin(startVal);
            
            // 邏輯 A: 修改「開始」或「停留時間(時/分)」 -> 自動算「結束」
            if (source === 'start' || source === 'duration') {
                if (totalDurationMin === 0 && source === 'start') {
                    // 如果只是改開始時間且持續時間為0，預設給 60 分鐘方便操作
                    totalDurationMin = 60;
                    durHInput.value = 1;
                    durMInput.value = 0;
                }
                const newEndMin = startMin + totalDurationMin;
                endInput.value = minToTime(newEndMin);
            }
            
            // 邏輯 B: 修改「結束」 -> 自動反推「停留時間 (時:分)」
            else if (source === 'end') {
                if (!endVal) return;
                const endMin = timeToMin(endVal);
                
                // 處理跨日
                let diff = endMin - startMin;
                if (diff < 0) diff += 24 * 60; 
                
                // 換算回 時:分
                const newH = Math.floor(diff / 60);
                const newM = diff % 60;

                durHInput.value = newH;
                durMInput.value = newM;
            }
        }
        function closeModal() {
            const modal = document.getElementById('edit-modal'); const content = modal.querySelector('div');
            modal.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); currentDayIdx = null; currentEvtIdx = null; }, 250);
        }
        // --- 核心邏輯 B：整體自動排程 (骨牌效應) ---
        function autoAdjustSchedule(dayIdx) {
            const events = itineraryData[dayIdx].events;

            // 1. 依照「開始時間」排序
            events.sort((a, b) => {
                const startA = timeToMin(a.time);
                const startB = timeToMin(b.time);
                return startA - startB;
            });

            // 2. 確保沒有行程「騎」在另一個行程頭上 (簡易骨牌)
            for (let i = 0; i < events.length - 1; i++) {
                const current = events[i];
                const next = events[i+1];

                if (!current.time || !next.time) continue;

                const [currStart, currEnd] = current.time.split('~').map(s => s.trim());
                if (!currEnd) continue;
                
                const currEndMin = timeToMin(currEnd);
                const nextStartMin = timeToMin(next.time);

                // 如果 [當前結束] > [下個開始]，代表還有重疊 (通常是 resolveInsertConflicts 後續產生的推擠)
                // 把下一個行程往後推
                if (currEndMin > nextStartMin) {
                    const nextDuration = getDuration(next);
                    const newNextStart = currEndMin;
                    const newNextEnd = newNextStart + nextDuration;
                    next.time = `${minToTime(newNextStart)} ~ ${minToTime(newNextEnd)}`;
                }
            }
        }
        // --- 核心邏輯 C：緊湊排列 (拖曳排序專用) ---
        // 重新計算所有行程，讓它們像火車車廂一樣緊密相連，填補空隙
        function resequenceEvents(dayIdx) {
            const events = itineraryData[dayIdx].events;
            if (events.length === 0) return;

            // 1. 找出當天「最早」的開始時間作為起點 (錨點)
            let minStart = 24 * 60; 
            let hasValidTime = false;

            events.forEach(evt => {
                if (evt.time && evt.time.includes('~')) {
                    const start = timeToMin(evt.time.split('~')[0]);
                    if (start < minStart) {
                        minStart = start;
                        hasValidTime = true;
                    }
                }
            });

            // 如果都沒填時間，預設從 09:00 (540分) 開始
            if (!hasValidTime) minStart = 540; 

            // 2. 依照當前的新順序，重新串接時間
            let currentStart = minStart;

            events.forEach(evt => {
                // 取得該行程原本的持續時間 (Duration)
                const duration = getDuration(evt);
                
                // 計算新的結束時間
                const newEnd = currentStart + duration;

                // 更新時間字串
                evt.time = `${minToTime(currentStart)} ~ ${minToTime(newEnd)}`;

                // 下一個行程的開始 = 這個行程的結束
                currentStart = newEnd;
            });
        }
        // --- 刪除後的自動遞補 (吸附邏輯) ---
        function shiftEventsBack(dayIdx, startIndex, durationMinutes) {
            const events = itineraryData[dayIdx].events;
            
            // 從被刪除的位置開始，把後面所有的行程都往前移
            for (let i = startIndex; i < events.length; i++) {
                const evt = events[i];
                if (!evt.time) continue;

                const parts = evt.time.split('~');
                const startStr = parts[0].trim();
                const endStr = parts[1] ? parts[1].trim() : null;
                if (!startStr) continue;

                const currentStartMin = timeToMin(startStr);
                // 往前移動，但不能小於 0
                const newStartMin = Math.max(0, currentStartMin - durationMinutes);
                
                let newTimeStr = minToTime(newStartMin);

                if (endStr) {
                    const currentEndMin = timeToMin(endStr);
                    const newEndMin = Math.max(0, currentEndMin - durationMinutes);
                    newTimeStr += ` ~ ${minToTime(newEndMin)}`;
                }
                evt.time = newTimeStr;
            }
        }        
        // --- 儲存行程 (整合版) ---
        function saveEvent() {
            if (currentDayIdx === null) return;
            const start = document.getElementById('edit-start').value;
            const end = document.getElementById('edit-end').value;
            const title = document.getElementById('edit-title').value;

            if (!title) { showToast('請輸入標題', 'error'); return; }

            const originalEvt = (currentEvtIdx > -1) ? itineraryData[currentDayIdx].events[currentEvtIdx] : {};
            
            const newEvent = {
                time: (start && end) ? `${start} ~ ${end}` : (start || ''),
                title,
                type: document.getElementById('edit-type').value,
                note: document.getElementById('edit-note').value,
                station: document.getElementById('edit-station').value,
                tags: document.getElementById('edit-tags').value ? document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(s => s) : [],
                story: originalEvt.story || "",
                tips: originalEvt.tips || ""
            };

            let targetIdx = currentEvtIdx;

            // 判斷是新增還是編輯
            if (currentEvtIdx === -1) {
                itineraryData[currentDayIdx].events.push(newEvent);
                targetIdx = itineraryData[currentDayIdx].events.length - 1; // 取得新加入的索引
            } else {
                itineraryData[currentDayIdx].events[currentEvtIdx] = newEvent;
            }

            // ★ 步驟 1: 先執行「排斥邏輯」
            // 確保新行程(targetIdx)把重疊的舊行程踢開
            resolveInsertConflicts(currentDayIdx, targetIdx);

            // ★ 步驟 2: 再執行「全體排序與整理」
            // 確保被踢開的行程整齊排列
            autoAdjustSchedule(currentDayIdx);

            // 存檔與同步
            localStorage.setItem('hk_itinerary_v20', JSON.stringify(itineraryData));
            saveToCloud('hk_itinerary_v20', itineraryData);

            renderPlan();
            closeModal();
            showToast("行程已更新並自動調整", "success");
        }
    </script>   
    <!-- Service Worker Registration with Cache Busting -->
    <script>
        if ('serviceWorker' in navigator) {
            // 只在 http(s) 原始位置註冊 Service Worker，避免 file:// 拋錯
            if (location.protocol === 'http:' || location.protocol === 'https:') {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js?v=' + new Date().getTime())
                        .then((reg) => {
                            console.log('Service Worker 註冊成功:', reg);
                            reg.onupdatefound = () => {
                                const installingWorker = reg.installing;
                                installingWorker.onstatechange = () => {
                                    if (installingWorker.state === 'installed') {
                                        if (navigator.serviceWorker.controller) {
                                            console.log('新內容已下載，即將重新整理...');
                                            window.location.reload();
                                        }
                                    }
                                };
                            };
                        })
                        .catch((err) => console.log('Service Worker 註冊失敗:', err));
                });
            } else {
                console.log('跳過 Service Worker 註冊（非 http/https 協定）');
            }
        }
    </script>
</body>
</html>