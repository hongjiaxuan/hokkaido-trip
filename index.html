<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æµ·é“å†¬æ—… 2025</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#7d6c5e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2315/2315357.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#f9f9f9', card: '#ffffff', text: '#4a4a4a', subtext: '#8a8a8a',
                            accent: '#7d6c5e', highlight: '#a84a32', border: '#e5e5e5',
                            transport: '#eff6ff', transportText: '#3b82f6',
                            spot: '#f0fdf4', spotText: '#15803d',
                            food: '#fff7ed', foodText: '#c2410c',
                            shop: '#fdf2f8', shopText: '#be185d'
                        }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },
                    boxShadow: { 'soft': '0 4px 20px rgba(0, 0, 0, 0.05)', 'card': '0 1px 3px rgba(0,0,0,0.1)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f9f9f9; color: #4a4a4a; -webkit-tap-highlight-color: transparent; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-content { display: none; animation: fadeIn 0.25s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .timeline-line::before { content: ''; position: absolute; top: 16px; bottom: -16px; left: 18px; width: 2px; background: #e5e5e5; z-index: 0; }
        .timeline-line:last-child::before { display: none; }
        .tag-must-eat { background-color: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .tag-must-buy { background-color: #fce7f3; color: #be185d; border: 1px solid #fbcfe8; }
        .tag-reserve { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .tag-transport { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex justify-center overflow-hidden font-sans">

    <!-- App Container -->
    <div class="w-full max-w-md h-full bg-muji-bg flex flex-col relative shadow-2xl overflow-hidden mx-auto">
        
        <!-- Header -->
        <header class="bg-muji-card px-5 py-4 shadow-sm z-20 flex justify-between items-center shrink-0 border-b border-gray-100 select-none">
            <div>
                <h1 class="text-xl font-serif font-bold text-muji-accent tracking-widest">HOKKAIDO</h1>
                <p class="text-[10px] text-muji-subtext tracking-wider uppercase">Winter Trip 2025</p>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold bg-muji-accent text-white px-3 py-1 rounded-full shadow-sm flex items-center">
                    <i class="fas fa-snowflake mr-1.5 text-xs animate-pulse"></i> Day <span id="current-day-display" class="ml-1 text-sm">1</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto hide-scrollbar pb-24 p-4 scroll-smooth" id="main-container">
            <!-- SECTION: PLAN -->
            <section id="plan" class="tab-content active">
                <div class="bg-white p-4 rounded-xl shadow-card mb-4 border-l-4 border-blue-400">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-plane mr-2 text-blue-400"></i>èˆªç­è³‡è¨Š</h3>
                        <span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded">é•·æ¦®èˆªç©º</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-600">
                        <div>
                            <span class="block text-gray-400">å»ç¨‹ 12/18</span>
                            <span class="font-bold text-gray-800 text-sm">06:15 TPE</span> <i class="fas fa-long-arrow-alt-right text-gray-300 mx-1"></i> 11:00 CTS
                        </div>
                        <div>
                            <span class="block text-gray-400">å›ç¨‹ 12/23</span>
                            <span class="font-bold text-gray-800 text-sm">15:20 CTS</span> <i class="fas fa-long-arrow-alt-right text-gray-300 mx-1"></i> 19:05 TPE
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-card mb-6 border-l-4 border-indigo-400">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-gray-700 text-sm"><i class="fas fa-hotel mr-2 text-indigo-400"></i>ä½å®¿è³‡è¨Š</h3>
                        <a href="https://www.google.com/maps/search/?api=1&query=æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—" target="_blank" class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded hover:bg-indigo-100 transition">
                            <i class="fas fa-location-arrow mr-1"></i>å°èˆª
                        </a>
                    </div>
                    <div class="text-xs text-gray-600">
                        <h4 class="font-bold text-sm text-gray-800 mb-1">æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—</h4>
                        <p class="text-gray-400 font-mono leading-tight">3 Chome-1-25 Minami 8 Jonishi, Chuo Ward, Sapporo, Hokkaido 064-0808</p>
                    </div>
                </div>
                <div id="itinerary-list" class="space-y-8 pb-10"></div>
                <div class="text-center mt-8 pb-4">
                    <button onclick="resetItinerary()" class="text-xs text-gray-400 underline hover:text-red-400">æ¢å¾©é è¨­è¡Œç¨‹ (æ¸…é™¤ä¿®æ”¹)</button>
                </div>
            </section>

            <!-- SECTION: GUIDE -->
            <section id="guide" class="tab-content">
                <h2 class="text-xl font-serif text-muji-accent mb-4 pl-2 border-l-4 border-muji-accent">æ·±åº¦å°è¦½</h2>
                <h3 class="font-bold text-gray-700 mb-3 mt-6 flex items-center"><i class="fas fa-utensils text-orange-400 mr-2"></i>åŒ—æµ·é“å¿…åƒç¾é£Ÿ</h3>
                <div class="space-y-3">
                     <div class="bg-white p-3 rounded-lg shadow-sm border border-orange-100 flex gap-3">
                        <div class="w-16 h-16 bg-gray-200 rounded-md bg-cover bg-center shrink-0" style="background-image: url('https://images.unsplash.com/photo-1542384557-0824d90731ee?q=80&w=300&auto=format&fit=crop');"></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-800">æ¹¯å’–å“© (Soup Curry)</h4>
                            <p class="text-xs text-gray-500 mt-1">æºè‡ªæœ­å¹Œï¼Œé¦™æ–™è±å¯Œçš„æ¹¯åº•æ­é…å¤§é‡è”¬èœèˆ‡ç‚¸é›è…¿ã€‚æ¨è–¦ï¼šSuage+, Samurai, Picanteã€‚</p>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-orange-100 flex gap-3">
                        <div class="w-16 h-16 bg-gray-200 rounded-md bg-cover bg-center shrink-0" style="background-image: url('https://plus.unsplash.com/premium_photo-1661600135837-77569a9b7405?q=80&w=300&auto=format&fit=crop');"></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-800">æˆå‰æ€æ±—çƒ¤è‚‰</h4>
                            <p class="text-xs text-gray-500 mt-1">ä½¿ç”¨åœ“é ‚éµé‹ç‡’çƒ¤æ–°é®®ç¾Šè‚‰ï¼Œæ­é…ç‰¹è£½é†¬æ±ã€‚æ¨è–¦ï¼šé”æ‘©, ç‚­ç«å…œ, æœ­å¹Œå•¤é…’åœ’ã€‚</p>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-orange-100 flex gap-3">
                        <div class="w-16 h-16 bg-gray-200 rounded-md bg-cover bg-center shrink-0" style="background-image: url('https://images.unsplash.com/photo-1698822830847-f41851e5e227?q=80&w=300&auto=format&fit=crop');"></div>
                        <div>
                            <h4 class="text-sm font-bold text-gray-800">æµ·é®®ä¸¼ (Seafood Don)</h4>
                            <p class="text-xs text-gray-500 mt-1">é‹ªæ»¿æµ·è†½ã€é®­é­šåµã€å¹²è²çš„å¥¢è¯äº«å—ã€‚æ¨è–¦ï¼šä¸‰è§’å¸‚å ´, å ´å¤–å¸‚å ´ã€‚</p>
                        </div>
                    </div>
                </div>
                <h3 class="font-bold text-gray-700 mb-3 mt-8 flex items-center"><i class="fas fa-gift text-pink-400 mr-2"></i>äººæ°£ä¼´æ‰‹ç¦®</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-pink-50 text-center">
                        <div class="text-2xl mb-1">ğŸª</div>
                        <h4 class="text-xs font-bold text-gray-800">å…­èŠ±äº­</h4>
                        <p class="text-[10px] text-gray-500">å¥¶æ²¹å¤¾å¿ƒé¤…ä¹¾</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-pink-50 text-center">
                        <div class="text-2xl mb-1">ğŸ«</div>
                        <h4 class="text-xs font-bold text-gray-800">ROYCE'</h4>
                        <p class="text-[10px] text-gray-500">ç”Ÿå·§å…‹åŠ›</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-pink-50 text-center">
                        <div class="text-2xl mb-1">ğŸ¥”</div>
                        <h4 class="text-xs font-bold text-gray-800">Calbee</h4>
                        <p class="text-[10px] text-gray-500">è–¯æ¢ä¸‰å…„å¼Ÿ</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-pink-50 text-center">
                        <div class="text-2xl mb-1">ğŸ§€</div>
                        <h4 class="text-xs font-bold text-gray-800">LeTAO</h4>
                        <p class="text-[10px] text-gray-500">é›™å±¤èµ·å¸è›‹ç³•</p>
                    </div>
                </div>
                <h3 class="font-bold text-gray-700 mb-3 mt-8 flex items-center"><i class="fas fa-map-marked-alt text-green-500 mr-2"></i>æ™¯é»ä»‹ç´¹</h3>
                <div class="space-y-4">
                    <article class="bg-white rounded-xl overflow-hidden shadow-card">
                        <div class="h-32 bg-gray-200 relative">
                            <img src="https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 bg-gradient-to-t from-black/60 to-transparent w-full p-3">
                                <h3 class="text-white font-bold text-lg">æœ­å¹Œé›»è¦–å¡”</h3>
                            </div>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-gray-600 leading-relaxed text-justify">
                                ä½æ–¼å¤§é€šå…¬åœ’åŒ—ç«¯ï¼Œæ˜¯æœ­å¹Œçš„åœ°æ¨™ã€‚ç™»ä¸Š90å…¬å°ºé«˜çš„è§€æ™¯å°ï¼Œå¯ä»¥360åº¦çœºæœ›æœ­å¹Œå¸‚æ™¯ã€‚å†¬å­£é…åˆã€Œç™½è‰²ç‡ˆæ¨¹ç¯€ã€ï¼Œå¾å¡”ä¸Šä¿¯ç°çš„å¤œæ™¯å¦‚å¤¢ä¼¼å¹»ï¼Œæ˜¯æƒ…ä¾¶ç´„æœƒè–åœ°ã€‚
                            </p>
                        </div>
                    </article>
                    <article class="bg-white rounded-xl overflow-hidden shadow-card">
                        <div class="h-32 bg-gray-200 relative">
                            <img src="https://images.unsplash.com/photo-1549179928-8b3503257d07?q=80&w=800&auto=format&fit=crop" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 bg-gradient-to-t from-black/60 to-transparent w-full p-3">
                                <h3 class="text-white font-bold text-lg">å°æ¨½é‹æ²³</h3>
                            </div>
                        </div>
                        <div class="p-4">
                            <p class="text-sm text-gray-600 leading-relaxed text-justify">
                                å¤§æ­£æ™‚ä»£åŒ—æµ·é“é‡‘èä¸­å¿ƒç¹æ¦®çš„è±¡å¾µã€‚é‹æ²³æ²¿å²¸çš„ç´…ç£šå€‰åº«ç¾¤ä¿ç•™äº†ç•¶å¹´çš„é¢¨è²Œï¼Œç¾å·²æ”¹å»ºç‚ºé¤å»³èˆ‡å·¥è—å“åº—ã€‚é»ƒæ˜æ™‚åˆ†ç…¤æ°£ç‡ˆäº®èµ·ï¼Œé‹æ²³æ°´é¢æ³¢å…‰ç²¼ç²¼ï¼Œæ¥µå…·æ‡·èˆŠé¢¨æƒ…ã€‚
                            </p>
                        </div>
                    </article>
                </div>
            </section>

            <!-- SECTION: WALLET -->
            <section id="wallet" class="tab-content">
                <div class="bg-gradient-to-br from-stone-600 to-stone-700 text-white p-5 rounded-2xl shadow-lg mb-6 sticky top-0 z-30">
                    <div class="flex justify-between items-center mb-4 opacity-80">
                        <h3 class="text-xs uppercase tracking-widest">Currency Converter</h3>
                        <div class="text-[10px] bg-white/20 px-2 py-0.5 rounded">åŒ¯ç‡: <input type="number" id="exchange-rate" value="0.225" class="w-10 bg-transparent text-center focus:outline-none" step="0.001"></div>
                    </div>
                    <div class="flex flex-col items-end mb-2">
                        <input type="text" id="jpy-input" placeholder="0" class="w-full bg-transparent text-right text-3xl font-mono font-bold focus:outline-none placeholder-white/30">
                        <span class="text-xs opacity-60">JPY (è¼¸å…¥ç®—å¼å¦‚ 500+200*2)</span>
                    </div>
                    <div class="h-px w-full bg-white/20 my-2"></div>
                    <div class="flex flex-col items-end">
                        <div id="twd-output" class="text-4xl font-mono font-bold text-yellow-300">0</div>
                        <span class="text-xs opacity-60">TWD (Approx.)</span>
                    </div>
                    <button onclick="calculateRate()" class="absolute bottom-4 left-5 bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition"><i class="fas fa-equals text-sm"></i></button>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-card mb-6">
                    <h3 class="font-bold text-gray-700 mb-3 text-sm">æ–°å¢è¨˜å¸³</h3>
                    <div class="flex gap-2 mb-3">
                        <select id="expense-payer" class="w-24 px-2 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent">
                            <option value="å°æˆ´">å°æˆ´</option>
                            <option value="ä½³æ¬£">ä½³æ¬£</option>
                            <option value="ä½³è±">ä½³è±</option>
                            <option value="çŸå»·">çŸå»·</option>
                        </select>
                        <input type="text" id="expense-item" placeholder="å“é …åç¨±" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent">
                    </div>
                    <div class="flex gap-2 mb-3">
                        <input type="number" id="expense-price" placeholder="é‡‘é¡ (æ—¥å¹£)" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-muji-accent">
                    </div>
                    <div class="flex gap-2">
                         <label class="flex-1 flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-pointer hover:bg-gray-200 transition text-sm">
                            <i class="fas fa-camera mr-2"></i> <span id="photo-label">æ‹ç…§/ä¸Šå‚³</span>
                            <input type="file" id="expense-photo" accept="image/*" class="hidden" onchange="document.getElementById('photo-label').innerText = 'å·²é¸æ“‡'">
                        </label>
                        <button onclick="addExpense()" class="flex-1 bg-muji-accent text-white py-2 rounded-lg shadow-sm hover:opacity-90 transition text-sm font-medium">
                            <i class="fas fa-plus mr-1"></i> å„²å­˜
                        </button>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="font-bold text-gray-600 text-sm">æ”¯å‡ºç´€éŒ„</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="openSplitBillModal()" class="text-xs bg-white text-muji-accent border border-muji-accent px-2 py-1 rounded hover:bg-muji-accent hover:text-white transition">
                            <i class="fas fa-calculator mr-1"></i>æŸ¥çœ‹åˆ†å¸³
                        </button>
                        <span id="total-expense" class="text-xs font-mono font-bold text-muji-accent">Total: Â¥0</span>
                    </div>
                </div>
                <div class="space-y-3 pb-8" id="expense-list"></div>
                <div class="text-center">
                     <button onclick="clearExpenses()" class="text-xs text-red-300 underline py-2">æ¸…é™¤è³‡æ–™</button>
                </div>
            </section>

            <!-- SECTION: LISTS -->
            <section id="lists" class="tab-content">
                <div class="flex bg-gray-200 p-1 rounded-xl mb-4">
                    <button class="flex-1 py-2 text-sm rounded-lg transition-all font-bold bg-white shadow-sm text-gray-800" id="btn-checklist" onclick="toggleListTab('checklist')">è¡Œå‰æ¸…å–®</button>
                    <button class="flex-1 py-2 text-sm rounded-lg transition-all font-medium text-gray-500 hover:text-gray-700" id="btn-memo" onclick="toggleListTab('memo')">å‚™å¿˜éŒ„</button>
                </div>
                <div id="view-checklist">
                     <div class="bg-white rounded-xl shadow-card overflow-hidden">
                        <div class="p-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                            <span class="text-xs font-bold text-gray-500">å®Œæˆåº¦</span>
                            <div class="flex items-center gap-2">
                                <div class="w-24 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div id="progress-bar" class="h-full bg-green-500 w-0 transition-all duration-500"></div>
                                </div>
                                <span id="progress-text" class="text-xs font-mono text-gray-600">0%</span>
                            </div>
                        </div>
                        <div class="p-2 border-b border-gray-100 flex gap-2">
                            <input type="text" id="new-check-item" placeholder="æ–°å¢é …ç›®..." class="flex-1 text-sm px-2 py-1 bg-transparent focus:outline-none">
                            <button onclick="addCheckItem()" class="text-muji-accent px-2"><i class="fas fa-plus-circle"></i></button>
                        </div>
                        <div id="checklist-container" class="divide-y divide-gray-100 max-h-[60vh] overflow-y-auto"></div>
                    </div>
                </div>
                <div id="view-memo" class="hidden h-full flex flex-col">
                    <div class="bg-white p-4 rounded-xl shadow-card flex-1 flex flex-col min-h-[50vh]">
                        <textarea id="memo-area" class="flex-1 w-full bg-transparent resize-none focus:outline-none text-sm leading-relaxed text-gray-600 placeholder-gray-300" placeholder="éš¨æ‰‹è¨˜ä¸‹ç­†è¨˜ã€ç¶²å€... (ç¶²å€æœƒè‡ªå‹•ç”Ÿæˆä¸‹æ–¹é€£çµ)"></textarea>
                        <div class="text-right mt-2 pt-2 border-t border-gray-100">
                            <button onclick="saveMemo()" class="bg-muji-accent text-white px-4 py-1.5 rounded-lg text-xs shadow-sm">å„²å­˜</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-xs font-bold text-gray-400 mb-2 pl-1">é€£çµé è¦½</h4>
                        <div id="memo-links" class="space-y-2"></div>
                    </div>
                </div>
            </section>

            <!-- SECTION: INFO -->
            <section id="info" class="tab-content">
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <a href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="bg-blue-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition">
                        <i class="fas fa-cloud-sun text-3xl text-blue-400"></i>
                        <span class="text-sm font-bold text-gray-600">å¤©æ°£é å ±</span>
                    </a>
                    <a href="tel:119" class="bg-red-50 p-4 rounded-xl flex flex-col items-center justify-center gap-2 shadow-sm hover:shadow-md transition">
                        <i class="fas fa-ambulance text-3xl text-red-400"></i>
                        <span class="text-sm font-bold text-gray-600">ç·Šæ€¥ 119</span>
                    </a>
                </div>
                <div class="bg-white rounded-xl shadow-card overflow-hidden mb-4">
                    <div class="bg-orange-50 px-4 py-3 border-b border-orange-100">
                        <h3 class="font-bold text-orange-800 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>é‡è¦æé†’</h3>
                    </div>
                    <div class="p-4 text-sm text-gray-600 space-y-3">
                         <p><span class="font-bold text-gray-800">é›»å£“:</span> 100V é›™å¹³è…³æ’åº§ (èˆ‡å°ç£åŒ)ã€‚</p>
                         <p><span class="font-bold text-gray-800">ç©¿è‘—:</span> å®¤å…§æš–æ°£å¼·ï¼Œè«‹æ¡æ´‹è”¥å¼ç©¿æ­ã€‚å¿…å‚™é˜²æ»‘é‹/å†°çˆªã€‚</p>
                         <p><span class="font-bold text-gray-800">ç¦å¿Œ:</span> åš´ç¦æ”œå¸¶è‚‰è£½å“å…¥å¢ƒã€‚åƒåœ¾éœ€åˆ†é¡æˆ–å¸¶å›é£¯åº—ã€‚</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Navbar -->
        <nav class="bg-white border-t border-gray-100 flex justify-around items-center py-2 px-1 shadow-[0_-5px_15px_rgba(0,0,0,0.02)] z-30 shrink-0 h-[70px] select-none pb-safe">
            <button class="nav-btn active group w-1/5" data-target="plan">
                <div class="flex flex-col items-center gap-1 transition-all">
                    <div class="w-10 h-8 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10">
                        <i class="fas fa-map-marked-alt text-lg text-gray-400 group-[.active]:text-muji-accent transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-medium text-gray-400 group-[.active]:text-muji-accent">è¡Œç¨‹</span>
                </div>
            </button>
            <button class="nav-btn group w-1/5" data-target="guide">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-10 h-8 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10">
                        <i class="fas fa-book-reader text-lg text-gray-400 group-[.active]:text-muji-accent transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-medium text-gray-400 group-[.active]:text-muji-accent">å°è¦½</span>
                </div>
            </button>
            <button class="nav-btn group w-1/5" data-target="wallet">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-10 h-8 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10">
                        <i class="fas fa-wallet text-lg text-gray-400 group-[.active]:text-muji-accent transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-medium text-gray-400 group-[.active]:text-muji-accent">éŒ¢åŒ…</span>
                </div>
            </button>
            <button class="nav-btn group w-1/5" data-target="lists">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-10 h-8 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10">
                        <i class="fas fa-check-square text-lg text-gray-400 group-[.active]:text-muji-accent transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-medium text-gray-400 group-[.active]:text-muji-accent">æ¸…å–®</span>
                </div>
            </button>
            <button class="nav-btn group w-1/5" data-target="info">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-10 h-8 rounded-xl flex items-center justify-center group-[.active]:bg-muji-accent/10">
                        <i class="fas fa-info-circle text-lg text-gray-400 group-[.active]:text-muji-accent transition-colors"></i>
                    </div>
                    <span class="text-[10px] font-medium text-gray-400 group-[.active]:text-muji-accent">è³‡è¨Š</span>
                </div>
            </button>
        </nav>

        <!-- ITINERARY EDIT MODAL -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold text-gray-700" id="modal-title">ç·¨è¼¯è¡Œç¨‹</h3>
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="edit-start" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">çµæŸæ™‚é–“</label>
                            <input type="time" id="edit-end" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é¡å‹</label>
                        <select id="edit-type" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                            <option value="spot">æ™¯é» (ç¶ )</option>
                            <option value="food">ç¾é£Ÿ (æ©˜)</option>
                            <option value="shop">è³¼ç‰© (ç²‰)</option>
                            <option value="transport">äº¤é€š (è—)</option>
                            <option value="stay">ä½å®¿ (ç´«)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ¨™é¡Œ</label>
                        <input type="text" id="edit-title" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none" placeholder="è¡Œç¨‹åç¨±">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å‚™è¨»</label>
                        <textarea id="edit-note" rows="2" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none resize-none" placeholder="ç´°ç¯€èªªæ˜..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æœ€è¿‘è»Šç«™ (é¸å¡«)</label>
                        <input type="text" id="edit-station" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none" placeholder="ä¾‹å¦‚: å¤§é€šç«™">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ¨™ç±¤ (é€—è™Ÿåˆ†éš”)</label>
                        <input type="text" id="edit-tags" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none" placeholder="å¿…åƒ, é ç´„, æ‹ç…§ç†±é»">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3">
                    <button type="button" onclick="deleteEvent()" id="btn-delete" class="px-4 py-2 bg-red-50 text-red-500 rounded text-sm font-bold hover:bg-red-100 hidden">åˆªé™¤</button>
                    <button type="button" onclick="saveEvent()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold hover:opacity-90 shadow-sm">å„²å­˜</button>
                </div>
            </div>
        </div>

        <!-- EXPENSE EDIT MODAL -->
        <div id="expense-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold text-gray-700">ç·¨è¼¯æ”¯å‡º</h3>
                    <button type="button" onclick="closeExpenseEditModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <div class="flex gap-2">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾äºº</label>
                            <select id="edit-expense-payer" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                                <option value="å°æˆ´">å°æˆ´</option>
                                <option value="ä½³æ¬£">ä½³æ¬£</option>
                                <option value="ä½³è±">ä½³è±</option>
                                <option value="çŸå»·">çŸå»·</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">å“é …</label>
                            <input type="text" id="edit-expense-item" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é‡‘é¡ (æ—¥å¹£)</label>
                        <input type="number" id="edit-expense-price" class="w-full p-2 border border-gray-200 rounded text-sm bg-gray-50 focus:border-muji-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ç…§ç‰‡ (é¸å¡«)</label>
                        <input type="file" id="edit-expense-photo" accept="image/*" class="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-100 file:text-gray-600 hover:file:bg-gray-200">
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100 flex gap-3">
                    <button type="button" onclick="saveExpenseEdit()" class="flex-1 px-4 py-2 bg-muji-accent text-white rounded text-sm font-bold hover:opacity-90 shadow-sm">å„²å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>

        <!-- SPLIT BILL MODAL -->
        <div id="split-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden opacity-0 transition-opacity flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-200">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                    <h3 class="font-bold text-gray-700"><i class="fas fa-calculator mr-2 text-muji-accent"></i>åˆ†å¸³çµæœ</h3>
                    <button type="button" onclick="closeSplitBillModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-5">
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å„äººä»£å¢Šç¸½é¡</h4>
                        <div id="split-summary" class="space-y-2 text-sm"></div>
                        <div class="mt-3 pt-2 border-t border-gray-100 text-right">
                            <span class="text-xs text-gray-400 mr-2">å¹³å‡æ¯äººæ‡‰ä»˜:</span>
                            <span id="split-average" class="font-bold text-muji-text"></span>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-500 mb-3 border-b pb-1">å»ºè­°çµç®—æ–¹å¼</h4>
                        <div id="split-plan" class="space-y-2"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 text-center rounded-b-xl">
                    <p class="text-[10px] text-gray-400">â€» é‡‘é¡å·²ä¾åŒ¯ç‡æ›ç®—ç‚ºç´„ç•¥å°å¹£</p>
                </div>
            </div>
        </div>

        <!-- CONFIRM MODAL -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-5 text-center">
                <h3 class="font-bold text-gray-700 text-lg mb-2">ç¢ºèªåˆªé™¤</h3>
                <p class="text-sm text-gray-500 mb-6">æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ<br>æ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3 justify-center">
                    <button type="button" onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-gray-500 hover:bg-gray-50">å–æ¶ˆ</button>
                    <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 shadow-sm">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ... (Please retain all JavaScript logic from hokkaido_trip_v4.html, no changes needed for JS) ...
        // Note: For brevity, I'm pasting the JS block below.
        
        let itineraryData = [];
        let currentDayIdx = null;
        let currentEvtIdx = null;
        let currentExpenseId = null;
        let deleteTarget = null;
        let deleteExpenseId = null;

        const defaultItinerary = [
            {
                date: "12/18 (å››)",
                day: 1,
                weather: { icon: 'fa-cloud', temp: '-1Â°C', desc: 'å¤šé›²' },
                events: [
                    { time: "06:15 ~ 11:00", title: "TPE æ¡ƒåœ’æ©Ÿå ´ T2", type: "transport", note: "é•·æ¦® BR166 (é£›è¡Œ 03:45)", tags: ["èˆªç­"] },
                    { time: "11:00 ~ 12:00", title: "CTS æ–°åƒæ­²æ©Ÿå ´", type: "transport", note: "å…¥å¢ƒã€é ˜è¡Œæã€è³¼è²·ç¥¨åˆ¸", station: "æ–°åƒæ­²ç©ºæ¸¯ç«™" },
                    { time: "13:11 ~ 14:11", title: "æœ­å¹Œä¸­å³¶å…¬åœ’æ—¥èˆªéƒ½å¸‚é…’åº—", type: "stay", note: "Check-in / å¯„æ”¾è¡Œæ", station: "ä¸­å³¶å…¬åœ’ç«™" },
                    { time: "15:00 ~ 18:00", title: "å¤§é€šå…¬åœ’ & ç´…ç£šå»³èˆ", type: "spot", note: "å¸‚å€æ•£æ­¥æ‹ç…§", station: "å¤§é€šç«™" },
                    { time: "18:32 ~ 19:30", title: "Gyoza no Ohsho", type: "food", note: "æ™šé¤ï¼šé¤ƒå­", tags: ["æ™šé¤"] },
                    { time: "19:34 ~ 20:34", title: "Matcha Cafe & Sweets RIQ", type: "food", note: "æŠ¹èŒ¶ç”œé»", tags: ["å¿…åƒç”œé»"] },
                    { time: "20:35 ~ 22:35", title: "ç‹¸å°è·¯å•†åº—è¡—", type: "shop", note: "è—¥å¦ã€ä¼´æ‰‹ç¦®æ¡è²·", station: "ç‹¸å°è·¯ç«™", tags: ["é€›è¡—"] },
                    { time: "22:35 ~ 23:00", title: "è¿”å›é£¯åº—", type: "transport", note: "æ­ä¹˜åœ°éµå—åŒ—ç·šæˆ–è¨ˆç¨‹è»Š", station: "ä¸­å³¶å…¬åœ’ç«™" }
                ]
            },
            {
                date: "12/19 (äº”)",
                day: 2,
                weather: { icon: 'fa-snowflake', temp: '-4Â°C', desc: 'å°é›ª' },
                events: [
                    { time: "08:00 ~ 17:30", title: "æœ­å¹Œæ‰‹ç¨»æ»‘é›ªå ´", type: "spot", note: "æ»‘é›ªé«”é©— (å«å°ˆè»Šæ¥é€)", tags: ["é‡é»è¡Œç¨‹"] },
                    { time: "17:30 ~ 18:00", title: "å›é£¯åº—æ¢³æ´—", type: "stay", note: "ä¼‘æ¯æ›è£" },
                    { time: "18:16 ~ 19:16", title: "Suage+ Soup Curry", type: "food", note: "åŒ—æµ·é“å¿…åƒæ¹¯å’–å“©", station: "è–„é‡ç«™", tags: ["å¿…é»:è„†çš®çŸ¥åºŠé›", "æ’éšŠååº—"] },
                    { time: "19:29 ~ 20:29", title: "3COINS OOOPS!", type: "shop", note: "å¹³åƒ¹é›œè²¨å¥½ç‰©", station: "å¤§é€šç«™" },
                    { time: "20:29 ~ 22:00", title: "æœ­å¹Œé›»è¦–å¡” & é˜æ¨“", type: "spot", note: "å¤œæ™¯èˆ‡æ‰“å¡", station: "å¤§é€šç«™", tags: ["å¤œæ™¯"] },
                    { time: "22:00 ~ 22:30", title: "è¿”å›é£¯åº—", type: "transport", note: "è¨ˆç¨‹è»Šæˆ–åœ°éµ" }
                ]
            },
            {
                date: "12/20 (å…­)",
                day: 3,
                weather: { icon: 'fa-sun', temp: '-2Â°C', desc: 'æ™´æ™‚å¤šé›²' },
                events: [
                    { time: "07:40 ~ 08:42", title: "å‡ºç™¼å‰å¾€ä¼è¦‹ç¨»è·ç¥ç¤¾", type: "transport", note: "æ‹æ”åƒæœ¬é³¥å±…", station: "è¥¿ç·š14æ¢" },
                    { time: "10:00 ~ 10:40", title: "å‰å¾€ç¾æœˆæ«»", type: "transport", note: "é è¨ˆ 10:40 å‰æŠµé”" },
                    { time: "10:40 ~ 11:40", title: "ç¾æœˆæ«»å’Œæœ", type: "spot", note: "å’Œæœé«”é©— (è‘—è£)", station: "åœ“å±±å…¬åœ’ç«™", tags: ["é ç´„è¡Œç¨‹"] },
                    { time: "11:40 ~ 13:00", title: "åŒ—æµ·é“ç¥å®® & åœ“å±±å…¬åœ’", type: "spot", note: "åƒæ‹œã€é›ªåœ°æ‹ç…§", station: "åœ“å±±å…¬åœ’ç«™" },
                    { time: "13:00 ~ 14:00", title: "ç¥å®®èŒ¶å±‹ & å…­èŠ±äº­", type: "food", note: "ä¼‘æ¯åƒé»å¿ƒ", tags: ["å¿…åƒ:åˆ¤å®˜é¤…"] },
                    { time: "16:00 ~ 16:47", title: "æ­¸é‚„å’Œæœ", type: "spot", note: "è¿”å›ç¾æœˆæ«»" },
                    { time: "18:15 ~ 20:00", title: "ç‚­ç«å…œ æˆå‰æ€æ±—ç¾Šè‚‰", type: "food", note: "åŒ—æµ·é“ç‰¹è‰²çƒ¤è‚‰", tags: ["é ç´„ 18:30", "å¿…åƒ"] },
                    { time: "20:00 ~ 21:00", title: "COCONO SUSUKINO", type: "shop", note: "æ–°åœ°æ¨™é€›è¡—", station: "è–„é‡ç«™" },
                    { time: "21:00 ~ 21:30", title: "è¿”å›é£¯åº—", type: "stay", note: "ä¼‘æ¯", station: "ä¸­å³¶å…¬åœ’ç«™" }
                ]
            },
            {
                date: "12/21 (æ—¥)",
                day: 4,
                weather: { icon: 'fa-snowflake', temp: '-5Â°C', desc: 'å¤§é›ª' },
                events: [
                    { time: "08:30 ~ 08:43", title: "å‰å¾€æœ­å¹Œç«™", type: "transport", note: "æº–å‚™æ­ä¹˜JR" },
                    { time: "08:43 ~ 09:18", title: "JR å¿«é€Ÿ Airport", type: "transport", note: "æœ­å¹Œç™¼ -> å°æ¨½è‘—", tags: ["JRç­æ¬¡å»ºè­°"] },
                    { time: "09:34 ~ 10:00", title: "ä¸­å¤®å·´å£« (ç¥æ´¥ç·š)", type: "transport", note: "å°æ¨½ç«™å‰å·´å£«ç«™ -> æ°´æ—é¤¨", tags: ["å·´å£«ç­æ¬¡"] },
                    { time: "10:00 ~ 12:40", title: "å°æ¨½æ°´æ—é¤¨", type: "spot", note: "ä¼éµæ•£æ­¥", tags: ["è¦ªå­æ¨è–¦"] },
                    { time: "12:40 ~ 13:10", title: "æ­å·´å£«å›å°æ¨½ç«™", type: "transport", note: "å‰å¾€ä¸‰è§’å¸‚å ´/é‹æ²³å€" },
                    { time: "13:30 ~ 15:30", title: "å°æ¨½å ºç”ºé€šå•†åº—è¡—", type: "shop", note: "éŸ³æ¨‚ç›’å ‚ã€LeTAOã€åŒ—è“æ¨“", tags: ["å¿…è²·ä¼´æ‰‹ç¦®"] },
                    { time: "15:30 ~ 17:30", title: "å…­èŠ±äº­ & åŒ—ä¸€ç¡å­", type: "shop", note: "ç»ç’ƒå·¥è—èˆ‡ç”œé»", tags: ["å¿…åƒ:å¥¶æ²¹å¤¾å¿ƒé¤…"] },
                    { time: "17:30 ~ 19:00", title: "å°æ¨½é‹æ²³", type: "spot", note: "æ¬£è³é‹æ²³å¤œæ™¯", station: "å°æ¨½ç«™", tags: ["æ‹ç…§ç†±é»"] },
                    { time: "21:30 ~ 22:15", title: "JR å¿«é€Ÿ Airport (å›ç¨‹)", type: "transport", note: "å°æ¨½ç™¼ -> æœ­å¹Œè‘—", tags: ["æœ«ç­è»Šæ³¨æ„"] },
                    { time: "22:15 ~ 22:45", title: "è¿”å›é£¯åº—", type: "stay", note: "ä¼‘æ¯" }
                ]
            },
            {
                date: "12/22 (ä¸€)",
                day: 5,
                weather: { icon: 'fa-cloud', temp: '-2Â°C', desc: 'é™°' },
                events: [
                    { time: "09:00 ~ 10:00", title: "å ´å¤–å¸‚å ´", type: "food", note: "æµ·é®®ä¸¼æ—©é¤", station: "äºŒåå››è»’ç«™", tags: ["å¿…åƒæµ·é®®"] },
                    { time: "10:54 ~ 11:54", title: "åŒ—æµ·é“å¤§å­¸", type: "spot", note: "éŠ€æå¤§é“(é›–å·²è½è‘‰ä½†æ ¡åœ’å¾ˆç¾)", station: "åŒ—12æ¢ç«™" },
                    { time: "12:17 ~ 13:17", title: "è«è¨ªç¥ç¤¾", type: "spot", note: "ç‰¹è‰²èŠ±æ‰‹æ°´", station: "åŒ—13æ¢æ±ç«™" },
                    { time: "13:40 ~ 14:40", title: "æœ­å¹Œå•¤é…’åšç‰©é¤¨", type: "spot", note: "ç´…ç£šå»ºç¯‰æ‹ç…§", tags: ["æ­·å²"] },
                    { time: "14:58 ~ 16:00", title: "æœ­å¹Œ Stellar Place", type: "shop", note: "è»Šç«™å…±æ§‹å•†å ´é€›è¡—", station: "æœ­å¹Œç«™" },
                    { time: "16:03 ~ 17:03", title: "ä¸²é³¥ æœ­å¹Œé§…å‰åº—", type: "food", note: "å¹³åƒ¹ç¾å‘³ä¸²ç‡’", tags: ["å¿…åƒä¸²ç‡’"] },
                    { time: "17:05 ~ 19:00", title: "BIC CAMERA & ç‹¸å°è·¯", type: "shop", note: "è£œé½Šé›»å™¨è—¥å¦", station: "æœ­å¹Œç«™/ç‹¸å°è·¯" },
                    { time: "19:00 ~ 19:30", title: "è¿”å›é£¯åº—", type: "stay", note: "ä¼‘æ¯", station: "ä¸­å³¶å…¬åœ’ç«™" }
                ]
            },
            {
                date: "12/23 (äºŒ)",
                day: 6,
                weather: { icon: 'fa-plane', temp: '0Â°C', desc: 'è¿”ç¨‹' },
                events: [
                    { time: "08:00 ~ 11:00", title: "Check-out & ç§»å‹•", type: "stay", note: "å‰å¾€æ©Ÿå ´" },
                    { time: "11:00 ~ 15:00", title: "æ–°åƒæ­²æ©Ÿå ´", type: "shop", note: "æœ€å¾Œæ¡è²·ã€å“†å•¦Aå¤¢ç©ºä¸­æ¨‚åœ’" },
                    { time: "15:20 ~ 19:05", title: "BR115 è¿”å°", type: "transport", note: "CTS -> TPE" }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            initItinerary();
            initChecklist();
            initWallet();
            initMemo();
            setupNav();
        });

        function initItinerary() {
            const stored = localStorage.getItem('hk_itinerary_v3');
            if (stored) {
                itineraryData = JSON.parse(stored);
            } else {
                itineraryData = JSON.parse(JSON.stringify(defaultItinerary));
            }
            renderPlan();
        }

        function resetItinerary() {
            deleteTarget = 'itinerary-reset';
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function setupNav() {
            const btns = document.querySelectorAll('.nav-btn');
            const sections = document.querySelectorAll('.tab-content');
            btns.forEach(btn => {
                btn.addEventListener('click', () => {
                    btns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    sections.forEach(s => {
                        s.classList.remove('active');
                        if(s.id === btn.dataset.target) s.classList.add('active');
                    });
                    if(btn.dataset.target === 'lists') updateChecklistProgress();
                });
            });
        }

        function renderPlan() {
            const container = document.getElementById('itinerary-list');
            let html = '';
            itineraryData.forEach((day, dayIdx) => {
                let eventsHtml = '';
                day.events.forEach((evt, evtIdx) => {
                    let bgClass = 'bg-white border-l-4 border-gray-200';
                    let iconClass = 'text-gray-400 fa-map-marker-alt';
                    let titleClass = 'text-muji-text';
                    if (evt.type === 'transport') { bgClass = 'bg-muji-transport border-l-4 border-blue-400'; iconClass = 'text-blue-500 fa-train'; }
                    else if (evt.type === 'food') { bgClass = 'bg-muji-food border-l-4 border-orange-400'; iconClass = 'text-orange-500 fa-utensils'; }
                    else if (evt.type === 'shop') { bgClass = 'bg-muji-shop border-l-4 border-pink-400'; iconClass = 'text-pink-500 fa-shopping-bag'; }
                    else if (evt.type === 'spot') { bgClass = 'bg-muji-spot border-l-4 border-green-500'; iconClass = 'text-green-600 fa-camera'; }
                    else if (evt.type === 'stay') { iconClass = 'text-indigo-400 fa-bed'; }

                    let tagsHtml = '';
                    if (evt.tags) {
                        evt.tags.forEach(tag => {
                            let tagStyle = 'bg-gray-100 text-gray-500';
                            if (tag.includes('å¿…åƒ')) tagStyle = 'tag-must-eat';
                            else if (tag.includes('å¿…è²·')) tagStyle = 'tag-must-buy';
                            else if (tag.includes('é ç´„')) tagStyle = 'tag-reserve';
                            else if (tag.includes('è»Š') || tag.includes('JR')) tagStyle = 'tag-transport';
                            tagsHtml += `<span class="text-[10px] px-1.5 py-0.5 rounded mr-1 mb-1 inline-block ${tagStyle}">${tag}</span>`;
                        });
                    }

                    eventsHtml += `
                        <div class="relative pl-8 pb-6 timeline-line group">
                            <div class="absolute left-0 top-4 w-8 text-center z-10">
                                <div class="w-8 h-8 rounded-full bg-white border border-gray-100 shadow-sm flex items-center justify-center">
                                    <i class="fas ${iconClass} text-xs"></i>
                                </div>
                            </div>
                            <div class="${bgClass} p-3 rounded-lg shadow-card relative cursor-pointer hover:shadow-md transition-shadow" onclick="openModal(${dayIdx}, ${evtIdx})">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-mono text-sm font-bold text-gray-500">${evt.time}</span>
                                    <div class="flex gap-2">
                                        <button class="text-xs text-gray-300 hover:text-gray-500 p-1"><i class="fas fa-pen"></i></button>
                                        ${evt.title.includes('é£¯åº—') || evt.type === 'transport' ? '' : `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(evt.title + ' åŒ—æµ·é“')}" target="_blank" onclick="event.stopPropagation()" class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded hover:bg-gray-100 hover:text-blue-500 transition"><i class="fas fa-map-marked-alt mr-1"></i>åœ°åœ–</a>`}
                                    </div>
                                </div>
                                <h4 class="text-base font-bold ${titleClass} mb-1 leading-tight">${evt.title}</h4>
                                ${evt.station ? `<div class="text-xs text-muji-subtext mb-1"><i class="fas fa-subway mr-1 text-gray-300"></i>${evt.station}</div>` : ''}
                                ${evt.note ? `<p class="text-xs text-gray-500 mb-2 leading-relaxed">${evt.note}</p>` : ''}
                                <div class="flex flex-wrap">${tagsHtml}</div>
                            </div>
                        </div>
                    `;
                });
                html += `
                    <div class="mb-4">
                        <div class="sticky top-0 bg-gray-100/95 backdrop-blur pt-2 pb-3 z-10 mb-2 flex justify-between items-end border-b border-gray-200">
                            <div><h2 class="text-xl font-serif font-bold text-muji-accent">Day ${day.day}</h2><span class="text-xs text-gray-500 font-mono">${day.date}</span></div>
                            <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm text-xs text-gray-600"><i class="fas ${day.weather.icon} text-blue-400"></i><span class="font-bold">${day.weather.temp}</span><span class="text-[10px] text-gray-400">${day.weather.desc}</span></div>
                        </div>
                        <div class="pt-2">${eventsHtml}</div>
                        <button onclick="openModal(${dayIdx}, -1)" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 text-sm font-bold hover:border-muji-accent hover:text-muji-accent transition"><i class="fas fa-plus mr-1"></i> æ–°å¢è¡Œç¨‹</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function openModal(dayIdx, evtIdx) {
            currentDayIdx = dayIdx; currentEvtIdx = evtIdx;
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const btnDelete = document.getElementById('btn-delete');
            if (evtIdx === -1) {
                title.innerText = "æ–°å¢è¡Œç¨‹"; btnDelete.classList.add('hidden');
                document.getElementById('edit-start').value = ""; document.getElementById('edit-end').value = "";
                document.getElementById('edit-title').value = ""; document.getElementById('edit-type').value = "spot";
                document.getElementById('edit-note').value = ""; document.getElementById('edit-station').value = ""; document.getElementById('edit-tags').value = "";
            } else {
                const evt = itineraryData[dayIdx].events[evtIdx];
                title.innerText = "ç·¨è¼¯è¡Œç¨‹"; btnDelete.classList.remove('hidden');
                const times = evt.time ? evt.time.split(' ~ ') : ['',''];
                document.getElementById('edit-start').value = times[0] || ''; document.getElementById('edit-end').value = times[1] || '';
                document.getElementById('edit-title').value = evt.title; document.getElementById('edit-type').value = evt.type || 'spot';
                document.getElementById('edit-note').value = evt.note || ''; document.getElementById('edit-station').value = evt.station || '';
                document.getElementById('edit-tags').value = evt.tags ? evt.tags.join(', ') : '';
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
            document.body.classList.add('modal-active');
        }

        function closeModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); currentDayIdx = null; currentEvtIdx = null; }, 250);
        }

        function saveEvent() {
            if (currentDayIdx === null) return;
            const start = document.getElementById('edit-start').value;
            const end = document.getElementById('edit-end').value;
            const title = document.getElementById('edit-title').value;
            if (!title) { alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
            const newEvent = {
                time: (start && end) ? `${start} ~ ${end}` : (start || ''),
                title, type: document.getElementById('edit-type').value, note: document.getElementById('edit-note').value,
                station: document.getElementById('edit-station').value, tags: document.getElementById('edit-tags').value ? document.getElementById('edit-tags').value.split(',').map(s => s.trim()).filter(s => s) : []
            };
            if (currentEvtIdx === -1) { itineraryData[currentDayIdx].events.push(newEvent); itineraryData[currentDayIdx].events.sort((a, b) => a.time.localeCompare(b.time)); }
            else { itineraryData[currentDayIdx].events[currentEvtIdx] = newEvent; }
            localStorage.setItem('hk_itinerary_v3', JSON.stringify(itineraryData));
            renderPlan(); closeModal();
        }

        function deleteEvent() {
            if (currentDayIdx === null || currentEvtIdx === null || currentEvtIdx < 0) return;
            deleteTarget = 'itinerary';
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden'); deleteTarget = null; deleteExpenseId = null;
        }

        function executeDelete() {
            if (deleteTarget === 'itinerary') {
                try { itineraryData[currentDayIdx].events.splice(currentEvtIdx, 1); localStorage.setItem('hk_itinerary_v3', JSON.stringify(itineraryData)); renderPlan(); closeModal(); } catch(e) { console.error(e); }
            } else if (deleteTarget === 'itinerary-reset') {
                localStorage.removeItem('hk_itinerary_v3'); initItinerary();
            } else if (deleteTarget === 'expense-clear') {
                localStorage.removeItem('hk_wallet_v2'); renderExpenseList();
            } else if (deleteTarget === 'expense-single') {
                let expenses = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
                expenses = expenses.filter(e => e.id !== deleteExpenseId);
                localStorage.setItem('hk_wallet_v2', JSON.stringify(expenses));
                renderExpenseList();
            }
            closeConfirmModal();
        }

        function initWallet() {
            renderExpenseList();
            document.getElementById('jpy-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') calculateRate(); });
        }

        function calculateRate() {
            const input = document.getElementById('jpy-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const output = document.getElementById('twd-output');
            try {
                const clean = input.replace(/[^0-9+\-*/().]/g, ''); if(!clean) return;
                const jpy = Function('"use strict";return (' + clean + ')')();
                const twd = Math.round(jpy * rate);
                output.innerText = twd.toLocaleString();
                if(!isNaN(clean)) document.getElementById('jpy-input').value = jpy.toLocaleString(); 
            } catch(e) { output.innerText = "Err"; }
        }

        function addExpense() {
            const payer = document.getElementById('expense-payer').value;
            const item = document.getElementById('expense-item').value;
            const price = document.getElementById('expense-price').value;
            const fileInput = document.getElementById('expense-photo');
            if(!item || !price) { alert("è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡"); return; }
            const processSave = (img) => {
                const data = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
                data.unshift({ id: Date.now(), payer, item, price: parseFloat(price), img, date: new Date().toLocaleDateString() });
                try {
                    localStorage.setItem('hk_wallet_v2', JSON.stringify(data));
                    document.getElementById('expense-item').value = ''; document.getElementById('expense-price').value = ''; fileInput.value = '';
                    document.getElementById('photo-label').innerText = 'æ‹ç…§/ä¸Šå‚³'; renderExpenseList();
                } catch(e) { alert("å„²å­˜ç©ºé–“å·²æ»¿"); }
            };
            if(fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const maxW = 300; const scale = maxW / img.width; c.width = maxW; c.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, c.width, c.height); processSave(c.toDataURL('image/jpeg', 0.6));
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(fileInput.files[0]);
            } else processSave(null);
        }

        function renderExpenseList() {
            const list = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            const container = document.getElementById('expense-list');
            let total = 0; let html = '';
            list.forEach(ex => {
                total += ex.price;
                const payerBadge = ex.payer ? `<span class="text-xs bg-gray-200 text-gray-600 px-1 rounded mr-1">[${ex.payer}]</span>` : '';
                html += `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg border border-gray-100 shadow-sm relative group">
                        <div class="flex items-center gap-3">
                             <div class="w-10 h-10 rounded bg-gray-100 flex-shrink-0 bg-cover bg-center border border-gray-200" style="background-image: url('${ex.img || ''}');" ${ex.img ? `onclick="window.open('${ex.img}')"` : ''}>
                                  ${!ex.img ? '<i class="fas fa-receipt text-gray-300 m-auto h-full flex items-center justify-center"></i>' : ''}
                             </div>
                             <div><div class="text-sm font-bold text-gray-700">${payerBadge}${ex.item}</div><div class="text-[10px] text-gray-400">${ex.date}</div></div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <div><div class="text-sm font-bold">Â¥${ex.price.toLocaleString()}</div><div class="text-[10px] text-gray-500 font-medium">â‰ˆ NT$${Math.round(ex.price * rate).toLocaleString()}</div></div>
                            <div class="flex flex-col gap-2 border-l border-gray-100 pl-2">
                                <button onclick="openExpenseEdit(${ex.id})" class="text-gray-400 hover:text-muji-accent"><i class="fas fa-pen text-xs"></i></button>
                                <button onclick="confirmDeleteExpense(${ex.id})" class="text-gray-400 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = list.length ? html : '<div class="text-center text-gray-300 text-xs mt-4">å°šç„¡æ¶ˆè²»</div>';
            document.getElementById('total-expense').innerText = `Total: Â¥${total.toLocaleString()}`;
        }

        function openExpenseEdit(id) {
            const list = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
            const expense = list.find(e => e.id === id);
            if (!expense) return;
            currentExpenseId = id;
            document.getElementById('edit-expense-payer').value = expense.payer || 'å°æˆ´';
            document.getElementById('edit-expense-item').value = expense.item;
            document.getElementById('edit-expense-price').value = expense.price;
            document.getElementById('edit-expense-photo').value = ''; 
            const modal = document.getElementById('expense-edit-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }

        function closeExpenseEditModal() {
            const modal = document.getElementById('expense-edit-modal');
            modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); currentExpenseId = null; }, 250);
        }

        function saveExpenseEdit() {
            if (!currentExpenseId) return;
            const payer = document.getElementById('edit-expense-payer').value;
            const item = document.getElementById('edit-expense-item').value;
            const price = parseFloat(document.getElementById('edit-expense-price').value);
            const fileInput = document.getElementById('edit-expense-photo');
            if (!item || !price) { alert("è«‹å¡«å¯«å®Œæ•´"); return; }
            const updateList = (newImg) => {
                const list = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
                const idx = list.findIndex(e => e.id === currentExpenseId);
                if (idx > -1) {
                    list[idx].payer = payer; list[idx].item = item; list[idx].price = price;
                    if (newImg) list[idx].img = newImg;
                    localStorage.setItem('hk_wallet_v2', JSON.stringify(list));
                    renderExpenseList(); closeExpenseEditModal();
                }
            };
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext('2d');
                        const maxW = 300; const scale = maxW / img.width; c.width = maxW; c.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, c.width, c.height); updateList(c.toDataURL('image/jpeg', 0.6));
                    }; img.src = e.target.result;
                }; reader.readAsDataURL(fileInput.files[0]);
            } else { updateList(null); }
        }

        function confirmDeleteExpense(id) {
            deleteTarget = 'expense-single'; deleteExpenseId = id;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function clearExpenses() {
            deleteTarget = 'expense-clear';
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function openSplitBillModal() {
            const list = JSON.parse(localStorage.getItem('hk_wallet_v2') || '[]');
            const members = ['å°æˆ´', 'ä½³æ¬£', 'ä½³è±', 'çŸå»·'];
            const rate = parseFloat(document.getElementById('exchange-rate').value);
            let totals = {}; members.forEach(m => totals[m] = 0);
            let grandTotal = 0;
            list.forEach(ex => { if (totals[ex.payer] !== undefined) { totals[ex.payer] += ex.price; grandTotal += ex.price; } });
            const average = grandTotal / members.length;
            const avgTwd = Math.round(average * rate);
            let summaryHtml = '';
            members.forEach(m => {
                const paid = totals[m]; const diff = paid - average;
                const diffTwd = Math.round(diff * rate);
                const diffClass = diff >= 0 ? 'text-green-600' : 'text-red-500';
                const diffSign = diff >= 0 ? '+' : '';
                summaryHtml += `<div class="flex justify-between items-center py-1 border-b border-gray-50 last:border-0"><span class="font-bold text-gray-700 w-16">${m}</span><span class="text-xs text-gray-400">å¢Š Â¥${paid.toLocaleString()}</span><span class="font-mono ${diffClass} w-24 text-right">${diffSign} $${diffTwd.toLocaleString()}</span></div>`;
            });
            document.getElementById('split-summary').innerHTML = summaryHtml;
            document.getElementById('split-average').innerText = `Â¥${Math.round(average).toLocaleString()} (ç´„ $${avgTwd.toLocaleString()})`;

            let debtors = []; let creditors = [];
            members.forEach(m => {
                const diff = totals[m] - average;
                if (diff < -1) debtors.push({ name: m, amount: -diff });
                else if (diff > 1) creditors.push({ name: m, amount: diff });
            });
            debtors.sort((a, b) => b.amount - a.amount); creditors.sort((a, b) => b.amount - a.amount);
            let planHtml = ''; let i = 0, j = 0;
            if(debtors.length === 0 && creditors.length === 0) { planHtml = '<div class="text-center text-green-500 font-bold py-2">ç›®å‰æ”¶æ”¯å¹³è¡¡ï¼</div>'; }
            else {
                while (i < debtors.length && j < creditors.length) {
                    let debtor = debtors[i]; let creditor = creditors[j];
                    let amount = Math.min(debtor.amount, creditor.amount);
                    let amountTwd = Math.round(amount * rate);
                    planHtml += `<div class="flex items-center justify-between bg-gray-50 p-2 rounded text-sm"><div class="flex items-center gap-2"><span class="font-bold text-gray-700">${debtor.name}</span><i class="fas fa-long-arrow-alt-right text-gray-400"></i><span class="font-bold text-gray-700">${creditor.name}</span></div><div class="font-mono font-bold text-muji-accent">Â¥${Math.round(amount).toLocaleString()} <span class="text-xs font-normal text-gray-400">($${amountTwd})</span></div></div>`;
                    debtor.amount -= amount; creditor.amount -= amount;
                    if (debtor.amount < 1) i++; if (creditor.amount < 1) j++;
                }
            }
            document.getElementById('split-plan').innerHTML = planHtml;
            const modal = document.getElementById('split-bill-modal');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('div').classList.remove('scale-95'); modal.querySelector('div').classList.add('scale-100'); }, 10);
        }

        function closeSplitBillModal() {
            const modal = document.getElementById('split-bill-modal');
            modal.classList.add('opacity-0'); modal.querySelector('div').classList.remove('scale-100'); modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 250);
        }

        function initChecklist() {
            const defaultChecks = ["è­·ç…§ (æ•ˆæœŸ6å€‹æœˆ+)", "Visit Japan Web", "æ©Ÿç¥¨/ä½å®¿æ†‘è­‰", "æ—…éŠä¿éšªå–®", "ç¾é‡‘ (æ—¥å¹£/å°å¹£)", "ä¿¡ç”¨å¡ (æµ·å¤–é–‹é€š)", "ç¶²å¡/eSIM", "è¡Œå‹•é›»æº/å……é›»ç·š", "å€‹äººè—¥å“/å£ç½©", "ç‰™åˆ·ç‰™è†/æ´—æ²", "ä¿æš–è¡£ç‰©/ç™¼ç†±è¡£", "æ‰‹å¥—/æ¯›å¸½/åœå·¾", "å¥½èµ°çš„é˜²æ»‘é‹", "æ‘ºç–Šå‚˜", "è³¼ç‰©è¢‹"];
            let stored = JSON.parse(localStorage.getItem('hk_checks_v2'));
            if(!stored) { stored = defaultChecks.map(txt => ({ txt, done: false })); localStorage.setItem('hk_checks_v2', JSON.stringify(stored)); }
            renderChecklist();
        }

        function renderChecklist() {
            const list = JSON.parse(localStorage.getItem('hk_checks_v2') || '[]');
            const container = document.getElementById('checklist-container');
            let html = ''; let doneCount = 0;
            list.forEach((item, idx) => {
                if(item.done) doneCount++;
                html += `<div class="flex items-center p-3 hover:bg-gray-50 group"><label class="flex items-center cursor-pointer flex-1"><input type="checkbox" class="peer hidden" onchange="toggleCheck(${idx})" ${item.done ? 'checked' : ''}><div class="w-5 h-5 border-2 border-gray-300 rounded-md peer-checked:bg-muji-accent peer-checked:border-muji-accent flex items-center justify-center transition-colors"><i class="fas fa-check text-white text-xs opacity-0 peer-checked:opacity-100"></i></div><span class="ml-3 text-sm text-gray-600 peer-checked:line-through peer-checked:text-gray-300 transition-colors select-none">${item.txt}</span></label><button onclick="delCheckItem(${idx})" class="text-gray-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button></div>`;
            });
            container.innerHTML = html; updateChecklistProgress(doneCount, list.length);
        }

        function toggleCheck(idx) {
            const list = JSON.parse(localStorage.getItem('hk_checks_v2'));
            list[idx].done = !list[idx].done;
            localStorage.setItem('hk_checks_v2', JSON.stringify(list));
            renderChecklist();
        }

        function addCheckItem() {
            const input = document.getElementById('new-check-item');
            if(!input.value.trim()) return;
            const list = JSON.parse(localStorage.getItem('hk_checks_v2'));
            list.unshift({ txt: input.value, done: false });
            localStorage.setItem('hk_checks_v2', JSON.stringify(list));
            input.value = ''; renderChecklist();
        }

        function delCheckItem(idx) {
            const list = JSON.parse(localStorage.getItem('hk_checks_v2'));
            list.splice(idx, 1); localStorage.setItem('hk_checks_v2', JSON.stringify(list)); renderChecklist();
        }

        function updateChecklistProgress(done, total) {
            if(total === undefined) { const list = JSON.parse(localStorage.getItem('hk_checks_v2') || '[]'); total = list.length; done = list.filter(i => i.done).length; }
            const pct = total === 0 ? 0 : Math.round((done / total) * 100);
            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('progress-text').innerText = `${pct}%`;
        }

        function toggleListTab(tab) {
            document.getElementById('view-checklist').classList.toggle('hidden', tab !== 'checklist');
            document.getElementById('view-memo').classList.toggle('hidden', tab !== 'memo');
            const btnCheck = document.getElementById('btn-checklist'); const btnMemo = document.getElementById('btn-memo');
            if(tab === 'checklist') {
                btnCheck.classList.add('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnCheck.classList.remove('text-gray-500');
                btnMemo.classList.remove('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnMemo.classList.add('text-gray-500');
            } else {
                btnMemo.classList.add('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnMemo.classList.remove('text-gray-500');
                btnCheck.classList.remove('bg-white', 'shadow-sm', 'text-gray-800', 'font-bold'); btnCheck.classList.add('text-gray-500');
            }
        }

        function initMemo() { const txt = localStorage.getItem('hk_memo_v2') || ''; document.getElementById('memo-area').value = txt; renderMemoLinks(txt); }
        function saveMemo() { const txt = document.getElementById('memo-area').value; localStorage.setItem('hk_memo_v2', txt); renderMemoLinks(txt); alert('å·²å„²å­˜'); }
        function renderMemoLinks(txt) {
            const matches = txt.match(/(https?:\/\/[^\s]+)/g); const container = document.getElementById('memo-links');
            if(matches) { container.innerHTML = matches.map(url => `<a href="${url}" target="_blank" class="block truncate text-xs text-blue-500 bg-blue-50 p-2 rounded hover:bg-blue-100"><i class="fas fa-link mr-1"></i>${url}</a>`).join(''); } 
            else { container.innerHTML = '<span class="text-[10px] text-gray-300">å°šç„¡é€£çµ</span>'; }
        }

        // --- SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service worker registered.', reg))
                    .catch((err) => console.log('Service worker registration failed:', err));
            });
        }
    </script>
</body>
</html>